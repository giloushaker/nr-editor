import{_ as X,a as ne}from"./CreateSystem.0ba59659.js";import{p as K,q as ie,r as ee,t as G,h as m,v as z,w as re,k as J,u as j,x as _,a as te,y as ue,z as de,A as ce,n as me,o as ge,B as he,D as S}from"./editorStore.5db7dbca.js";import{e as q,N as T,o as i,b as u,i as s,u as b,F as v,m as f,a as V,w as I,v as U,O as pe,t as g,P as Z,Q as _e,D as H,A as O,q as R,x as h,h as A,y as W,z as Y,R as fe,c as N,l as P,S as ye,k as be,K as ve,j as Ce,p as Q,T as ke,U as we}from"./entry.fb674813.js";import{a as Se,_ as Ie,b as se}from"./warning_sign.f2a15676.js";const Ae=["disabled"],xe=q({__name:"UploadJson",emits:["uploaded"],setup(e,{emit:t}){const o=T(null),l=T(!1);async function r(n){var d;try{l.value=!0;const c=[...((d=n.target)==null?void 0:d.files)||[]];if(!c){l.value=!1;return}const k=[];for(const y of c.filter(w=>K(w.name))){const w=ie(y.name)?await y.arrayBuffer():await y.text(),x=await ee(w,G(y.name));m(x).fullFilePath=y.name,k.push(x)}k.length&&t("uploaded",k),l.value=!1}catch(c){console.error(c),l.value=!1}}async function a(){o.value.click()}return(n,d)=>(i(),u(v,null,[s("input",{type:"file",accept:".gst, .gstz, .xml, .zip, .cat, .catz, .json",multiple:"",onChange:r,class:"invisible",ref_key:"fileinput",ref:o},null,544),s("button",{onClick:a,class:"bouton",disabled:b(l)},[b(l)?(i(),u(v,{key:1},[f(" ... ")],64)):(i(),u(v,{key:0},[f(" Import Catalogues ")],64))],8,Ae)],64))}});const ae=V(xe,[["__scopeId","data-v-959d97f5"]]),Ue=["disabled"],oe=q({__name:"ImportFromGithub",emits:["uploaded"],setup(e,{emit:t}){const o=T(""),l=T(!1);async function r(a){if(!a||z(a)!==a){console.log("bad url",a);return}try{l.value=!0;const n=a.split("/").slice(-2).join("/"),d=n.split("/")[1],c=`https://api.github.com/repos/${n}`,k=(await $fetch(c)).default_branch,y=`https://codeload.github.com/${n}/zip/refs/heads/${k}`,w=await $fetch(`https://corsproxy.io/?${y}`),x=await re(w,`${d}-${k}`),E=[];for(const[B,p]of Object.entries(x)){const D=G(B);if(K(D)){const F=await ee(p,D);E.push(F),m(F).fullFilePath=B}}E.length&&t("uploaded",E),o.value=""}catch(n){console.error(n)}finally{l.value=!1}}return(a,n)=>(i(),u(v,null,[I(s("input",{type:"text",class:"bouton !font-normal","onUpdate:modelValue":n[0]||(n[0]=d=>pe(o)?o.value=d:null),placeholder:'repo eg: "BSData/wh40k"'},null,512),[[U,b(o)]]),s("button",{onClick:n[1]||(n[1]=d=>r(b(z)(b(o)))),class:"bouton",disabled:b(z)(b(o))==null||b(l)},g(b(l)?"...":"Import from github"),9,Ue)],64))}}),$e={emits:["new","itemClicked","itemDoubleClicked"],setup(){return{cataloguesStore:J(),store:j()}},props:{items:{type:Array,required:!0},modelValue:{required:!0}},methods:{getDataObject:m,getType(e){var t;return e.gameSystem?{icon:"assets/icons/system1.png",order:1}:(t=e.catalogue)!=null&&t.library?{icon:"assets/icons/library.png",order:2}:{icon:"assets/icons/book.png",order:3}},elementDoubleClicked(e){this.$emit("itemDoubleClicked",e)},elementClicked(e){this.$emit("itemClicked",e)},changed(e){return this.store.get_catalogue_state(e).isChangedOnDisk},errors(e){var l;const t=[];(l=this.store.get_catalogue_state(e))!=null&&l.unsaved&&t.push({severity:"info",msg:"Unsaved"});const o=m(e).errors;if(o!=null&&o.length){const r={};for(const n of o)n.severity?Z(r,n.severity):Z(r,"error");let a=[];for(const n in r)a.push(`${r[n]} ${_e(n)}${r[n]===1?"":"s"}`);o.find(n=>n.severity==="error")?t.push({severity:"error",msg:`Has ${a.join(", ")}`}):o.find(n=>n.severity==="warning")&&t.push({severity:"warning",msg:`Has ${a.join(", ")}`})}return t},edited(e){return this.cataloguesStore.getEdited(_(e))},name(e){return m(e).name},add(){this.$emit("new")}},computed:{sortedItems(){return H(H(this.items,e=>this.name(e)),e=>this.getType(e).order)}},components:{ErrorIcon:te}};const M=e=>(W("data-v-f50dea5a"),e=e(),Y(),e),Ee={class:"items"},De=["onClick","onDblclick"],Fe=["src"],Ne={class:"error flex flex-row"},Ve={key:0,class:"my-auto",title:`This file was changed by another program.
You may want to reload the system through the Systems tab`},Be=M(()=>s("img",{class:"my-auto align-text-bottom",src:Se},null,-1)),Pe=[Be],Te=M(()=>s("img",{class:"w-40px h-40px",src:Ie},null,-1)),Oe=M(()=>s("div",{class:"bold text-blue"},"New",-1)),ze=[Te,Oe];function Re(e,t,o,l,r,a){const n=te;return i(),u("div",Ee,[(i(!0),u(v,null,O(a.sortedItems,d=>(i(),u("div",{class:R(["relative item unselectable",{edited:a.edited(d),selected:d===o.modelValue}]),onClick:c=>a.elementClicked(d),onDblclick:c=>a.elementDoubleClicked(d)},[s("img",{class:"icon",src:a.getType(d).icon},null,8,Fe),s("div",null,g(a.name(d)),1),s("div",Ne,[a.changed(d)?(i(),u("span",Ve,Pe)):h("",!0),A(n,{errors:a.errors(d)},null,8,["errors"])])],42,De))),256)),s("div",{class:"relative item add unselectable",onClick:t[0]||(t[0]=(...d)=>a.add&&a.add(...d))},ze)])}const le=V($e,[["render",Re],["__scopeId","data-v-f50dea5a"]]),Ge={emits:["edit","delete"],props:{catalogue:{type:Object,required:!0}},setup(){return{catalogueStore:J(),store:j()}},data(){return{deletePopup:!1}},methods:{download_file(){const e=m(this.catalogue),t=this.store.get_system(e.gameSystemId||e.id).getLoadedCatalogue({targetId:e.id}),o=ue(t||e),l=e.fullFilePath?de(ce(e.fullFilePath)):e.name,r=e.gameSystemId?"cat":"gst";fe(`${l}.${r}`,"application/xml",o)}},computed:{is_catalogue(){return!!this.catalogue.catalogue},electron(){return!!globalThis.electron},imports(){return this.cataloguedata.catalogueLinks||[]},refs(){return this.catalogueStore.getDependents(_(this.catalogue))||[]},cataloguedata(){return m(this.catalogue)},isSystem(){return!this.cataloguedata.gameSystemId}}};const C=e=>(W("data-v-83e7a2c1"),e=e(),Y(),e),Je={class:"details"},je={key:0},qe=C(()=>s("span",{class:"grey hastooltip",title:"indicates that this catalogue is used to store data, no forces may be created from it if true."}," Library: ",-1)),We=C(()=>s("span",{class:"grey"},"Id:",-1)),Ye=C(()=>s("span",{class:"grey"},"path:",-1)),Me={key:1},Le=C(()=>s("span",{class:"grey"},"authorUrl:",-1)),Ze=C(()=>s("span",{class:"grey"},"authorContact:",-1)),He=C(()=>s("span",{class:"grey"},"authorName:",-1)),Qe={key:2},Xe=C(()=>s("span",{class:"bold"},"imports:",-1)),Ke={class:"ml-10px"},et={key:3},tt=C(()=>s("span",{class:"bold"},"imported by:",-1)),st={class:"ml-10px"},at={class:"section boutons"},ot=C(()=>s("p",{class:"info"}," To quickly edit a catalogue, you can double-click on it. ",-1));function lt(e,t,o,l,r,a){var d;const n=ye;return i(),u("fieldset",Je,[s("div",null,[s("legend",null,g(a.cataloguedata.name),1),a.is_catalogue?(i(),u("div",je,[qe,f(" "+g(a.cataloguedata.library),1)])):h("",!0),s("div",null,[We,f(" "+g(a.cataloguedata.id),1)]),s("div",null,[Ye,f(" "+g(a.cataloguedata.fullFilePath),1)]),a.electron?(i(),u("div",Me,[Le,f(" "+g(a.cataloguedata.authorUrl),1)])):h("",!0),s("div",null,[Ze,f(" "+g(a.cataloguedata.authorContact),1)]),s("div",null,[He,f(" "+g(a.cataloguedata.authorName),1)]),(d=a.cataloguedata.catalogueLinks)!=null&&d.length?(i(),u("div",Qe,[Xe,s("div",Ke,[(i(!0),u(v,null,O(a.cataloguedata.catalogueLinks,c=>(i(),u("div",null,[s("span",{class:R({grey:!c.importRootEntries})},g(c.name),3)]))),256))])])):h("",!0),a.refs.length&&!a.isSystem?(i(),u("div",et,[tt,s("div",st,[(i(!0),u(v,null,O(a.refs,c=>(i(),u("div",null,[s("span",{class:R({grey:!c.importRootEntries})},g(c.sourceName),3)]))),256))])])):h("",!0)]),s("div",at,[s("button",{class:"bouton",onClick:t[0]||(t[0]=c=>e.$emit("edit",o.catalogue))},"Edit"),s("button",{class:"bouton",onClick:t[1]||(t[1]=c=>r.deletePopup=!0)},"Delete"),s("button",{class:"bouton",onClick:t[2]||(t[2]=(...c)=>a.download_file&&a.download_file(...c))},"Download"),ot]),r.deletePopup?(i(),N(n,{key:0,button:"Confirm",text:"Cancel",onButton:t[3]||(t[3]=c=>e.$emit("delete",o.catalogue)),modelValue:r.deletePopup,"onUpdate:modelValue":t[4]||(t[4]=c=>r.deletePopup=c)},{default:P(()=>[s("div",null,"Are you sure you want to delete this "+g(a.is_catalogue?"catalogue":"Game System")+"?",1)]),_:1},8,["modelValue"])):h("",!0)])}const nt=V(Ge,[["render",lt],["__scopeId","data-v-83e7a2c1"]]),it={emits:["create"],props:{catalogue:{type:Object,required:!0}},computed:{cataloguedata(){return m(this.catalogue)}}};const $=e=>(W("data-v-3d1f2a25"),e=e(),Y(),e),rt={class:"details"},ut={class:"editorTable"},dt=$(()=>s("td",null,[s("label",{for:"name"}," name: ")],-1)),ct=$(()=>s("td",null,[s("label",{for:"authorUrl"}," authorUrl: ")],-1)),mt=$(()=>s("td",null,[s("label",{for:"authorContact"}," authorContact: ")],-1)),gt=$(()=>s("td",null,[s("label",{for:"authorName"}," authorName: ")],-1)),ht=$(()=>s("td",null,"id:",-1)),pt=$(()=>s("td",null,[s("label",{for:"library",class:"hastooltip",title:"indicates that this catalogue is used to store data, no forces may be created from it if true."}," library: ")],-1));function _t(e,t,o,l,r,a){return i(),u("fieldset",rt,[s("legend",null,g(a.cataloguedata.name),1),s("table",ut,[s("tr",null,[dt,s("td",null,[I(s("input",{type:"text",id:"name","onUpdate:modelValue":t[0]||(t[0]=n=>a.cataloguedata.name=n)},null,512),[[U,a.cataloguedata.name]])])]),s("tr",null,[ct,s("td",null,[I(s("input",{type:"text",id:"authorUrl","onUpdate:modelValue":t[1]||(t[1]=n=>a.cataloguedata.authorUrl=n)},null,512),[[U,a.cataloguedata.authorUrl]])])]),s("tr",null,[mt,s("td",null,[I(s("input",{type:"text",id:"authorContact","onUpdate:modelValue":t[2]||(t[2]=n=>a.cataloguedata.authorContact=n)},null,512),[[U,a.cataloguedata.authorContact]])])]),s("tr",null,[gt,s("td",null,[I(s("input",{type:"text",id:"authorName","onUpdate:modelValue":t[3]||(t[3]=n=>a.cataloguedata.authorName=n)},null,512),[[U,a.cataloguedata.authorName]])])]),s("tr",null,[ht,s("td",null,[I(s("input",{type:"text",class:"gray",id:"id","onUpdate:modelValue":t[4]||(t[4]=n=>a.cataloguedata.id=n)},null,512),[[U,a.cataloguedata.id]])])]),s("tr",null,[pt,s("td",null,[I(s("input",{type:"checkbox",id:"library","onUpdate:modelValue":t[5]||(t[5]=n=>a.cataloguedata.library=n)},null,512),[[be,a.cataloguedata.library]])])])]),s("button",{class:"bouton",onClick:t[6]||(t[6]=n=>e.$emit("create",o.catalogue))}," Create Catalogue ")])}const ft=V(it,[["render",_t],["__scopeId","data-v-3d1f2a25"]]),yt=q({components:{UploadJson:ae,CataloguesDetail:nt,ImportFromGithub:oe,CataloguesCreate:ft,SelectFile:X,IconContainer:le,SplitView:se},head(){return{title:"New Recruit - Editor"}},data(){return{msg:"",selectedItem:null,mode:"edit",editingItem:null,failed:!1}},setup(){return{cataloguesStore:J(),store:j(),settings:ve()}},created(){this.store.init(this.$router),electron||this.store.load_systems_from_db()},activated(){window.addEventListener("beforeunload",this.beforeUnload)},deactivated(){window.removeEventListener("beforeunload",this.beforeUnload)},computed:{electron(){return!!globalThis.electron},filter(){var t;const e=(t=this.$route.query)==null?void 0:t.id;if(e)return e.split(",")},systems(){if(this.filter){const e={};for(const t of this.filter){const o=this.store.gameSystems[t];return o&&(e[t]=o),e}}return this.store.gameSystems}},methods:{githubHoverTitle(e){return e.discovered?`using discovered .git repo at ${e.githubUrl}
use a publication name="Github", url="https://github.com/{owner}/{repo}" in the gameSystem to overwrite.`:`using repo at ${e.githubUrl}`},saveAll(){var t;let e=!1;try{for(const o of Object.values(this.systems))for(const l of o.getAllLoadedCatalogues())(t=this.store.get_catalogue_state(l))!=null&&t.unsaved&&this.store.save_catalogue(o,l)}catch{e=!0}this.failed=e},async beforeUnload(e){if(!globalThis._closeWindow){if(this.store.unsavedCount){const t="You have unsaved changes that will be lost";e.returnValue=t,electron&&setTimeout(async()=>{await me({message:"You have unsaved changes that will be lost?",buttons:["Cancel","Leave"],defaultId:0,cancelId:0,type:"question"})===1&&(globalThis._closeWindow=!0,ge())})}return!1}},systemAndCatalogues(e){let t=[];return e.gameSystem&&t.push(e.gameSystem),e.catalogueFiles&&t.push(...Object.values(e.catalogueFiles)),t},itemClicked(e){this.selectedItem=e,this.mode="edit"},itemDoubleClicked(e){const t=m(e).id,o=m(e).gameSystemId||t;this.$router.push({name:"catalogue",query:{systemId:o,id:t}})},newCatalogue(e){if(!e.gameSystem)return;const t=e.gameSystem.gameSystem;this.mode="create",this.selectedItem={catalogue:{library:!1,id:Ce(),name:"New Catalogue",gameSystemId:t.id,gameSystemRevision:t.revision,revision:1}}},getCatExtension(e){switch(G(e)){case"json":return"json";case"gstz":return"catz";default:case"gst":return"cat"}},createCatalogue(e){const t=this.store.get_system(e.catalogue.gameSystemId),o=JSON.parse(JSON.stringify(e));if(o.catalogue.battleScribeVersion="2.03",electron){if(!t.gameSystem)throw new Error("Cannot create catalogue: no game system");const l=m(t.gameSystem).fullFilePath;if(!l)throw new Error("Cannot create catalogue: game system has no path set");const r=o.catalogue.name;if(!r)throw new Error("Cannot create catalogue: no name provided");const a=he(l);m(o).fullFilePath=`${a}/${r}.${this.getCatExtension(l)}`}t.setCatalogue(o),this.cataloguesStore.setEdited(_(o),!0),this.store.set_catalogue_changed(o,!0),this.store.get_catalogue_state(o).incremented=!0,this.selectedItem=o,electron||S.catalogues.put({content:o,id:_(e)}),this.mode="edit"},deleteCatalogue(e){console.log("Deleted catalogue",e);const t=m(e),o=t.gameSystemId||t.id;if(e.catalogue)this.store.get_system(o).removeCatalogue(e),electron||S.catalogues.delete(_(e));else if(e.gameSystem){const l=this.store.get_system(o);for(const r of Object.values(l.catalogueFiles)){const a=_(r);S.catalogues.delete(a)}S.catalogues.delete(_(l.gameSystem)),S.systems.delete(_(l.gameSystem)),this.store.delete_system(o)}this.selectedItem=null},filesUploaded(e){console.log("Uploaded",e.length,"files",e);const t=e.filter(l=>l.gameSystem);for(const l of t){const r=l.gameSystem.id,a=_(l);this.store.get_system(r).setSystem(l),electron||S.systems.put({content:l,id:a}),this.cataloguesStore.updateCatalogue(l.gameSystem),this.cataloguesStore.setEdited(a,!1)}const o=e.filter(l=>l.catalogue);for(const l of o){const r=l.catalogue.gameSystemId;this.store.get_system(r).setCatalogue(l),electron||S.catalogues.put({content:l,id:_(l)}),this.cataloguesStore.updateCatalogue(l.catalogue),this.cataloguesStore.setEdited(_(l),!1)}delete this.$route.query.id},async editCatalogue(e){const t=m(e).id,o=m(e).gameSystemId||t;this.$router.push({name:"catalogue",query:{systemId:o,id:t}})}}}),bt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAKa8AACmvAUYJFJkAAAJdSURBVFhHvddNiE1hHMfxy1yS8VYMm1mwklhYoBRqrLCgWCkvCysxXiIrS4tZmVkrCyWZTF6WSEo2SMhLFt6KsuAOMUNJ+P6cc29//55z7/Oce8evPp1zp3me+z/Pec5znltpkW7sxDk8xzh+ooY7GMRaTEJHMw3HMYrfER5gAzqSJXiK0Be1choqvnRW4BNCnce6Ad26qNh7twh3Me/vp3/zBJehkdE8WIDV2Io58LmEbVBBUZmM2/BX8xabUZSZGIAmpm+7F9HZDt/BI+hKY7IFP2Db60kJjU4wD+Eb9yIl+2D7kKNomWXwDfcjNZpP92D70ePZMgdgG33FdJTJLti+fmEuCqPJpxGw0WT8lp0m53p+rEejsjQ7DUcFzM9OG3mZH8vkPXzxTSeyCvDRsLUT377pe0IFfMxOG1mYH8tEi9iM7LSRD/kxGBWg1c1mDaZmp8lZnx9tnuXHwiyHnbmyG2VyE7Yff3GFUZW24Ts0fXwCCa2meqVHZQ9841vQWh8T3bYx2PZfEHqxBdOF+7AdyGOsRFGqOIjv8G2PISnaiHyG70iP1TXo7bYO2jNswgm8hv//urPQhSWlD34o26G9pEYpKavwBqEOyziP5CJm4SS0rIY69V7hlPubNYzkIpQeaJJdhVa0eofaAb3AGWgzUu/8COwXWxcwBW1FO97ZaHY1hxEqQEbQdhExOQQ9PaEiLuK/FKGNTlER2jWXfd8kpR9FRVxBNXmhSIx+Z2iDuxF+X7AYtYkuQFEReoK0evoi/F5kQqOl3N+OpB8vncgO6NeW3pRDlUql6w9PQiGMhlvIAAAAAABJRU5ErkJggg==";const vt={key:0,class:"p-10px"},Ct={class:"box"},kt=s("h3",null,"My Catalogues",-1),wt={class:"boutons"},St={key:0},It=s("p",{class:"info"},[f(" To return to this page, simply click on the 'New Recruit' icon located in the top-left corner of the screen. "),s("br"),f(" Returning to this page will not cause you to lose your changes. ")],-1),At={class:"mx-10px box h-full pb-200px"},xt={class:"scrollable"},Ut=s("img",{class:"w-24px h-24px align-bottom icon",src:bt,title:"Search"},null,-1),$t=["href"],Et=["src","title"],Dt={key:0,class:"scrollable"},Ft={key:1,class:"status mx-2 text-red"},Nt={key:2,class:"status mx-2"};function Vt(e,t,o,l,r,a){const n=X,d=ae,c=oe,k=ne,y=we,w=le,x=Q("CataloguesCreate"),E=Q("CataloguesDetail"),B=se;return i(),u(v,null,[e.electron?h("",!0):(i(),u("div",vt,[s("div",Ct,[kt,s("div",wt,[e.electron?(i(),N(n,{key:0,onUploaded:e.filesUploaded},null,8,["onUploaded"])):h("",!0),A(d,{onUploaded:e.filesUploaded},null,8,["onUploaded"]),A(c,{onUploaded:e.filesUploaded},null,8,["onUploaded"]),A(k)]),e.electron?(i(),u("div",St," Note: if you modify an already imported file in another program, you will need to import it again ")):h("",!0)])])),It,s("div",At,[A(B,{showMiddle:"",showRight:"",rightWidth:400,id:"systemView"},{middle:P(()=>[s("div",xt,[(i(!0),u(v,null,O(e.systems,p=>{var D,F;return i(),u("fieldset",null,[s("legend",null,[f(g(((D=p.gameSystem)==null?void 0:D.gameSystem.name)||"Unknown GameSystem")+" ",1),A(y,{to:`/search/${p.getId()}`},{default:P(()=>[Ut]),_:2},1032,["to"]),(F=p.github)!=null&&F.githubUrl?(i(),u("a",{key:0,href:p.github.githubUrl,target:"_blank"},[s("img",{class:"w-24px h-24px ml-5px align-bottom",src:e.settings.theme==="dark"?"assets/icons/github-dark.png":"assets/icons/github-light.png",title:e.githubHoverTitle(p.github)},null,8,Et)],8,$t)):h("",!0)]),A(w,{items:e.systemAndCatalogues(p),onItemClicked:e.itemClicked,onItemDoubleClicked:e.itemDoubleClicked,onNew:L=>e.newCatalogue(p),modelValue:e.selectedItem,"onUpdate:modelValue":t[0]||(t[0]=L=>e.selectedItem=L)},null,8,["items","onItemClicked","onItemDoubleClicked","onNew","modelValue"])])}),256))])]),right:P(()=>[e.selectedItem?(i(),u("div",Dt,[e.mode==="create"?(i(),N(x,{key:0,onCreate:e.createCatalogue,catalogue:e.selectedItem},null,8,["onCreate","catalogue"])):(i(),N(E,{key:1,onDelete:e.deleteCatalogue,onEdit:e.editCatalogue,catalogue:e.selectedItem},null,8,["onDelete","onEdit","catalogue"]))])):h("",!0)]),_:1}),e.store.unsavedCount&&e.$route.name=="index"?(i(),N(ke,{key:0,to:"#titlebar-content"},[e.store.unsavedCount?(i(),u("button",{key:0,class:"bouton save ml-10px !w-100px",onClick:t[1]||(t[1]=(...p)=>e.saveAll&&e.saveAll(...p))},"Save All")):e.failed?(i(),u("span",Ft,"failed to save")):(i(),u("span",Nt,"saved"))])):h("",!0)])],64)}const zt=V(yt,[["render",Vt]]);export{zt as default};
//# sourceMappingURL=index.b50cfc95.js.map
