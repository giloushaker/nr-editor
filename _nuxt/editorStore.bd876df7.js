var Ri=Object.defineProperty;var Bi=(e,t,n)=>t in e?Ri(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var b=(e,t,n)=>(Bi(e,typeof t!="symbol"?t+"":t,n),n);import{a5 as $s,a6 as ee,a7 as xe,a8 as Fi,a9 as Bn,aa as Ki,ab as qe,ac as Fn,j as X,ad as Mi,V as Ui,ae as Je,af as vn,ag as zi,ah as qi,ai as ji,aj as Wr,ak as Vr,a3 as wr,a4 as Gs,al as Wi,am as Dr,an as Vi,q as bn,S as he,ao as wn,ap as Di,aq as Ji}from"./entry.6df6229c.js";function Hi(e){if(!e.constraints)return e;const t=[];for(const r of e.constraints)if(r.type==="exactly"){const s={...r,id:r.id+"-min",type:"min"},i={...r,id:r.id+"-max",type:"max"};t.push(s,i)}else t.push(r);const n=$s(e);return n.constraints=t,n}function Xi(e){if(!e.modifiers&&!e.modifierGroups||!e.constraintsIterator)return e;const t={};for(const i of e.constraintsIterator())i.type==="exactly"&&(t[i.id]=i);function n(i){const o=[];for(const c of i)if(c.field in t){const a={...c,field:c.field+"-min"},l={...c,field:c.field+"-max"};o.push(a,l)}else o.push(c);return o}function r(i){const o=[];for(const c of i){const a={...c};a.modifiers&&(a.modifiers=n(a.modifiers)),a.modifierGroups&&(a.modifierGroups=r(a.modifierGroups)),o.push(a)}return o}const s=$s(e);return s.modifiers&&(s.modifiers=n(s.modifiers)),s.modifierGroups&&(s.modifierGroups=r(s.modifierGroups)),s}const Yi=["modifiers","modifierGroups","constraints","entryLinks","categoryLinks","selectionEntries","selectionEntryGroups","infoLinks","infoGroups","rules","profiles"],Rs=["profile","rule","infoLink","infoGroup","selectionEntry","selectionEntryGroup","entryLink","profiles","rules","infoLinks","infoGroups","entryLinks","selectionEntries","selectionEntryLinks","selectionEntryGroups","categoryLinks","costTypes","profileTypes","characteristicTypes","categoryEntries","categories","forceEntries","forces","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","rules","rootRules","publications","catalogueLinks","constraints","characteristics","costs"],Qi=["conditions","conditionGroups","modifiers","modifierGroups","repeats"],_r=new Set([...Rs,...Qi]),Zi=new Set(Rs);function ye(e){if(e.isCatalogue&&e.isCatalogue())return e;if(e.gameSystem)return e.gameSystem;if(e.catalogue)return e.catalogue;throw Error("getDataObject data argument is not a valid system or catalogue")}function Jr(e){if(e.isCatalogue&&e.isCatalogue()){if(e.id&&e.gameSystemId)return`${e.gameSystemId}-${e.id}`;if(e.id)return`${e.id}`}if(e.catalogue)return`${e.catalogue.gameSystemId}-${e.catalogue.id}`;if(e.gameSystem)return e.gameSystem.id;throw Error("getDataId data argument is not a valid system or catalogue")}class R{constructor(t){b(this,"id");b(this,"type");b(this,"subType");b(this,"shared");b(this,"import");b(this,"collective");b(this,"comment");b(this,"publicationId");b(this,"typeName");b(this,"typeId");b(this,"categoryEntryId");b(this,"name");b(this,"hidden");b(this,"value");b(this,"page");b(this,"defaultAmount");b(this,"profiles");b(this,"rules");b(this,"infoLinks");b(this,"infoGroups");b(this,"publications");b(this,"costs");b(this,"selectionEntries");b(this,"selectionEntryGroups");b(this,"entryLinks");b(this,"profileTypes");b(this,"categoryEntries");b(this,"categoryLinks");b(this,"forceEntries");b(this,"sharedSelectionEntryGroups");b(this,"sharedSelectionEntries");b(this,"sharedProfiles");b(this,"sharedRules");b(this,"sharedInfoGroups");b(this,"target");b(this,"modifiers");b(this,"modifierGroups");b(this,"constraints");b(this,"repeats");b(this,"conditions");b(this,"conditionGroups");b(this,"catalogue");b(this,"extra_constraints");b(this,"childs");b(this,"loaded");b(this,"collective_recursive");b(this,"limited_to_one");b(this,"associations");b(this,"associationConstraints");b(this,"flatten");b(this,"collapsible");b(this,"sortIndex");return Object.setPrototypeOf(t,Object.getPrototypeOf(this))}get url(){return"%{main_catalogue|catalogue}/%{id}/%{getName}"}process(){this.loaded||(this.collective_recursive=this.isCollectiveRecursive(),this.limited_to_one=!this.canAmountBeAbove1(),this.loaded=!0)}toJson(){return jt(this)}getCatalogue(){return this.catalogue}getGameSystem(){return this.getCatalogue().getGameSystem()}get[Symbol.toStringTag](){return globalThis.isEditor?"Object":"ObjectNoObserve"}isGroup(){return!1}isForce(){return!1}isCatalogue(){return!1}isLink(){return!1}isCategory(){return!1}isRoster(){return!1}isQuantifiable(){return!1}isEntry(){return!1}isIdUnique(){return!1}isRule(){return!1}isProfile(){return!1}isInfoGroup(){return!1}isUnit(){for(const t of this.categoryLinks||[])if(t.primary)return!0;return!1}getId(){return this.id}getType(){return this.subType??this.type}getTypeName(){return this.typeName}getCategoryEntryId(){return this.categoryEntryId}getHidden(){return this.hidden}getPage(){return this.page}getName(){return this.name}getDefaultAmount(){return this.defaultAmount}isCollective(){return this.collective}isCollectiveRecursive(){const t=[...this.selectionsIterator()];for(;t.length;){const n=t.pop();if(!n.isCollective()&&!n.isGroup())return!1;t.push(...n.selectionsIterator())}return!0}isEmptyNode(){for(const t of Yi)if(this[t]!==void 0)return!1;return!0}*forcesIterator(){}*associationsIterator(){this.associations&&(yield*this.associations)}*profilesIterator(){var t;for(const n of It(this))n.profiles&&(yield*n.profiles),n.infoLinks&&(yield*(t=n.infoLinks)==null?void 0:t.filter(r=>r.type==="profile").map(r=>r.target))}*rulesIterator(){var t;for(const n of It(this))n.rules&&(yield*n.rules),n.infoLinks&&(yield*(t=n.infoLinks)==null?void 0:t.filter(r=>r.type==="rule").map(r=>r.target))}*constraintsIterator(){this.constraints&&(yield*this.constraints)}*extraConstraintsIterator(){this.extra_constraints&&(yield*this.extra_constraints)}*modifierGroupsIterator(){this.modifierGroups&&(yield*this.modifierGroups)}*modifiersIterator(){this.modifiers&&(yield*this.modifiers)}*modifierGroupsIteratorRecursive(){yield this,this.isLink()&&(yield this.target);for(const t of this.modifierGroupsIterator())yield t,yield*tn(t.modifierGroups)}*selectionsIterator(){this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*localSelectionsIterator(){this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*nodesIterator(){this.isLink()&&(yield*this.target.nodesIterator()),this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.isLink()&&(yield*this.target.entriesIterator()),this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks),this.childs&&(yield*this.childs)}*iterateSelectionEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups)}*iterateSelectionEntriesWithRoot(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups)}*iterateRootEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.forceEntries&&(yield*this.forceEntries)}*iterateAllRootEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.forceEntries&&(yield*this.forceEntries)}*categoryLinksIterator(){this.categoryLinks&&(yield*this.categoryLinks)}*infoLinksIterator(){this.infoLinks&&(yield*this.infoLinks)}*infoGroupsIterator(){this.infoGroups&&(yield*this.infoGroups)}*infoRulesIterator(){if(this.isForce()){const t=this.getGameSystem();t.rules&&(yield*t.rules);const n=this.main_catalogue;n.rules&&(yield*n.rules)}this.rules&&(yield*this.rules)}*infoProfilesIterator(){this.profiles&&(yield*this.profiles)}forEachCond(t,n=0){if(t(this,0)===void 0)for(const r of this.selectionsIterator())r.forEachCond(t,n+1)}forEach(t){t(this);for(const n of this.selectionsIterator())n.forEach(t)}forEachNode(t){t(this);for(const n of this.nodesIterator())n.forEachNode(t)}forEachNodeCb(t){const n=[this],r=new Set;for(;n.length;){const s=n.pop();if(!r.has(s.id)){if(r.add(s.id),t(s),s.childs){n.push(...s.childs);continue}if(s.target){const i=s.target;i.selectionEntries&&n.push(...i.selectionEntries),i.selectionEntryGroups&&n.push(...i.selectionEntryGroups),i.entryLinks&&n.push(...i.entryLinks)}s.selectionEntries&&n.push(...s.selectionEntries),s.selectionEntryGroups&&n.push(...s.selectionEntryGroups),s.entryLinks&&n.push(...s.entryLinks)}}}forEachObjectWhitelist(t,n=_r){const r=[this];for(;r.length;){const s=r.pop();for(const i in s){const o=s[i];if(n.has(i)&&ee(o))if(Array.isArray(o)){if(o.length&&ee(o[0]))for(let c=0;c<o.length;c++){const a=o[c];t(a,s),r.push(a)}}else t(o,s),r.push(o)}}}forEachObject(t,n=new Set){const r=[this];for(;r.length;){const s=r.pop();for(const i of Object.keys(s)){const o=s[i];if(!n.has(i)&&ee(o))if(Array.isArray(o)){if(o.length&&ee(o[0]))for(let c=o.length;c--;){const a=o[c];t(a,s),r.push(a)}}else t(o,s),r.push(o)}}}findOption(t){for(const n of this.selectionsIterator())if(t(n))return n}findOptionRecursive(t){const n=[...this.selectionsIterator()];for(;n.length;){const r=n.pop();if(t(r))return r}}getCosts(){return this.costs||[]}getPrimaryCategory(){for(const t of this.categoryLinks||[])if(t.primary)return t.targetId;return this.getCategoryEntryId()??Oe}getPrimaryCategoryLink(){for(const t of this.categoryLinks||[])if(t.primary)return t}getPackedConstraint(t){const n=Object.assign({},t);n.name=this.getName(),n.parent=this;const r=t.shared||this instanceof Bs;n.childId=this.isLink()&&r?this.targetId:this.id,n.modifiers=[];for(const s of this.modifiersIterator())(s.field===t.id||s.field==="hidden"&&t.type==="min")&&n.modifiers.push(s);n.modifierGroups=[];for(const s of this.modifierGroupsIterator())e:for(const i of tn([s]))for(const o of i.modifiers||[])if(o.field===t.id||o.field==="hidden"&&t.type==="min"){n.modifierGroups.push(s);break e}return n}getBoundConstraint(t){const n=this.getPackedConstraint(t);return n.scope="self",n}getChildBoundConstraints(t){const n=[];for(const r of this.selectionsIterator())if(!(t&&r.isGroup())){for(const s of r.constraintsIterator())(s.type==="min"||s.type==="exactly")&&s.scope==="parent"&&n.push(r.getBoundConstraint(s));r.isGroup()&&n.push(...r.getChildBoundConstraints())}return n}canAmountBeAbove1(){const t=to(this.constraintsIterator(),[...this.modifierGroupsIterator(),{modifiers:[...this.modifiersIterator()]}]);return!t.length||t.includes(-1)?!0:Math.min(...t)>1}hasOption(t){let n;return this.forEachCond(r=>(r.getName()===t&&(n=!0),n)),!!n}}class _n extends R{isEntry(){return!0}isQuantifiable(){return!0}isIdUnique(){return!0}}class En extends R{getDefaultSelectionEntryId(){return this.defaultSelectionEntryId}isGroup(){return!0}isIdUnique(){return!0}}class et extends R{constructor(){super(...arguments);b(this,"targetId")}isLink(){return!0}isGroup(){var n;return(n=this.target)==null?void 0:n.isGroup()}isCategory(){var n;return(n=this.target)==null?void 0:n.isCategory()}isQuantifiable(){var n;return(n=this.target)==null?void 0:n.isQuantifiable()}isEntry(){var n;return(n=this.target)==null?void 0:n.isEntry()}isIdUnique(){return!1}isProfile(){var n;return((n=this.target)==null?void 0:n.isProfile())||!1}isRule(){var n;return((n=this.target)==null?void 0:n.isRule())||!1}isInfoGroup(){var n;return((n=this.target)==null?void 0:n.isInfoGroup())||!1}isUnit(){if(this.target.isUnit())return!0;for(const n of this.categoryLinks||[])if(n.primary)return!0;return!1}getId(){return this.targetId}getType(){var n;return(n=this.target)==null?void 0:n.getType()}getPage(){var n;return this.page||((n=this.target)==null?void 0:n.page)}getHidden(){return this.target.hidden||this.hidden}getDefaultSelectionEntryId(){var n;return this.defaultSelectionEntryId||((n=this.target)==null?void 0:n.getDefaultSelectionEntryId())}getCategoryEntryId(){var n;return this.categoryEntryId??((n=this.target)==null?void 0:n.categoryEntryId)}get associationConstraints(){return this.target.associationConstraints}getAssociations(){return this.associations||this.target.associations}isCollective(){var n;return super.isCollective()||((n=this.target)==null?void 0:n.isCollective())}*extraConstraintsIterator(){yield*this.target.extraConstraintsIterator(),yield*super.extraConstraintsIterator()}*associationsIterator(){yield*this.target.associationsIterator(),yield*super.associationsIterator()}*rulesIterator(){yield*this.target.rulesIterator(),yield*super.rulesIterator()}*profilesIterator(){yield*this.target.profilesIterator(),yield*super.profilesIterator()}*constraintsIterator(){this.target&&(yield*this.target.constraintsIterator()),yield*super.constraintsIterator()}*modifierGroupsIterator(){yield*this.target.modifierGroupsIterator(),yield*super.modifierGroupsIterator()}*modifiersIterator(){yield*this.target.modifiersIterator(),yield*super.modifiersIterator()}*selectionsIterator(){yield*this.target.selectionsIterator(),yield*super.selectionsIterator()}*categoryLinksIterator(){yield*this.target.categoryLinksIterator(),yield*super.categoryLinksIterator()}*infoLinksIterator(){yield*this.target.infoLinksIterator(),yield*super.infoLinksIterator()}*infoGroupsIterator(){yield*this.target.infoGroupsIterator(),yield*super.infoGroupsIterator()}*infoRulesIterator(){yield*this.target.infoRulesIterator(),yield*super.infoRulesIterator()}*infoProfilesIterator(){yield*this.target.infoProfilesIterator(),yield*super.infoProfilesIterator()}getDefaultAmount(){return this.defaultAmount===void 0?this.target.defaultAmount:this.defaultAmount}getName(){var n;return((n=this.target)==null?void 0:n.name)||this.name}getParent(){return this.parent}getPrimaryCategory(){for(const n of this.categoryLinks||[])if(n.primary)return n.targetId;for(const n of this.target.categoryLinks||[])if(n.primary)return n.targetId;return this.getCategoryEntryId()??Oe}getPrimaryCategoryLink(){for(const n of this.categoryLinks||[])if(n.primary)return n;for(const n of this.target.categoryLinks||[])if(n.primary)return n}getCosts(){var r;const n={};if((r=this.target)!=null&&r.costs)for(const s of this.target.costs)n[s.typeId]=s;if(this.costs)for(const s of this.costs)n[s.typeId]=s;return Object.values(n)}}et.prototype.keyInfoCache={};class eo extends et{getTypeName(){var t;return(t=this.target)==null?void 0:t.typeName}}class Bs extends et{constructor(){super(...arguments);b(this,"primary");b(this,"main_catalogue")}get units(){return this.target.units}*selectionsIterator(){yield*this.target.units}isEmpty(){return this.target.isEmpty()}}const Oe="(No Category)",kn="(Illegal Units)";class pt extends R{constructor(){super(...arguments);b(this,"units");b(this,"main_catalogue")}isCategory(){return!0}*selectionsIterator(){yield*this.units}isEmpty(){return!this.units.length}isIdUnique(){return!this.isEmptyNode()}}class In extends R{constructor(){super(...arguments);b(this,"categories");b(this,"forces");b(this,"main_catalogue")}isForce(){return!0}isEntry(){return!0}isIdUnique(){return!0}*selectionsIterator(){yield*this.categories,this.forces&&(yield*this.forces)}*rulesIterator(){var n;for(const r of It(this))r.rules&&(yield*r.rules),r.infoLinks&&(yield*(n=r.infoLinks)==null?void 0:n.filter(s=>s.type==="rule").map(s=>s.target));this.main_catalogue&&(yield*this.main_catalogue.rulesIterator())}generateForces(n){const r=[];for(const s of this.forceEntries||[]){const i=xe(s);i.main_catalogue=this.main_catalogue;const o=[];for(const c of s.categoryLinks||[])c.targetId in n&&o.push(n[c.targetId]);i.categories=o,this.main_catalogue.index[i.id]=i,r.push(i)}return this.forces=r,r}isEmpty(){for(const n of this.categories)if(!n.isEmpty())return!1;return!0}*forcesIterator(){this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const n of this.forces)yield n,yield*n.forcesIteratorRecursive()}}const xn=1/0;function to(e,t){var s,i,o,c;const n=[];function r(a){n.push(a)}for(const a of e){const l=n.length;if(a.field!=="selections"||a.type!=="max")continue;if(a.value>1){r(a.value);continue}let u=a.value;for(const f of tn(t))for(const d of f.modifiers||[])if(d.field===a.id){if(d.type==="increment"){if((s=f.repeats)!=null&&s.length||(i=d.repeats)!=null&&i.length){r(xn);continue}if(u+=d.value,u>1){r(u);continue}}if(d.type==="decrement"&&d.value<0){if((o=f.repeats)!=null&&o.length||(c=d.repeats)!=null&&c.length){r(xn);continue}if(u-=d.value,u>1){r(u);continue}}if(d.type==="set"&&d.value>1){if(d.value===-1){r(xn);continue}r(d.value)}}l===n.length&&r(u)}return n}class no extends R{}class gt extends R{isProfile(){return!0}getTypeName(){return this.typeName}isIdUnique(){return!0}}class Hr extends R{constructor(){super(...arguments);b(this,"originalValue")}getLabel(){var n;return this.catalogue?((n=this.catalogue.findOptionById(this.typeId))==null?void 0:n.getName())??this.typeId:this.typeId}getTypeName(){return this.getLabel()}getName(){return`${this.getLabel()} = ${this.$text}`}}class Sn extends R{isInfoGroup(){return!0}isIdUnique(){return!0}}const Xr=new Set(["any","model","unit","upgrade","mount","crew"]);class Ke extends R{}class Kn extends Ke{}class Er extends R{}class Fs extends R{}class qt extends R{getDescription(){return Array.isArray(this.description)?this.description.join(`
`):this.description}isRule(){return!0}isIdUnique(){return!0}}function*It(e){yield e;for(const t of e.infoGroups||[])yield*It(t);for(const t of e.infoLinks||[])t.type==="infoGroup"&&(yield*It(t.target))}function*tn(e){if(e)for(const t of e)yield t,yield*tn(t.modifierGroups)}const ro=["costTypes","costs","categoryEntries","forceEntries","sharedSelectionEntries","selectionEntries","sharedSelectionEntryGroups","selectionEntryGroups","entryLinks","infoLinks","categoryLinks","catalogueLinks","sharedProfiles","profiles","profileTypes","characteristics","characteristicTypes","sharedInfoGroups","infoGroups","sharedRules","rules","publications","associations","modifierGroups","modifiers","constraints","conditionGroups","conditions","repeats"],Ks=new Set(ro),st=new Set([...Ks,"defaultAmount","id","import","importRootEntries","name","hidden","field","scope","value","percentValue","shared","includeChildSelections","includeChildForces","childId","type","targetId","primary","typeId","collective","$text","page","typeName","defaultSelectionEntryId","revision","battleScribeVersion","authorName","authorContact","authorUrl","library","gameSystemId","gameSystemRevision","xmlns","readme","description","comment","publicationDate","publisher","publisherId","publisherUrl","shortName","repeats","roundUp","defaultCostLimit","publicationId","label","labelMembers","maxAssociationsPerMember","ids","min","max","of","flatten","collapsible","sortIndex","subType","arg","costTypeId","profileTypeId","characteristicTypeId","value"]);function Mn(e,t=!1){const n={catalogue:void 0,gameSystem:void 0},r={...e};e.gameSystemId?(n.catalogue=r,n.catalogue.type="catalogue",delete n.gameSystem):(n.gameSystem=r,n.gameSystem.type="gameSystem",delete n.catalogue);const s=t?ye(n):n;return JSON.stringify(s,(o,c)=>{if(!(Array.isArray(c)&&c.length===0)&&(c===r||st.has(o)||isFinite(Number(o))))return ee(c)?Hi(Xi(c)):c})}function jt(e,t){return JSON.stringify(e,function(r,s){if(!(Array.isArray(s)&&s.length===0)&&(st.has(r)||isFinite(Number(r))||t!=null&&t.has(r)))return s})}function so(e,t,n){const r=(n==null?void 0:n.forceArray)===!1;return e=Array.isArray(e)&&(e==null?void 0:e.length)===1&&r?e[0]:e,JSON.stringify(e,function(i,o){if(st.has(i)||isFinite(Number(i))||t!=null&&t.has(i))return o},(n==null?void 0:n.formatted)===!0?2:void 0)}function Wt(e,t,n=_r){for(const r in e)if(n.has(r)){const s=e[r];if(Array.isArray(s)&&s.length&&ee(s[0]))for(let i=0;i<s.length;i++){const o=s[i];t(o,e),Wt(o,t,n)}}}const kr=new Set(["force","roster","self","parent","ancestor","primary-category","force","roster","primary-catalogue"]),io=new Set(["any","unit","model","upgrade","mount","crew"]);function oo(e,t){if(kr.has(t))return!0;const r=e.catalogue.findOptionById(t);if(r&&(r.isForce()||r.isCategory()||r.isCatalogue()))return!0;const s=[e];for(;s.length;){const i=s.pop();if(i.id===t)return!0;i.parent&&s.push(i.parent)}return!1}function Xe(e){return Fi(e,n=>!(n instanceof Er||n instanceof Ke||n instanceof Fs))}function ao(e,t){if(!e||!t)return;const n=e.getCatalogue();if(e.parent){const s=Xe(e);if(s){for(const i of s.constraintsIterator())if(i.id===t)return i}}return n==null?void 0:n.findOptionById(t)}function $e(e,t){if(t===void 0)return"";if(e){if(`${t}`.startsWith("limit::"))return`limit::${$e(e,Bn(`${t}`,"limit::"))}`;const n=e.catalogue||e,r=ao(e,t);if(r){const i=r.type;if(i&&["min","max","exactly"].includes(i))return co(e,r);if(r.name)return r.isCategory&&r.isCategory()?`${r.name}`:r.url?`${r.name}`:r.name}const s=n.manager;if(s){const i=n.manager.findOptionById(t)||s.getCatalogueInfo({targetId:t});return(i==null?void 0:i.name)||t}}return t}function Yr(e,t,n=!1,r=$e){const s=t.type||"none",i=t.value===void 0?1:t.percentValue?`${t.value}%`:t.value,o=r(e,t.field),c=["selections","forces"].includes(o)?` ${o}`:` ${r(e,o)}`,a=r(e,t.childId||"")+(n?`(${t.childId||"any"})`:""),l=a&&c?"of ":"",u=r(e,t.scope),f=u===(e==null?void 0:e.getName())?"":`${u}`,d=t.includeChildSelections?" (recursive)":"",h=f?` in ${f}${d}`:"";switch(s){case"instanceOf":return`${f} is ${a}`;case"notInstanceOf":return`${f} is not ${a}`;case"atLeast":return`${i}+${c} ${l}${a}${h}`;case"greaterThan":return`${Number(i)+1}+${c} ${l}${a}${h}`;case"atMost":return`${i}${i===0?"":"-"}${c} ${l}${a}${h}`;case"lessThan":return`${Number(i)-1}${Number(i)-1===0?"":"-"}${c} ${l}${a}${h}`;case"equalTo":return`${i}${c} ${l}${a}${h}`;case"notEqualTo":return`not ${i}${c} ${l}${a}${h}`;case"none":return`${c} ${l}${a}${h}`;default:return`${s} ${i}${c} ${l}${a}${h}`}}function co(e,t,n=$e){if(!Ki(e.constraintsIterator(),t))return t.id;const r=t.field==="selections"?"":` ${n(e,t.field)}`,s=t.scope==="parent"?"":`(${n(e,t.scope)})`,i=t.childId?` ${n(e,t.childId)}`:"";return`${t.type}${r}${i}${s}`}function lo(e,t,n=$e){var r;return`${t.type} ${n(e,t.field)} ${n(e,(r=t.value)==null?void 0:r.toString())}`}typeof $toRaw>"u"&&(globalThis.$toRaw=function(e){return e});class Ir extends R{constructor(){super(...arguments);b(this,"targetId");b(this,"importRootEntries")}isLink(){return!1}}class Qr extends R{constructor(){super(...arguments);b(this,"shortName");b(this,"publisher");b(this,"publicationDate");b(this,"publisherUrl")}}class nn extends R{constructor(){super(...arguments);b(this,"library");b(this,"revision");b(this,"gameSystemId");b(this,"gameSystemRevision");b(this,"authorContact");b(this,"authorName");b(this,"authorUrl");b(this,"battleScribeVersion");b(this,"costTypes");b(this,"catalogueLinks");b(this,"gameSystem");b(this,"initialized");b(this,"loaded_wiki");b(this,"loaded_editor");b(this,"imports");b(this,"importsWithEntries");b(this,"index");b(this,"unresolvedLinks",{});b(this,"forces");b(this,"categories");b(this,"units");b(this,"roster_constraints");b(this,"manager");b(this,"book");b(this,"short");b(this,"version");b(this,"nrversion");b(this,"lastUpdated");b(this,"costIndex");b(this,"fullFilePath");b(this,"errors")}reset(){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.loaded_wiki;for(const n of this.imports||[])delete n.initialized,delete n.loaded,delete n.loaded_editor,delete n.loaded_wiki}init(n=!0){this.initialized||(this.initialized=!0,this.generateImports(n),this.resolveAllLinks(n),this.generateCostIndex())}process(){if(this.loaded)return;this.loaded=!0,this.init();const n=this.generateUnits(),r=this.generateCategories(n);this.categories=Object.values(r),this.generateForces(r),this.generateExtraConstraints()}processForWiki(n){if(this.loaded_wiki)return;this.loaded_wiki=!0,this.process();const r=n.rules||{};n.rules=r,this.imports.forEach(i=>{qe(i,"links",this)});function s(i,o){i.parent=o,i.target&&qe(i.target,"links",o),i instanceof qt&&(r[i.id]=i)}Wt(this,s,Zi);for(const i of this.forces||[]){i.parent=this;for(const o of i.categories)o.parent=i}}processForEditor(){this.loaded_editor||(this.loaded_editor=!0,this.init(!1),this.gameSystem&&qe(this.gameSystem,"links",this),Wt(this,(n,r)=>{if(n.parent=r,n.catalogue=this,n.links||(n.links=[]),n.other_links||(n.other_links=[]),n.target&&qe(n.target,"links",n),n.isProfile()&&!n.isLink()){const i=this.findOptionById(n.typeId);i&&qe(i,"links",n)}const s=n.value;if(s){const i=this.findOptionById(s);i&&qe(i,"other_links",n)}this.refreshErrors(n)},Ks))}get url(){return"%{book}"}isCatalogue(){return!0}isGameSystem(){return this.gameSystemId===this.id||!this.gameSystemId}isIdUnique(){return!0}getCatalogue(){return this}getGameSystem(){return this.isGameSystem()?this:this.gameSystem}getSystemId(){return this.isGameSystem()?this.id:this.gameSystemId}addError(n,r){this.removeError(n,r.id),n.errors||(n.errors=[]),this.errors||(this.errors=[]),n.errors.push(r),this.errors.push(r)}onRemoveError(n,r=!0){var s,i;if(this.errors){const o=this.errors.indexOf(n);o>=0&&this.errors.splice(o,1)}if(n.other&&r){const o=n.other;(s=o.getCatalogue())==null||s.removeError(o,"duplicate-id-1",!1),(i=o.getCatalogue())==null||i.removeError(o,"duplicate-id-2",!1)}}removeErrors(n){var r;(r=n.errors)==null||r.forEach(s=>this.onRemoveError(s)),n instanceof Kn&&n.catalogue.updateConstraint(n,!0),delete n.errors}removeError(n,r,s=!0){var i;(i=n.errors)!=null&&i.length&&(n.errors=n.errors.filter(o=>(o.id===r&&this.onRemoveError(o,s),o.id!==r)))}*iterateCategoryEntries(){for(const n of this.imports)for(const r of n.categoryEntries||[])yield r;this.categoryEntries&&(yield*this.categoryEntries)}*iterateCostTypes(){for(const n of this.imports)for(const r of n.costTypes||[])yield r;this.costTypes&&(yield*this.costTypes)}*forcesIterator(){for(const n of this.imports)for(const r of n.forceEntries||[])yield r;this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const n of this.forces)yield n,yield*n.forcesIteratorRecursive()}*iterateProfileTypes(){for(const n of this.imports)n.profileTypes&&(yield*n.profileTypes);this.profileTypes&&(yield*this.profileTypes)}*iteratePublications(){for(const n of this.imports)for(const r of n.publications||[])yield r;for(const n of this.publications||[])yield n}*iterateSelectionEntries(){for(const n of this.importsWithEntries){for(const r of n.sharedSelectionEntries||[])yield r;for(const r of n.sharedSelectionEntryGroups||[])yield r}this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllImported(){const n=["sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","categoryEntries"],r=["rules","entryLinks","profiles","infoGroups","selectionEntries","selectionEntryGroups"];for(const s of this.importsWithEntries)for(const i of r)for(const o of s[i]||[])o.import!==!1&&(yield o);for(const s of this.imports)for(const i of n)for(const o of s[i]||[])yield o;for(const s of r)for(const i of this[s]||[])yield i;for(const s of n)for(const i of this[s]||[])yield i}*iterateSelectionEntriesWithRoot(){for(const n of this.importsWithEntries){for(const r of n.selectionEntries||[])r.import!==!1&&(yield r);for(const r of n.entryLinks||[])r.import!==!1&&(yield r);for(const r of n.sharedSelectionEntries||[])yield r;for(const r of n.sharedSelectionEntryGroups||[])yield r}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllRootEntries(){for(const n of this.importsWithEntries){for(const r of n.selectionEntries||[])r.import!==!1&&(yield r);for(const r of n.entryLinks||[])r.import!==!1&&(yield r)}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.selectionEntries&&(yield*this.selectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}forEachNode(n){if(n(this),this.childs)for(const r of this.childs)r.forEachNode(n)}*selectionsIterator(){yield*this.forces}findOptionById(n){var i;const r=this.index[n];if(r)return r;const s=(i=this.imports.find(o=>n in o.index))==null?void 0:i.index[n];if(s)return s;if(this.manager&&n)return this.manager.getLoadedCatalogue(n)??this.manager.getCatalogueInfo({targetId:n})}findOptionByIdGlobal(n){var i;const r=this.index[n];if(r)return r;const s=(i=this.imports.find(o=>n in o.index))==null?void 0:i.index[n];if(s)return s;if(this.manager){const o=this.manager.findOptionById(n);return o||this.manager.getCatalogueInfo({targetId:n})}}findOptionsById(n){const r=[];for(const s of[this,...this.imports])for(const i of Object.values(s.index))i.id&&i.id===n&&r.push(i);return r}findOptionsByText(n){var i,o,c;if(!n||!n.trim()){const a=[];for(const l of[this,...this.imports])for(const u of Object.values(l.index))if(u.getName){if(u.isLink()&&u.target&&u.isCategory()&&!((i=u.parent)!=null&&i.isForce()))continue;a.push(u)}else console.log(u);return a}const r=[],s=Fn(n);for(const a of[this,...this.imports])for(const l of Object.values(a.index)){const u=(o=l.getName)==null?void 0:o.call(l),f=l.id;if(u&&String(u).match(s)||f===n){if(l.isLink()&&l.target&&l.isCategory()&&!((c=l.parent)!=null&&c.isForce()))continue;r.push(l)}}return r}generateNonConflictingId(n){if(n&&this.findOptionByIdGlobal(n)===void 0)return n;for(;;){const r=X();if(this.findOptionById(r)===void 0)return r}}generateCostIndex(){const n={};for(const r of this.imports)for(const s of r.costTypes||[])n[s.id]=s,this.index[s.id]=s;for(const r of this.costTypes||[])n[r.id]=r,this.index[r.id]=r;return this.costIndex=n,n}generateImports(n=!0){const r={},s={};this.gameSystem&&(this.gameSystem.init(n),r[this.gameSystem.id]=this.gameSystem,s[this.gameSystem.id]=this.gameSystem,this.gameSystem.import||(this.gameSystem.imports=[]));for(const i of this.catalogueLinks||[]){const o=i.target;if(o){o.init(n);for(const c of o.imports)s[c.id]=c;for(const c of o.importsWithEntries)r[c.id]=c;i.importRootEntries&&(r[o.id]=o),s[o.id]=o}}return this.imports=Object.values(s),this.importsWithEntries=Object.values(r),this.imports}generateForces(n){var s,i;const r=[];for(const o of this.forcesIterator()){const c=xe(o);c.main_catalogue=this;const a=[];(i=(s=n[Oe])==null?void 0:s.units)!=null&&i.length&&a.push(n[Oe]);const l=new Set;for(const f of o.categoryLinks||[])if(f.targetId in n){const d=xe(f);d.main_catalogue=this;const h=n[d.targetId];d.target=h,d.childs=h.childs;for(const y of d.childs)l.add(y.id);a.push(d)}for(const f of o.categoryEntries||[])if(f.id in n){const d=n[f.id],h=xe(d);h.main_catalogue=this;for(const y of h.childs)l.add(y.id);a.push(h)}const u=this.units.filter(f=>!l.has(f.id));if(u.length){const f=xe(n[kn]);f.childs=u,f.units=u,a.push(f)}c.childs=a,c.categories=a,this.index[c.id]=c,c.forceEntries&&c.generateForces(n),r.push(c)}return this.forces=r,this.childs=r,r}generateCategories(n){const r={},s=new Set;for(const a of this.iterateCategoryEntries()){const l=xe(a);l.main_catalogue=this;const u=n[l.id]||[];l.units=u,l.childs=u,this.index[a.id]=a,r[l.id]=l,s.add(l.id)}for(const a in n)if(!s.has(a)){const l=this.findOptionById(a);if(l){const u=xe(l);u.main_catalogue=this;const f=n[u.id]||[];u.units=f,u.childs=f,this.index[l.id]=l,r[u.id]=u}}const i=n[Oe]||[],o={name:"Uncategorized",id:Oe,hidden:!1,units:i,childs:i,catalogue:this};r[Oe]=Object.setPrototypeOf(o,pt.prototype);const c={name:"Illegal Units",id:kn,hidden:!0,units:[],childs:[],catalogue:this};return r[kn]=Object.setPrototypeOf(c,pt.prototype),r}generateUnits(){const n=[];for(const i of this.importsWithEntries){const o=i.isGameSystem();for(const c of i.selectionEntries||[])(o||c.import!==!1)&&n.push(c);for(const c of i.entryLinks||[])(o||c.import!==!1)&&n.push(c)}for(const i of this.selectionEntries||[])n.push(i);for(const i of this.entryLinks||[])n.push(i);const r=Mi(n,i=>i.getName());return this.units=r,Ui(r,i=>i.getPrimaryCategory())}generateExtraConstraints(){const n={},r=[],s={},i=new Set,o={};function c(a,l,u){const f=l.target||l;for(const d of u){const h=`${d.id}::${l.id}`;switch(d.scope){case"parent":break;case"roster":n[h]=l.getBoundConstraint(d);break;case"force":r.push(l.getBoundConstraint(d));break;case"primary-category":case"primary-catalogue":break;default:if(i.has(d.scope)){Je(s,d.scope,f.getBoundConstraint(d));break}const y=a.index[d.scope];if(y){const p=y.extra_constraints||[];p.push(l.getBoundConstraint(d)),y.extra_constraints=p;break}break}}}for(const a of this.forcesIteratorRecursive())i.add(a.id);for(const a of this.categories)i.add(a.id);for(const a of this.categories){c(this,a,a.constraintsIterator());const l={};a.forEachNodeCb(u=>{var f;if(u&&!u.isForce()&&(!u.isGroup()&&!u.extra_constraints&&(u.extra_constraints=u.getChildBoundConstraints(!0)),!(u.isCategory()&&u.isLink())&&!(!u.constraints&&!((f=u.target)!=null&&f.constraints)))){for(const d of u.constraintsIterator())if(d.type==="min"||d.type==="exactly"){const h=`${d.id}::${u.id}`;switch(d.scope){case"parent":break;case"roster":n[h]=u.getBoundConstraint(d);break;case"force":l[h]=u.getBoundConstraint(d);break;case"primary-category":case"primary-catalogue":break;default:if(i.has(d.scope)){Je(s,d.scope,u.getBoundConstraint(d));break}const y=this.index[d.scope];if(y){const p=y.extra_constraints||[];p.push(u.getBoundConstraint(d)),y.extra_constraints=p;break}break}}}}),o[a.getId()]=Object.values(l)}for(const a of this.forcesIteratorRecursive()){const l=a.extra_constraints||[];l.push(...r),a.id in s&&l.push(...s[a.id]),l.length&&(a.extra_constraints=l);for(const u of a.categories)u.getId()in o&&l.push(...o[u.getId()]);l.length&&(a.extra_constraints=l)}for(const a of this.categories){const l=a.extra_constraints||[];a.id in s&&l.push(...s[a.id]),l.length&&(a.extra_constraints=l)}this.roster_constraints=Object.values(n)}async reload(n=this.manager){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.index;const r=this.isGameSystem()?"gameSystem":"catalogue",s=await n.loadData({[r]:this});return this.processForEditor(),s}refreshErrors(n,r=!1){var s,i;n.isLink()?n.target?(this.removeError(n,"no-target"),vn(this.unresolvedLinks,n.targetId,$toRaw(n)),vn(this.manager.unresolvedLinks,n.targetId,$toRaw(n))):(this.addError(n,{source:n,severity:"error",msg:`(${n.editorTypeName}) ${n.name} has no target`,id:"no-target"}),!((s=this.unresolvedLinks[n.targetId])!=null&&s.includes($toRaw(n)))&&!r&&Je(this.unresolvedLinks,n.targetId,$toRaw(n)),(i=this.manager.unresolvedLinks[n.targetId])!=null&&i.includes($toRaw(n))||Je(this.manager.unresolvedLinks,n.targetId,$toRaw(n))):n.isProfile()?n.typeId?this.removeError(n,"no-profile-type"):this.addError(n,{source:n,severity:"error",msg:"Profile has no type",id:"no-profile-type"}):n instanceof Ke&&this.updateCondition(n)}addToIndex(n){var r,s,i,o,c,a;if(n.id){if(n.catalogue=this,(s=(r=this.manager)==null?void 0:r.settings)!=null&&s.globalDuplicateIdError){const l=this.manager.index;if(l[n.id]&&l[n.id]!==n&&(n.isIdUnique()||l[n.id].isIdUnique())){const u=l[n.id],f=u.getCatalogue(),d=this!==f;f&&d&&(f.addError(u,{source:u,severity:"error",msg:`Duplicate id ${n.id} ${n.getName()}`,id:"duplicate-id-1",other:n,extra:f.name}),f.addError(n,{source:n,severity:"error",msg:`Duplicate id ${n.id} ${u.getName()}`,id:"duplicate-id-2",other:u,extra:this.name})),this.addError(u,{source:u,severity:"error",msg:`Duplicate id ${n.id}  ${n.getName()}`,id:"duplicate-id-1",other:n,extra:d?f.name:void 0}),this.addError(n,{source:n,severity:"error",msg:`Duplicate id ${n.id} ${u.getName()}`,id:"duplicate-id-2",other:u,extra:d?this.name:void 0})}l[n.id]=n}else if(this.index[n.id]&&this.index[n.id]!==n){const l=this.index[n.id];(n.isIdUnique()||l.isIdUnique()||n.getName()!==l.getName())&&(this.addError(l,{source:l,severity:"error",msg:`Duplicate id ${n.id} ${n.getName()}`,id:"duplicate-id-1",other:n}),this.addError(n,{source:n,severity:"error",msg:`Duplicate id ${n.id} ${l.getName()}`,id:"duplicate-id-2",other:l}))}if(this.index[n.id]=n,this.unresolvedLinks&&this.unresolvedLinks[n.id])for(const l of[...this.unresolvedLinks[n.id]])l.isLink()&&l.catalogue?this.updateLink(l):this.refreshErrors(l);if((i=this.manager)!=null&&i.unresolvedLinks&&((o=this.manager.unresolvedLinks[n.id])!=null&&o.length))for(const l of[...this.manager.unresolvedLinks[n.id]])l.isLink()?(c=l.catalogue)==null||c.updateLink(l):(a=l.catalogue)==null||a.refreshErrors(l)}}removeFromIndex(n){n.id&&$toRaw(this.index[n.id])===$toRaw(n)&&delete this.index[n.id],this.removeErrors(n);for(const r of n.links||[])delete r.target,r.catalogue.refreshErrors(r);for(const r of n.other_links||[])r.catalogue.refreshErrors(r,!0)}getIndexes(){const n=[];n.push(this.index);for(const r of this.imports)n.push(r.index);return n}resolveAllLinks(n=!0){const r=[],s=[],i=[];this.index=go(),Wt(this,(a,l)=>{this.addToIndex(a),a.publicationId&&(delete a.publication,s.push(a)),a.isLink()&&(delete a.target,r.push(a),i.push(l)),ho(a)},_r);const o=this.getIndexes(),c=uo(r,o,i,n);if(fo(s,o),!n){this.unresolvedLinks={};for(const a of c)Je(this.unresolvedLinks,a.targetId,$toRaw(a)),delete a.target}}removeRef(n,r){r.links||(r.links=[]);const s=r.links.indexOf(n);s>=0&&r.links.splice(s,1)}addRef(n,r){r.links||(r.links=[]),r.links.indexOf(n)===-1&&r.links.push(n)}hasOtherRef(n,r){return r.other_links&&r.other_links.includes(n)}removeOtherRef(n,r){r.other_links||(r.other_links=[]);const s=r.other_links.indexOf(n);s>=0&&r.other_links.splice(s,1)}addOtherRef(n,r){r.other_links||(r.other_links=[]),r.other_links.indexOf(n)===-1&&r.other_links.push(n)}updateLink(n){n.target&&this.removeRef(n,n.target);const r=Ms(n.targetId,this.getIndexes());if(r!=null&&r.isLink()){console.warn(`Failed to resolve link (target is a link): ${n.getName()}(${n.id})`),n.catalogue.addError(n,{id:"bad-link-target",msg:"Link target Cannot be a Link",source:n});return}else{if(n.catalogue.removeError(n,"bad-link-target"),n.target=r,n.target){this.addRef(n,n.target);const s=n.target.editorTypeName;s=="category"?delete n.type:n.type=s}return this.refreshErrors(n),n.target!==void 0}}updateConstraint(n,r=!1){var o,c,a,l;const s=new Set,i=new Set;for(const u of((o=n.parent)==null?void 0:o.constraintsIterator())||[])r&&n===u||(s.has(u.id)?i.add(u.id):s.add(u.id));for(const u of((c=n.parent)==null?void 0:c.constraintsIterator())||[])r&&n===u||(i.has(u.id)?(a=u.catalogue)==null||a.addError(u,{id:"duplicate-constraint-id",msg:"Duplicate constraints id",source:n}):(l=u.catalogue)==null||l.removeError(u,"duplicate-constraint-id"))}updateCondition(n,r){if(n.scope){const i=Xe(n);if(i&&!oo(i,n.scope)?this.addError(n,{source:n,id:"invalid-scope",msg:`Invalid scope ${n.scope}`}):this.removeError(n,"invalid-scope"),n.scope&&!kr.has(n.scope)){const o=this.findOptionById(n.scope);o&&o.getCatalogue().addOtherRef(n,o)}}if(n instanceof Kn)return this.updateConstraint(n);const s=["instanceOf","notInstanceOf"].includes(n.type);if(r&&!Xr.has(r)){const i=s?this.findOptionByIdGlobal(r):this.findOptionById(r);i&&this.removeOtherRef(n,i)}if(n.childId){if(Xr.has(n.childId)){this.removeError(n,"id-not-exist");return}const i=s?this.findOptionByIdGlobal(n.childId):this.findOptionById(n.childId);if(i){this.hasOtherRef(n,i)||this.addOtherRef(n,i),this.removeError(n,"id-not-exist"),vn(this.manager.unresolvedLinks,n.childId,$toRaw(n));return}}this.addError(n,{source:n,severity:"warning",msg:"child id does not exist",id:"id-not-exist"}),zi(this.manager.unresolvedLinks,n.childId,$toRaw(n))}unlinkLink(n){n.target&&this.removeRef(n,n.target)}}function Ms(e,t){for(const n of t)if(e in n)return n[e]}function uo(e=[],t,n,r=!0){e.length;let s=0;for(;e.length!==s;){const i=e,o=n;s=i.length,e=[],n=[];for(let c=0;c<i.length;c++){const a=i[c],l=o[c],u=a.targetId,f=Ms(u,t);if(f){f.isLink()?console.warn(`Failed to resolve link (target is a link): ${a.getName()}(${a.id})`):a.target=f;continue}e.push(a),n.push(l)}}if(e.length&&r)for(let i=0;i<e.length;i++){const o=e[i],c=n[i];for(const[a,l]of Object.entries(c))if(l===o&&delete c[a],Array.isArray(l))for(const u in l)l[u]===o&&l.splice(u,1)}return e}function fo(e=[],t){for(const n of e)for(const r of t)if(n.publicationId in r){n.publication=r[n.publicationId];break}}function ho(e){return e.shared!==!1&&e.childId!==void 0}let po=class{get[Symbol.toStringTag](){return"ObjectNoObserve"}};function go(){return new po}function Us(e){return e.arrayBuffer?e.arrayBuffer():new Promise((t,n)=>{const r=new FileReader;r.addEventListener("loadend",()=>{t(r.result)}),r.addEventListener("error",n),r.readAsArrayBuffer(e)})}async function yo(e){const t=await Us(e);return new Uint8Array(t)}function zs(e){return typeof Blob<"u"&&e instanceof Blob}function xt(e){return typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer}const mo=typeof process<"u"&&process.versions&&typeof process.versions.node<"u"&&typeof process.versions.electron>"u";function vo(e){return e.byteOffset===0&&e.byteLength===e.buffer.byteLength}class Zr{constructor(t){this.typedArray=t instanceof ArrayBuffer||xt(t)?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}async getLength(){return this.typedArray.byteLength}async read(t,n){return new Uint8Array(this.typedArray.buffer,this.typedArray.byteOffset+t,n)}}class es{constructor(t){this.blob=t}async getLength(){return this.blob.size}async read(t,n){const r=this.blob.slice(t,t+n),s=await Us(r);return new Uint8Array(s)}async sliceAsBlob(t,n,r=""){return this.blob.slice(t,t+n,r)}}function bo(e,t){var n=Uint8Array;if(e[0]==3&&e[1]==0)return t||new n(0);var r=_o,s=qs,i=wo,o=js,c=t==null;c&&(t=new n(e.length>>>2<<3));for(var a=0,l=0,u=0,f=0,d=0,h=0,y=0,p=0,g=0,m,v;a==0;){if(a=r(e,g,1),l=r(e,g+1,2),g+=3,l==0){g&7&&(g+=8-(g&7));var w=(g>>>3)+4,k=e[w-4]|e[w-3]<<8;c&&(t=Cn(t,p+k)),t.set(new n(e.buffer,e.byteOffset+w,k),p),g=w+k<<3,p+=k;continue}if(c&&(t=Cn(t,p+(1<<17))),l==1&&(m=N.flmap,v=N.fdmap,h=512-1,y=32-1),l==2){u=s(e,g,5)+257,f=s(e,g+5,5)+1,d=s(e,g+10,4)+4,g+=14;for(var _=0;_<38;_+=2)N.itree[_]=0,N.itree[_+1]=0;for(var E=1,_=0;_<d;_++){var I=s(e,g+_*3,3);N.itree[(N.ordr[_]<<1)+1]=I,I>E&&(E=I)}g+=3*d,yt(N.itree,E),mt(N.itree,E,N.imap),m=N.lmap,v=N.dmap,g=i(N.imap,(1<<E)-1,u+f,e,g,N.ttree);var A=ts(N.ttree,0,u,N.ltree);h=(1<<A)-1;var S=ts(N.ttree,u,f,N.dtree);y=(1<<S)-1,yt(N.ltree,A),mt(N.ltree,A,m),yt(N.dtree,S),mt(N.dtree,S,v)}for(;;){var P=m[o(e,g)&h];g+=P&15;var T=P>>>4;if(!(T>>>8))t[p++]=T;else{if(T==256)break;var U=p+T-254;if(T>264){var F=N.ldef[T-257];U=p+(F>>>3)+s(e,g,F&7),g+=F&7}var $=v[o(e,g)&y];g+=$&15;var de=$>>>4,ne=N.ddef[de],z=(ne>>>4)+r(e,g,ne&15);for(g+=ne&15,c&&(t=Cn(t,p+(1<<17)));p<U;)t[p]=t[p++-z],t[p]=t[p++-z],t[p]=t[p++-z],t[p]=t[p++-z];p=U}}}return t.length==p?t:t.slice(0,p)}function Cn(e,t){var n=e.length;if(t<=n)return e;var r=new Uint8Array(Math.max(n<<1,t));return r.set(e,0),r}function wo(e,t,n,r,s,i){for(var o=qs,c=js,a=0;a<n;){var l=e[c(r,s)&t];s+=l&15;var u=l>>>4;if(u<=15)i[a]=u,a++;else{var f=0,d=0;u==16?(d=3+o(r,s,2),s+=2,f=i[a-1]):u==17?(d=3+o(r,s,3),s+=3):u==18&&(d=11+o(r,s,7),s+=7);for(var h=a+d;a<h;)i[a]=f,a++}}return s}function ts(e,t,n,r){for(var s=0,i=0,o=r.length>>>1;i<n;){var c=e[i+t];r[i<<1]=0,r[(i<<1)+1]=c,c>s&&(s=c),i++}for(;i<o;)r[i<<1]=0,r[(i<<1)+1]=0,i++;return s}function yt(e,t){for(var n=e.length,r,s,i,o,c,a=N.bl_count,o=0;o<=t;o++)a[o]=0;for(o=1;o<n;o+=2)a[e[o]]++;var l=N.next_code;for(r=0,a[0]=0,s=1;s<=t;s++)r=r+a[s-1]<<1,l[s]=r;for(i=0;i<n;i+=2)c=e[i+1],c!=0&&(e[i]=l[c],l[c]++)}function mt(e,t,n){for(var r=e.length,s=N.rev15,i=0;i<r;i+=2)if(e[i+1]!=0)for(var o=i>>1,c=e[i+1],a=o<<4|c,l=t-c,u=e[i]<<l,f=u+(1<<l);u!=f;){var d=s[u]>>>15-t;n[d]=a,u++}}function ns(e,t){for(var n=N.rev15,r=15-t,s=0;s<e.length;s+=2){var i=e[s]<<t-e[s+1];e[s]=n[i]>>>r}}function qs(e,t,n){return(e[t>>>3]|e[(t>>>3)+1]<<8)>>>(t&7)&(1<<n)-1}function _o(e,t,n){return(e[t>>>3]|e[(t>>>3)+1]<<8|e[(t>>>3)+2]<<16)>>>(t&7)&(1<<n)-1}function js(e,t){return(e[t>>>3]|e[(t>>>3)+1]<<8|e[(t>>>3)+2]<<16)>>>(t&7)}const N=function(){var e=Uint16Array,t=Uint32Array;return{next_code:new e(16),bl_count:new e(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new e(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new t(32),flmap:new e(512),fltree:[],fdmap:new e(32),fdtree:[],lmap:new e(32768),ltree:[],ttree:[],dmap:new e(32768),dtree:[],imap:new e(512),itree:[],rev15:new e(32768),lhst:new t(286),dhst:new t(30),ihst:new t(19),lits:new t(15e3),strt:new e(65536),prev:new e(32768)}}();(function(){for(var e=32768,t=0;t<e;t++){var n=t;n=(n&2863311530)>>>1|(n&1431655765)<<1,n=(n&3435973836)>>>2|(n&858993459)<<2,n=(n&4042322160)>>>4|(n&252645135)<<4,n=(n&4278255360)>>>8|(n&16711935)<<8,N.rev15[t]=(n>>>16|n<<16)>>>17}function r(s,i,o){for(;i--!=0;)s.push(0,o)}for(var t=0;t<32;t++)N.ldef[t]=N.of0[t]<<3|N.exb[t],N.ddef[t]=N.df0[t]<<4|N.dxb[t];r(N.fltree,144,8),r(N.fltree,255-143,9),r(N.fltree,279-255,7),r(N.fltree,287-279,8),yt(N.fltree,9),mt(N.fltree,9,N.flmap),ns(N.fltree,9),r(N.fdtree,32,5),yt(N.fdtree,5),mt(N.fdtree,5,N.fdmap),ns(N.fdtree,5),r(N.itree,19,0),r(N.ltree,286,0),r(N.dtree,30,0),r(N.ttree,320,0)})();const rs={table:function(){for(var e=new Uint32Array(256),t=0;t<256;t++){for(var n=t,r=0;r<8;r++)n&1?n=3988292384^n>>>1:n=n>>>1;e[t]=n}return e}(),update:function(e,t,n,r){for(var s=0;s<r;s++)e=rs.table[(e^t[n+s])&255]^e>>>8;return e},crc:function(e,t,n){return rs.update(4294967295,e,t,n)^4294967295}};function Eo(e,t){return bo(e,t)}const ss={numWorkers:1,workerURL:"",useWorkers:!1};let ko=0;const Vt=[];function Nn(e){return new Promise((t,n)=>{const r=new Worker(e);r.onmessage=s=>{s.data==="start"?(r.onerror=void 0,r.onmessage=void 0,t(r)):n(new Error(`unexpected message: ${s.data}`))},r.onerror=n})}function Io(e,t){return e.require?e.require(t):{}}(function(){if(mo){const{Worker:e}=Io(module,"worker_threads");return{async createWorker(t){return new e(t)},addEventListener(t,n){t.on("message",r=>{n({target:t,data:r})})},async terminate(t){await t.terminate()}}}else return{async createWorker(e){try{return await Nn(e)}catch{console.warn("could not load worker:",e)}let t;try{const n=await fetch(e,{mode:"cors"});if(!n.ok)throw new Error(`could not load: ${e}`);t=await n.text(),e=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));const r=await Nn(e);return ss.workerURL=e,r}catch{console.warn("could not load worker via fetch:",e)}if(t!==void 0)try{e=`data:application/javascript;base64,${btoa(t)}`;const n=await Nn(e);return ss.workerURL=e,n}catch{console.warn("could not load worker via dataURI")}throw console.warn("workers will not be used"),new Error("can not start workers")},addEventListener(e,t){e.addEventListener("message",t)},async terminate(e){e.terminate()}}})();function xo(e,t,n,r){const s=new Uint8Array(t);Eo(e,s),r(n?new Blob([s],{type:n}):s.buffer)}async function So(){if(Vt.length!==0)for(;Vt.length;){const{src:e,uncompressedSize:t,type:n,resolve:r}=Vt.shift();let s=e;zs(e)&&(s=await yo(e)),xo(s,t,n,r)}}function Ws(e,t,n){return new Promise((r,s)=>{Vt.push({src:e,uncompressedSize:t,type:n,resolve:r,reject:s,id:ko++}),So()})}function Co(e,t){const n=e&31,r=(e>>5&15)-1,s=(e>>9&127)+1980,i=0,o=(t&31)*2,c=t>>5&63,a=t>>11&31;return new Date(s,r,n,a,c,o,i)}class No{constructor(t,n){this._reader=t,this._rawEntry=n,this.name=n.name,this.nameBytes=n.nameBytes,this.size=n.uncompressedSize,this.compressedSize=n.compressedSize,this.comment=n.comment,this.commentBytes=n.commentBytes,this.compressionMethod=n.compressionMethod,this.lastModDate=Co(n.lastModFileDate,n.lastModFileTime),this.isDirectory=n.uncompressedSize===0&&n.name.endsWith("/"),this.encrypted=!!(n.generalPurposeBitFlag&1),this.externalFileAttributes=n.externalFileAttributes,this.versionMadeBy=n.versionMadeBy}async blob(t="application/octet-stream"){return await Ko(this._reader,this._rawEntry,t)}async arrayBuffer(){return await Fo(this._reader,this._rawEntry)}async text(){const t=await this.arrayBuffer();return vt(new Uint8Array(t))}async json(){const t=await this.text();return JSON.parse(t)}}const On=22,Oo=65535,Ao=101010256,To=101075792;async function tt(e,t,n){return await e.read(t,n)}async function Un(e,t,n,r){return e.sliceAsBlob?await e.sliceAsBlob(t,n,r):await e.read(t,n)}const Po={unsigned(){return 0}};function j(e,t){return e[t]+e[t+1]*256}function D(e,t){return e[t]+e[t+1]*256+e[t+2]*65536+e[t+3]*16777216}function Te(e,t){return D(e,t)+D(e,t+4)*4294967296}const Lo=new TextDecoder;function vt(e,t){return xt(e.buffer)&&(e=new Uint8Array(e)),Lo.decode(e)}async function $o(e,t){const n=Math.min(On+Oo,t),r=t-n,s=await tt(e,r,n);for(let i=n-On;i>=0;--i){if(D(s,i)!==Ao)continue;const o=new Uint8Array(s.buffer,s.byteOffset+i,s.byteLength-i),c=j(o,4);if(c!==0)throw new Error(`multi-volume zip files are not supported. This is volume: ${c}`);const a=j(o,10),l=D(o,12),u=D(o,16),f=j(o,20),d=o.length-On;if(f!==d)throw new Error(`invalid comment length. expected: ${d}, actual: ${f}`);const h=new Uint8Array(o.buffer,o.byteOffset+22,f),y=vt(h);return a===65535||u===4294967295?await Ro(e,r+i,y,h):await Vs(e,u,l,a,y,h)}throw new Error("could not find end of central directory. maybe not zip file")}const Go=117853008;async function Ro(e,t,n,r){const s=t-20,i=await tt(e,s,20);if(D(i,0)!==Go)throw new Error("invalid zip64 end of central directory locator signature");const o=Te(i,8),c=await tt(e,o,56);if(D(c,0)!==To)throw new Error("invalid zip64 end of central directory record signature");const a=Te(c,32),l=Te(c,40),u=Te(c,48);return Vs(e,u,l,a,n,r)}const Bo=33639248;async function Vs(e,t,n,r,s,i){let o=0;const c=await tt(e,t,n),a=[];for(let u=0;u<r;++u){const f=c.subarray(o,o+46),d=D(f,0);if(d!==Bo)throw new Error(`invalid central directory file header signature: 0x${d.toString(16)}`);const h={versionMadeBy:j(f,4),versionNeededToExtract:j(f,6),generalPurposeBitFlag:j(f,8),compressionMethod:j(f,10),lastModFileTime:j(f,12),lastModFileDate:j(f,14),crc32:D(f,16),compressedSize:D(f,20),uncompressedSize:D(f,24),fileNameLength:j(f,28),extraFieldLength:j(f,30),fileCommentLength:j(f,32),internalFileAttributes:j(f,36),externalFileAttributes:D(f,38),relativeOffsetOfLocalHeader:D(f,42)};if(h.generalPurposeBitFlag&64)throw new Error("strong encryption is not supported");o+=46;const y=c.subarray(o,o+h.fileNameLength+h.extraFieldLength+h.fileCommentLength);h.nameBytes=y.slice(0,h.fileNameLength),h.name=vt(h.nameBytes);const p=h.fileNameLength+h.extraFieldLength,g=y.slice(h.fileNameLength,p);h.extraFields=[];let m=0;for(;m<g.length-3;){const w=j(g,m+0),k=j(g,m+2),_=m+4,E=_+k;if(E>g.length)throw new Error("extra field length exceeds extra field buffer size");h.extraFields.push({id:w,data:g.slice(_,E)}),m=E}if(h.commentBytes=y.slice(p,p+h.fileCommentLength),h.comment=vt(h.commentBytes),o+=y.length,h.uncompressedSize===4294967295||h.compressedSize===4294967295||h.relativeOffsetOfLocalHeader===4294967295){const w=h.extraFields.find(E=>E.id===1);if(!w)throw new Error("expected zip64 extended information extra field");const k=w.data;let _=0;if(h.uncompressedSize===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include uncompressed size");h.uncompressedSize=Te(k,_),_+=8}if(h.compressedSize===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include compressed size");h.compressedSize=Te(k,_),_+=8}if(h.relativeOffsetOfLocalHeader===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include relative header offset");h.relativeOffsetOfLocalHeader=Te(k,_),_+=8}}const v=h.extraFields.find(w=>w.id===28789&&w.data.length>=6&&w.data[0]===1&&D(w.data,1),Po.unsigned(h.nameBytes));if(v&&(h.fileName=vt(v.data.slice(5))),h.compressionMethod===0){let w=h.uncompressedSize;if(h.generalPurposeBitFlag&1&&(w+=12),h.compressedSize!==w)throw new Error(`compressed size mismatch for stored file: ${h.compressedSize} != ${w}`)}a.push(h)}return{zip:{comment:s,commentBytes:i},entries:a.map(u=>new No(e,u))}}async function Ds(e,t){if(t.generalPurposeBitFlag&1)throw new Error("encrypted entries not supported");const n=await tt(e,t.relativeOffsetOfLocalHeader,30),r=await e.getLength(),s=D(n,0);if(s!==67324752)throw new Error(`invalid local file header signature: 0x${s.toString(16)}`);const i=j(n,26),o=j(n,28),c=t.relativeOffsetOfLocalHeader+n.length+i+o;let a;if(t.compressionMethod===0)a=!1;else if(t.compressionMethod===8)a=!0;else throw new Error(`unsupported compression method: ${t.compressionMethod}`);const l=c,u=l+t.compressedSize;if(t.compressedSize!==0&&u>r)throw new Error(`file data overflows file bounds: ${l} +  ${t.compressedSize}  > ${r}`);return{decompress:a,fileDataStart:l}}async function Fo(e,t){const{decompress:n,fileDataStart:r}=await Ds(e,t);if(!n){const o=await tt(e,r,t.compressedSize);return vo(o)?o.buffer:o.slice().buffer}const s=await Un(e,r,t.compressedSize);return await Ws(s,t.uncompressedSize)}async function Ko(e,t,n){const{decompress:r,fileDataStart:s}=await Ds(e,t);if(!r){const c=await Un(e,s,t.compressedSize,n);return zs(c)?c:new Blob([xt(c.buffer)?new Uint8Array(c):c],{type:n})}const i=await Un(e,s,t.compressedSize);return await Ws(i,t.uncompressedSize,n)}async function Mo(e){let t;if(typeof Blob<"u"&&e instanceof Blob)t=new es(e);else if(e instanceof ArrayBuffer||e&&e.buffer&&e.buffer instanceof ArrayBuffer)t=new Zr(e);else if(xt(e)||xt(e.buffer))t=new Zr(e);else if(typeof e=="string"){const r=await fetch(e);if(!r.ok)throw new Error(`failed http request ${e}, status: ${r.status}: ${r.statusText}`);const s=await r.blob();t=new es(s)}else if(typeof e.getLength=="function"&&typeof e.read=="function")t=e;else throw new Error("unsupported source type");const n=await t.getLength();if(n>Number.MAX_SAFE_INTEGER)throw new Error(`file too large. size: ${n}. Only file sizes up 4503599627370496 bytes are supported`);return await $o(t,n)}async function Js(e){const{zip:t,entries:n}=await Mo(e);return{zip:t,entries:Object.fromEntries(n.map(r=>[r.name,r]))}}var xr={},Sr={};(function(e){const t=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",n=t+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",r="["+t+"]["+n+"]*",s=new RegExp("^"+r+"$"),i=function(c,a){const l=[];let u=a.exec(c);for(;u;){const f=[];f.startIndex=a.lastIndex-u[0].length;const d=u.length;for(let h=0;h<d;h++)f.push(u[h]);l.push(f),u=a.exec(c)}return l},o=function(c){const a=s.exec(c);return!(a===null||typeof a>"u")};e.isExist=function(c){return typeof c<"u"},e.isEmptyObject=function(c){return Object.keys(c).length===0},e.merge=function(c,a,l){if(a){const u=Object.keys(a),f=u.length;for(let d=0;d<f;d++)l==="strict"?c[u[d]]=[a[u[d]]]:c[u[d]]=a[u[d]]}},e.getValue=function(c){return e.isExist(c)?c:""},e.isName=o,e.getAllMatches=i,e.nameRegexp=r})(Sr);const Cr=Sr,Uo={allowBooleanAttributes:!1,unpairedTags:[]};xr.validate=function(e,t){t=Object.assign({},Uo,t);const n=[];let r=!1,s=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let i=0;i<e.length;i++)if(e[i]==="<"&&e[i+1]==="?"){if(i+=2,i=os(e,i),i.err)return i}else if(e[i]==="<"){let o=i;if(i++,e[i]==="!"){i=as(e,i);continue}else{let c=!1;e[i]==="/"&&(c=!0,i++);let a="";for(;i<e.length&&e[i]!==">"&&e[i]!==" "&&e[i]!=="	"&&e[i]!==`
`&&e[i]!=="\r";i++)a+=e[i];if(a=a.trim(),a[a.length-1]==="/"&&(a=a.substring(0,a.length-1),i--),!Ho(a)){let f;return a.trim().length===0?f="Invalid space after '<'.":f="Tag '"+a+"' is an invalid name.",K("InvalidTag",f,Y(e,i))}const l=jo(e,i);if(l===!1)return K("InvalidAttr","Attributes for '"+a+"' have open quote.",Y(e,i));let u=l.value;if(i=l.index,u[u.length-1]==="/"){const f=i-u.length;u=u.substring(0,u.length-1);const d=cs(u,t);if(d===!0)r=!0;else return K(d.err.code,d.err.msg,Y(e,f+d.err.line))}else if(c)if(l.tagClosed){if(u.trim().length>0)return K("InvalidTag","Closing tag '"+a+"' can't have attributes or invalid starting.",Y(e,o));{const f=n.pop();if(a!==f.tagName){let d=Y(e,f.tagStartPos);return K("InvalidTag","Expected closing tag '"+f.tagName+"' (opened in line "+d.line+", col "+d.col+") instead of closing tag '"+a+"'.",Y(e,o))}n.length==0&&(s=!0)}}else return K("InvalidTag","Closing tag '"+a+"' doesn't have proper closing.",Y(e,i));else{const f=cs(u,t);if(f!==!0)return K(f.err.code,f.err.msg,Y(e,i-u.length+f.err.line));if(s===!0)return K("InvalidXml","Multiple possible root nodes found.",Y(e,i));t.unpairedTags.indexOf(a)!==-1||n.push({tagName:a,tagStartPos:o}),r=!0}for(i++;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="!"){i++,i=as(e,i);continue}else if(e[i+1]==="?"){if(i=os(e,++i),i.err)return i}else break;else if(e[i]==="&"){const f=Do(e,i);if(f==-1)return K("InvalidChar","char '&' is not expected.",Y(e,i));i=f}else if(s===!0&&!is(e[i]))return K("InvalidXml","Extra text at the end",Y(e,i));e[i]==="<"&&i--}}else{if(is(e[i]))continue;return K("InvalidChar","char '"+e[i]+"' is not expected.",Y(e,i))}if(r){if(n.length==1)return K("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",Y(e,n[0].tagStartPos));if(n.length>0)return K("InvalidXml","Invalid '"+JSON.stringify(n.map(i=>i.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return K("InvalidXml","Start tag expected.",1);return!0};function is(e){return e===" "||e==="	"||e===`
`||e==="\r"}function os(e,t){const n=t;for(;t<e.length;t++)if(e[t]=="?"||e[t]==" "){const r=e.substr(n,t-n);if(t>5&&r==="xml")return K("InvalidXml","XML declaration allowed only at the start of the document.",Y(e,t));if(e[t]=="?"&&e[t+1]==">"){t++;break}else continue}return t}function as(e,t){if(e.length>t+5&&e[t+1]==="-"&&e[t+2]==="-"){for(t+=3;t<e.length;t++)if(e[t]==="-"&&e[t+1]==="-"&&e[t+2]===">"){t+=2;break}}else if(e.length>t+8&&e[t+1]==="D"&&e[t+2]==="O"&&e[t+3]==="C"&&e[t+4]==="T"&&e[t+5]==="Y"&&e[t+6]==="P"&&e[t+7]==="E"){let n=1;for(t+=8;t<e.length;t++)if(e[t]==="<")n++;else if(e[t]===">"&&(n--,n===0))break}else if(e.length>t+9&&e[t+1]==="["&&e[t+2]==="C"&&e[t+3]==="D"&&e[t+4]==="A"&&e[t+5]==="T"&&e[t+6]==="A"&&e[t+7]==="["){for(t+=8;t<e.length;t++)if(e[t]==="]"&&e[t+1]==="]"&&e[t+2]===">"){t+=2;break}}return t}const zo='"',qo="'";function jo(e,t){let n="",r="",s=!1;for(;t<e.length;t++){if(e[t]===zo||e[t]===qo)r===""?r=e[t]:r!==e[t]||(r="");else if(e[t]===">"&&r===""){s=!0;break}n+=e[t]}return r!==""?!1:{value:n,index:t,tagClosed:s}}const Wo=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function cs(e,t){const n=Cr.getAllMatches(e,Wo),r={};for(let s=0;s<n.length;s++){if(n[s][1].length===0)return K("InvalidAttr","Attribute '"+n[s][2]+"' has no space in starting.",ct(n[s]));if(n[s][3]!==void 0&&n[s][4]===void 0)return K("InvalidAttr","Attribute '"+n[s][2]+"' is without value.",ct(n[s]));if(n[s][3]===void 0&&!t.allowBooleanAttributes)return K("InvalidAttr","boolean attribute '"+n[s][2]+"' is not allowed.",ct(n[s]));const i=n[s][2];if(!Jo(i))return K("InvalidAttr","Attribute '"+i+"' is an invalid name.",ct(n[s]));if(!r.hasOwnProperty(i))r[i]=1;else return K("InvalidAttr","Attribute '"+i+"' is repeated.",ct(n[s]))}return!0}function Vo(e,t){let n=/\d/;for(e[t]==="x"&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(e[t]===";")return t;if(!e[t].match(n))break}return-1}function Do(e,t){if(t++,e[t]===";")return-1;if(e[t]==="#")return t++,Vo(e,t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(e[t]===";")break;return-1}return t}function K(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function Jo(e){return Cr.isName(e)}function Ho(e){return Cr.isName(e)}function Y(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function ct(e){return e.startIndex+e[1].length}var Nr={};const Hs={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}},Xo=function(e){return Object.assign({},Hs,e)};Nr.buildOptions=Xo;Nr.defaultOptions=Hs;class Yo{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,n){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:n})}addChild(t){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,[":@"]:t[":@"]}):this.child.push({[t.tagname]:t.child})}}var Qo=Yo;function Zo(e,t){const n={};if(e[t+3]==="O"&&e[t+4]==="C"&&e[t+5]==="T"&&e[t+6]==="Y"&&e[t+7]==="P"&&e[t+8]==="E"){t=t+9;let r=1,s=!1,i=!1,o="";for(;t<e.length;t++)if(e[t]==="<"&&!i){if(s&&na(e,t))t+=7,[entityName,val,t]=ea(e,t+1),val.indexOf("&")===-1&&(n[entityName]={regx:RegExp(`&${entityName};`,"g"),val});else if(s&&ra(e,t))t+=8;else if(s&&sa(e,t))t+=8;else if(s&&ia(e,t))t+=9;else if(ta)i=!0;else throw new Error("Invalid DOCTYPE");r++,o=""}else if(e[t]===">"){if(i?e[t-1]==="-"&&e[t-2]==="-"&&(i=!1,r--):r--,r===0)break}else e[t]==="["?s=!0:o+=e[t];if(r!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:n,i:t}}function ea(e,t){let n="";for(;t<e.length&&e[t]!=="'"&&e[t]!=='"';t++)n+=e[t];if(n=n.trim(),n.indexOf(" ")!==-1)throw new Error("External entites are not supported");const r=e[t++];let s="";for(;t<e.length&&e[t]!==r;t++)s+=e[t];return[n,s,t]}function ta(e,t){return e[t+1]==="!"&&e[t+2]==="-"&&e[t+3]==="-"}function na(e,t){return e[t+1]==="!"&&e[t+2]==="E"&&e[t+3]==="N"&&e[t+4]==="T"&&e[t+5]==="I"&&e[t+6]==="T"&&e[t+7]==="Y"}function ra(e,t){return e[t+1]==="!"&&e[t+2]==="E"&&e[t+3]==="L"&&e[t+4]==="E"&&e[t+5]==="M"&&e[t+6]==="E"&&e[t+7]==="N"&&e[t+8]==="T"}function sa(e,t){return e[t+1]==="!"&&e[t+2]==="A"&&e[t+3]==="T"&&e[t+4]==="T"&&e[t+5]==="L"&&e[t+6]==="I"&&e[t+7]==="S"&&e[t+8]==="T"}function ia(e,t){return e[t+1]==="!"&&e[t+2]==="N"&&e[t+3]==="O"&&e[t+4]==="T"&&e[t+5]==="A"&&e[t+6]==="T"&&e[t+7]==="I"&&e[t+8]==="O"&&e[t+9]==="N"}var oa=Zo;const aa=/^[-+]?0x[a-fA-F0-9]+$/,ca=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt);!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);const la={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function ua(e,t={}){if(t=Object.assign({},la,t),!e||typeof e!="string")return e;let n=e.trim();if(t.skipLike!==void 0&&t.skipLike.test(n))return e;if(t.hex&&aa.test(n))return Number.parseInt(n,16);{const r=ca.exec(n);if(r){const s=r[1],i=r[2];let o=fa(r[3]);const c=r[4]||r[6];if(!t.leadingZeros&&i.length>0&&s&&n[2]!==".")return e;if(!t.leadingZeros&&i.length>0&&!s&&n[1]!==".")return e;{const a=Number(n),l=""+a;return l.search(/[eE]/)!==-1||c?t.eNotation?a:e:n.indexOf(".")!==-1?l==="0"&&o===""||l===o||s&&l==="-"+o?a:e:i?o===l||s+o===l?a:e:n===l||n===s+l?a:e}}else return e}}function fa(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substr(0,e.length-1))),e}var da=ua;const Or=Sr,lt=Qo,ha=oa,pa=da;"<((!\\[CDATA\\[([\\s\\S]*?)(]]>))|((NAME:)?(NAME))([^>]*)>|((\\/)(NAME)\\s*>))([^<]*)".replace(/NAME/g,Or.nameRegexp);let ga=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:""},pound:{regex:/&(pound|#163);/g,val:""},yen:{regex:/&(yen|#165);/g,val:""},euro:{regex:/&(euro|#8364);/g,val:""},copyright:{regex:/&(copy|#169);/g,val:""},reg:{regex:/&(reg|#174);/g,val:""},inr:{regex:/&(inr|#8377);/g,val:""}},this.addExternalEntities=ya,this.parseXml=_a,this.parseTextData=ma,this.resolveNameSpace=va,this.buildAttributesMap=wa,this.isItStopNode=xa,this.replaceEntitiesValue=ka,this.readStopNodeData=Ca,this.saveTextToParentTag=Ia,this.addChild=Ea}};function ya(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function ma(e,t,n,r,s,i,o){if(e!==void 0&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){o||(e=this.replaceEntitiesValue(e));const c=this.options.tagValueProcessor(t,e,n,s,i);return c==null?e:typeof c!=typeof e||c!==e?c:this.options.trimValues?qn(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?qn(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function va(e){if(this.options.removeNSPrefix){const t=e.split(":"),n=e.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(e=n+t[1])}return e}const ba=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function wa(e,t,n){if(!this.options.ignoreAttributes&&typeof e=="string"){const r=Or.getAllMatches(e,ba),s=r.length,i={};for(let o=0;o<s;o++){const c=this.resolveNameSpace(r[o][1]);let a=r[o][4],l=this.options.attributeNamePrefix+c;if(c.length)if(this.options.transformAttributeName&&(l=this.options.transformAttributeName(l)),l==="__proto__"&&(l="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const u=this.options.attributeValueProcessor(c,a,t);u==null?i[l]=a:typeof u!=typeof a||u!==a?i[l]=u:i[l]=qn(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(i[l]=!0)}if(!Object.keys(i).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=i,o}return i}}const _a=function(e){e=e.replace(/\r\n?/g,`
`);const t=new lt("!xml");let n=t,r="",s="";for(let i=0;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="/"){const c=Pe(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,c).trim();if(this.options.removeNSPrefix){const f=a.indexOf(":");f!==-1&&(a=a.substr(f+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&(r=this.saveTextToParentTag(r,n,s));const l=s.substring(s.lastIndexOf(".")+1);if(a&&this.options.unpairedTags.indexOf(a)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let u=0;l&&this.options.unpairedTags.indexOf(l)!==-1?(u=s.lastIndexOf(".",s.lastIndexOf(".")-1),this.tagsNodeStack.pop()):u=s.lastIndexOf("."),s=s.substring(0,u),n=this.tagsNodeStack.pop(),r="",i=c}else if(e[i+1]==="?"){let c=zn(e,i,!1,"?>");if(!c)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,s),!(this.options.ignoreDeclaration&&c.tagName==="?xml"||this.options.ignorePiTags)){const a=new lt(c.tagName);a.add(this.options.textNodeName,""),c.tagName!==c.tagExp&&c.attrExpPresent&&(a[":@"]=this.buildAttributesMap(c.tagExp,s,c.tagName)),this.addChild(n,a,s)}i=c.closeIndex+1}else if(e.substr(i+1,3)==="!--"){const c=Pe(e,"-->",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,c-2);r=this.saveTextToParentTag(r,n,s),n.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=c}else if(e.substr(i+1,2)==="!D"){const c=ha(e,i);this.docTypeEntities=c.entities,i=c.i}else if(e.substr(i+1,2)==="!["){const c=Pe(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,c);if(r=this.saveTextToParentTag(r,n,s),this.options.cdataPropName)n.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]);else{let l=this.parseTextData(a,n.tagname,s,!0,!1,!0);l==null&&(l=""),n.add(this.options.textNodeName,l)}i=c+2}else{let c=zn(e,i,this.options.removeNSPrefix),a=c.tagName,l=c.tagExp,u=c.attrExpPresent,f=c.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&r&&n.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,n,s,!1));const d=n;if(d&&this.options.unpairedTags.indexOf(d.tagname)!==-1&&(n=this.tagsNodeStack.pop(),s=s.substring(0,s.lastIndexOf("."))),a!==t.tagname&&(s+=s?"."+a:a),this.isItStopNode(this.options.stopNodes,s,a)){let h="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)i=c.closeIndex;else if(this.options.unpairedTags.indexOf(a)!==-1)i=c.closeIndex;else{const p=this.readStopNodeData(e,a,f+1);if(!p)throw new Error(`Unexpected end of ${a}`);i=p.i,h=p.tagContent}const y=new lt(a);a!==l&&u&&(y[":@"]=this.buildAttributesMap(l,s,a)),h&&(h=this.parseTextData(h,a,s,!0,u,!0,!0)),s=s.substr(0,s.lastIndexOf(".")),y.add(this.options.textNodeName,h),this.addChild(n,y,s)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){a[a.length-1]==="/"?(a=a.substr(0,a.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const h=new lt(a);a!==l&&u&&(h[":@"]=this.buildAttributesMap(l,s,a)),this.addChild(n,h,s),s=s.substr(0,s.lastIndexOf("."))}else{const h=new lt(a);this.tagsNodeStack.push(n),a!==l&&u&&(h[":@"]=this.buildAttributesMap(l,s,a)),this.addChild(n,h,s),n=h}r="",i=f}}else r+=e[i];return t.child};function Ea(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);r===!1||(typeof r=="string"&&(t.tagname=r),e.addChild(t))}const ka=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Ia(e,t,n,r){return e&&(r===void 0&&(r=Object.keys(t.child).length===0),e=this.parseTextData(e,t.tagname,n,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,r),e!==void 0&&e!==""&&t.add(this.options.textNodeName,e),e=""),e}function xa(e,t,n){const r="*."+n;for(const s in e){const i=e[s];if(r===i||t===i)return!0}return!1}function Sa(e,t,n=">"){let r,s="";for(let i=t;i<e.length;i++){let o=e[i];if(r)o===r&&(r="");else if(o==='"'||o==="'")r=o;else if(o===n[0])if(n[1]){if(e[i+1]===n[1])return{data:s,index:i}}else return{data:s,index:i};else o==="	"&&(o=" ");s+=o}}function Pe(e,t,n,r){const s=e.indexOf(t,n);if(s===-1)throw new Error(r);return s+t.length-1}function zn(e,t,n,r=">"){const s=Sa(e,t+1,r);if(!s)return;let i=s.data;const o=s.index,c=i.search(/\s/);let a=i,l=!0;if(c!==-1&&(a=i.substr(0,c).replace(/\s\s*$/,""),i=i.substr(c+1)),n){const u=a.indexOf(":");u!==-1&&(a=a.substr(u+1),l=a!==s.data.substr(u+1))}return{tagName:a,tagExp:i,closeIndex:o,attrExpPresent:l}}function Ca(e,t,n){const r=n;let s=1;for(;n<e.length;n++)if(e[n]==="<")if(e[n+1]==="/"){const i=Pe(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(s--,s===0))return{tagContent:e.substring(r,n),i};n=i}else if(e[n+1]==="?")n=Pe(e,"?>",n+1,"StopNode is not closed.");else if(e.substr(n+1,3)==="!--")n=Pe(e,"-->",n+3,"StopNode is not closed.");else if(e.substr(n+1,2)==="![")n=Pe(e,"]]>",n,"StopNode is not closed.")-2;else{const i=zn(e,n,">");i&&((i&&i.tagName)===t&&i.tagExp[i.tagExp.length-1]!=="/"&&s++,n=i.closeIndex)}}function qn(e,t,n){if(t&&typeof e=="string"){const r=e.trim();return r==="true"?!0:r==="false"?!1:pa(e,n)}else return Or.isExist(e)?e:""}var Na=ga,Xs={};function Oa(e,t){return Ys(e,t)}function Ys(e,t,n){let r;const s={};for(let i=0;i<e.length;i++){const o=e[i],c=Aa(o);let a="";if(n===void 0?a=c:a=n+"."+c,c===t.textNodeName)r===void 0?r=o[c]:r+=""+o[c];else{if(c===void 0)continue;if(o[c]){let l=Ys(o[c],t,a);const u=Pa(l,t);o[":@"]?Ta(l,o[":@"],a,t):Object.keys(l).length===1&&l[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?l=l[t.textNodeName]:Object.keys(l).length===0&&(t.alwaysCreateTextNode?l[t.textNodeName]="":l=""),s[c]!==void 0&&s.hasOwnProperty(c)?(Array.isArray(s[c])||(s[c]=[s[c]]),s[c].push(l)):t.isArray(c,a,u)?s[c]=[l]:s[c]=l}}}return typeof r=="string"?r.length>0&&(s[t.textNodeName]=r):r!==void 0&&(s[t.textNodeName]=r),s}function Aa(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(r!==":@")return r}}function Ta(e,t,n,r){if(t){const s=Object.keys(t),i=s.length;for(let o=0;o<i;o++){const c=s[o];r.isArray(c,n+"."+c,!0,!0)?e[c]=[t[c]]:e[c]=t[c]}}}function Pa(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return!!(r===0||r===1&&(e[n]||typeof e[n]=="boolean"||e[n]===0))}Xs.prettify=Oa;const{buildOptions:La}=Nr,$a=Na,{prettify:Ga}=Xs,Ra=xr;let Ba=class{constructor(t){this.externalEntities={},this.options=La(t)}parse(t,n){if(typeof t!="string")if(t.toString)t=t.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(n){n===!0&&(n={});const i=Ra.validate(t,n);if(i!==!0)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const r=new $a(this.options);r.addExternalEntities(this.externalEntities);const s=r.parseXml(t);return this.options.preserveOrder||s===void 0?s:Ga(s,this.options)}addEntity(t,n){if(n.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(n==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=n}};var Fa=Ba;const Ka=`
`;function Ma(e,t){let n="";return t.format&&t.indentBy.length>0&&(n=Ka),Qs(e,t,"",n)}function Qs(e,t,n,r){let s="",i=!1;for(let o=0;o<e.length;o++){const c=e[o],a=Ua(c);let l="";if(n.length===0?l=a:l=`${n}.${a}`,a===t.textNodeName){let y=c[a];za(l,t)||(y=t.tagValueProcessor(a,y),y=Zs(y,t)),i&&(s+=r),s+=y,i=!1;continue}else if(a===t.cdataPropName){i&&(s+=r),s+=`<![CDATA[${c[a][0][t.textNodeName]}]]>`,i=!1;continue}else if(a===t.commentPropName){s+=r+`<!--${c[a][0][t.textNodeName]}-->`,i=!0;continue}else if(a[0]==="?"){const y=ls(c[":@"],t),p=a==="?xml"?"":r;let g=c[a][0][t.textNodeName];g=g.length!==0?" "+g:"",s+=p+`<${a}${g}${y}?>`,i=!0;continue}let u=r;u!==""&&(u+=t.indentBy);const f=ls(c[":@"],t),d=r+`<${a}${f}`,h=Qs(c[a],t,l,u);t.unpairedTags.indexOf(a)!==-1?t.suppressUnpairedNode?s+=d+">":s+=d+"/>":(!h||h.length===0)&&t.suppressEmptyNode?s+=d+"/>":h&&h.endsWith(">")?s+=d+`>${h}${r}</${a}>`:(s+=d+">",h&&r!==""&&(h.includes("/>")||h.includes("</"))?s+=r+t.indentBy+h+r:s+=h,s+=`</${a}>`),i=!0}return s}function Ua(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(r!==":@")return r}}function ls(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){let s=t.attributeValueProcessor(r,e[r]);s=Zs(s,t),s===!0&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${s}"`}return n}function za(e,t){e=e.substr(0,e.length-t.textNodeName.length-1);let n=e.substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function Zs(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}var qa=Ma;const ja=qa,Wa={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Ee(e){this.options=Object.assign({},Wa,e),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Ja),this.processTextOrObjNode=Va,this.options.format?(this.indentate=Da,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}Ee.prototype.build=function(e){return this.options.preserveOrder?ja(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0).val)};Ee.prototype.j2x=function(e,t){let n="",r="";for(let s in e)if(!(typeof e[s]>"u"))if(e[s]===null)s[0]==="?"?r+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:r+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)r+=this.buildTextValNode(e[s],s,"",t);else if(typeof e[s]!="object"){const i=this.isAttribute(s);if(i)n+=this.buildAttrPairStr(i,""+e[s]);else if(s===this.options.textNodeName){let o=this.options.tagValueProcessor(s,""+e[s]);r+=this.replaceEntitiesValue(o)}else r+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const i=e[s].length;let o="";for(let c=0;c<i;c++){const a=e[s][c];typeof a>"u"||(a===null?s[0]==="?"?r+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:r+=this.indentate(t)+"<"+s+"/"+this.tagEndChar:typeof a=="object"?this.options.oneListGroup?o+=this.j2x(a,t+1).val:o+=this.processTextOrObjNode(a,s,t):o+=this.buildTextValNode(a,s,"",t))}this.options.oneListGroup&&(o=this.buildObjectNode(o,s,"",t)),r+=o}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const i=Object.keys(e[s]),o=i.length;for(let c=0;c<o;c++)n+=this.buildAttrPairStr(i[c],""+e[s][i[c]])}else r+=this.processTextOrObjNode(e[s],s,t);return{attrStr:n,val:r}};Ee.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&t==="true"?" "+e:" "+e+'="'+t+'"'};function Va(e,t,n){const r=this.j2x(e,n+1);return e[this.options.textNodeName]!==void 0&&Object.keys(e).length===1?this.buildTextValNode(e[this.options.textNodeName],t,r.attrStr,n):this.buildObjectNode(r.val,t,r.attrStr,n)}Ee.prototype.buildObjectNode=function(e,t,n,r){if(e==="")return t[0]==="?"?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let s="</"+t+this.tagEndChar,i="";return t[0]==="?"&&(i="?",s=""),n&&e.indexOf("<")===-1?this.indentate(r)+"<"+t+n+i+">"+e+s:this.options.commentPropName!==!1&&t===this.options.commentPropName&&i.length===0?this.indentate(r)+`<!--${e}-->`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+s}};Ee.prototype.closeTag=function(e){let t="";return this.options.unpairedTags.indexOf(e)!==-1?this.options.suppressUnpairedNode||(t="/"):this.options.suppressEmptyNode?t="/":t=`></${e}`,t};Ee.prototype.buildTextValNode=function(e,t,n,r){if(this.options.cdataPropName!==!1&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(this.options.commentPropName!==!1&&t===this.options.commentPropName)return this.indentate(r)+`<!--${e}-->`+this.newLine;if(t[0]==="?")return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let s=this.options.tagValueProcessor(t,e);return s=this.replaceEntitiesValue(s),s===""?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+s+"</"+t+this.tagEndChar}};Ee.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};function Da(e){return this.options.indentBy.repeat(e)}function Ja(e){return e.startsWith(this.options.attributeNamePrefix)?e.substr(this.attrPrefixLen):!1}var Ha=Ee;const Xa=xr,Ya=Fa,Qa=Ha;var ei={XMLParser:Ya,XMLValidator:Xa,XMLBuilder:Qa};const Za={catalogueLinks:{allowedChildrens:[]},publications:{allowedChildrens:[]},costTypes:{allowedChildrens:[]},profileTypes:{allowedChildrens:["characteristicTypes"]},categoryEntries:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups"]},categoryLinks:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups"]},forceEntries:{allowedChildrens:["forceEntries","categoryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","costs"]},entryLinks:{allowedChildrens:"type"},selectionEntryGroups:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","categoryLinks","costs"]},sharedSelectionEntryGroups:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","categoryLinks","costs"]},selectionEntries:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","associations","constraints","modifiers","modifierGroups","categoryLinks","costs"]},sharedSelectionEntries:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","associations","constraints","modifiers","modifierGroups","categoryLinks","costs"]},associations:{allowedChildrens:[]},sharedRules:{allowedChildrens:["modifiers","modifierGroups"]},rule:{allowedChildrens:["modifiers","modifierGroups"]},rules:{allowedChildrens:["modifiers","modifierGroups"]},profile:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},profiles:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},sharedProfiles:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},infoGroup:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},infoGroups:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},sharedInfoGroups:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},infoLinks:{allowedChildrens:"type"},modifiers:{allowedChildrens:["conditions","conditionGroups","repeats"]},modifierGroups:{allowedChildrens:["modifiers","modifierGroups","conditions","conditionGroups","repeats"]},conditions:{allowedChildrens:[]},conditionGroups:{allowedChildrens:["conditions","conditionGroups"]},catalogue:{allowedChildrens:["catalogueLinks","publications","costTypes","profileTypes","categoryEntries","forceEntries","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","selectionEntries","entryLinks","infoLinks","infoGroups","rules"]},gameSystem:{allowedChildrens:["publications","costTypes","profileTypes","categoryEntries","forceEntries","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","selectionEntries","entryLinks","infoLinks","infoGroups","rules"]}},Ge={categories:"category",catalogueLinks:"catalogueLink",categoryEntries:"categoryEntry",categoryLinks:"categoryLink",characteristics:"characteristic",characteristicTypes:"characteristicType",conditions:"condition",conditionGroups:"conditionGroup",constraints:"constraint",costs:"cost",costLimits:"costLimit",costTypes:"costType",entryLinks:"entryLink",forceEntries:"forceEntry",infoGroups:"infoGroup",infoLinks:"infoLink",forces:"force",modifiers:"modifier",modifierGroups:"modifierGroup",profiles:"profile",profileTypes:"profileType",publications:"publication",repeats:"repeat",rules:"rule",selections:"selection",selectionEntries:"selectionEntry",selectionEntryGroups:"selectionEntryGroup",sharedInfoGroups:"infoGroup",sharedProfiles:"profile",sharedRules:"rule",sharedSelectionEntries:"selectionEntry",sharedSelectionEntryGroups:"selectionEntryGroup",associations:"association"},pn=new Set(["description","readme","comment"]),us=/&(?:amp|lt|gt|quot|#39|apos);/g,ec={"&amp;":"&","&apos;":"'","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},fs=e=>us.test(e)?e.replace(us,t=>ec[t]):e,Ar={};for(const e in Ge)Ar[Ge[e]]=e;const nt={};for(const[e,t]of Object.entries(Za))typeof t.allowedChildrens=="string"?nt[e]=t.allowedChildrens:nt[e]=new Set(t.allowedChildrens);function tc(e){switch(e){case"true":return!0;case"false":return!1;default:if(isNaN(e))return e;const t=parseFloat(e);return isFinite(t)&&e.includes("+")==!1?t:e}}function nc(e){const t={allowBooleanAttributes:!0,ignoreAttributes:!1,attributeNamePrefix:"",textNodeName:"$text",processEntities:!1,parseTagValue:!1,ignoreDeclaration:!0,alwaysCreateTextNode:!0,isArray:(n,r,s,i)=>!i&&n in Ar,attributeValueProcessor:(n,r)=>tc(fs(r)),tagValueProcessor:(n,r)=>fs(r)};return new ei.XMLParser(t).parse(e)}async function Rl(e,t){const n=await Js(e),r={};console.log("unzipping folder",n,"path",t);for(const s in n.entries){const i=n.entries[s];if(i.isDirectory)continue;const o=Bn(Bn(s,t),"/");if(o.startsWith("."))continue;const c=ti(o)?await i.arrayBuffer():await i.text();r[o]=c}return r}async function rc(e){if(typeof e=="string"){var t=new TextEncoder;e=t.encode(e)}const n=await Js(e);for(const r of Object.values(n.entries))return await r.text();throw"unzipFile failed: No Entries"}const sc=["gstz","zip","catz"],ic=["gst","gstz","xml","zip","cat","catz","json"];function Bl(e){const t=e.lastIndexOf(".");return t===-1?e:e.substring(0,t)}function gn(e){return e.split(".").pop().toLowerCase()}function ti(e){const t=gn(e);return sc.includes(t)}function oc(e){const t=gn(e);return!!ic.includes(t)}const ds={sharedRules:"shareRule",sharedProfiles:"sharedProfile",sharedInfoGroups:"sharedInfoGroup",sharedSelectionEntries:"sharedSelectionEntry",sharedSelectionEntryGroups:"sharedSelectionEntryGroup"};function jn(e){var t,n;for(let r in e)if(e[r]==="")delete e[r];else if(Ge[r]&&e[r])if(r in ds){const s=e[r][Ge[r]],i=e[r][ds[r]];e[r]=[...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]],(t=e[r])==null||t.forEach(jn)}else{const s=e[r][Ge[r]];Array.isArray(s)?(e[r]=s,(n=e[r])==null||n.forEach(jn)):ee(e[r])&&delete e[r]}else pn.has(r)&&(e[r]=e[r].$text??"");return e}function Wn(e,t){const n=nt[t],r=typeof n=="string"?nt[e[n]]:n;for(let s in e)s in Ge&&Array.isArray(e[s])&&(r&&!r.has(s)?delete e[s]:e[s].forEach(i=>Wn(i,s)))}const hs=new Set;function ps(e,t){let n=nt[t];if(typeof n=="string"){const r=e[n];if(r){const s=lc(r);if(typeof s!="string"||s===n)return hs;n=nt[s]}}return n||hs}function gs(e){const t=nc(e);jn(ye(t));const n=t.catalogue?"catalogue":"gameSystem";t.catalogue?(t.playable=1,t.id=qi(t.catalogue.id),t.include=[1e3]):(t.playable=0,t.id=1e3);const r=t[n];return t.name=r.name,t.short=ji(r.name),t.playable=!r.library,t.version=r.battleScribeVersion,t.nrversion=r.revision,t}async function ac(e,t){switch(t=gn(t),t){case"xml":case"cat":case"gst":return gs(e);case"zip":case"catz":case"gstz":return gs(await rc(e));case"json":return JSON.parse(e);default:throw new Error("Extension not supported "+t)}}function cc(e){return Ge[e]}function lc(e){return Ar[e]}const ni=new Set(["?xml","$text","_"]);function uc(e){for(const[t,n]of Object.entries(e))pn.has(t)?e[t]=Array.isArray(n)?n:[n]:Array.isArray(n)&&!ni.has(t)&&(e[t]=[{[cc(t)]:n}])}function fc(e){return Wr(e,t=>{typeof t=="object"&&uc(t)}),Wr(e,t=>{if(typeof t=="object")for(const[n,r]of Object.entries(t))Array.isArray(r)||ni.has(n)||pn.has(n)||ee(r)||(t[`_${n}`]=r,delete t[n])}),e}function dc(e){const t=JSON.parse(Mn(e));fc(t);const n={textNodeName:"$text",format:!0,attributeNamePrefix:"_",ignoreAttributes:!1,suppressBooleanAttributes:!1,suppressEmptyNode:!0};return t.gameSystem&&(t.gameSystem._xmlns="http://www.battlescribe.net/schema/gameSystemSchema"),t.catalogue&&(t.catalogue._xmlns="http://www.battlescribe.net/schema/catalogueSchema"),`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
`+new ei.XMLBuilder(n).build(t)}const hc=[{type:"publications",name:"Publications",icon:"publication.png"},{type:"costTypes",name:"Cost Types",icon:"cost.png"},{type:"profileTypes",name:"Profile Types",icon:"profileType.png"},{type:"categoryEntries",name:"Category Entries",icon:"category.png"},{type:"forceEntries",name:"Force Entries",icon:"force.png"},{type:"sharedSelectionEntries",name:"Shared Selection Entries",icon:"selectionEntryLink.png"},{type:"sharedSelectionEntryGroups",name:"Shared Selection Entry Groups",icon:"shared_groups.png"},{type:"sharedProfiles",name:"Shared Profiles",icon:"shared_profiles.png"},{type:"sharedRules",name:"Shared Rules",icon:"shared_rules.png"},{type:"sharedInfoGroups",name:"Shared Info Groups",icon:"infoGroup.png"},{type:"rules",links:"infoLinks",name:"Root Rules",icon:"rule.png"},{type:"selectionEntries",links:"entryLinks",name:"Root Selection Entries",icon:"selectionEntry.png"}],Fl=[{type:"catalogueLinks",name:"Catalogue Links",icon:"catalogueLink.png"},...hc];function je(e,t){switch(e){case"selectionEntry":return"Entry";case"selectionEntryGroup":return"Group";case"selectionEntryLink":return"Entry (link)";case"selectionEntryGroupLink":return"Group (link)";case"force":return"Force";case"category":return"Category";case"categoryLink":return"Category (link)";case"catalogueLink":return"Catalogue (link)";case"publication":return"Publication";case"costType":return"Cost Type";case"costs":return"Cost";case"link":return"Link";case"profileType":return"Profile Type";case"profile":return"Profile";case"rule":return"Rule";case"infoLink":return"Info (link)";case"infoGroup":return"Info Group";case"profileLink":return"Profile";case"ruleLink":return"Rule (link)";case"infoGroupLink":return"Info Group (link)";case"characteristic":return"Characteristic";case"characteristicType":return"Characteristic Type";case"constraint":return"Constraint";case"condition":return"Condition";case"modifier":return"Modifier";case"modifierGroup":return"Modifier Group";case"repeat":return"Repeat";case"conditionGroup":return"Condition Group";case"catalogue":return"Catalogue";case"gameSystem":return"Game System";default:return console.warn("unknown getTypeLabel key",e),e}}function Se(e,t){switch(e){case"selectionEntries":return"selectionEntry";case"selectionEntryGroups":return"selectionEntryGroup";case"sharedSelectionEntries":return t!=null&&t.targetId?"selectionEntryLink":"selectionEntry";case"sharedSelectionEntryGroups":return t!=null&&t.targetId?"selectionEntryLink":"selectionEntryGroup";case"entryLinks":return t!=null&&t.target?t.target.editorTypeName+"Link":"link";case"forceEntries":return"force";case"categoryEntries":return"category";case"categoryLinks":return"categoryLink";case"catalogueLinks":return"catalogueLink";case"publications":return"publication";case"costTypes":return"costType";case"costs":return"cost";case"profileTypes":return"profileType";case"profiles":return"profile";case"rules":return"rule";case"characteristics":return"characteristic";case"characteristicTypes":return"characteristicType";case"sharedProfiles":return"profile";case"sharedRules":return"rule";case"sharedInfoGroups":return"infoGroup";case"infoLinks":return t?`${t.type||"info"}Link`:"infoLink";case"infoGroups":return"infoGroup";case"associations":return"association";case"constraints":return"constraint";case"conditions":return"condition";case"modifiers":return"modifier";case"modifierGroups":return"modifierGroup";case"repeats":return"repeat";case"conditionGroups":return"conditionGroup";case"catalogue":case"gameSystem":return e;default:return console.warn("unknown getTypeName key",e),e}}function Kl(e,t=!0,n=!0){var o,c,a,l,u;const r=e.parentKey,s=[];switch(r){case"infoLinks":["profiles","sharedProfiles"].includes((o=e.target)==null?void 0:o.parentKey)&&n&&s.push(e.target.typeName);break;case"sharedProfiles":case"profiles":n&&s.push(e.typeName);break;case"selectionEntries":case"sharedSelectionEntries":e.isEntry()&&e.getType()!=="upgrade"&&n&&s.push(e.getType());break;case"entryLinks":e.target&&e.isEntry()&&e.getType()!=="upgrade"&&n&&s.push(e.getType());break;case"modifierGroups":s.push(`(${(((c=e.modifiers)==null?void 0:c.length)||0)+(((a=e.modifierGroups)==null?void 0:a.length)||0)})`);break}const i=(((l=e.links)==null?void 0:l.length)??0)+(((u=e.other_links)==null?void 0:u.length)??0);if(i&&t){const f=i===1?"":"s";s.push(`(${i||0} ref${f})`)}return e.comment&&e.comment[0]&&s.push("# "+e.comment),e.isCollective&&e.isCollective()&&s.push("(collective)"),s.join(" ")}function Vn(e){const t=e.parentKey;switch(t){case"selectionEntries":case"sharedSelectionEntries":case"selectionEntryGroups":case"sharedSelectionEntryGroups":case"entryLinks":case"forceEntries":case"categoryLinks":case"categoryEntries":case"sharedInfoGroups":case"infoGroups":case"catalogueLinks":case"publications":case"profileTypes":case"catalogue":case"gameSystem":case"rules":case"sharedRules":case"costs":case"costTypes":case"sharedProfiles":case"profiles":case"characteristics":case"characteristicTypes":return e.getName();case"modifiers":return lo(Xe(e),e);case"repeats":{const n=e,r=Xe(e);return r||console.error("no parent for repeat",e),`Repeat ${n.repeats} times for every ${n.value} ${$e(r,n.field)} in ${$e(r,n.scope)} of ${n.childId?$e(r,n.childId):" any"}`}case"conditions":return Yr(Xe(e),e);case"constraints":return Yr(Xe(e),e);case"modifierGroups":return"Modify...";case"conditionGroups":return`${e.type.toUpperCase()}`;case"infoLinks":return e.target?Vn(e.target):e.getName();case"associations":return e.name;default:return console.log(t,e),t}}function rn(e,t){t(e);const n=[e];for(;n.length;){const r=n.pop();for(const s of Object.keys(r)){if(!st.has(s)||pn.has(s))continue;const i=r[s];if(i&&Array.isArray(i))for(const o of i)n.push(o),t(o,s,r)}}}function pc(e){const t=e.parent;if(t){const n=t[e.parentKey],r=n.indexOf(e);r!==-1&&n.splice(r,1)}}function ut(e,t){const n=e.catalogue;rn(e,(r,s,i)=>{if(n.removeFromIndex(r),r.isLink&&r.isLink()&&(n.unlinkLink(r),delete r.target),r instanceof gt&&r.typeId){const o=r.catalogue.findOptionById(r.typeId);o&&r.catalogue.removeRef(r,o)}if(r instanceof Ke){const o=r.scope,c=r.childId;if(!kr.has(o)){const a=r.catalogue.findOptionById(r.scope);a&&r.catalogue.removeOtherRef(r,a)}if(!io.has(c)){const a=r.catalogue.findOptionById(r.childId);a&&r.catalogue.removeOtherRef(r,a)}}delete r.parent,delete r.catalogue}),t&&e instanceof Ir&&n.reload(t)}function We(e,t,n,r){let s=!1;for(const i of Array.isArray(e)?e:[e])rn(i,(o,c,a)=>{if(ee(o)){if(o.parent=a||n,o.catalogue=t,t.addToIndex(o),o instanceof et&&t.updateLink(o),o instanceof gt&&o.typeId){const l=o.catalogue.findOptionById(o.typeId);l&&o.catalogue.addRef(o,l)}o instanceof Ir&&o.targetId&&(s=!0),t.refreshErrors(o)}});s&&n&&(n.catalogue||n).reload(r)}function pe(e){if(!e.parent&&!e.isCatalogue())return[{id:e.id,key:e.parentKey,index:0}];const t=[];for(;e.parent;){const n=e.parent||e.catalogue;t.push({key:e.parentKey,index:n[e.parentKey].indexOf(e),id:e.id}),e=e.parent}return t.reverse(),t}function Ml(e){if(!e.parent&&!e.isCatalogue())return[{id:e.id,key:e.parentKey,index:0}];const t=[];do{const n=e.parent||e.catalogue;n?t.push({name:e.getName(),type:e.editorTypeName,label:e.getTypeName(),display:Vn(e),key:e.parentKey,index:n[e.parentKey].indexOf(e),id:e.id}):t.push({name:e.getName(),display:Vn(e),type:"catalogue",key:"catalogue",id:e.id,index:0}),e=e.parent}while(e);return t.reverse(),t}function ys(e,t,n){let r=e;for(let o=0;o<t.length-1;o++){const c=t[o];r=r[c.key][c.index]}const s=t[t.length-1];return r[s.key]||(r[s.key]=[]),r[s.key].splice(s.index,0,n),r}function Ul(e,t){let n=e;for(const r of t){if(n=n[r.key],!n)return;n=n[r.index]}return n}function Gt(e,t){let n=e;const r=t[t.length-1];for(const o of t)o!==r&&(n=n[o.key][o.index]);const i=n[r.key].splice(r.index,1)[0];if(!i)throw new Error("popAtEntryPath failed");return i}function ms(e,t){const n={},r=Array.isArray(t)?t:[t];for(const s of r)rn(s,(i,o,c)=>{if(i.id){const a=i.id,l=e.generateNonConflictingId(a);i.id=l,n[a]=l}});for(const s of r)rn(s,(i,o,c)=>{i instanceof Ke&&(i.scope in n&&(i.scope=n[i.scope]),i.childId in n&&(i.childId=n[i.childId])),i instanceof Er&&i.field in n&&(i.field=n[i.field])})}function vs(e,t,n){if(e.isCatalogue()){if(n)switch(t){case"sharedRules":case"rules":return["sharedRules","rules"].includes(n)?n:"";case"sharedProfiles":case"profiles":return["sharedProfiles","profiles"].includes(n)?n:"";case"sharedInfoGroups":case"infoGroups":return["sharedInfoGroups","infoGroups"].includes(n)?n:"";case"sharedSelectionEntries":case"selectionEntries":return["sharedSelectionEntries","selectionEntries"].includes(n)?n:"";case"sharedSelectionEntryGroups":case"selectionEntryGroups":return["sharedSelectionEntryGroups","selectionEntryGroups"].includes(n)?n:"";default:return t}}else switch(t){case"sharedRules":return"rules";case"sharedProfiles":return"profiles";case"sharedInfoGroups":return"infoGroups";case"sharedSelectionEntries":return"selectionEntries";case"sharedSelectionEntryGroups":return"selectionEntryGroups";default:return t}return t}class gc{get[Symbol.toStringTag](){return"ObjectNoObserve"}}function yc(){return new gc}const mc={};function vc(e,t,n){if(t in e)return e[t];const r=class extends R{get parentKey(){return t}get editorTypeName(){return Se(t,this)}toString(){return`${this.editorTypeName} - ${this.getName()}`}};return r.prototype.parentKey,Object.setPrototypeOf(r.prototype,Object.getPrototypeOf(n)),e[t]=r.prototype,r.prototype}function bc(e,t,n){Object.setPrototypeOf(n,vc(e,t,n))}const Dt={"*":R.prototype,catalogue:nn.prototype,catalogueLinks:Ir.prototype,gameSystem:nn.prototype,forceEntries:In.prototype,forces:In.prototype,force:In.prototype,categoryEntries:pt.prototype,category:pt.prototype,categories:pt.prototype,link:et.prototype,infoLinks:eo.prototype,categoryLinks:Bs.prototype,entry:_n.prototype,selectionEntries:_n.prototype,entryLinks:et.prototype,sharedSelectionEntries:_n.prototype,group:En.prototype,selectionEntryGroups:En.prototype,sharedSelectionEntryGroups:En.prototype,sharedRules:qt.prototype,rules:qt.prototype,rule:qt.prototype,profileTypes:no.prototype,sharedProfiles:gt.prototype,profiles:gt.prototype,profile:gt.prototype,characteristics:Hr.prototype,characteristic:Hr.prototype,characteristicTypes:R.prototype,characteristicType:R.prototype,sharedInfoGroups:Sn.prototype,infoGroups:Sn.prototype,infoGroup:Sn.prototype,publications:Qr.prototype,publication:Qr.prototype,repeats:Ke.prototype,conditions:Ke.prototype,constraints:Kn.prototype,modifiers:Er.prototype,modifierGroups:Fs.prototype};Object.values(Dt);function wc(e){return e in Dt?Dt[e]:Dt["*"]}function Dn(e,t){const n=wc(t);return n&&(Object.setPrototypeOf(e,n),e.post_init&&e.post_init(),globalThis.isEditor&&bc(e.keyInfoCache||mc,t,e)),e}function Ce(e){const t=[e];for(;t.length;){const n=t.pop();for(const r of Object.keys(n)){const s=n[r];if(ee(s))if(Array.isArray(s)){if(s.length&&ee(s[0]))for(let i=s.length;i--;){const o=s[i];Vr(o)&&(Dn(o,r),t.push(o))}}else Vr(s)&&(Dn(s,r),t.push(s))}}}const bs=wr("catalogues",{state:()=>({dict:{},version:1}),persist:{storage:globalThis.localStorage},actions:{get(e){return e in this.dict||(this.dict[e]={}),this.dict[e]},setEdited(e,t){this.get(e).edited=t},getEdited(e){return this.get(e).edited},setErrors(e,t){this.get(e).errors=t},getErrors(e){return this.get(e).errors},getDependents(e){return this.get(e).dependents},updateCatalogue(e){var s;const t=e.id,n=e.gameSystemId||e.id,r=(s=e.catalogueLinks)==null?void 0:s.map(i=>({targetId:i.targetId===n?n:`${n}-${i.targetId}`,sourceId:t===n?n:`${n}-${t}`,importRootEntries:i.importRootEntries,sourceName:e.name}));e.gameSystemId&&(r==null||r.push({targetId:e.gameSystemId,sourceId:t,importRootEntries:!0,sourceName:e.name})),this.setDependencies(t,r)},setDependencies(e,t){var r;const n=(r=this.get(e))==null?void 0:r.dependencies;if(n)for(const s of n)this.removeDependent(s.targetId,s);if(t)for(const s of t)this.addDependent(s.targetId,s);this.get(e).dependencies=t||[]},setDependents(e,t){this.get(e).dependents=t},addDependent(e,t){const n=this.get(e);n.dependents||(n.dependents=[]),n.dependents.push(t)},removeDependent(e,t){var r;const n=(r=this.get(e))==null?void 0:r.dependents;if(n){const s=n.findIndex(i=>i.sourceId===t.sourceId);s>=0&&n.splice(s,1)}}}});function Tr(e){return e.replaceAll("\\","/").split("/").slice(0,-1).join("/")}function Pr(e){const t=e.replaceAll("\\","/").split("/");return t[t.length-1]}async function ri(e){return electron?await electron.invoke("getFolderFiles",e):[]}async function _c(e){if(electron)try{const t=[];if(!await electron.invoke("isDirectory",e))return[];const r=await electron.invoke("readdirSync",e);for(const s of r){const i=`${e}/${s}`;try{if(await electron.invoke("isDirectory",i)){const c={name:s,path:i};t.push(c)}}catch(o){console.error("Error reading dir:",i,o);continue}}return t}catch(t){throw console.error("Error:",t),t}}async function Jn(e,t){if(!electron)return;const n=Tr(e);await electron.invoke("mkdirSync",n,{recursive:!0}),await electron.invoke("writeFileSync",e,t)}async function Ec(e){if(electron)return await electron.invoke("unlinkSync",e)}async function kc(e){if(electron)return await electron.invoke("getFile",e)}async function Ic(e){if(electron)return electron.invoke("showOpenDialog",e)}async function xc(e){if(electron)return electron.invoke("showMessageBoxSync",e)}async function Sc(){if(electron)return electron.invoke("closeWindow")}async function Cc(e){if(electron)return await electron.invoke("getPath",e)}async function si(e){electron&&await electron.invoke("mkdirSync",e,{recursive:!0})}let ws=!1;const Hn={};async function ii(e,t){electron&&(ws||(ws=!0,electron.on("fileChanged",(n,r,s)=>{const i=Hn[r];i&&i(r,s)})),await electron.invoke("chokidarWatchFile",e),Hn[e]=t)}async function Nc(e){electron&&(delete Hn[e],await electron.invoke("chokidarUnwatchFile",e))}async function oi(e){return electron?await electron.invoke("getFolderRemote",e):null}const Oc=Object.freeze(Object.defineProperty({__proto__:null,closeWindow:Sc,createFolder:si,deleteFile:Ec,dirname:Tr,filename:Pr,getFolderFiles:ri,getFolderFolders:_c,getFolderRemote:oi,getPath:Cc,readFile:kc,showMessageBox:xc,showOpenDialog:Ic,unwatchFile:Nc,watchFile:ii,writeFile:Jn},Symbol.toStringTag,{value:"Module"})),Ac={showImported:!1,ignoreProfilesRules:!1,filter:"",scroll:0,selection:void 0,mode:"edit"},An=wr("editor-ui",{state:()=>({catalogues:{}}),persist:{storage:globalThis.localStorage},actions:{collapse_level(e){var t;if(e>=0){const n=`depth-${e} collapsible-box opened`,r=document.documentElement.getElementsByClassName(n);if(r!=null&&r.length)for(const s of r)(t=ve(s))==null||t.close()}},collapse_all(){this.collapse_level(1),this.collapse_level(0)},collapse_deepest(){const e="collapsible-box opened",t=document.documentElement.getElementsByClassName(e);let n=-1;if(t!=null&&t.length)for(const r of t)r.classList.forEach(s=>{s.startsWith("depth-")&&(n=Math.max(n,parseInt(s.split("-")[1])))});this.collapse_level(n)},set_state(e,t){function n(i,o,c=0){const a=`depth-${c} collapsible-box opened`,l=i.getElementsByClassName(a);if(l!=null&&l.length)for(const u of l){const f=Ne(ve(u)),d=f.parentKey,h=f.parent;let y=o;if(h){const p=h[d];if(!p||!Array.isArray(p))continue;const g=p.indexOf(f);d in o||(o[d]={});const m=o[d];g in m||(m[g]={}),y=m[g]}else{const p=[...u.classList].filter(g=>st.has(g));for(const g of p)o[g]={},o[g][0]={},y=o[g][0]}n(u,y,c+1)}}const r={};n(document.documentElement,r);const s={...t,open:r};return this.$state.catalogues[e]=s,r},get_data(e){const t=this.$state.catalogues[e];return t||{}},get_root(e,t){let n=this.$state.catalogues[e];return!(!n||(n=n.open[t],!n))},get(e,t){if(!t.length)return!1;let n=this.$state.catalogues[e];if(!n)return!1;let r=n.open[t[0].key];if(!r||(r=r[0],!r))return!1;for(const s of t){const i=r[s.key];if(!i)return!1;const o=i[s.index];if(!o)return!1;r=o}return!0}}}),G=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,M=Object.keys,V=Array.isArray;function H(e,t){return typeof t!="object"||M(t).forEach(function(n){e[n]=t[n]}),e}typeof Promise>"u"||G.Promise||(G.Promise=Promise);const St=Object.getPrototypeOf,Tc={}.hasOwnProperty;function Z(e,t){return Tc.call(e,t)}function rt(e,t){typeof t=="function"&&(t=t(St(e))),(typeof Reflect>"u"?M:Reflect.ownKeys)(t).forEach(n=>{le(e,n,t[n])})}const ai=Object.defineProperty;function le(e,t,n,r){ai(e,t,H(n&&Z(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function Ye(e){return{from:function(t){return e.prototype=Object.create(t.prototype),le(e.prototype,"constructor",e),{extend:rt.bind(null,e.prototype)}}}}const Pc=Object.getOwnPropertyDescriptor;function Lr(e,t){let n;return Pc(e,t)||(n=St(e))&&Lr(n,t)}const Lc=[].slice;function sn(e,t,n){return Lc.call(e,t,n)}function ci(e,t){return t(e)}function dt(e){if(!e)throw new Error("Assertion Failed")}function li(e){G.setImmediate?setImmediate(e):setTimeout(e,0)}function ui(e,t){return e.reduce((n,r,s)=>{var i=t(r,s);return i&&(n[i[0]]=i[1]),n},{})}function ue(e,t){if(Z(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],r=0,s=t.length;r<s;++r){var i=ue(e,t[r]);n.push(i)}return n}var o=t.indexOf(".");if(o!==-1){var c=e[t.substr(0,o)];return c===void 0?void 0:ue(c,t.substr(o+1))}}function te(e,t,n){if(e&&t!==void 0&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){dt(typeof n!="string"&&"length"in n);for(var r=0,s=t.length;r<s;++r)te(e,t[r],n[r])}else{var i=t.indexOf(".");if(i!==-1){var o=t.substr(0,i),c=t.substr(i+1);if(c==="")n===void 0?V(e)&&!isNaN(parseInt(o))?e.splice(o,1):delete e[o]:e[o]=n;else{var a=e[o];a&&Z(e,o)||(a=e[o]={}),te(a,c,n)}}else n===void 0?V(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function fi(e){var t={};for(var n in e)Z(e,n)&&(t[n]=e[n]);return t}const $c=[].concat;function di(e){return $c.apply([],e)}const hi="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(di([8,16,32,64].map(e=>["Int","Uint","Float"].map(t=>t+e+"Array")))).filter(e=>G[e]),Gc=hi.map(e=>G[e]);ui(hi,e=>[e,!0]);let me=null;function Pt(e){me=typeof WeakMap<"u"&&new WeakMap;const t=Xn(e);return me=null,t}function Xn(e){if(!e||typeof e!="object")return e;let t=me&&me.get(e);if(t)return t;if(V(e)){t=[],me&&me.set(e,t);for(var n=0,r=e.length;n<r;++n)t.push(Xn(e[n]))}else if(Gc.indexOf(e.constructor)>=0)t=e;else{const i=St(e);for(var s in t=i===Object.prototype?{}:Object.create(i),me&&me.set(e,t),e)Z(e,s)&&(t[s]=Xn(e[s]))}return t}const{toString:Rc}={};function Yn(e){return Rc.call(e).slice(8,-1)}const Qn=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Bc=typeof Qn=="symbol"?function(e){var t;return e!=null&&(t=e[Qn])&&t.apply(e)}:function(){return null},He={};function ae(e){var t,n,r,s;if(arguments.length===1){if(V(e))return e.slice();if(this===He&&typeof e=="string")return[e];if(s=Bc(e)){for(n=[];!(r=s.next()).done;)n.push(r.value);return n}if(e==null)return[e];if(typeof(t=e.length)=="number"){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}const $r=typeof Symbol<"u"?e=>e[Symbol.toStringTag]==="AsyncFunction":()=>!1;var se=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function pi(e,t){se=e,gi=t}var gi=()=>!0;const Fc=!new Error("").stack;function ze(){if(Fc)try{throw ze.arguments,new Error}catch(e){return e}return new Error}function Zn(e,t){var n=e.stack;return n?(t=t||0,n.indexOf(e.name)===0&&(t+=(e.name+e.message).split(`
`).length),n.split(`
`).slice(t).filter(gi).map(r=>`
`+r).join("")):""}var yi=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Gr=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(yi),Kc={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Qe(e,t){this._e=ze(),this.name=e,this.message=t}function mi(e,t){return e+". Errors: "+Object.keys(t).map(n=>t[n].toString()).filter((n,r,s)=>s.indexOf(n)===r).join(`
`)}function on(e,t,n,r){this._e=ze(),this.failures=t,this.failedKeys=r,this.successCount=n,this.message=mi(e,t)}function bt(e,t){this._e=ze(),this.name="BulkError",this.failures=Object.keys(t).map(n=>t[n]),this.failuresByPos=t,this.message=mi(e,t)}Ye(Qe).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Zn(this._e,2))}},toString:function(){return this.name+": "+this.message}}),Ye(on).from(Qe),Ye(bt).from(Qe);var Rr=Gr.reduce((e,t)=>(e[t]=t+"Error",e),{});const Mc=Qe;var O=Gr.reduce((e,t)=>{var n=t+"Error";function r(s,i){this._e=ze(),this.name=n,s?typeof s=="string"?(this.message=`${s}${i?`
 `+i:""}`,this.inner=i||null):typeof s=="object"&&(this.message=`${s.name} ${s.message}`,this.inner=s):(this.message=Kc[t]||n,this.inner=null)}return Ye(r).from(Mc),e[t]=r,e},{});O.Syntax=SyntaxError,O.Type=TypeError,O.Range=RangeError;var _s=yi.reduce((e,t)=>(e[t+"Error"]=O[t],e),{}),Jt=Gr.reduce((e,t)=>(["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=O[t]),e),{});function L(){}function Ct(e){return e}function Uc(e,t){return e==null||e===Ct?t:function(n){return t(e(n))}}function Me(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function zc(e,t){return e===L?t:function(){var n=e.apply(this,arguments);n!==void 0&&(arguments[0]=n);var r=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var i=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Me(r,this.onsuccess):r),s&&(this.onerror=this.onerror?Me(s,this.onerror):s),i!==void 0?i:n}}function qc(e,t){return e===L?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Me(n,this.onsuccess):n),r&&(this.onerror=this.onerror?Me(r,this.onerror):r)}}function jc(e,t){return e===L?t:function(n){var r=e.apply(this,arguments);H(n,r);var s=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=t.apply(this,arguments);return s&&(this.onsuccess=this.onsuccess?Me(s,this.onsuccess):s),i&&(this.onerror=this.onerror?Me(i,this.onerror):i),r===void 0?o===void 0?void 0:o:H(r,o)}}function Wc(e,t){return e===L?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function Br(e,t){return e===L?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,s=arguments.length,i=new Array(s);s--;)i[s]=arguments[s];return n.then(function(){return t.apply(r,i)})}return t.apply(this,arguments)}}Jt.ModifyError=on,Jt.DexieError=Qe,Jt.BulkError=bt;var Nt={};const[er,an,tr]=typeof Promise>"u"?[]:(()=>{let e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,St(e),e];const t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,St(t),e]})(),vi=an&&an.then,Ht=er&&er.constructor,Fr=!!tr;var nr=!1,Vc=tr?()=>{tr.then(Rt)}:G.setImmediate?setImmediate.bind(null,Rt):G.MutationObserver?()=>{var e=document.createElement("div");new MutationObserver(()=>{Rt(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:()=>{setTimeout(Rt,0)},wt=function(e,t){ht.push([e,t]),cn&&(Vc(),cn=!1)},rr=!0,cn=!0,Re=[],Xt=[],sr=null,ir=Ct,Ze={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:ks,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(e=>{try{ks(e[0],e[1])}catch{}})}},C=Ze,ht=[],Be=0,Yt=[];function x(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=L,this._lib=!1;var t=this._PSD=C;if(se&&(this._stackHolder=ze(),this._prev=null,this._numPrev=0),typeof e!="function"){if(e!==Nt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&ar(this,this._value))}this._state=null,this._value=null,++t.ref,wi(this,e)}const or={get:function(){var e=C,t=ln;function n(r,s){var i=!e.global&&(e!==C||t!==ln);const o=i&&!fe();var c=new x((a,l)=>{Kr(this,new bi(un(r,e,i,o),un(s,e,i,o),a,l,e))});return se&&ki(c,this),c}return n.prototype=Nt,n},set:function(e){le(this,"then",e&&e.prototype===Nt?or:{get:function(){return e},set:or.set})}};function bi(e,t,n,r,s){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=r,this.psd=s}function wi(e,t){try{t(n=>{if(e._state===null){if(n===e)throw new TypeError("A promise cannot be resolved with itself.");var r=e._lib&&Lt();n&&typeof n.then=="function"?wi(e,(s,i)=>{n instanceof x?n._then(s,i):n.then(s,i)}):(e._state=!0,e._value=n,_i(e)),r&&$t()}},ar.bind(null,e))}catch(n){ar(e,n)}}function ar(e,t){if(Xt.push(t),e._state===null){var n=e._lib&&Lt();t=ir(t),e._state=!1,e._value=t,se&&t!==null&&typeof t=="object"&&!t._promise&&function(r,s,i){try{r.apply(null,i)}catch(o){s&&s(o)}}(()=>{var r=Lr(t,"stack");t._promise=e,le(t,"stack",{get:()=>nr?r&&(r.get?r.get.apply(t):r.value):e.stack})}),function(r){Re.some(s=>s._value===r._value)||Re.push(r)}(e),_i(e),n&&$t()}}function _i(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)Kr(e,t[n]);var s=e._PSD;--s.ref||s.finalize(),Be===0&&(++Be,wt(()=>{--Be==0&&Mr()},[]))}function Kr(e,t){if(e._state!==null){var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Be,wt(Dc,[n,e,t])}else e._listeners.push(t)}function Dc(e,t,n){try{sr=t;var r,s=t._value;t._state?r=e(s):(Xt.length&&(Xt=[]),r=e(s),Xt.indexOf(s)===-1&&function(i){for(var o=Re.length;o;)if(Re[--o]._value===i._value)return void Re.splice(o,1)}(t)),n.resolve(r)}catch(i){n.reject(i)}finally{sr=null,--Be==0&&Mr(),--n.psd.ref||n.psd.finalize()}}function Ei(e,t,n){if(t.length===n)return t;var r="";if(e._state===!1){var s,i,o=e._value;o!=null?(s=o.name||"Error",i=o.message||o,r=Zn(o,0)):(s=o,i=""),t.push(s+(i?": "+i:"")+r)}return se&&((r=Zn(e._stackHolder,2))&&t.indexOf(r)===-1&&t.push(r),e._prev&&Ei(e._prev,t,n)),t}function ki(e,t){var n=t?t._numPrev+1:0;n<100&&(e._prev=t,e._numPrev=n)}function Rt(){Lt()&&$t()}function Lt(){var e=rr;return rr=!1,cn=!1,e}function $t(){var e,t,n;do for(;ht.length>0;)for(e=ht,ht=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}while(ht.length>0);rr=!0,cn=!0}function Mr(){var e=Re;Re=[],e.forEach(r=>{r._PSD.onunhandled.call(null,r._value,r)});for(var t=Yt.slice(0),n=t.length;n;)t[--n]()}function Bt(e){return new x(Nt,!1,e)}function B(e,t){var n=C;return function(){var r=Lt(),s=C;try{return we(n,!0),e.apply(this,arguments)}catch(i){t&&t(i)}finally{we(s,!1),r&&$t()}}}rt(x.prototype,{then:or,_then:function(e,t){Kr(this,new bi(null,null,e,t,C))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=arguments[0],n=arguments[1];return typeof t=="function"?this.then(null,r=>r instanceof t?n(r):Bt(r)):this.then(null,r=>r&&r.name===t?n(r):Bt(r))},finally:function(e){return this.then(t=>(e(),t),t=>(e(),Bt(t)))},stack:{get:function(){if(this._stack)return this._stack;try{nr=!0;var e=Ei(this,[],20).join(`
From previous: `);return this._state!==null&&(this._stack=e),e}finally{nr=!1}}},timeout:function(e,t){return e<1/0?new x((n,r)=>{var s=setTimeout(()=>r(new O.Timeout(t)),e);this.then(n,r).finally(clearTimeout.bind(null,s))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&le(x.prototype,Symbol.toStringTag,"Dexie.Promise"),Ze.env=Ii(),rt(x,{all:function(){var e=ae.apply(null,arguments).map(Ft);return new x(function(t,n){e.length===0&&t([]);var r=e.length;e.forEach((s,i)=>x.resolve(s).then(o=>{e[i]=o,--r||t(e)},n))})},resolve:e=>{if(e instanceof x)return e;if(e&&typeof e.then=="function")return new x((n,r)=>{e.then(n,r)});var t=new x(Nt,!0,e);return ki(t,sr),t},reject:Bt,race:function(){var e=ae.apply(null,arguments).map(Ft);return new x((t,n)=>{e.map(r=>x.resolve(r).then(t,n))})},PSD:{get:()=>C,set:e=>C=e},totalEchoes:{get:()=>ln},newPSD:be,usePSD:ot,scheduler:{get:()=>wt,set:e=>{wt=e}},rejectionMapper:{get:()=>ir,set:e=>{ir=e}},follow:(e,t)=>new x((n,r)=>be((s,i)=>{var o=C;o.unhandleds=[],o.onunhandled=i,o.finalize=Me(function(){(function(c){function a(){c(),Yt.splice(Yt.indexOf(a),1)}Yt.push(a),++Be,wt(()=>{--Be==0&&Mr()},[])})(()=>{this.unhandleds.length===0?s():i(this.unhandleds[0])})},o.finalize),e()},t,n,r))}),Ht&&(Ht.allSettled&&le(x,"allSettled",function(){const e=ae.apply(null,arguments).map(Ft);return new x(t=>{e.length===0&&t([]);let n=e.length;const r=new Array(n);e.forEach((s,i)=>x.resolve(s).then(o=>r[i]={status:"fulfilled",value:o},o=>r[i]={status:"rejected",reason:o}).then(()=>--n||t(r)))})}),Ht.any&&typeof AggregateError<"u"&&le(x,"any",function(){const e=ae.apply(null,arguments).map(Ft);return new x((t,n)=>{e.length===0&&n(new AggregateError([]));let r=e.length;const s=new Array(r);e.forEach((i,o)=>x.resolve(i).then(c=>t(c),c=>{s[o]=c,--r||n(new AggregateError(s))}))})}));const W={awaits:0,echoes:0,id:0};var Jc=0,Qt=[],Tn=0,ln=0,Hc=0;function be(e,t,n,r){var s=C,i=Object.create(s);i.parent=s,i.ref=0,i.global=!1,i.id=++Hc;var o=Ze.env;i.env=Fr?{Promise:x,PromiseProp:{value:x,configurable:!0,writable:!0},all:x.all,race:x.race,allSettled:x.allSettled,any:x.any,resolve:x.resolve,reject:x.reject,nthen:Es(o.nthen,i),gthen:Es(o.gthen,i)}:{},t&&H(i,t),++s.ref,i.finalize=function(){--this.parent.ref||this.parent.finalize()};var c=ot(i,e,n,r);return i.ref===0&&i.finalize(),c}function it(){return W.id||(W.id=++Jc),++W.awaits,W.echoes+=100,W.id}function fe(){return!!W.awaits&&(--W.awaits==0&&(W.id=0),W.echoes=100*W.awaits,!0)}function Ft(e){return W.echoes&&e&&e.constructor===Ht?(it(),e.then(t=>(fe(),t),t=>(fe(),q(t)))):e}function Xc(e){++ln,W.echoes&&--W.echoes!=0||(W.echoes=W.id=0),Qt.push(C),we(e,!0)}function Yc(){var e=Qt[Qt.length-1];Qt.pop(),we(e,!1)}function we(e,t){var n=C;if((t?!W.echoes||Tn++&&e===C:!Tn||--Tn&&e===C)||xi(t?Xc.bind(null,e):Yc),e!==C&&(C=e,n===Ze&&(Ze.env=Ii()),Fr)){var r=Ze.env.Promise,s=e.env;an.then=s.nthen,r.prototype.then=s.gthen,(n.global||e.global)&&(Object.defineProperty(G,"Promise",s.PromiseProp),r.all=s.all,r.race=s.race,r.resolve=s.resolve,r.reject=s.reject,s.allSettled&&(r.allSettled=s.allSettled),s.any&&(r.any=s.any))}}function Ii(){var e=G.Promise;return Fr?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(G,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:an.then,gthen:e.prototype.then}:{}}function ot(e,t,n,r,s){var i=C;try{return we(e,!0),t(n,r,s)}finally{we(i,!1)}}function xi(e){vi.call(er,e)}function un(e,t,n,r){return typeof e!="function"?e:function(){var s=C;n&&it(),we(t,!0);try{return e.apply(this,arguments)}finally{we(s,!1),r&&xi(fe)}}}function Es(e,t){return function(n,r){return e.call(this,un(n,t),un(r,t))}}(""+vi).indexOf("[native code]")===-1&&(it=fe=L);function ks(e,t){var n;try{n=t.onuncatched(e)}catch{}if(n!==!1)try{var r,s={promise:t,reason:e};if(G.document&&document.createEvent?((r=document.createEvent("Event")).initEvent("unhandledrejection",!0,!0),H(r,s)):G.CustomEvent&&H(r=new CustomEvent("unhandledrejection",{detail:s}),s),r&&G.dispatchEvent&&(dispatchEvent(r),!G.PromiseRejectionEvent&&G.onunhandledrejection))try{G.onunhandledrejection(r)}catch{}se&&r&&!r.defaultPrevented&&console.warn(`Unhandled rejection: ${e.stack||e}`)}catch{}}var q=x.reject;function cr(e,t,n,r){if(e.idbdb&&(e._state.openComplete||C.letThrough||e._vip)){var s=e._createTransaction(t,n,e._dbSchema);try{s.create(),e._state.PR1398_maxLoop=3}catch(i){return i.name===Rr.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(()=>cr(e,t,n,r))):q(i)}return s._promise(t,(i,o)=>be(()=>(C.trans=s,r(i,o,s)))).then(i=>s._completion.then(()=>i))}if(e._state.openComplete)return q(new O.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return q(new O.DatabaseClosed);e.open().catch(L)}return e._state.dbReadyPromise.then(()=>cr(e,t,n,r))}const Le=String.fromCharCode(65535),ie="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",_t=[],yn=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Qc=yn,Zc=yn,Si=e=>!/(dexie\.js|dexie\.min\.js)/.test(e);function Ue(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}const Ci={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Kt(e){return typeof e!="string"||/\./.test(e)?t=>t:t=>(t[e]===void 0&&e in t&&delete(t=Pt(t))[e],t)}class el{_trans(t,n,r){const s=this._tx||C.trans,i=this.name;function o(a,l,u){if(!u.schema[i])throw new O.NotFound("Table "+i+" not part of transaction");return n(u.idbtrans,u)}const c=Lt();try{return s&&s.db===this.db?s===C.trans?s._promise(t,o,r):be(()=>s._promise(t,o,r),{trans:s,transless:C.transless||C}):cr(this.db,t,[this.name],o)}finally{c&&$t()}}get(t,n){return t&&t.constructor===Object?this.where(t).first(n):this._trans("readonly",r=>this.core.get({trans:r,key:t}).then(s=>this.hook.reading.fire(s))).then(n)}where(t){if(typeof t=="string")return new this.db.WhereClause(this,t);if(V(t))return new this.db.WhereClause(this,`[${t.join("+")}]`);const n=M(t);if(n.length===1)return this.where(n[0]).equals(t[n[0]]);const r=this.schema.indexes.concat(this.schema.primKey).filter(l=>l.compound&&n.every(u=>l.keyPath.indexOf(u)>=0)&&l.keyPath.every(u=>n.indexOf(u)>=0))[0];if(r&&this.db._maxKey!==Le)return this.where(r.name).equals(r.keyPath.map(l=>t[l]));!r&&se&&console.warn(`The query ${JSON.stringify(t)} on ${this.name} would benefit of a compound index [${n.join("+")}]`);const{idxByName:s}=this.schema,i=this.db._deps.indexedDB;function o(l,u){try{return i.cmp(l,u)===0}catch{return!1}}const[c,a]=n.reduce(([l,u],f)=>{const d=s[f],h=t[f];return[l||d,l||!d?Ue(u,d&&d.multi?y=>{const p=ue(y,f);return V(p)&&p.some(g=>o(h,g))}:y=>o(h,ue(y,f))):u]},[null,null]);return c?this.where(c.name).equals(t[c.keyPath]).filter(a):r?this.filter(a):this.where(n).equals("")}filter(t){return this.toCollection().and(t)}count(t){return this.toCollection().count(t)}offset(t){return this.toCollection().offset(t)}limit(t){return this.toCollection().limit(t)}each(t){return this.toCollection().each(t)}toArray(t){return this.toCollection().toArray(t)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(t){return new this.db.Collection(new this.db.WhereClause(this,V(t)?`[${t.join("+")}]`:t))}reverse(){return this.toCollection().reverse()}mapToClass(t){this.schema.mappedClass=t;const n=r=>{if(!r)return r;const s=Object.create(t.prototype);for(var i in r)if(Z(r,i))try{s[i]=r[i]}catch{}return s};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=n,this.hook("reading",n),t}defineClass(){return this.mapToClass(function(t){H(this,t)})}add(t,n){const{auto:r,keyPath:s}=this.schema.primKey;let i=t;return s&&r&&(i=Kt(s)(t)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"add",keys:n!=null?[n]:null,values:[i]})).then(o=>o.numFailures?x.reject(o.failures[0]):o.lastResult).then(o=>{if(s)try{te(t,s,o)}catch{}return o})}update(t,n){if(typeof t!="object"||V(t))return this.where(":id").equals(t).modify(n);{const r=ue(t,this.schema.primKey.keyPath);if(r===void 0)return q(new O.InvalidArgument("Given object does not contain its primary key"));try{typeof n!="function"?M(n).forEach(s=>{te(t,s,n[s])}):n(t,{value:t,primKey:r})}catch{}return this.where(":id").equals(r).modify(n)}}put(t,n){const{auto:r,keyPath:s}=this.schema.primKey;let i=t;return s&&r&&(i=Kt(s)(t)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"put",values:[i],keys:n!=null?[n]:null})).then(o=>o.numFailures?x.reject(o.failures[0]):o.lastResult).then(o=>{if(s)try{te(t,s,o)}catch{}return o})}delete(t){return this._trans("readwrite",n=>this.core.mutate({trans:n,type:"delete",keys:[t]})).then(n=>n.numFailures?x.reject(n.failures[0]):void 0)}clear(){return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"deleteRange",range:Ci})).then(t=>t.numFailures?x.reject(t.failures[0]):void 0)}bulkGet(t){return this._trans("readonly",n=>this.core.getMany({keys:t,trans:n}).then(r=>r.map(s=>this.hook.reading.fire(s))))}bulkAdd(t,n,r){const s=Array.isArray(n)?n:void 0,i=(r=r||(s?void 0:n))?r.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&s)throw new O.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(s&&s.length!==t.length)throw new O.InvalidArgument("Arguments objects and keys must have the same length");const l=t.length;let u=a&&c?t.map(Kt(a)):t;return this.core.mutate({trans:o,type:"add",keys:s,values:u,wantResults:i}).then(({numFailures:f,results:d,lastResult:h,failures:y})=>{if(f===0)return i?d:h;throw new bt(`${this.name}.bulkAdd(): ${f} of ${l} operations failed`,y)})})}bulkPut(t,n,r){const s=Array.isArray(n)?n:void 0,i=(r=r||(s?void 0:n))?r.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&s)throw new O.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(s&&s.length!==t.length)throw new O.InvalidArgument("Arguments objects and keys must have the same length");const l=t.length;let u=a&&c?t.map(Kt(a)):t;return this.core.mutate({trans:o,type:"put",keys:s,values:u,wantResults:i}).then(({numFailures:f,results:d,lastResult:h,failures:y})=>{if(f===0)return i?d:h;throw new bt(`${this.name}.bulkPut(): ${f} of ${l} operations failed`,y)})})}bulkDelete(t){const n=t.length;return this._trans("readwrite",r=>this.core.mutate({trans:r,type:"delete",keys:t})).then(({numFailures:r,lastResult:s,failures:i})=>{if(r===0)return s;throw new bt(`${this.name}.bulkDelete(): ${r} of ${n} operations failed`,i)})}}function Et(e){var t={},n=function(c,a){if(a){for(var l=arguments.length,u=new Array(l-1);--l;)u[l-1]=arguments[l];return t[c].subscribe.apply(null,u),e}if(typeof c=="string")return t[c]};n.addEventType=i;for(var r=1,s=arguments.length;r<s;++r)i(arguments[r]);return n;function i(c,a,l){if(typeof c=="object")return o(c);a||(a=Wc),l||(l=L);var u={subscribers:[],fire:l,subscribe:function(f){u.subscribers.indexOf(f)===-1&&(u.subscribers.push(f),u.fire=a(u.fire,f))},unsubscribe:function(f){u.subscribers=u.subscribers.filter(function(d){return d!==f}),u.fire=u.subscribers.reduce(a,l)}};return t[c]=n[c]=u,u}function o(c){M(c).forEach(function(a){var l=c[a];if(V(l))i(a,c[a][0],c[a][1]);else{if(l!=="asap")throw new O.InvalidArgument("Invalid event config");var u=i(a,Ct,function(){for(var f=arguments.length,d=new Array(f);f--;)d[f]=arguments[f];u.subscribers.forEach(function(h){li(function(){h.apply(null,d)})})})}})}}function ft(e,t){return Ye(t).from({prototype:e}),t}function Ve(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Pn(e,t){e.filter=Ue(e.filter,t)}function Ln(e,t,n){var r=e.replayFilter;e.replayFilter=r?()=>Ue(r(),t()):t,e.justLimit=n&&!r}function Zt(e,t){if(e.isPrimKey)return t.primaryKey;const n=t.getIndexByKeyPath(e.index);if(!n)throw new O.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Is(e,t,n){const r=Zt(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:r,range:e.range}})}function Mt(e,t,n,r){const s=e.replayFilter?Ue(e.filter,e.replayFilter()):e.filter;if(e.or){const i={},o=(c,a,l)=>{if(!s||s(a,l,d=>a.stop(d),d=>a.fail(d))){var u=a.primaryKey,f=""+u;f==="[object ArrayBuffer]"&&(f=""+new Uint8Array(u)),Z(i,f)||(i[f]=!0,t(c,a,l))}};return Promise.all([e.or._iterate(o,n),xs(Is(e,r,n),e.algorithm,o,!e.keysOnly&&e.valueMapper)])}return xs(Is(e,r,n),Ue(e.algorithm,s),t,!e.keysOnly&&e.valueMapper)}function xs(e,t,n,r){var s=B(r?(i,o,c)=>n(r(i),o,c):n);return e.then(i=>{if(i)return i.start(()=>{var o=()=>i.continue();t&&!t(i,c=>o=c,c=>{i.stop(c),o=L},c=>{i.fail(c),o=L})||s(i.value,i,c=>o=c),o()})})}function J(e,t){try{const n=Ss(e),r=Ss(t);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return function(s,i){const o=s.length,c=i.length,a=o<c?o:c;for(let l=0;l<a;++l)if(s[l]!==i[l])return s[l]<i[l]?-1:1;return o===c?0:o<c?-1:1}(Cs(e),Cs(t));case"Array":return function(s,i){const o=s.length,c=i.length,a=o<c?o:c;for(let l=0;l<a;++l){const u=J(s[l],i[l]);if(u!==0)return u}return o===c?0:o<c?-1:1}(e,t)}}catch{}return NaN}function Ss(e){const t=typeof e;if(t!=="object")return t;if(ArrayBuffer.isView(e))return"binary";const n=Yn(e);return n==="ArrayBuffer"?"binary":n}function Cs(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}class tl{_read(t,n){var r=this._ctx;return r.error?r.table._trans(null,q.bind(null,r.error)):r.table._trans("readonly",t).then(n)}_write(t){var n=this._ctx;return n.error?n.table._trans(null,q.bind(null,n.error)):n.table._trans("readwrite",t,"locked")}_addAlgorithm(t){var n=this._ctx;n.algorithm=Ue(n.algorithm,t)}_iterate(t,n){return Mt(this._ctx,t,n,this._ctx.table.core)}clone(t){var n=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return t&&H(r,t),n._ctx=r,n}raw(){return this._ctx.valueMapper=null,this}each(t){var n=this._ctx;return this._read(r=>Mt(n,t,r,n.table.core))}count(t){return this._read(n=>{const r=this._ctx,s=r.table.core;if(Ve(r,!0))return s.count({trans:n,query:{index:Zt(r,s.schema),range:r.range}}).then(o=>Math.min(o,r.limit));var i=0;return Mt(r,()=>(++i,!1),n,s).then(()=>i)}).then(t)}sortBy(t,n){const r=t.split(".").reverse(),s=r[0],i=r.length-1;function o(l,u){return u?o(l[r[u]],u-1):l[s]}var c=this._ctx.dir==="next"?1:-1;function a(l,u){var f=o(l,i),d=o(u,i);return f<d?-c:f>d?c:0}return this.toArray(function(l){return l.sort(a)}).then(n)}toArray(t){return this._read(n=>{var r=this._ctx;if(r.dir==="next"&&Ve(r,!0)&&r.limit>0){const{valueMapper:s}=r,i=Zt(r,r.table.core.schema);return r.table.core.query({trans:n,limit:r.limit,values:!0,query:{index:i,range:r.range}}).then(({result:o})=>s?o.map(s):o)}{const s=[];return Mt(r,i=>s.push(i),n,r.table.core).then(()=>s)}},t)}offset(t){var n=this._ctx;return t<=0||(n.offset+=t,Ve(n)?Ln(n,()=>{var r=t;return(s,i)=>r===0||(r===1?(--r,!1):(i(()=>{s.advance(r),r=0}),!1))}):Ln(n,()=>{var r=t;return()=>--r<0})),this}limit(t){return this._ctx.limit=Math.min(this._ctx.limit,t),Ln(this._ctx,()=>{var n=t;return function(r,s,i){return--n<=0&&s(i),n>=0}},!0),this}until(t,n){return Pn(this._ctx,function(r,s,i){return!t(r.value)||(s(i),n)}),this}first(t){return this.limit(1).toArray(function(n){return n[0]}).then(t)}last(t){return this.reverse().first(t)}filter(t){var n,r;return Pn(this._ctx,function(s){return t(s.value)}),n=this._ctx,r=t,n.isMatch=Ue(n.isMatch,r),this}and(t){return this.filter(t)}or(t){return new this.db.WhereClause(this._ctx.table,t,this)}reverse(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,s){t(s.key,s)})}eachUniqueKey(t){return this._ctx.unique="unique",this.eachKey(t)}eachPrimaryKey(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,s){t(s.primaryKey,s)})}keys(t){var n=this._ctx;n.keysOnly=!n.isMatch;var r=[];return this.each(function(s,i){r.push(i.key)}).then(function(){return r}).then(t)}primaryKeys(t){var n=this._ctx;if(n.dir==="next"&&Ve(n,!0)&&n.limit>0)return this._read(s=>{var i=Zt(n,n.table.core.schema);return n.table.core.query({trans:s,values:!1,limit:n.limit,query:{index:i,range:n.range}})}).then(({result:s})=>s).then(t);n.keysOnly=!n.isMatch;var r=[];return this.each(function(s,i){r.push(i.primaryKey)}).then(function(){return r}).then(t)}uniqueKeys(t){return this._ctx.unique="unique",this.keys(t)}firstKey(t){return this.limit(1).keys(function(n){return n[0]}).then(t)}lastKey(t){return this.reverse().firstKey(t)}distinct(){var t=this._ctx,n=t.index&&t.table.schema.idxByName[t.index];if(!n||!n.multi)return this;var r={};return Pn(this._ctx,function(s){var i=s.primaryKey.toString(),o=Z(r,i);return r[i]=!0,!o}),this}modify(t){var n=this._ctx;return this._write(r=>{var s;if(typeof t=="function")s=t;else{var i=M(t),o=i.length;s=function(p){for(var g=!1,m=0;m<o;++m){var v=i[m],w=t[v];ue(p,v)!==w&&(te(p,v,w),g=!0)}return g}}const c=n.table.core,{outbound:a,extractKey:l}=c.schema.primaryKey,u=this.db._options.modifyChunkSize||200,f=[];let d=0;const h=[],y=(p,g)=>{const{failures:m,numFailures:v}=g;d+=p-v;for(let w of M(m))f.push(m[w])};return this.clone().primaryKeys().then(p=>{const g=m=>{const v=Math.min(u,p.length-m);return c.getMany({trans:r,keys:p.slice(m,m+v),cache:"immutable"}).then(w=>{const k=[],_=[],E=a?[]:null,I=[];for(let S=0;S<v;++S){const P=w[S],T={value:Pt(P),primKey:p[m+S]};s.call(T,T.value,T)!==!1&&(T.value==null?I.push(p[m+S]):a||J(l(P),l(T.value))===0?(_.push(T.value),a&&E.push(p[m+S])):(I.push(p[m+S]),k.push(T.value)))}const A=Ve(n)&&n.limit===1/0&&(typeof t!="function"||t===$n)&&{index:n.index,range:n.range};return Promise.resolve(k.length>0&&c.mutate({trans:r,type:"add",values:k}).then(S=>{for(let P in S.failures)I.splice(parseInt(P),1);y(k.length,S)})).then(()=>(_.length>0||A&&typeof t=="object")&&c.mutate({trans:r,type:"put",keys:E,values:_,criteria:A,changeSpec:typeof t!="function"&&t}).then(S=>y(_.length,S))).then(()=>(I.length>0||A&&t===$n)&&c.mutate({trans:r,type:"delete",keys:I,criteria:A}).then(S=>y(I.length,S))).then(()=>p.length>m+v&&g(m+u))})};return g(0).then(()=>{if(f.length>0)throw new on("Error modifying one or more objects",f,d,h);return p.length})})})}delete(){var t=this._ctx,n=t.range;return Ve(t)&&(t.isPrimKey&&!Zc||n.type===3)?this._write(r=>{const{primaryKey:s}=t.table.core.schema,i=n;return t.table.core.count({trans:r,query:{index:s,range:i}}).then(o=>t.table.core.mutate({trans:r,type:"deleteRange",range:i}).then(({failures:c,lastResult:a,results:l,numFailures:u})=>{if(u)throw new on("Could not delete some values",Object.keys(c).map(f=>c[f]),o-u);return o-u}))}):this.modify($n)}}const $n=(e,t)=>t.value=null;function nl(e,t){return e<t?-1:e===t?0:1}function rl(e,t){return e>t?-1:e===t?0:1}function Q(e,t,n){var r=e instanceof Oi?new e.Collection(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function De(e){return new e.Collection(e,()=>Ni("")).limit(0)}function sl(e,t,n,r,s,i){for(var o=Math.min(e.length,r.length),c=-1,a=0;a<o;++a){var l=t[a];if(l!==r[a])return s(e[a],n[a])<0?e.substr(0,a)+n[a]+n.substr(a+1):s(e[a],r[a])<0?e.substr(0,a)+r[a]+n.substr(a+1):c>=0?e.substr(0,c)+t[c]+n.substr(c+1):null;s(e[a],l)<0&&(c=a)}return o<r.length&&i==="next"?e+n.substr(e.length):o<e.length&&i==="prev"?e.substr(0,n.length):c<0?null:e.substr(0,c)+r[c]+n.substr(c+1)}function Ut(e,t,n,r){var s,i,o,c,a,l,u,f=n.length;if(!n.every(p=>typeof p=="string"))return Q(e,"String expected.");function d(p){s=function(m){return m==="next"?v=>v.toUpperCase():v=>v.toLowerCase()}(p),i=function(m){return m==="next"?v=>v.toLowerCase():v=>v.toUpperCase()}(p),o=p==="next"?nl:rl;var g=n.map(function(m){return{lower:i(m),upper:s(m)}}).sort(function(m,v){return o(m.lower,v.lower)});c=g.map(function(m){return m.upper}),a=g.map(function(m){return m.lower}),l=p,u=p==="next"?"":r}d("next");var h=new e.Collection(e,()=>ge(c[0],a[f-1]+r));h._ondirectionchange=function(p){d(p)};var y=0;return h._addAlgorithm(function(p,g,m){var v=p.key;if(typeof v!="string")return!1;var w=i(v);if(t(w,a,y))return!0;for(var k=null,_=y;_<f;++_){var E=sl(v,w,c[_],a[_],o,l);E===null&&k===null?y=_+1:(k===null||o(k,E)>0)&&(k=E)}return g(k!==null?function(){p.continue(k+u)}:m),!1}),h}function ge(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function Ni(e){return{type:1,lower:e,upper:e}}class Oi{get Collection(){return this._ctx.table.db.Collection}between(t,n,r,s){r=r!==!1,s=s===!0;try{return this._cmp(t,n)>0||this._cmp(t,n)===0&&(r||s)&&(!r||!s)?De(this):new this.Collection(this,()=>ge(t,n,!r,!s))}catch{return Q(this,ie)}}equals(t){return t==null?Q(this,ie):new this.Collection(this,()=>Ni(t))}above(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(t,void 0,!0))}aboveOrEqual(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(t,void 0,!1))}below(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(void 0,t,!1,!0))}belowOrEqual(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(void 0,t))}startsWith(t){return typeof t!="string"?Q(this,"String expected."):this.between(t,t+Le,!0,!0)}startsWithIgnoreCase(t){return t===""?this.startsWith(t):Ut(this,(n,r)=>n.indexOf(r[0])===0,[t],Le)}equalsIgnoreCase(t){return Ut(this,(n,r)=>n===r[0],[t],"")}anyOfIgnoreCase(){var t=ae.apply(He,arguments);return t.length===0?De(this):Ut(this,(n,r)=>r.indexOf(n)!==-1,t,"")}startsWithAnyOfIgnoreCase(){var t=ae.apply(He,arguments);return t.length===0?De(this):Ut(this,(n,r)=>r.some(s=>n.indexOf(s)===0),t,Le)}anyOf(){const t=ae.apply(He,arguments);let n=this._cmp;try{t.sort(n)}catch{return Q(this,ie)}if(t.length===0)return De(this);const r=new this.Collection(this,()=>ge(t[0],t[t.length-1]));r._ondirectionchange=i=>{n=i==="next"?this._ascending:this._descending,t.sort(n)};let s=0;return r._addAlgorithm((i,o,c)=>{const a=i.key;for(;n(a,t[s])>0;)if(++s,s===t.length)return o(c),!1;return n(a,t[s])===0||(o(()=>{i.continue(t[s])}),!1)}),r}notEqual(t){return this.inAnyRange([[-(1/0),t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const t=ae.apply(He,arguments);if(t.length===0)return new this.Collection(this);try{t.sort(this._ascending)}catch{return Q(this,ie)}const n=t.reduce((r,s)=>r?r.concat([[r[r.length-1][1],s]]):[[-(1/0),s]],null);return n.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})}inAnyRange(t,n){const r=this._cmp,s=this._ascending,i=this._descending,o=this._min,c=this._max;if(t.length===0)return De(this);if(!t.every(v=>v[0]!==void 0&&v[1]!==void 0&&s(v[0],v[1])<=0))return Q(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",O.InvalidArgument);const a=!n||n.includeLowers!==!1,l=n&&n.includeUppers===!0;let u,f=s;function d(v,w){return f(v[0],w[0])}try{u=t.reduce(function(v,w){let k=0,_=v.length;for(;k<_;++k){const E=v[k];if(r(w[0],E[1])<0&&r(w[1],E[0])>0){E[0]=o(E[0],w[0]),E[1]=c(E[1],w[1]);break}}return k===_&&v.push(w),v},[]),u.sort(d)}catch{return Q(this,ie)}let h=0;const y=l?v=>s(v,u[h][1])>0:v=>s(v,u[h][1])>=0,p=a?v=>i(v,u[h][0])>0:v=>i(v,u[h][0])>=0;let g=y;const m=new this.Collection(this,()=>ge(u[0][0],u[u.length-1][1],!a,!l));return m._ondirectionchange=v=>{v==="next"?(g=y,f=s):(g=p,f=i),u.sort(d)},m._addAlgorithm((v,w,k)=>{for(var _=v.key;g(_);)if(++h,h===u.length)return w(k),!1;return!!function(E){return!y(E)&&!p(E)}(_)||(this._cmp(_,u[h][1])===0||this._cmp(_,u[h][0])===0||w(()=>{f===s?v.continue(u[h][0]):v.continue(u[h][1])}),!1)}),m}startsWithAnyOf(){const t=ae.apply(He,arguments);return t.every(n=>typeof n=="string")?t.length===0?De(this):this.inAnyRange(t.map(n=>[n,n+Le])):Q(this,"startsWithAnyOf() only works with strings")}}function re(e){return B(function(t){return Ot(t),e(t.target.error),!1})}function Ot(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}const _e=Et(null,"storagemutated");class il{_lock(){return dt(!C.global),++this._reculock,this._reculock!==1||C.global||(C.lockOwnerFor=this),this}_unlock(){if(dt(!C.global),--this._reculock==0)for(C.global||(C.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{ot(t[1],t[0])}catch{}}return this}_locked(){return this._reculock&&C.lockOwnerFor!==this}create(t){if(!this.mode)return this;const n=this.db.idbdb,r=this.db._state.dbOpenError;if(dt(!this.idbtrans),!t&&!n)switch(r&&r.name){case"DatabaseClosedError":throw new O.DatabaseClosed(r);case"MissingAPIError":throw new O.MissingAPI(r.message,r);default:throw new O.OpenFailed(r)}if(!this.active)throw new O.TransactionInactive;return dt(this._completion._state===null),(t=this.idbtrans=t||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):n.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=B(s=>{Ot(s),this._reject(t.error)}),t.onabort=B(s=>{Ot(s),this.active&&this._reject(new O.Abort(t.error)),this.active=!1,this.on("abort").fire(s)}),t.oncomplete=B(()=>{this.active=!1,this._resolve(),"mutatedParts"in t&&_e.storagemutated.fire(t.mutatedParts)}),this}_promise(t,n,r){if(t==="readwrite"&&this.mode!=="readwrite")return q(new O.ReadOnly("Transaction is readonly"));if(!this.active)return q(new O.TransactionInactive);if(this._locked())return new x((i,o)=>{this._blockedFuncs.push([()=>{this._promise(t,n,r).then(i,o)},C])});if(r)return be(()=>{var i=new x((o,c)=>{this._lock();const a=n(o,c,this);a&&a.then&&a.then(o,c)});return i.finally(()=>this._unlock()),i._lib=!0,i});var s=new x((i,o)=>{var c=n(i,o,this);c&&c.then&&c.then(i,o)});return s._lib=!0,s}_root(){return this.parent?this.parent._root():this}waitFor(t){var n=this._root();const r=x.resolve(t);if(n._waitingFor)n._waitingFor=n._waitingFor.then(()=>r);else{n._waitingFor=r,n._waitingQueue=[];var s=n.idbtrans.objectStore(n.storeNames[0]);(function o(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(s.get(-1/0).onsuccess=o)})()}var i=n._waitingFor;return new x((o,c)=>{r.then(a=>n._waitingQueue.push(B(o.bind(null,a))),a=>n._waitingQueue.push(B(c.bind(null,a)))).finally(()=>{n._waitingFor===i&&(n._waitingFor=null)})})}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new O.Abort))}table(t){const n=this._memoizedTables||(this._memoizedTables={});if(Z(n,t))return n[t];const r=this.schema[t];if(!r)throw new O.NotFound("Table "+t+" not part of transaction");const s=new this.db.Table(t,r,this);return s.core=this.db.core.table(t),n[t]=s,s}}function lr(e,t,n,r,s,i,o){return{name:e,keyPath:t,unique:n,multi:r,auto:s,compound:i,src:(n&&!o?"&":"")+(r?"*":"")+(s?"++":"")+Ai(t)}}function Ai(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Ti(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:ui(n,r=>[r.name,r])}}let At=e=>{try{return e.only([[]]),At=()=>[[]],[[]]}catch{return At=()=>Le,Le}};function ur(e){return e==null?()=>{}:typeof e=="string"?function(t){return t.split(".").length===1?n=>n[t]:n=>ue(n,t)}(e):t=>ue(t,e)}function Ns(e){return[].slice.call(e)}let ol=0;function kt(e){return e==null?":id":typeof e=="string"?e:`[${e.join("+")}]`}function al(e,t,n){function r(a){if(a.type===3)return null;if(a.type===4)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:l,upper:u,lowerOpen:f,upperOpen:d}=a;return l===void 0?u===void 0?null:t.upperBound(u,!!d):u===void 0?t.lowerBound(l,!!f):t.bound(l,u,!!f,!!d)}const{schema:s,hasGetAll:i}=function(a,l){const u=Ns(a.objectStoreNames);return{schema:{name:a.name,tables:u.map(f=>l.objectStore(f)).map(f=>{const{keyPath:d,autoIncrement:h}=f,y=V(d),p=d==null,g={},m={name:f.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:p,compound:y,keyPath:d,autoIncrement:h,unique:!0,extractKey:ur(d)},indexes:Ns(f.indexNames).map(v=>f.index(v)).map(v=>{const{name:w,unique:k,multiEntry:_,keyPath:E}=v,I={name:w,compound:V(E),keyPath:E,unique:k,multiEntry:_,extractKey:ur(E)};return g[kt(E)]=I,I}),getIndexByKeyPath:v=>g[kt(v)]};return g[":id"]=m.primaryKey,d!=null&&(g[kt(d)]=m.primaryKey),m})},hasGetAll:u.length>0&&"getAll"in l.objectStore(u[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(e,n),o=s.tables.map(a=>function(l){const u=l.name;return{name:u,schema:l,mutate:function({trans:f,type:d,keys:h,values:y,range:p}){return new Promise((g,m)=>{g=B(g);const v=f.objectStore(u),w=v.keyPath==null,k=d==="put"||d==="add";if(!k&&d!=="delete"&&d!=="deleteRange")throw new Error("Invalid operation type: "+d);const{length:_}=h||y||{length:1};if(h&&y&&h.length!==y.length)throw new Error("Given keys array must have same length as given values array.");if(_===0)return g({numFailures:0,failures:{},results:[],lastResult:void 0});let E;const I=[],A=[];let S=0;const P=U=>{++S,Ot(U)};if(d==="deleteRange"){if(p.type===4)return g({numFailures:S,failures:A,results:[],lastResult:void 0});p.type===3?I.push(E=v.clear()):I.push(E=v.delete(r(p)))}else{const[U,F]=k?w?[y,h]:[y,null]:[h,null];if(k)for(let $=0;$<_;++$)I.push(E=F&&F[$]!==void 0?v[d](U[$],F[$]):v[d](U[$])),E.onerror=P;else for(let $=0;$<_;++$)I.push(E=v[d](U[$])),E.onerror=P}const T=U=>{const F=U.target.result;I.forEach(($,de)=>$.error!=null&&(A[de]=$.error)),g({numFailures:S,failures:A,results:d==="delete"?h:I.map($=>$.result),lastResult:F})};E.onerror=U=>{P(U),T(U)},E.onsuccess=T})},getMany:({trans:f,keys:d})=>new Promise((h,y)=>{h=B(h);const p=f.objectStore(u),g=d.length,m=new Array(g);let v,w=0,k=0;const _=I=>{const A=I.target;m[A._pos]=A.result,++k===w&&h(m)},E=re(y);for(let I=0;I<g;++I)d[I]!=null&&(v=p.get(d[I]),v._pos=I,v.onsuccess=_,v.onerror=E,++w);w===0&&h(m)}),get:({trans:f,key:d})=>new Promise((h,y)=>{h=B(h);const p=f.objectStore(u).get(d);p.onsuccess=g=>h(g.target.result),p.onerror=re(y)}),query:function(f){return d=>new Promise((h,y)=>{h=B(h);const{trans:p,values:g,limit:m,query:v}=d,w=m===1/0?void 0:m,{index:k,range:_}=v,E=p.objectStore(u),I=k.isPrimaryKey?E:E.index(k.name),A=r(_);if(m===0)return h({result:[]});if(f){const S=g?I.getAll(A,w):I.getAllKeys(A,w);S.onsuccess=P=>h({result:P.target.result}),S.onerror=re(y)}else{let S=0;const P=g||!("openKeyCursor"in I)?I.openCursor(A):I.openKeyCursor(A),T=[];P.onsuccess=U=>{const F=P.result;return F?(T.push(g?F.value:F.primaryKey),++S===m?h({result:T}):void F.continue()):h({result:T})},P.onerror=re(y)}})}(i),openCursor:function({trans:f,values:d,query:h,reverse:y,unique:p}){return new Promise((g,m)=>{g=B(g);const{index:v,range:w}=h,k=f.objectStore(u),_=v.isPrimaryKey?k:k.index(v.name),E=y?p?"prevunique":"prev":p?"nextunique":"next",I=d||!("openKeyCursor"in _)?_.openCursor(r(w),E):_.openKeyCursor(r(w),E);I.onerror=re(m),I.onsuccess=B(A=>{const S=I.result;if(!S)return void g(null);S.___id=++ol,S.done=!1;const P=S.continue.bind(S);let T=S.continuePrimaryKey;T&&(T=T.bind(S));const U=S.advance.bind(S),F=()=>{throw new Error("Cursor not stopped")};S.trans=f,S.stop=S.continue=S.continuePrimaryKey=S.advance=()=>{throw new Error("Cursor not started")},S.fail=B(m),S.next=function(){let $=1;return this.start(()=>$--?this.continue():this.stop()).then(()=>this)},S.start=$=>{const de=new Promise((z,ke)=>{z=B(z),I.onerror=re(ke),S.fail=ke,S.stop=at=>{S.stop=S.continue=S.continuePrimaryKey=S.advance=F,z(at)}}),ne=()=>{if(I.result)try{$()}catch(z){S.fail(z)}else S.done=!0,S.start=()=>{throw new Error("Cursor behind last entry")},S.stop()};return I.onsuccess=B(z=>{I.onsuccess=ne,ne()}),S.continue=P,S.continuePrimaryKey=T,S.advance=U,ne(),de},g(S)},m)})},count({query:f,trans:d}){const{index:h,range:y}=f;return new Promise((p,g)=>{const m=d.objectStore(u),v=h.isPrimaryKey?m:m.index(h.name),w=r(y),k=w?v.count(w):v.count();k.onsuccess=B(_=>p(_.target.result)),k.onerror=re(g)})}}}(a)),c={};return o.forEach(a=>c[a.name]=a),{stack:"dbcore",transaction:e.transaction.bind(e),table(a){if(!c[a])throw new Error(`Table '${a}' not found`);return c[a]},MIN_KEY:-1/0,MAX_KEY:At(t),schema:s}}function fr({_novip:e},t){const n=t.db,r=function(s,i,{IDBKeyRange:o,indexedDB:c},a){return{dbcore:function(u,f){return f.reduce((d,{create:h})=>({...d,...h(d)}),u)}(al(i,o,a),s.dbcore)}}(e._middlewares,n,e._deps,t);e.core=r.dbcore,e.tables.forEach(s=>{const i=s.name;e.core.schema.tables.some(o=>o.name===i)&&(s.core=e.core.table(i),e[i]instanceof e.Table&&(e[i].core=s.core))})}function fn({_novip:e},t,n,r){n.forEach(s=>{const i=r[s];t.forEach(o=>{const c=Lr(o,s);(!c||"value"in c&&c.value===void 0)&&(o===e.Transaction.prototype||o instanceof e.Transaction?le(o,s,{get(){return this.table(s)},set(a){ai(this,s,{value:a,writable:!0,configurable:!0,enumerable:!0})}}):o[s]=new e.Table(s,i))})})}function dr({_novip:e},t){t.forEach(n=>{for(let r in n)n[r]instanceof e.Table&&delete n[r]})}function cl(e,t){return e._cfg.version-t._cfg.version}function ll(e,t,n,r){const s=e._dbSchema,i=e._createTransaction("readwrite",e._storeNames,s);i.create(n),i._completion.catch(r);const o=i._reject.bind(i),c=C.transless||C;be(()=>{C.trans=i,C.transless=c,t===0?(M(s).forEach(a=>{Gn(n,a,s[a].primKey,s[a].indexes)}),fr(e,n),x.follow(()=>e.on.populate.fire(i)).catch(o)):function({_novip:a},l,u,f){const d=[],h=a._versions;let y=a._dbSchema=pr(a,a.idbdb,f),p=!1;function g(){return d.length?x.resolve(d.shift()(u.idbtrans)).then(g):x.resolve()}return h.filter(m=>m._cfg.version>=l).forEach(m=>{d.push(()=>{const v=y,w=m._cfg.dbschema;gr(a,v,f),gr(a,w,f),y=a._dbSchema=w;const k=Pi(v,w);k.add.forEach(E=>{Gn(f,E[0],E[1].primKey,E[1].indexes)}),k.change.forEach(E=>{if(E.recreate)throw new O.Upgrade("Not yet support for changing primary key");{const I=f.objectStore(E.name);E.add.forEach(A=>hr(I,A)),E.change.forEach(A=>{I.deleteIndex(A.name),hr(I,A)}),E.del.forEach(A=>I.deleteIndex(A))}});const _=m._cfg.contentUpgrade;if(_&&m._cfg.version>l){fr(a,f),u._memoizedTables={},p=!0;let E=fi(w);k.del.forEach(P=>{E[P]=v[P]}),dr(a,[a.Transaction.prototype]),fn(a,[a.Transaction.prototype],M(E),E),u.schema=E;const I=$r(_);let A;I&&it();const S=x.follow(()=>{if(A=_(u),A&&I){var P=fe.bind(null,null);A.then(P,P)}});return A&&typeof A.then=="function"?x.resolve(A):S.then(()=>A)}}),d.push(v=>{(!p||!Qc)&&function(w,k){[].slice.call(k.db.objectStoreNames).forEach(_=>w[_]==null&&k.db.deleteObjectStore(_))}(m._cfg.dbschema,v),dr(a,[a.Transaction.prototype]),fn(a,[a.Transaction.prototype],a._storeNames,a._dbSchema),u.schema=a._dbSchema})}),g().then(()=>{var m,v;v=f,M(m=y).forEach(w=>{v.db.objectStoreNames.contains(w)||Gn(v,w,m[w].primKey,m[w].indexes)})})}(e,t,i,n).catch(o)})}function Pi(e,t){const n={del:[],add:[],change:[]};let r;for(r in e)t[r]||n.del.push(r);for(r in t){const s=e[r],i=t[r];if(s){const o={name:r,def:i,recreate:!1,del:[],add:[],change:[]};if(""+(s.primKey.keyPath||"")!=""+(i.primKey.keyPath||"")||s.primKey.auto!==i.primKey.auto&&!yn)o.recreate=!0,n.change.push(o);else{const c=s.idxByName,a=i.idxByName;let l;for(l in c)a[l]||o.del.push(l);for(l in a){const u=c[l],f=a[l];u?u.src!==f.src&&o.change.push(f):o.add.push(f)}(o.del.length>0||o.add.length>0||o.change.length>0)&&n.change.push(o)}}else n.add.push([r,i])}return n}function Gn(e,t,n,r){const s=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(i=>hr(s,i)),s}function hr(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function pr(e,t,n){const r={};return sn(t.objectStoreNames,0).forEach(s=>{const i=n.objectStore(s);let o=i.keyPath;const c=lr(Ai(o),o||"",!1,!1,!!i.autoIncrement,o&&typeof o!="string",!0),a=[];for(let u=0;u<i.indexNames.length;++u){const f=i.index(i.indexNames[u]);o=f.keyPath;var l=lr(f.name,o,!!f.unique,!!f.multiEntry,!1,o&&typeof o!="string",!1);a.push(l)}r[s]=Ti(s,c,a)}),r}function gr({_novip:e},t,n){const r=n.db.objectStoreNames;for(let s=0;s<r.length;++s){const i=r[s],o=n.objectStore(i);e._hasGetAll="getAll"in o;for(let c=0;c<o.indexNames.length;++c){const a=o.indexNames[c],l=o.index(a).keyPath,u=typeof l=="string"?l:"["+sn(l).join("+")+"]";if(t[i]){const f=t[i].idxByName[u];f&&(f.name=a,delete t[i].idxByName[u],t[i].idxByName[a]=f)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&G.WorkerGlobalScope&&G instanceof G.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}class ul{_parseStoresSpec(t,n){M(t).forEach(r=>{if(t[r]!==null){var s=t[r].split(",").map((o,c)=>{const a=(o=o.trim()).replace(/([&*]|\+\+)/g,""),l=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return lr(a,l||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),V(l),c===0)}),i=s.shift();if(i.multi)throw new O.Schema("Primary key cannot be multi-valued");s.forEach(o=>{if(o.auto)throw new O.Schema("Only primary key can be marked as autoIncrement (++)");if(!o.keyPath)throw new O.Schema("Index must have a name and cannot be an empty string")}),n[r]=Ti(r,i,s)}})}stores(t){const n=this.db;this._cfg.storesSource=this._cfg.storesSource?H(this._cfg.storesSource,t):t;const r=n._versions,s={};let i={};return r.forEach(o=>{H(s,o._cfg.storesSource),i=o._cfg.dbschema={},o._parseStoresSpec(s,i)}),n._dbSchema=i,dr(n,[n._allTables,n,n.Transaction.prototype]),fn(n,[n._allTables,n,n.Transaction.prototype,this._cfg.tables],M(i),i),n._storeNames=M(i),this}upgrade(t){return this._cfg.contentUpgrade=Br(this._cfg.contentUpgrade||L,t),this}}function Ur(e,t){let n=e._dbNamesDB;return n||(n=e._dbNamesDB=new Fe("__dbnames",{addons:[],indexedDB:e,IDBKeyRange:t}),n.version(1).stores({dbnames:"name"})),n.table("dbnames")}function zr(e){return e&&typeof e.databases=="function"}function yr(e){return be(function(){return C.letThrough=!0,e()})}function fl(){var e;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(t){var n=function(){return indexedDB.databases().finally(t)};e=setInterval(n,100),n()}).finally(function(){return clearInterval(e)}):Promise.resolve()}function dl(e){const t=e._state,{indexedDB:n}=e._deps;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(()=>t.dbOpenError?q(t.dbOpenError):e);se&&(t.openCanceller._stackHolder=ze()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;const r=t.openCanceller;function s(){if(t.openCanceller!==r)throw new O.DatabaseClosed("db.open() was cancelled")}let i=t.dbReadyResolve,o=null,c=!1;return x.race([r,(typeof navigator>"u"?x.resolve():fl()).then(()=>new x((a,l)=>{if(s(),!n)throw new O.MissingAPI;const u=e.name,f=t.autoSchema?n.open(u):n.open(u,Math.round(10*e.verno));if(!f)throw new O.MissingAPI;f.onerror=re(l),f.onblocked=B(e._fireOnBlocked),f.onupgradeneeded=B(d=>{if(o=f.transaction,t.autoSchema&&!e._options.allowEmptyDB){f.onerror=Ot,o.abort(),f.result.close();const y=n.deleteDatabase(u);y.onsuccess=y.onerror=B(()=>{l(new O.NoSuchDatabase(`Database ${u} doesnt exist`))})}else{o.onerror=re(l);var h=d.oldVersion>Math.pow(2,62)?0:d.oldVersion;c=h<1,e._novip.idbdb=f.result,ll(e,h/10,o,l)}},l),f.onsuccess=B(()=>{o=null;const d=e._novip.idbdb=f.result,h=sn(d.objectStoreNames);if(h.length>0)try{const p=d.transaction((y=h).length===1?y[0]:y,"readonly");t.autoSchema?function({_novip:g},m,v){g.verno=m.version/10;const w=g._dbSchema=pr(0,m,v);g._storeNames=sn(m.objectStoreNames,0),fn(g,[g._allTables],M(w),w)}(e,d,p):(gr(e,e._dbSchema,p),function(g,m){const v=Pi(pr(0,g.idbdb,m),g._dbSchema);return!(v.add.length||v.change.some(w=>w.add.length||w.change.length))}(e,p)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),fr(e,p)}catch{}var y;_t.push(e),d.onversionchange=B(p=>{t.vcFired=!0,e.on("versionchange").fire(p)}),d.onclose=B(p=>{e.on("close").fire(p)}),c&&function({indexedDB:p,IDBKeyRange:g},m){!zr(p)&&m!=="__dbnames"&&Ur(p,g).put({name:m}).catch(L)}(e._deps,u),a()},l)}))]).then(()=>(s(),t.onReadyBeingFired=[],x.resolve(yr(()=>e.on.ready.fire(e.vip))).then(function a(){if(t.onReadyBeingFired.length>0){let l=t.onReadyBeingFired.reduce(Br,L);return t.onReadyBeingFired=[],x.resolve(yr(()=>l(e.vip))).then(a)}}))).finally(()=>{t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(()=>e).catch(a=>{t.dbOpenError=a;try{o&&o.abort()}catch{}return r===t.openCanceller&&e._close(),q(a)}).finally(()=>{t.openComplete=!0,i()})}function mr(e){var t=i=>e.next(i),n=s(t),r=s(i=>e.throw(i));function s(i){return o=>{var c=i(o),a=c.value;return c.done?a:a&&typeof a.then=="function"?a.then(n,r):V(a)?Promise.all(a).then(n,r):n(a)}}return s(t)()}function hl(e,t,n){var r=arguments.length;if(r<2)throw new O.InvalidArgument("Too few arguments");for(var s=new Array(r-1);--r;)s[r-1]=arguments[r];n=s.pop();var i=di(s);return[e,i,n]}function Li(e,t,n,r,s){return x.resolve().then(()=>{const i=C.transless||C,o=e._createTransaction(t,n,e._dbSchema,r),c={trans:o,transless:i};if(r)o.idbtrans=r.idbtrans;else try{o.create(),e._state.PR1398_maxLoop=3}catch(f){return f.name===Rr.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(()=>Li(e,t,n,null,s))):q(f)}const a=$r(s);let l;a&&it();const u=x.follow(()=>{if(l=s.call(o,o),l)if(a){var f=fe.bind(null,null);l.then(f,f)}else typeof l.next=="function"&&typeof l.throw=="function"&&(l=mr(l))},c);return(l&&typeof l.then=="function"?x.resolve(l).then(f=>o.active?f:q(new O.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))):u.then(()=>l)).then(f=>(r&&o._resolve(),o._completion.then(()=>f))).catch(f=>(o._reject(f),q(f)))})}function zt(e,t,n){const r=V(e)?e.slice():[e];for(let s=0;s<n;++s)r.push(t);return r}const pl={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return{...e,table(t){const n=e.table(t),{schema:r}=n,s={},i=[];function o(u,f,d){const h=kt(u),y=s[h]=s[h]||[],p=u==null?0:typeof u=="string"?1:u.length,g=f>0,m={...d,isVirtual:g,keyTail:f,keyLength:p,extractKey:ur(u),unique:!g&&d.unique};return y.push(m),m.isPrimaryKey||i.push(m),p>1&&o(p===2?u[0]:u.slice(0,p-1),f+1,d),y.sort((v,w)=>v.keyTail-w.keyTail),m}const c=o(r.primaryKey.keyPath,0,r.primaryKey);s[":id"]=[c];for(const u of r.indexes)o(u.keyPath,0,u);function a(u){const f=u.query.index;return f.isVirtual?{...u,query:{index:f,range:(d=u.query.range,h=f.keyTail,{type:d.type===1?2:d.type,lower:zt(d.lower,d.lowerOpen?e.MAX_KEY:e.MIN_KEY,h),lowerOpen:!0,upper:zt(d.upper,d.upperOpen?e.MIN_KEY:e.MAX_KEY,h),upperOpen:!0})}}:u;var d,h}return{...n,schema:{...r,primaryKey:c,indexes:i,getIndexByKeyPath:function(u){const f=s[kt(u)];return f&&f[0]}},count:u=>n.count(a(u)),query:u=>n.query(a(u)),openCursor(u){const{keyTail:f,isVirtual:d,keyLength:h}=u.query.index;return d?n.openCursor(a(u)).then(y=>y&&function(p){return Object.create(p,{continue:{value:function(m){m!=null?p.continue(zt(m,u.reverse?e.MAX_KEY:e.MIN_KEY,f)):u.unique?p.continue(p.key.slice(0,h).concat(u.reverse?e.MIN_KEY:e.MAX_KEY,f)):p.continue()}},continuePrimaryKey:{value(m,v){p.continuePrimaryKey(zt(m,e.MAX_KEY,f),v)}},primaryKey:{get:()=>p.primaryKey},key:{get(){const m=p.key;return h===1?m[0]:m.slice(0,h)}},value:{get:()=>p.value}})}(y)):n.openCursor(u)}}}}}};function qr(e,t,n,r){return n=n||{},r=r||"",M(e).forEach(s=>{if(Z(t,s)){var i=e[s],o=t[s];if(typeof i=="object"&&typeof o=="object"&&i&&o){const c=Yn(i);c!==Yn(o)?n[r+s]=t[s]:c==="Object"?qr(i,o,n,r+s+"."):i!==o&&(n[r+s]=t[s])}else i!==o&&(n[r+s]=t[s])}else n[r+s]=void 0}),M(t).forEach(s=>{Z(e,s)||(n[r+s]=t[s])}),n}const gl={stack:"dbcore",name:"HooksMiddleware",level:2,create:e=>({...e,table(t){const n=e.table(t),{primaryKey:r}=n.schema;return{...n,mutate(i){const o=C.trans,{deleting:c,creating:a,updating:l}=o.table(t).hook;switch(i.type){case"add":if(a.fire===L)break;return o._promise("readwrite",()=>u(i),!0);case"put":if(a.fire===L&&l.fire===L)break;return o._promise("readwrite",()=>u(i),!0);case"delete":if(c.fire===L)break;return o._promise("readwrite",()=>u(i),!0);case"deleteRange":if(c.fire===L)break;return o._promise("readwrite",()=>function(d){return f(d.trans,d.range,1e4)}(i),!0)}return n.mutate(i);function u(d){const h=C.trans,y=d.keys||function(p,g){return g.type==="delete"?g.keys:g.keys||g.values.map(p.extractKey)}(r,d);if(!y)throw new Error("Keys missing");return(d=d.type==="add"||d.type==="put"?{...d,keys:y}:{...d}).type!=="delete"&&(d.values=[...d.values]),d.keys&&(d.keys=[...d.keys]),function(p,g,m){return g.type==="add"?Promise.resolve([]):p.getMany({trans:g.trans,keys:m,cache:"immutable"})}(n,d,y).then(p=>{const g=y.map((m,v)=>{const w=p[v],k={onerror:null,onsuccess:null};if(d.type==="delete")c.fire.call(k,m,w,h);else if(d.type==="add"||w===void 0){const _=a.fire.call(k,m,d.values[v],h);m==null&&_!=null&&(m=_,d.keys[v]=m,r.outbound||te(d.values[v],r.keyPath,m))}else{const _=qr(w,d.values[v]),E=l.fire.call(k,_,m,w,h);if(E){const I=d.values[v];Object.keys(E).forEach(A=>{Z(I,A)?I[A]=E[A]:te(I,A,E[A])})}}return k});return n.mutate(d).then(({failures:m,results:v,numFailures:w,lastResult:k})=>{for(let _=0;_<y.length;++_){const E=v?v[_]:y[_],I=g[_];E==null?I.onerror&&I.onerror(m[_]):I.onsuccess&&I.onsuccess(d.type==="put"&&p[_]?d.values[_]:E)}return{failures:m,results:v,numFailures:w,lastResult:k}}).catch(m=>(g.forEach(v=>v.onerror&&v.onerror(m)),Promise.reject(m)))})}function f(d,h,y){return n.query({trans:d,values:!1,query:{index:r,range:h},limit:y}).then(({result:p})=>u({type:"delete",keys:p,trans:d}).then(g=>g.numFailures>0?Promise.reject(g.failures[0]):p.length<y?{failures:[],numFailures:0,lastResult:void 0}:f(d,{...h,lower:p[p.length-1],lowerOpen:!0},y)))}}}}})};function $i(e,t,n){try{if(!t||t.keys.length<e.length)return null;const r=[];for(let s=0,i=0;s<t.keys.length&&i<e.length;++s)J(t.keys[s],e[i])===0&&(r.push(n?Pt(t.values[s]):t.values[s]),++i);return r.length===e.length?r:null}catch{return null}}const yl={stack:"dbcore",level:-1,create:e=>({table:t=>{const n=e.table(t);return{...n,getMany:r=>{if(!r.cache)return n.getMany(r);const s=$i(r.keys,r.trans._cache,r.cache==="clone");return s?x.resolve(s):n.getMany(r).then(i=>(r.trans._cache={keys:r.keys,values:r.cache==="clone"?Pt(i):i},i))},mutate:r=>(r.type!=="add"&&(r.trans._cache=null),n.mutate(r))}}})};function jr(e){return!("from"in e)}const oe=function(e,t){if(!this){const n=new oe;return e&&"d"in e&&H(n,e),n}H(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0})};function Tt(e,t,n){const r=J(t,n);if(isNaN(r))return;if(r>0)throw RangeError();if(jr(e))return H(e,{from:t,to:n,d:1});const s=e.l,i=e.r;if(J(n,e.from)<0)return s?Tt(s,t,n):e.l={from:t,to:n,d:1,l:null,r:null},Os(e);if(J(t,e.to)>0)return i?Tt(i,t,n):e.r={from:t,to:n,d:1,l:null,r:null},Os(e);J(t,e.from)<0&&(e.from=t,e.l=null,e.d=i?i.d+1:1),J(n,e.to)>0&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1);const o=!e.r;s&&!e.l&&dn(e,s),i&&o&&dn(e,i)}function dn(e,t){jr(t)||function n(r,{from:s,to:i,l:o,r:c}){Tt(r,s,i),o&&n(r,o),c&&n(r,c)}(e,t)}function ml(e,t){const n=vr(t);let r=n.next();if(r.done)return!1;let s=r.value;const i=vr(e);let o=i.next(s.from),c=o.value;for(;!r.done&&!o.done;){if(J(c.from,s.to)<=0&&J(c.to,s.from)>=0)return!0;J(s.from,c.from)<0?s=(r=n.next(c.from)).value:c=(o=i.next(s.from)).value}return!1}function vr(e){let t=jr(e)?null:{s:0,n:e};return{next(n){const r=arguments.length>0;for(;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&J(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||J(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function Os(e){var t,n;const r=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((n=e.l)===null||n===void 0?void 0:n.d)||0),s=r>1?"r":r<-1?"l":"";if(s){const i=s==="r"?"l":"r",o={...e},c=e[s];e.from=c.from,e.to=c.to,e[s]=c[s],o[s]=c[i],e[i]=o,o.d=As(o)}e.d=As(e)}function As({r:e,l:t}){return(e?t?Math.max(e.d,t.d):e.d:t?t.d:0)+1}rt(oe.prototype,{add(e){return dn(this,e),this},addKey(e){return Tt(this,e,e),this},addKeys(e){return e.forEach(t=>Tt(this,t,t)),this},[Qn](){return vr(this)}});const vl={stack:"dbcore",level:0,create:e=>{const t=e.schema.name,n=new oe(e.MIN_KEY,e.MAX_KEY);return{...e,table:r=>{const s=e.table(r),{schema:i}=s,{primaryKey:o}=i,{extractKey:c,outbound:a}=o,l={...s,mutate:d=>{const h=d.trans,y=h.mutatedParts||(h.mutatedParts={}),p=E=>{const I=`idb://${t}/${r}/${E}`;return y[I]||(y[I]=new oe)},g=p(""),m=p(":dels"),{type:v}=d;let[w,k]=d.type==="deleteRange"?[d.range]:d.type==="delete"?[d.keys]:d.values.length<50?[[],d.values]:[];const _=d.trans._cache;return s.mutate(d).then(E=>{if(V(w)){v!=="delete"&&(w=E.results),g.addKeys(w);const I=$i(w,_);I||v==="add"||m.addKeys(w),(I||k)&&function(A,S,P,T){function U(F){const $=A(F.name||"");function de(z){return z!=null?F.extractKey(z):null}const ne=z=>F.multiEntry&&V(z)?z.forEach(ke=>$.addKey(ke)):$.addKey(z);(P||T).forEach((z,ke)=>{const at=P&&de(P[ke]),mn=T&&de(T[ke]);J(at,mn)!==0&&(at!=null&&ne(at),mn!=null&&ne(mn))})}S.indexes.forEach(U)}(p,i,I,k)}else if(w){const I={from:w.lower,to:w.upper};m.add(I),g.add(I)}else g.add(n),m.add(n),i.indexes.forEach(I=>p(I.name).add(n));return E})}},u=({query:{index:d,range:h}})=>{var y,p;return[d,new oe((y=h.lower)!==null&&y!==void 0?y:e.MIN_KEY,(p=h.upper)!==null&&p!==void 0?p:e.MAX_KEY)]},f={get:d=>[o,new oe(d.key)],getMany:d=>[o,new oe().addKeys(d.keys)],count:u,query:u,openCursor:u};return M(f).forEach(d=>{l[d]=function(h){const{subscr:y}=C;if(y){const p=k=>{const _=`idb://${t}/${r}/${k}`;return y[_]||(y[_]=new oe)},g=p(""),m=p(":dels"),[v,w]=f[d](h);if(p(v.name||"").add(w),!v.isPrimaryKey){if(d!=="count"){const k=d==="query"&&a&&h.values&&s.query({...h,values:!1});return s[d].apply(this,arguments).then(_=>{if(d==="query"){if(a&&h.values)return k.then(({result:I})=>(g.addKeys(I),_));const E=h.values?_.result.map(c):_.result;h.values?g.addKeys(E):m.addKeys(E)}else if(d==="openCursor"){const E=_,I=h.values;return E&&Object.create(E,{key:{get:()=>(m.addKey(E.primaryKey),E.key)},primaryKey:{get(){const A=E.primaryKey;return m.addKey(A),A}},value:{get:()=>(I&&g.addKey(E.primaryKey),E.value)}})}return _})}m.add(n)}}return s[d].apply(this,arguments)}}),l}}}};class Fe{constructor(t,n){this._middlewares={},this.verno=0;const r=Fe.dependencies;this._options=n={addons:Fe.addons,autoOpen:!0,indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange,...n},this._deps={indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange};const{addons:s}=n;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const i={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:L,dbReadyPromise:null,cancelOpen:L,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};var o;i.dbReadyPromise=new x(c=>{i.dbReadyResolve=c}),i.openCanceller=new x((c,a)=>{i.cancelOpen=a}),this._state=i,this.name=t,this.on=Et(this,"populate","blocked","versionchange","close",{ready:[Br,L]}),this.on.ready.subscribe=ci(this.on.ready.subscribe,c=>(a,l)=>{Fe.vip(()=>{const u=this._state;if(u.openComplete)u.dbOpenError||x.resolve().then(a),l&&c(a);else if(u.onReadyBeingFired)u.onReadyBeingFired.push(a),l&&c(a);else{c(a);const f=this;l||c(function d(){f.on.ready.unsubscribe(a),f.on.ready.unsubscribe(d)})}})}),this.Collection=(o=this,ft(tl.prototype,function(c,a){this.db=o;let l=Ci,u=null;if(a)try{l=a()}catch(y){u=y}const f=c._ctx,d=f.table,h=d.hook.reading.fire;this._ctx={table:d,index:f.index,isPrimKey:!f.index||d.schema.primKey.keyPath&&f.index===d.schema.primKey.name,range:l,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:u,or:f.or,valueMapper:h!==Ct?h:null}})),this.Table=function(c){return ft(el.prototype,function(a,l,u){this.db=c,this._tx=u,this.name=a,this.schema=l,this.hook=c._allTables[a]?c._allTables[a].hook:Et(null,{creating:[zc,L],reading:[Uc,Ct],updating:[jc,L],deleting:[qc,L]})})}(this),this.Transaction=function(c){return ft(il.prototype,function(a,l,u,f,d){this.db=c,this.mode=a,this.storeNames=l,this.schema=u,this.chromeTransactionDurability=f,this.idbtrans=null,this.on=Et(this,"complete","error","abort"),this.parent=d||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new x((h,y)=>{this._resolve=h,this._reject=y}),this._completion.then(()=>{this.active=!1,this.on.complete.fire()},h=>{var y=this.active;return this.active=!1,this.on.error.fire(h),this.parent?this.parent._reject(h):y&&this.idbtrans&&this.idbtrans.abort(),q(h)})})}(this),this.Version=function(c){return ft(ul.prototype,function(a){this.db=c,this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}(this),this.WhereClause=function(c){return ft(Oi.prototype,function(a,l,u){this.db=c,this._ctx={table:a,index:l===":id"?null:l,or:u};const f=c._deps.indexedDB;if(!f)throw new O.MissingAPI;this._cmp=this._ascending=f.cmp.bind(f),this._descending=(d,h)=>f.cmp(h,d),this._max=(d,h)=>f.cmp(d,h)>0?d:h,this._min=(d,h)=>f.cmp(d,h)<0?d:h,this._IDBKeyRange=c._deps.IDBKeyRange})}(this),this.on("versionchange",c=>{c.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()}),this.on("blocked",c=>{!c.newVersion||c.newVersion<c.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${c.oldVersion/10}`)}),this._maxKey=At(n.IDBKeyRange),this._createTransaction=(c,a,l,u)=>new this.Transaction(c,a,l,this._options.chromeTransactionDurability,u),this._fireOnBlocked=c=>{this.on("blocked").fire(c),_t.filter(a=>a.name===this.name&&a!==this&&!a._state.vcFired).map(a=>a.on("versionchange").fire(c))},this.use(pl),this.use(gl),this.use(vl),this.use(yl),this.vip=Object.create(this,{_vip:{value:!0}}),s.forEach(c=>c(this))}version(t){if(isNaN(t)||t<.1)throw new O.Type("Given version is not a positive number");if(t=Math.round(10*t)/10,this.idbdb||this._state.isBeingOpened)throw new O.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);const n=this._versions;var r=n.filter(s=>s._cfg.version===t)[0];return r||(r=new this.Version(t),n.push(r),n.sort(cl),r.stores({}),this._state.autoSchema=!1,r)}_whenReady(t){return this.idbdb&&(this._state.openComplete||C.letThrough||this._vip)?t():new x((n,r)=>{if(this._state.openComplete)return r(new O.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void r(new O.DatabaseClosed);this.open().catch(L)}this._state.dbReadyPromise.then(n,r)}).then(t)}use({stack:t,create:n,level:r,name:s}){s&&this.unuse({stack:t,name:s});const i=this._middlewares[t]||(this._middlewares[t]=[]);return i.push({stack:t,create:n,level:r??10,name:s}),i.sort((o,c)=>o.level-c.level),this}unuse({stack:t,name:n,create:r}){return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(s=>r?s.create!==r:!!n&&s.name!==n)),this}open(){return dl(this)}_close(){const t=this._state,n=_t.indexOf(this);if(n>=0&&_t.splice(n,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}t.dbReadyPromise=new x(r=>{t.dbReadyResolve=r}),t.openCanceller=new x((r,s)=>{t.cancelOpen=s})}close(){this._close();const t=this._state;this._options.autoOpen=!1,t.dbOpenError=new O.DatabaseClosed,t.isBeingOpened&&t.cancelOpen(t.dbOpenError)}delete(){const t=arguments.length>0,n=this._state;return new x((r,s)=>{const i=()=>{this.close();var o=this._deps.indexedDB.deleteDatabase(this.name);o.onsuccess=B(()=>{(function({indexedDB:c,IDBKeyRange:a},l){!zr(c)&&l!=="__dbnames"&&Ur(c,a).delete(l).catch(L)})(this._deps,this.name),r()}),o.onerror=re(s),o.onblocked=this._fireOnBlocked};if(t)throw new O.InvalidArgument("Arguments not allowed in db.delete()");n.isBeingOpened?n.dbReadyPromise.then(i):i()})}backendDB(){return this.idbdb}isOpen(){return this.idbdb!==null}hasBeenClosed(){const t=this._state.dbOpenError;return t&&t.name==="DatabaseClosed"}hasFailed(){return this._state.dbOpenError!==null}dynamicallyOpened(){return this._state.autoSchema}get tables(){return M(this._allTables).map(t=>this._allTables[t])}transaction(){const t=hl.apply(this,arguments);return this._transaction.apply(this,t)}_transaction(t,n,r){let s=C.trans;s&&s.db===this&&t.indexOf("!")===-1||(s=null);const i=t.indexOf("?")!==-1;let o,c;t=t.replace("!","").replace("?","");try{if(c=n.map(l=>{var u=l instanceof this.Table?l.name:l;if(typeof u!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return u}),t=="r"||t==="readonly")o="readonly";else{if(t!="rw"&&t!="readwrite")throw new O.InvalidArgument("Invalid transaction mode: "+t);o="readwrite"}if(s){if(s.mode==="readonly"&&o==="readwrite"){if(!i)throw new O.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s=null}s&&c.forEach(l=>{if(s&&s.storeNames.indexOf(l)===-1){if(!i)throw new O.SubTransaction("Table "+l+" not included in parent transaction.");s=null}}),i&&s&&!s.active&&(s=null)}}catch(l){return s?s._promise(null,(u,f)=>{f(l)}):q(l)}const a=Li.bind(null,this,o,c,s,r);return s?s._promise(o,a,"lock"):C.trans?ot(C.transless,()=>this._whenReady(a)):this._whenReady(a)}table(t){if(!Z(this._allTables,t))throw new O.InvalidTable(`Table ${t} does not exist`);return this._allTables[t]}}const bl=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable";class wl{constructor(t){this._subscribe=t}subscribe(t,n,r){return this._subscribe(t&&typeof t!="function"?t:{next:t,error:n,complete:r})}[bl](){return this}}function Gi(e,t){return M(t).forEach(n=>{dn(e[n]||(e[n]=new oe),t[n])}),e}function _l(e){return new wl(t=>{const n=$r(e);let r=!1,s={},i={};const o={get closed(){return r},unsubscribe:()=>{r=!0,_e.storagemutated.unsubscribe(u)}};t.start&&t.start(o);let c=!1,a=!1;function l(){return M(i).some(d=>s[d]&&ml(s[d],i[d]))}const u=d=>{Gi(s,d),l()&&f()},f=()=>{if(c||r)return;s={};const d={},h=function(y){n&&it();const p=()=>be(e,{subscr:y,trans:null}),g=C.trans?ot(C.transless,p):p();return n&&g.then(fe,fe),g}(d);a||(_e("storagemutated",u),a=!0),c=!0,Promise.resolve(h).then(y=>{c=!1,r||(l()?f():(s={},i=d,t.next&&t.next(y)))},y=>{c=!1,t.error&&t.error(y),o.unsubscribe()})};return f(),o})}let br;try{br={indexedDB:G.indexedDB||G.mozIndexedDB||G.webkitIndexedDB||G.msIndexedDB,IDBKeyRange:G.IDBKeyRange||G.webkitIDBKeyRange}}catch{br={indexedDB:null,IDBKeyRange:null}}const Ie=Fe;function en(e){let t=ce;try{ce=!0,_e.storagemutated.fire(e)}finally{ce=t}}rt(Ie,{...Jt,delete:e=>new Ie(e,{addons:[]}).delete(),exists:e=>new Ie(e,{addons:[]}).open().then(t=>(t.close(),!0)).catch("NoSuchDatabaseError",()=>!1),getDatabaseNames(e){try{return function({indexedDB:t,IDBKeyRange:n}){return zr(t)?Promise.resolve(t.databases()).then(r=>r.map(s=>s.name).filter(s=>s!=="__dbnames")):Ur(t,n).toCollection().primaryKeys()}(Ie.dependencies).then(e)}catch{return q(new O.MissingAPI)}},defineClass:()=>function(e){H(this,e)},ignoreTransaction:e=>C.trans?ot(C.transless,e):e(),vip:yr,async:function(e){return function(){try{var t=mr(e.apply(this,arguments));return t&&typeof t.then=="function"?t:x.resolve(t)}catch(n){return q(n)}}},spawn:function(e,t,n){try{var r=mr(e.apply(n,t||[]));return r&&typeof r.then=="function"?r:x.resolve(r)}catch(s){return q(s)}},currentTransaction:{get:()=>C.trans||null},waitFor:function(e,t){const n=x.resolve(typeof e=="function"?Ie.ignoreTransaction(e):e).timeout(t||6e4);return C.trans?C.trans.waitFor(n):n},Promise:x,debug:{get:()=>se,set:e=>{pi(e,e==="dexie"?()=>!0:Si)}},derive:Ye,extend:H,props:rt,override:ci,Events:Et,on:_e,liveQuery:_l,extendObservabilitySet:Gi,getByKeyPath:ue,setByKeyPath:te,delByKeyPath:function(e,t){typeof t=="string"?te(e,t,void 0):"length"in t&&[].map.call(t,function(n){te(e,n,void 0)})},shallowClone:fi,deepClone:Pt,getObjectDiff:qr,cmp:J,asap:li,minKey:-(1/0),addons:[],connections:_t,errnames:Rr,dependencies:br,semVer:"3.2.3",version:"3.2.3".split(".").map(e=>parseInt(e)).reduce((e,t,n)=>e+t/Math.pow(10,2*n))}),Ie.maxKey=At(Ie.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(_e("storagemutated",e=>{if(!ce){let t;yn?(t=document.createEvent("CustomEvent"),t.initCustomEvent("x-storagemutated-1",!0,!0,e)):t=new CustomEvent("x-storagemutated-1",{detail:e}),ce=!0,dispatchEvent(t),ce=!1}}),addEventListener("x-storagemutated-1",({detail:e})=>{ce||en(e)}));let ce=!1;if(typeof BroadcastChannel<"u"){const e=new BroadcastChannel("x-storagemutated-1");typeof e.unref=="function"&&e.unref(),_e("storagemutated",t=>{ce||e.postMessage(t)}),e.onmessage=t=>{t.data&&en(t.data)}}else if(typeof self<"u"&&typeof navigator<"u"){_e("storagemutated",t=>{try{ce||(typeof localStorage<"u"&&localStorage.setItem("x-storagemutated-1",JSON.stringify({trig:Math.random(),changedParts:t})),typeof self.clients=="object"&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(n=>n.postMessage({type:"x-storagemutated-1",changedParts:t})))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",t=>{if(t.key==="x-storagemutated-1"){const n=JSON.parse(t.newValue);n&&en(n.changedParts)}});const e=self.document&&navigator.serviceWorker;e&&e.addEventListener("message",function({data:t}){t&&t.type==="x-storagemutated-1"&&en(t.changedParts)})}x.rejectionMapper=function(e,t){if(!e||e instanceof Qe||e instanceof TypeError||e instanceof SyntaxError||!e.name||!_s[e.name])return e;var n=new _s[e.name](t||e.message,e);return"stack"in e&&le(n,"stack",{get:function(){return this.inner.stack}}),n},pi(se,Si);class El extends Fe{constructor(){super("nr-editor");b(this,"catalogues");b(this,"systems");this.version(5).stores({catalogues:"id, content.catalogue.id, content.catalogue.gameSystemId",systems:"id"})}}const Ae=new El;function zl(e){const t=/^(?:(http(s?)?:\/\/)?github.com\/)?([^\/]+)\/([^\/]+)$/,n=e.match(t);if(!n)return null;const[,r="https://",s,i,o]=n;return!i||!o?null:`https://github.com/${i}/${o}`}function kl(e){const t=/^(?:https?:\/\/)?(?:www\.)?github\.com\/([^/]+)\/([^/]+)(?:\/)?$/,n=e.match(t);if(!n)throw new Error("Invalid GitHub URL format: "+e);const[,r,s]=n;return{githubUrl:e,githubRepo:`${r}/${s}`,githubOwner:r,githubName:s}}async function Ts(e,t){try{const n=e.split("/"),r=n[n.length-2],s=n[n.length-1].replace(".git",""),i=`https://api.github.com/repos/${r}/${s}/contents/${encodeURIComponent(t)}`;console.log(`Querying github api at ${i}`);const o=await $fetch(i,{headers:{"User-Agent":"New Recruit Data Editor (Electron)",Accept:"application/vnd.github.v3+json"}});if(!o||!(o!=null&&o.download_url))throw new Error("No download_url found");console.log(`Downloading file at ${o==null?void 0:o.download_url}`);const c=await $fetch(o.download_url,{headers:{"User-Agent":"New Recruit Data Editor (Electron)",Accept:"application/vnd.github.v3+json"}});return console.log(`Downloaded file, length: ${c.length}`),c}catch(n){throw n}}async function Il(e,t,n){try{return await Ts(e,t)}catch(r){if(!n)throw r;return await Ts(e,n)}}async function xl(e,t){if(t.fullFilePath)try{const n=Pr(t.fullFilePath),r=n.endsWith("z")?Gs(n,"z"):void 0,s=await Il(e.githubUrl,n,r),i=/revision="(\d+)"/,o=s.match(i);if(o){const c=(Number(o[1])||0)+1;return console.log(`Revision of ${t.name}: ${t.revision} -> ${c}`),c}}catch(n){console.error(n)}return t.revision||1}function Ps(e,t){if(e)return e[t]||e["*"]}async function hn(e,t,n,r){if(!t.catalogue&&!t.gameSystem)throw Error("invalid loadBsData argument: no .catalogue or .gameSystem in data");const s=t.catalogue?"catalogue":"gameSystem",i=s==="gameSystem",o=s==="catalogue",c=t[s],a=c;if(a.loaded||a.loaded_editor)return a;Ce(c);const l=Dn(c,s);if(l.manager=e,o){const f={targetId:l.gameSystemId},d=e.getLoadedCatalogue(f,n);if(d)l.gameSystem=d;else{const h=await e.getData(f,n),y=e.getLoadedCatalogue(f,n);y?l.gameSystem=y:l.gameSystem=await hn(e,h,n)}}const u=[];for(const f of(l==null?void 0:l.catalogueLinks)||[]){if(!f.targetId){console.warn(`invalid link: no targetId in link: ${f}, found in ${c.name}`);continue}if(f.targetId===l.id){f.target=l;continue}const d=e.getLoadedCatalogue(f,n);if(d){f.target=d;continue}const h=e.getData(f,n).then(y=>{const p=e.getLoadedCatalogue(f,n);if(p){f.target=p;return}return hn(e,y,n).then(g=>f.target=g)});u.push(h)}return await Promise.all(u),i&&e.addLoadedSystem(l),o&&e.addLoadedCatalogue(l),l}class Sl{constructor(){b(this,"catalogues",{});b(this,"unresolvedLinks");b(this,"settings")}async getData(t,n){throw new Error("Method not implemented.")}getCatalogueInfo(t){}findOptionById(t){}getLoadedCatalogue(t,n){const r=typeof t=="string"?t:t.targetId||t.name,s=Ps(n,r)||"default",i=this.catalogues[r];return i?i[s]:void 0}addLoadedCatalogue(t,n){const r=Ps(n,t.id)||"default";this.catalogues[t.name]||(this.catalogues[t.name]={}),this.catalogues[t.id]||(this.catalogues[t.id]={}),this.catalogues[t.name][r]=t,this.catalogues[t.id][r]=t}addLoadedSystem(t,n){return this.addLoadedCatalogue(t,n)}unloadAll(){this.catalogues={}}async loadData(t,n){const r=await hn(this,t,n);return r.process(),r}async loadCatalogue(t,n,r){const s=this.getLoadedCatalogue(t,n);if(s&&!r)return s;const i=await this.getData(t,n);if(i)return await this.loadData(i,n);throw Error(`Couldn't load catalogue: couldn't getData ${t}`)}}class Ls extends Sl{constructor(){super(...arguments);b(this,"gameSystem",null);b(this,"catalogueFiles",yc());b(this,"allLoaded");b(this,"loadedCatalogues",{});b(this,"github");b(this,"unresolvedLinks",{});b(this,"index",{})}async loadData(n,r){return await hn(this,n,r)}findOptionById(n){for(const r of Object.values(this.loadedCatalogues))if(r.index&&r.index[n])return r.index[n]}unloadAll(){super.unloadAll();for(const n of Object.values(this.loadedCatalogues))n.reset();this.loadedCatalogues={},delete this.allLoaded}async loadAll(n){var i,o;let r=Object.values(this.catalogueFiles).length+1,s=0;if(this.allLoaded||console.log("Loading all catalogues in",(o=(i=this.gameSystem)==null?void 0:i.gameSystem)==null?void 0:o.name),this.gameSystem){n&&await n(s,r,`Loading ${this.gameSystem.gameSystem.name}`),(await this.loadCatalogue({targetId:this.gameSystem.gameSystem.id})).processForEditor(),s++;for(const a of Object.values(this.catalogueFiles))n&&await n(s,r,`Loading ${a.catalogue.name}`),(await this.loadCatalogue({targetId:a.catalogue.id})).processForEditor(),s++,n&&await n(s,r,`Loading ${a.catalogue.name}`)}this.allLoaded=!0}getLoadedCatalogue(n,r){const s=n.targetId||n.name;return this.loadedCatalogues[s]}addLoadedCatalogue(n,r){this.loadedCatalogues[n.id]=n}getAllLoadedCatalogues(){var r;return((r=this.gameSystem)==null?void 0:r.gameSystem.id)?Object.values(this.loadedCatalogues):[]}getId(){var n;return(n=this.gameSystem)==null?void 0:n.gameSystem.id}getCatalogueInfo(n){var r,s;if(((r=this.gameSystem)==null?void 0:r.gameSystem.id)===n.targetId)return(s=this.gameSystem)==null?void 0:s.gameSystem;for(const i of Object.values(this.catalogueFiles))if(i.catalogue.id===n.targetId)return i.catalogue}getAllCatalogueFiles(){return[...this.gameSystem?[this.gameSystem]:[],...Object.values(this.catalogueFiles)]}setSystem(n){this.gameSystem=n}setCatalogue(n){const r=n.catalogue.id;this.catalogueFiles[r]=n}removeCatalogue(n){for(const[r,s]of Object.entries(this.catalogueFiles))s.catalogue.id===n.catalogue.id&&delete this.catalogueFiles[r]}async getData(n,r){var c;if(n.targetId==((c=this.gameSystem)==null?void 0:c.gameSystem.id))return this.gameSystem;if(n.targetId in this.catalogueFiles)return this.catalogueFiles[n.targetId];const s=await Ae.catalogues.get({"content.catalogue.id":n.targetId});if(s)return s.content;const i=await Ae.systems.get(n.targetId);if(i)return i.content;const o=n.name?`name ${n.name}`:`id ${n.targetId}`;throw Error(`Couldn't import catalogue with ${o}, perhaps it wasnt uploaded?`)}}const Cl=!1;function ve(e){return e.vnode}function Ne(e){if(e instanceof R)return e;const t=e.$parent;if(t.item)return t.item;const n=t.$parent;return n.item?n.item:n.$parent.item}function Nl(e){e.isSaving=!0}function Ol(e){if(e.isSaving){e.isSaving=!1;return}e.isChangedOnDisk=!0}function Al(e){e.isChangedOnDisk&&(e.isChangedOnDisk=!1),e.isSaving===void 0&&(e.isSaving=!1)}const Rn=new Set(["select","showInEditor","showChildsInEditor"]),ql=wr("editor",{state:()=>({selections:[],selectedEntries:[],selectedElementGroup:null,selectedElement:null,selectedItem:null,filter:"",filterRegex:RegExp(""),filtered:[],undoStack:[],undoStackPos:-1,historyStack:[],historyStackPos:0,clipboard:[],mode:"edit",clipboardmode:"json",gameSystems:{},gameSystemsLoaded:!1,unsavedChanges:{},unsavedCount:0}),actions:{async create_system(e,t,n){console.log("Creating system with name:",e);const r=`sys-${X()}`,s=this.get_system(r),i=t?`${Gs(t.replaceAll("\\","/"),"/")}/${e}`:"";if(electron){if(!i)throw new Error("No folder specified");si(i)}const o={gameSystem:{id:r,name:e,battleScribeVersion:"2.03",revision:1,categoryEntries:[{name:"Default Category",id:"default-category"}],forceEntries:[{name:"Default Force",hidden:!1,id:"default-force",categoryLinks:[{name:"Default Category",hidden:!1,id:"default-force-category-link",targetId:"default-category"}]}],selectionEntries:[{type:"upgrade",import:!0,name:"Default Root Entry",hidden:!1,id:"default-entry",categoryLinks:[{targetId:"default-category",id:"default-category-link",primary:!0,name:"Default Category",hidden:!1}]}]}};return i&&(o.gameSystem.fullFilePath=`${i}/${e}.${n||"gst"}`),s.setSystem(o),this.get_catalogue_state(o).incremented=!0,this.saveCatalogue(o),s},saveCatalogueInDb(e){const t=Mn(e);!!!e.gameSystemId?Ae.systems.put({content:JSON.parse(t),path:e.fullFilePath,id:e.id}):Ae.catalogues.put({content:JSON.parse(t),path:e.fullFilePath,id:`${e.gameSystemId}-${e.id}`})},async saveCatalogueInFiles(e){const t=e.fullFilePath;if(!t){console.error(`No path included in the catalogue ${e.name} to save at`);return}const n=gn(t);if(t.endsWith(".json")){const r=Mn(e);await Jn(t,r)}else{const r=dc(e),s=ti(n),o=Pr(t).replace(".gstz",".gst").replace(".catz",".cat"),c=s?await Wi(o,r,"uint8array"):r;await Jn(t,c)}},saveCatalogue(e){const t=this.get_catalogue_state(e),n=ye(e);Nl(t),electron?this.saveCatalogueInFiles(n):this.saveCatalogueInDb(n),Al(t)},async load_systems_from_folder(e,t){var c,a;if(!globalThis.electron)throw new Error("Not running in electron");const n=await ri(e);if(!(n!=null&&n.length))return;console.log("Loading",n.length,"files",n);const r=[],s=[],i=[],o=n.filter(l=>oc(l.name));for(const l of o)try{t&&await t(s.length,o.length,l.path);const u=await ac(l.data,l.name.endsWith("json")?"json":"xml");if(!u.catalogue&&!u.gameSystem)continue;const f=ye(u);f.fullFilePath=l.path.replaceAll("\\","/");const d=(c=u==null?void 0:u.gameSystem)==null?void 0:c.id,h=(a=u==null?void 0:u.catalogue)==null?void 0:a.id;if(d){const y=this.get_system(d);y.setSystem(Dr(u)),i.push(y),r.push(d)}if(h){const y=this.get_system(u.catalogue.gameSystemId);y.catalogueFiles[h]=Dr(u)}s.push(u)}catch(u){console.error(`Error loading ${l.name}`,u)}t&&await t(s.length,o.length);for(const l of i)t&&await t(0,0,"Checking for github integration"),await this.load_system(l);return r},async load_systems_from_db(e=!1){if(!this.gameSystemsLoaded&&!e){this.gameSystemsLoaded=!0;let t=await Ae.systems.offset(0).keys();for(let n of t)n in this.gameSystems||this.load_system_from_db(n)}},async load_system_from_db(e){const t=await Ae.systems.get(e),n=t==null?void 0:t.content;if(!n)throw new Error("System not found "+e);n.gameSystem.fullFilePath||(n.gameSystem.fullFilePath=t.path);const r=await Ae.catalogues.where({"content.catalogue.gameSystemId":e}),s=this.get_system(n.gameSystem.id);s.setSystem(n);for(let{content:i,path:o}of await r.toArray()){const c=i.catalogue.id;i.catalogue.fullFilePath||(i.catalogue.fullFilePath=o),s.catalogueFiles[c]=Vi(i)}this.load_system(s,!0)},async load_system(e,t=!1){var n,r;if(e.gameSystem){const s=bs();if(await e.unloadAll(),!t)for(const a of e.getAllCatalogueFiles()){const l=this.get_catalogue_state(a);l&&(l.changed=!1,l.unsaved=!1,l.isChangedOnDisk=!1),s.updateCatalogue(ye(a)),s.setEdited(ye(a).id,!1)}const i=e.gameSystem.gameSystem.publications,o=i==null?void 0:i.find(a=>{var l;return((l=a.name)==null?void 0:l.trim().toLowerCase())==="github"}),c=e.gameSystem.gameSystem.fullFilePath;if(c&&Cl)try{const a=await oi(Tr(c));a&&a!=="origin"&&(console.log("remote:",a),e.github={...kl(a),discovered:!0})}catch(a){console.error(a)}o&&o.publisherUrl&&(e.github={githubUrl:o.publisherUrl},o.shortName&&o.shortName.includes("/")&&(e.github.githubRepo=o.shortName,e.github.githubOwner=(n=o.shortName)==null?void 0:n.split("/")[0],e.github.githubName=(r=o.shortName)==null?void 0:r.split("/")[1]))}for(const s of e.getAllCatalogueFiles()){const i=ye(s);i.fullFilePath&&ii(i.fullFilePath,()=>{this.on_file_changed(s)})}},on_file_changed(e){console.log(ye(e).name,"changed"),Ol(this.get_catalogue_state(e))},async get_or_load_system(e){return e in this.gameSystems||(this.gameSystems[e]=new Ls,await this.load_system_from_db(e)),this.gameSystems[e]},get_system(e){if(!(e in this.gameSystems)){const t=new Ls;t.settings=bn(),this.gameSystems[e]=t}return this.gameSystems[e]},delete_system(e){delete this.gameSystems[e]},get_catalogue_state(e){const t=Jr(e);return this.unsavedChanges[t]||(this.unsavedChanges[t]={changed:!1,unsaved:!1}),this.unsavedChanges[t]},set_catalogue_changed(e,t=!0){const n=this.get_catalogue_state(e);t?(n.changed=!0,n.unsaved||(this.unsavedCount+=1,n.unsaved=t)):n.unsaved=t},async save_catalogue(e,t,n){const r=this.get_catalogue_state(t),s=t.revision;n==="github"&&e.github&&(t.revision=await xl(e.github,t)),n==="yes"&&!(r!=null&&r.incremented)&&(t.revision=t.revision?t.revision+1:1,r.incremented=!0),n==="no"&&(r.incremented=!0),this.saveCatalogue(t);const i=bs(),o=Jr(t);return i.updateCatalogue(t),i.setEdited(o,!0),r!=null&&r.unsaved&&(this.unsavedCount--,r.unsaved=!1),t.revision!==s},async prompt_revision(e){const t=bn(),n=e instanceof nn?e.manager:e;for(const r of e instanceof nn?[e]:n.getAllLoadedCatalogues()){const s=this.get_catalogue_state(r);if(s!=null&&s.unsaved&&!s.incremented)return n.github?t.githubAutoIncrement&&!navigator.onLine?await(globalThis.customPrompt&&globalThis.customPrompt({html:`<span>Would you like to increase the revision of this catalogue?<span><br/>
  <span class="gray">Note: This is shown because Github cannot be accessed as your are offline</span>`,cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no":t.githubAutoIncrement?"github":await(globalThis.customPrompt&&globalThis.customPrompt({html:"<span>Would you like to increase the revision of this catalogue?<span><br/>",cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no":await(globalThis.customPrompt&&globalThis.customPrompt({html:`<span>Would you like to increase the revision of this catalogue?<span><br/>
  <span class="gray">Note: You can enable automatic revision increments by integrating with GitHub.<br/>This can be achieved by adding a publication in the GameSystem named "GitHub" with the repository's GitHub URL as the Publication URL.`,cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no"}},async save_all(e){var r,s,i;let t=!1,n=0;bn();try{for(const o of Object.values(this.gameSystems)){if(e&&((s=(r=o.gameSystem)==null?void 0:r.gameSystem)==null?void 0:s.id)!==e)continue;const c=await this.prompt_revision(o);for(const a of o.getAllLoadedCatalogues())(i=this.get_catalogue_state(a))!=null&&i.unsaved&&await this.save_catalogue(o,a,c)&&(n+=1)}}catch(o){notify({text:`Failed to save: ${o.name}: ${o.message}`,type:"error"}),t=!0}return n&&notify(`Incremented ${n} catalogue's revision`),t},set_filter(e){this.$state.filter=e,this.filterRegex=Fn(e)},init(e){this.catalogueComponent=e,globalThis.$store=this,globalThis.$node=Oc,globalThis.$search=t=>{var n;return this.system_search((n=this.catalogueComponent)==null?void 0:n.systemFiles,{filter:t})}},rerender_catalogue(){this.catalogueComponent&&(this.catalogueComponent.key+=1)},unselect(e){const t=[],n=[];for(const r of this.selections)e===void 0||he(r.obj)===he(e)?n.push(r):t.push(r);for(const r of this.selectedEntries)e===void 0||he(r.obj)===he(e)?n.push(r):t.push(r);this.selections=t;for(const r of n)r.onunselected&&r.onunselected(),r.obj===this.selectedItem&&(this.selectedItem=null)},is_selected(e){return e instanceof R?this.selectedEntries.find(t=>t.obj===e)!==void 0:this.selections.find(t=>t.obj===e)!==void 0},select(e,t,n){this.is_selected(e)||(e instanceof R?this.selectedEntries.push({obj:e,onunselected:t,payload:n}):this.selections.push({obj:e,onunselected:t,payload:n}))},do_select(e,t,n){const r=Array.isArray(n)?n:[n],s=this.selectedElementGroup,i=this.selectedElement;if(this.selectedElement=t,this.selectedElementGroup=n,e!=null&&e.shiftKey&&he(n)===he(s)){const o=r.findIndex(u=>u===he(i)),c=r.findIndex(u=>u===he(this.selectedElement)),a=Math.min(o,c),l=Math.max(o,c);for(let u=a;u<=l;u++)r[u].select();return}!(e!=null&&e.ctrlKey)&&!(e!=null&&e.metaKey)&&this.unselect(),e!=null&&e.ctrlKey&&this.is_selected(t)?this.unselect(t):(t.select(),this.selectedItem=t,this.mode="edit")},do_rightclick_select(e,t,n){this.is_selected(t)||this.do_select(e,t,n)},clear_selections(){this.unselect()},get_selections(){const e=this.selections.map(t=>Ne(t.obj));return this.selectedEntries.forEach(t=>e.push(t.obj)),e},get_selections_with_payload(){const e=this.selections.map(t=>({obj:Ne(t.obj),payload:t.payload}));return this.selectedEntries.forEach(t=>e.push({obj:t.obj,payload:t.payload})),e},get_selected(){return this.selectedItem&&Ne(this.selectedItem)},set_selections(e){this.clear_selections();const t=Array.isArray(e)?e:[e];this.selectedEntries=t.map(n=>({obj:n,onunselected:()=>null}))},async do_action(e,t,n){let r;try{r=await n()}catch(s){console.error(s);return}if(this.undoStackPos<this.undoStack.length){const s=this.undoStack.length-this.undoStackPos-1;this.undoStack.splice(this.undoStackPos+1,s,{type:e,undo:t,redo:n})}else this.undoStack.push({type:e,undo:t,redo:n});return this.undoStackPos+=1,r},async set_clipboard(e,t){if(this.clipboardmode==="json"){const n=e.map(s=>({parentKey:s.parentKey,...s,sortIndex:void 0})),r=so(n,new Set(["parentKey"]),{forceArray:!1,formatted:!0});t!=null&&t.clipboardData?t.clipboardData.setData("text/plain",r):await navigator.clipboard.writeText(r)}else this.clipboard=e},async get_clipboard(e){if(this.clipboardmode==="json")if(e!=null&&e.clipboardData){const t=e.clipboardData.getData("text/plain");return t?JSON.parse(t):[]}else{const t=await navigator.clipboard.readText();return JSON.parse(t)}return this.clipboard},can_undo(){return!!this.undoStack[this.undoStackPos]},async undo(){if(!this.can_undo())return;const e=this.undoStack[this.undoStackPos];e&&(await e.undo(),this.undoStackPos--)},can_redo(){return!!this.undoStack[this.undoStackPos+1]},async redo(){if(!this.can_redo())return;const e=this.undoStack[this.undoStackPos+1];e&&(await e.redo(),this.undoStackPos++)},async cut(e){await this.set_clipboard(this.get_selections(),e),this.remove()},async copy(e){await this.set_clipboard(this.get_selections(),e)},async paste(e){this.add(await this.get_clipboard(e))},async pasteLink(){const e=await this.get_clipboard();if(!e||!e.parentKey||Array.isArray(e))return;const n=this.get_selections()[0];if(!n)return;const r=n.getCatalogue().findOptionById(e.id);if(r){const s={parentKey:r.isGroup()||r.isEntry()?"entryLinks":"infoLinks",targetId:r.id,id:X(),type:r.editorTypeName,name:r.getName(),hidden:r.hidden,select:!0};this.add(s)}},async duplicate(){const e=this.get_selections();if(!e.length)return;const t=e[0].getCatalogue(),n=t.getSystemId();let r=[];const s=()=>{r=[];for(const o of e){const c=JSON.parse(jt(o,Rn));if(!o.parent)continue;const a=o.parent[o.parentKey];if(!Array.isArray(a))throw new Error(`Couldn't duplicate: parent[${o.parentKey}] is not an array`);Ce({[o.parentKey]:c}),ms(t,c),a.push(c),We(c,t,o.parent,this.get_system(n)),r.push(c)}},i=()=>{for(const o of r)Gt(t,pe(o)),ut(o)};await this.do_action("dupe",i,s),this.set_catalogue_changed(t,!0)},remove(e){let t=[];if(e)for(const a of Array.isArray(e)?e:[e])t.push(a);else{const a=this.get_selections();if(!a.length)return;for(const l of a)t.push(l)}const n=t[0].getCatalogue(),r=n.getSystemId();let s=[],i=[];const o=async()=>{const a=t,l=this.get_system(r);i=[],s=[];for(const u of a){const f=pe(u),d=Gt(n,f);i.push(d),s.push(f),ut(d,l)}i.reverse(),s.reverse()},c=async()=>{for(const[a,l]of Ji(s,i)){const u=ys(n,a,l);We(l,n,u,this.get_system(r))}};this.do_action("remove",c,o),this.set_catalogue_changed(n,!0),this.unselect()},async add(e,t,n){let r=[];if(n?(n=Array.isArray(n)?n:[n],r=n.map(f=>({obj:f}))):r=this.get_selections_with_payload(),!r.length){console.error("Couldn't add: no selection or parent(s) provided");return}const s=Array.isArray(e)?e:[e];if(!s.length){console.error("Couldn't add: no data provided");return}const i=r[0].obj.getCatalogue(),o=i.getSystemId();let c=[];const a=async()=>{var f;c=[];for(const d of r){const h=d.obj,y=d.payload;await this.open(h,!0);const p=[];for(const g of s){const m=vs(h,t||g.parentKey,y);if(!m){console.warn("Couldn't create",t||g.parentKey,"in",y);continue}h[m]||(h[m]=[]);const v=h[m];if(!Array.isArray(v))continue;if(!((f=ps(h,h.parentKey))!=null&&f.has(m))){console.warn("Couldn't add",m,"to a",h.parentKey,"because it is not allowed");continue}const w=g instanceof R?jt(g,Rn):JSON.stringify(g),k=JSON.parse(w);Wn(k,m),delete k.parentKey,Ce({[m]:k}),p.push({key:m,entry:k})}ms(i,p.map(g=>g.entry));for(const{key:g,entry:m}of p){h[g]||(h[g]=[]);const v=h[g];if(!Array.isArray(v))continue;this.filtered.push(m),m.showChildsInEditor=!0;let w=m;for(;w;)w.showInEditor=!0,w=w.parent;v.push(m),We(m,i,h,this.get_system(o)),c.push(m)}}return c[0]},l=()=>{for(const f of c)Gt(i,pe(f)),ut(f)},u=await this.do_action("add",l,a);return this.set_catalogue_changed(i,!0),u},open_selected(){for(const e of this.selections)e.obj.open()},get_initial_object(e,t){switch(e){case"costTypes":return{name:`New ${je(Se(e))}`,id:X(),defaultCostLimit:-1};case"repeats":return{value:1,repeats:1,field:"selections",scope:"parent",childId:"any",shared:!0,roundUp:!1,id:X()};case"constraints":{const s=(t==null?void 0:t.parentKey)==="associations",i={type:"min",value:1,field:t!=null&&t.isForce()?"forces":"selections",scope:"parent",shared:!0,id:X()};return s&&(i.childId="any"),i}case"conditions":return{type:"atLeast",value:1,field:"selections",scope:"parent",childId:"any",shared:!0};case"modifiers":return{type:"set",value:!0,field:"hidden"};case"modifierGroups":case"conditionGroups":return{type:"and"};case"sharedSelectionEntries":case"selectionEntries":return{type:"upgrade",import:!0,name:`New ${je(Se(e))}`,hidden:!1,id:X()};case"entryLinks":return{import:!0,name:`New ${je(Se(e))}`,hidden:!1,id:X()};case"associations":return{min:1,max:1,scope:"parent",childId:"any",ids:[],name:"New Association",id:X()};case"sharedProfiles":case"profiles":const n=t==null?void 0:t.getCatalogue().iterateProfileTypes().next().value;return{name:(!t||t!=null&&t.isCatalogue()||t==null?void 0:t.getName())||"New Profile",typeId:n==null?void 0:n.id,typeName:n==null?void 0:n.name,hidden:!1,id:X()};case"catalogueLinks":return{type:"catalogue",name:`New ${je(Se(e))}`,id:X()};case"categoryLinks":return{type:"category",name:`New ${je(Se(e))}`,hidden:!1,id:X()};default:return{name:`New ${je(Se(e))}`,hidden:!1,id:X()}}},async create(e,t){const n={...this.get_initial_object(e),select:!0,...t},r=await this.add(n,e);return this.open_selected(),r},async create_child(e,t,n){const r={...this.get_initial_object(e,t),select:!0,...n};await this.add(r,e,t),this.open_selected()},add_child(e,t,n){var a;const r=vs(t,e);if(!r)throw new Error(`Invalid key: ${e} in ${t.editorTypeName}`);const s=t.getCatalogue(),i=s.getSystemId(),o={...this.get_initial_object(r,t),id:X(),...n};t[r]||(t[r]=[]);const c=t[r];if(Array.isArray(c)){if(!((a=ps(t,t.parentKey))!=null&&a.has(r))){console.warn("Couldn't add",r,"to a",t.parentKey,"because it is not allowed");return}return Wn(o,r),delete o.parentKey,Ce({[r]:o}),c.push(o),We(o,s,t,this.get_system(i)),this.set_catalogue_changed(s),o}},del_child(e){e.catalogue&&this.set_catalogue_changed(e.catalogue);try{const t=e.catalogue,n=t.manager,r=pe(e),s=Gt(t,r);ut(s,n)}catch{console.error("Failed to delete",e)}},can_move(e){return!e.isLink()},edit_child(e,t){const n=JSON.parse(e.toJson());Object.assign(n,t),Ce({[e.parentKey]:n}),Object.assign(e,n),this.set_catalogue_changed(e.catalogue)},get_move_targets(e){const t=e.catalogue;if(!t||e.isLink())return;const n=[];if(!e.parentKey.startsWith("shared")&&this.move_to_key(e,"shared")?n.push({target:t,type:"shared"}):e.parentKey.startsWith("shared")&&this.move_to_key(e,"root")&&n.push({target:t,type:"root"}),this.move_to_key(e,"shared"))for(const r of t.imports)n.push({target:r,type:"shared"});if(this.move_to_key(e,"root"))for(const r of t.imports)n.push({target:r,type:"root"});return n},move_to_key(e,t){if(t==="shared")switch(e.editorTypeName){case"infoGroup":return"sharedInfoGroups";case"rule":return"sharedRules";case"profile":return"sharedProfiles";case"selectionEntry":return"sharedSelectionEntries";case"selectionEntryGroup":return"sharedSelectionEntryGroups";default:return""}switch(e.editorTypeName){case"infoGroup":return"infoGroups";case"rule":return"rules";case"profile":return"";case"category":return"categoryEntries";case"profileType":return"profileTypes";case"costType":return"costTypes";case"selectionEntry":return"selectionEntries";case"selectionEntryGroup":return"";default:return e.parentKey}},move(e,t,n,r){(()=>{const i=this.move_to_key(e,r);if(!i){console.error("Could not find key for move",e.editorTypeName,r);return}const o=e.parent,c=pe(e);pc(e),ut(e);const a=JSON.parse(jt(e,Rn));Ce({[i]:a}),n[i]||(n[i]=[]),n[i].push(a),We(a,n,n,this.get_system(n.getSystemId()));const u=["rule","infoGroup","profile","selectionEntry","selectionEntryGroup"].includes(e.editorTypeName),f=!e.parentKey.startsWith("shared");if(u&&f){const d={targetId:a.id,id:t.generateNonConflictingId(),type:e.editorTypeName,name:e.getName(),hidden:e.hidden,select:!0};e.isEntry()&&(d.collective=e.collective);const h=e.isGroup()||e.isEntry()?"entryLinks":"infoLinks";Ce({[h]:d}),c[c.length-1].key=h,ys(t,c,d),We(d,t,o,this.get_system(t.getSystemId()))}})(),this.set_catalogue_changed(t,!0),this.set_catalogue_changed(n,!0)},async open(e,t,n){var l;let r=document.getElementById("editor-entries");if(!r)return;async function s(u){const f=ve(u);Ne(f).showInEditor=!0,f.open(),await f.$nextTick()}async function i(u){const f=ve(u);f.close(),await f.$nextTick()}const o=pe(e);if(!(o!=null&&o.length))return;if(r=r.getElementsByClassName(`depth-0 ${o[0].key}`)[0],!r){n!==!0&&console.error("Couldn't find root element for",o[0].key,"in",e.catalogue.getName());return}await this.show(e),await s(r);const c=[];wn(e,u=>{c.push(u)}),c.pop(),c.reverse(),c.push(e),c[0].parentKey==="sharedProfiles"&&c.unshift({parentKey:`label-${c[0].typeName??"Untyped"}`});const a=c[c.length-1];for(let u=0;u<c.length;u++){const f=c[u],d=r.getElementsByClassName(`depth-${u+1} ${f.parentKey}`);let h;f.parentKey.startsWith("label-")?h=d[0]:h=[...d].find(y=>$toRaw(Ne(ve(y)))===$toRaw(f)),h||n!==!0&&console.error("Couldn't find path to",e.getName(),e,"parent:",(l=e.parent)==null?void 0:l.getName()),h&&(r=h),f!==a&&await s(r),f===a&&(t===!1?await i(r):t===!0&&await s(r))}return r},async goto_catalogue(e,t){var o,c,a;const n=this.$router;if(!n)throw new Error("Cannot follow link to another catalogue without $router set");const s=((o=n.currentRoute)==null?void 0:o.query)??((a=(c=n.currentRoute)==null?void 0:c.value)==null?void 0:a.query),i=(s==null?void 0:s.id)||(s==null?void 0:s.systemId);return e!==i?(n.push({name:"catalogue",query:{systemId:t||e,id:e}}),this.$nextTick=new Promise((l,u)=>{this.$nextTickResolve=l}),await this.$nextTick,!0):!1},async show(e,t=!0){this.filtered.includes(e)||this.filtered.push(e),e.showInEditor=!0,e.showChildsInEditor=!0,t&&(e.highlight=!0),wn(e,n=>{n.showInEditor=!0})},async goto(e){const t=e.getCatalogue();this.put_current_state_in_history();const n=An();n.get_data(t.id).selection=pe(e),await this.goto_catalogue(t.id,t.gameSystemId),this.show(e,!1),await this.scrollto(e)},async scrollto(e){const t=await this.open(e);if(t){const n=ve(t);this.do_select(null,n,n),t.scrollIntoView({behavior:"instant",block:"center",inline:"center"})}else setTimeout(async()=>{const n=await this.open(e);if(n){const r=ve(n);this.do_select(null,r,r),n.scrollIntoView({behavior:"instant",block:"center",inline:"center"})}},50)},can_goto(e){return e?typeof e=="object"&&e instanceof R:!1},can_follow(e){return!!(e!=null&&e.target)},async follow(e){e!=null&&e.target&&await this.goto(e.target)},async move_up(e){if(e.parent){const t=e.parent[e.parentKey],n=t.indexOf(e);if(n>0){const r=t.splice(n,1)[0];t.splice(n-1,0,r)}}},async move_down(e){if(e.parent){const t=e.parent[e.parentKey],n=t.indexOf(e);if(n>=0&&n<t.length-1){const r=t.splice(n,1)[0];t.splice(n+1,0,r)}}},get_leftpanel_open_collapsible_boxes(){function e(n,r,s=0){const i=`depth-${s} collapsible-box opened`,o=n.getElementsByClassName(i);if(o!=null&&o.length)for(const c of o){const a=Ne(ve(c)),l=a.parentKey,u=a.parent;if(u){const f=u[l];if(!f||!Array.isArray(f))continue;const d=f.indexOf(a);l in r||(r[l]={}),d in r[l]||(r[l][d]={}),e(c,r[l][d],s+1)}else{const f=[...c.classList].filter(d=>st.has(d)||d.startsWith("label-"));for(const d of f)r[d]={},r[d][0]={};e(c,r[f[0]][0],s+1)}}}const t={};return e(document.documentElement,t),t},get_leftpanel_state(){if(!this.catalogueComponent)return{};const e={},t=this.catalogueComponent.$refs.leftpanel;for(const n of Object.keys(Ac))e[n]=t[n];return e},get_current_state(){var n;const e=this.get_selected(),t=(n=this.catalogueComponent)==null?void 0:n.cat;return{...this.get_leftpanel_state(),mode:this.mode,open:this.get_leftpanel_open_collapsible_boxes(),selection:e?pe(e):void 0,catalogueId:t==null?void 0:t.id,systemId:t==null?void 0:t.gameSystemId}},save_state(){if(this.catalogueComponent&&this.catalogueComponent.cat){const e=this.catalogueComponent.cat.id,t=An(),n=this.get_current_state();t.set_state(e,n)}},async load_state(e){this.catalogueComponent&&(An().set_state(e.catalogueId,e),this.mode=e.mode||"edit",await this.goto_catalogue(e.catalogueId,e.systemId)||(this.catalogueComponent.load_state(e),this.rerender_catalogue()))},put_state_in_history(e){if(this.historyStackPos<this.historyStack.length){const t=this.historyStack.length-this.historyStackPos;this.historyStack.splice(this.historyStackPos,t,e)}else this.historyStack.push(e);this.historyStackPos=this.historyStack.length},put_current_state_in_history(){this.catalogueComponent&&this.catalogueComponent.cat&&this.put_state_in_history(this.get_current_state())},can_back(){return this.historyStackPos>0},async back(){this.can_back()&&(this.historyStack[this.historyStackPos]=this.get_current_state(),this.historyStackPos-=1,this.load_state(this.historyStack[this.historyStackPos]))},can_forward(){if(this.historyStack[this.historyStack.length-1])return this.historyStackPos<this.historyStack.length-1},async forward(){this.can_forward()&&(this.historyStackPos+=1,this.load_state(this.historyStack[this.historyStackPos]))},async update_catalogue_search(e,t){const{filter:n,ignoreProfilesRules:r}=t,s=this.filtered;for(const i of s)delete i.showInEditor,delete i.showChildsInEditor,delete i.highlight,wn(i,o=>{delete o.showInEditor,delete i.showChildsInEditor});if(n.length>1){this.set_filter(n),this.filtered=e.findOptionsByText(n),r&&(this.filtered=this.filtered.filter(i=>!i.isProfile()&&!i.isRule()&&!i.isInfoGroup()));for(const i of this.filtered)this.show(i);if(await Di(),this.filtered.length<300){for(const i of this.filtered)if(i.parent)try{await this.open(i,!1,!0)}catch{continue}}}else this.set_filter(""),this.filtered=[]},async system_search(e,t,n=1e3){const r=[],{filter:s}=t;if(!s)return null;const i=Fn(s);let o=!1;await e.loadAll();for(const a of e.getAllLoadedCatalogues())if(a.forEachObjectWhitelist((l,u)=>{var f;try{if(r.length>=n||l.targetId&&l.target&&l.target.isCategory()&&!(u!=null&&u.isForce()))return;const d=(f=l.getName)==null?void 0:f.call(l),h=l.$text,y=l.description,p=l.id;(p===s||d&&String(d).match(i)||p===s||h&&String(h).match(i)||y&&String(y).match(i))&&r.push(l)}catch(d){console.error("Error while searching:",d)}}),r.length>=n){o=!0;break}console.log("Search for",`"${s}"`,"found",r.length,"results");const c={};for(const a of r)Je(c,a.catalogue.name,a);return{grouped:c,all:r,more:o}}}});export{zl as A,Rl as B,Jr as C,dc as D,Bl as E,Pr as F,Ec as G,Tr as H,Ae as I,Ic as J,_c as K,Ac as L,Cc as M,ri as N,no as P,Vn as a,Xe as b,ye as c,Ml as d,Ne as e,ve as f,Kl as g,An as h,Se as i,je as j,pe as k,ao as l,ps as m,hc as n,Fl as o,Ul as p,bs as q,xl as r,Dn as s,xc as t,ql as u,Sc as v,oc as w,ti as x,ac as y,gn as z};
//# sourceMappingURL=editorStore.bd876df7.js.map
