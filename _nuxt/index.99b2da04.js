import{_ as H,a as se}from"./CreateSystem.667977ad.js";import{l as X,m as le,n as Z,o as L,p as g,q as P,r as ne,e as R,u as O,t as _,a as M,v as K,w as re,x as ie,j as ue,k as de,g as ce,y as me,z as w}from"./editorStore.8a197e9c.js";import{b as J,E as B,o as r,f as i,i as a,u as y,F as b,l as h,a as T,w as I,v as x,G as ge,t as m,p as z,z as q,h as D,s as G,x as W,q as f,c as F,k as A,H as pe,j as _e,B as he,y as Y,T as fe}from"./entry.02aa96f5.js";import{_ as ye,a as Q}from"./SplitView.6cf7bc2a.js";const be=["disabled"],ve=J({__name:"UploadJson",emits:["uploaded"],setup(e,{emit:t}){const s=B(null),l=B(!1);async function c(n){var u;try{l.value=!0;const d=[...((u=n.target)==null?void 0:u.files)||[]];if(!d){l.value=!1;return}const C=[];for(const k of d.filter(S=>X(S.name))){const S=le(k.name)?await k.arrayBuffer():await k.text(),$=await Z(S,L(k.name)),U=g($).fullFilePath="none";C.push($)}C.length&&t("uploaded",C),l.value=!1}catch(d){console.error(d),l.value=!1}}async function o(){s.value.click()}return(n,u)=>(r(),i(b,null,[a("input",{type:"file",accept:".gst, .gstz, .xml, .zip, .cat, .catz, .json",multiple:"",onChange:c,class:"invisible",ref_key:"fileinput",ref:s},null,544),a("button",{onClick:o,class:"bouton",disabled:y(l)},[y(l)?(r(),i(b,{key:1},[h(" ... ")],64)):(r(),i(b,{key:0},[h(" Import Catalogues ")],64))],8,be)],64))}});const ee=T(ve,[["__scopeId","data-v-d9b826d9"]]),Ce=["disabled"],te=J({__name:"ImportFromGithub",emits:["uploaded"],setup(e,{emit:t}){const s=B(""),l=B(!1);async function c(o){if(!o||P(o)!==o){console.log("bad url",o);return}try{l.value=!0;const n=o.split("/").slice(-2).join("/"),u=n.split("/")[1],d=`https://api.github.com/repos/${n}`,C=(await $fetch(d)).default_branch,k=`https://codeload.github.com/${n}/zip/refs/heads/${C}`,S=await $fetch(`https://corsproxy.io/?${k}`),$=await ne(S,`${u}-${C}`),U=[];for(const[p,j]of Object.entries($)){const V=L(p);if(X(V)){const N=await Z(j,V);U.push(N),g(N).fullFilePath=p}}U.length&&t("uploaded",U),s.value=""}catch(n){console.error(n)}finally{l.value=!1}}return(o,n)=>(r(),i(b,null,[I(a("input",{type:"text",class:"bouton !font-normal","onUpdate:modelValue":n[0]||(n[0]=u=>ge(s)?s.value=u:null),placeholder:'repo eg: "BSData/wh40k"'},null,512),[[x,y(s)]]),a("button",{onClick:n[1]||(n[1]=u=>c(y(P)(y(s)))),class:"bouton",disabled:y(P)(y(s))==null||y(l)},m(y(l)?"...":"Import from github"),9,Ce)],64))}}),ke={emits:["new","itemClicked","itemDoubleClicked"],setup(){return{cataloguesStore:R(),store:O()}},props:{items:{type:Array,required:!0},modelValue:{required:!0}},methods:{getType(e){var t;return e.gameSystem?{icon:"./assets/icons/system1.png",order:1}:(t=e.catalogue)!=null&&t.library?{icon:"./assets/icons/library.png",order:2}:{icon:"./assets/icons/book.png",order:3}},elementDoubleClicked(e){this.$emit("itemDoubleClicked",e)},elementClicked(e){this.$emit("itemClicked",e)},errors(e){var s;const t=[];return(s=this.store.get_catalogue_state(e))!=null&&s.unsaved&&t.push({severity:"info",msg:"Unsaved"}),t},edited(e){return this.cataloguesStore.getEdited(_(e))},name(e){return g(e).name},add(){this.$emit("new")}},computed:{sortedItems(){return M(M(this.items,e=>this.name(e)),e=>this.getType(e).order)}},components:{ErrorIcon:K}};const ae=e=>(G("data-v-74295ace"),e=e(),W(),e),Se={class:"items"},we=["onClick","onDblclick"],Ie=["src"],$e=ae(()=>a("img",{class:"w-40px h-40px",src:ye},null,-1)),Ue=ae(()=>a("div",{class:"bold text-blue"},"New",-1)),xe=[$e,Ue];function De(e,t,s,l,c,o){const n=K;return r(),i("div",Se,[(r(!0),i(b,null,z(o.sortedItems,u=>(r(),i("div",{class:q(["relative item unselectable",{edited:o.edited(u),selected:u===s.modelValue}]),onClick:d=>o.elementClicked(u),onDblclick:d=>o.elementDoubleClicked(u)},[D(n,{class:"error",errors:o.errors(u)},null,8,["errors"]),a("img",{class:"icon",src:o.getType(u).icon},null,8,Ie),a("div",null,m(o.name(u)),1)],42,we))),256)),a("div",{class:"relative item add unselectable",onClick:t[0]||(t[0]=(...u)=>o.add&&o.add(...u))},xe)])}const oe=T(ke,[["render",De],["__scopeId","data-v-74295ace"]]),Ee={emits:["edit","delete"],props:{catalogue:{type:Object,required:!0}},setup(){return{catalogueStore:R(),store:O()}},data(){return{deletePopup:!1}},methods:{download_file(){const e=g(this.catalogue),t=this.store.get_system(e.gameSystemId||e.id).getLoadedCatalogue({targetId:e.id}),s=re(t||e);ie(e.gameSystemId?`${e.name}.cat`:`${e.name}.gst`,"application/xml",s)}},computed:{electron(){return!!globalThis.electron},imports(){return this.cataloguedata.catalogueLinks||[]},refs(){return this.catalogueStore.getDependents(_(this.catalogue))||[]},cataloguedata(){return g(this.catalogue)},isSystem(){return!this.cataloguedata.gameSystemId}}};const v=e=>(G("data-v-d9f7a9e2"),e=e(),W(),e),Ve={class:"details"},Ne=v(()=>a("span",{class:"grey"},"Library:",-1)),Fe=v(()=>a("span",{class:"grey"},"Id:",-1)),Te=v(()=>a("span",{class:"grey"},"path:",-1)),je={key:0},Be=v(()=>a("span",{class:"grey"},"authorUrl:",-1)),ze=v(()=>a("span",{class:"grey"},"authorContact:",-1)),Pe=v(()=>a("span",{class:"grey"},"authorName:",-1)),qe={key:1},Ae=v(()=>a("span",{class:"bold"},"imports:",-1)),Le={class:"ml-10px"},Re={key:2},Oe=v(()=>a("span",{class:"bold"},"imported by:",-1)),Je={class:"ml-10px"},Ge={class:"section boutons"},We=v(()=>a("p",{class:"info"}," To quickly edit a catalogue, you can double-click on it. ",-1));function Me(e,t,s,l,c,o){var u;const n=pe;return r(),i("fieldset",Ve,[a("div",null,[a("legend",null,m(o.cataloguedata.name),1),a("div",null,[Ne,h(" "+m(o.cataloguedata.library),1)]),a("div",null,[Fe,h(" "+m(o.cataloguedata.id),1)]),a("div",null,[Te,h(" "+m(o.cataloguedata.fullFilePath),1)]),o.electron?(r(),i("div",je,[Be,h(" "+m(o.cataloguedata.authorUrl),1)])):f("",!0),a("div",null,[ze,h(" "+m(o.cataloguedata.authorContact),1)]),a("div",null,[Pe,h(" "+m(o.cataloguedata.authorName),1)]),(u=o.cataloguedata.catalogueLinks)!=null&&u.length?(r(),i("div",qe,[Ae,a("div",Le,[(r(!0),i(b,null,z(o.cataloguedata.catalogueLinks,d=>(r(),i("div",null,[a("span",{class:q({grey:!d.importRootEntries})},m(d.name),3)]))),256))])])):f("",!0),o.refs.length&&!o.isSystem?(r(),i("div",Re,[Oe,a("div",Je,[(r(!0),i(b,null,z(o.refs,d=>(r(),i("div",null,[a("span",{class:q({grey:!d.importRootEntries})},m(d.sourceName),3)]))),256))])])):f("",!0)]),a("div",Ge,[a("button",{class:"bouton",onClick:t[0]||(t[0]=d=>e.$emit("edit",s.catalogue))},"Edit"),a("button",{class:"bouton",onClick:t[1]||(t[1]=d=>c.deletePopup=!0)},"Delete"),a("button",{class:"bouton",onClick:t[2]||(t[2]=(...d)=>o.download_file&&o.download_file(...d))},"Download"),We]),c.deletePopup?(r(),F(n,{key:0,button:"Confirm",text:"Cancel",onButton:t[3]||(t[3]=d=>e.$emit("delete",s.catalogue)),modelValue:c.deletePopup,"onUpdate:modelValue":t[4]||(t[4]=d=>c.deletePopup=d)},{default:A(()=>[a("div",null,"Are you sure you want to delete this "+m(s.catalogue.catalogue?"catalogue":"Game System")+"?",1)]),_:1},8,["modelValue"])):f("",!0)])}const Ye=T(Ee,[["render",Me],["__scopeId","data-v-d9f7a9e2"]]),He={emits:["create"],props:{catalogue:{type:Object,required:!0}},computed:{cataloguedata(){return g(this.catalogue)}}};const E=e=>(G("data-v-e3adc0bd"),e=e(),W(),e),Xe={class:"details"},Ze={class:"editorTable"},Ke=E(()=>a("td",null,[a("label",{for:"name"}," name: ")],-1)),Qe=E(()=>a("td",null,[a("label",{for:"authorUrl"}," authorUrl: ")],-1)),et=E(()=>a("td",null,[a("label",{for:"authorContact"}," authorContact: ")],-1)),tt=E(()=>a("td",null,[a("label",{for:"authorName"}," authorName: ")],-1)),at=E(()=>a("td",null,"id:",-1)),ot=E(()=>a("td",null,[a("label",{for:"library"}," library: ")],-1));function st(e,t,s,l,c,o){return r(),i("fieldset",Xe,[a("legend",null,m(o.cataloguedata.name),1),a("table",Ze,[a("tr",null,[Ke,a("td",null,[I(a("input",{type:"text",id:"name","onUpdate:modelValue":t[0]||(t[0]=n=>o.cataloguedata.name=n)},null,512),[[x,o.cataloguedata.name]])])]),a("tr",null,[Qe,a("td",null,[I(a("input",{type:"text",id:"authorUrl","onUpdate:modelValue":t[1]||(t[1]=n=>o.cataloguedata.authorUrl=n)},null,512),[[x,o.cataloguedata.authorUrl]])])]),a("tr",null,[et,a("td",null,[I(a("input",{type:"text",id:"authorContact","onUpdate:modelValue":t[2]||(t[2]=n=>o.cataloguedata.authorContact=n)},null,512),[[x,o.cataloguedata.authorContact]])])]),a("tr",null,[tt,a("td",null,[I(a("input",{type:"text",id:"authorName","onUpdate:modelValue":t[3]||(t[3]=n=>o.cataloguedata.authorName=n)},null,512),[[x,o.cataloguedata.authorName]])])]),a("tr",null,[at,a("td",null,[I(a("input",{type:"text",class:"gray",id:"id","onUpdate:modelValue":t[4]||(t[4]=n=>o.cataloguedata.id=n)},null,512),[[x,o.cataloguedata.id]])])]),a("tr",null,[ot,a("td",null,[I(a("input",{type:"checkbox",id:"library","onUpdate:modelValue":t[5]||(t[5]=n=>o.cataloguedata.library=n)},null,512),[[_e,o.cataloguedata.library]])])])]),a("button",{class:"bouton",onClick:t[6]||(t[6]=n=>e.$emit("create",s.catalogue))}," Create Catalogue ")])}const lt=T(He,[["render",st],["__scopeId","data-v-e3adc0bd"]]),nt=J({components:{UploadJson:ee,CataloguesDetail:Ye,ImportFromGithub:te,CataloguesCreate:lt,SelectFile:H,IconContainer:oe,SplitView:Q},head(){return{title:"New Recruit - Editor"}},data(){return{msg:"",selectedItem:null,mode:"edit",editingItem:null,failed:!1}},setup(){return{cataloguesStore:R(),store:O(),settings:he()}},created(){this.store.init(this.$router),electron||this.store.load_systems_from_db()},activated(){window.addEventListener("beforeunload",this.beforeUnload)},deactivated(){window.removeEventListener("beforeunload",this.beforeUnload)},computed:{electron(){return!!globalThis.electron},filter(){var t;const e=(t=this.$route.query)==null?void 0:t.id;if(e)return e.split(",")},systems(){if(this.filter){const e={};for(const t of this.filter){const s=this.store.gameSystems[t];return s&&(e[t]=s),e}}return this.store.gameSystems}},methods:{saveAll(){var t;let e=!1;try{for(const s of Object.values(this.systems))for(const l of s.getAllLoadedCatalogues())(t=this.store.get_catalogue_state(l))!=null&&t.unsaved&&this.store.save_catalogue(s,l)}catch{e=!0}this.failed=e},async beforeUnload(e){if(!globalThis._closeWindow){if(this.store.unsavedCount){const t="You have unsaved changes that will be lost";e.returnValue=t,electron&&setTimeout(async()=>{await ue({message:"You have unsaved changes that will be lost?",buttons:["Cancel","Leave"],defaultId:0,cancelId:0,type:"question"})===1&&(globalThis._closeWindow=!0,de())})}return!1}},systemAndCatalogues(e){let t=[];return e.gameSystem&&t.push(e.gameSystem),e.catalogueFiles&&t.push(...Object.values(e.catalogueFiles)),t},itemClicked(e){this.selectedItem=e,this.mode="edit"},itemDoubleClicked(e){const t=g(e).id,s=g(e).gameSystemId||t;this.$router.push({name:"catalogue",query:{systemId:s,id:t}})},newCatalogue(e){if(!e.gameSystem)return;const t=e.gameSystem.gameSystem;this.mode="create",this.selectedItem={catalogue:{library:!1,id:ce(),name:"New Catalogue",gameSystemId:t.id,gameSystemRevision:t.revision,revision:1}}},getCatExtension(e){switch(L(e)){case"json":return"json";case"gstz":return"catz";default:case"gst":return"cat"}},createCatalogue(e){const t=this.store.get_system(e.catalogue.gameSystemId),s=JSON.parse(JSON.stringify(e));if(s.catalogue.battleScribeVersion="2.03",electron){if(!t.gameSystem)throw new Error("Cannot create catalogue: no game system");const l=g(t.gameSystem).fullFilePath;if(!l)throw new Error("Cannot create catalogue: game system has no path set");const c=s.catalogue.name;if(!c)throw new Error("Cannot create catalogue: no name provided");const o=me(l);g(s).fullFilePath=`${o}/${c}.${this.getCatExtension(l)}`}t.setCatalogue(s),this.cataloguesStore.setEdited(_(s),!0),this.store.set_catalogue_changed(s,!0),this.selectedItem=s,electron||w.catalogues.put({content:s,id:_(e)}),this.mode="edit"},deleteCatalogue(e){console.log("Deleted catalogue",e);const t=g(e),s=t.gameSystemId||t.id;if(e.catalogue)this.store.get_system(s).removeCatalogue(e),electron||w.catalogues.delete(_(e));else if(e.gameSystem){const l=this.store.get_system(s);for(const c of Object.values(l.catalogueFiles)){const o=_(c);w.catalogues.delete(o)}w.catalogues.delete(_(l.gameSystem)),w.systems.delete(_(l.gameSystem)),this.store.delete_system(s)}this.selectedItem=null},filesUploaded(e){console.log("Uploaded",e.length,"files",e);const t=e.filter(l=>l.gameSystem);for(const l of t){const c=l.gameSystem.id,o=_(l);this.store.get_system(c).setSystem(l),electron||w.systems.put({content:l,id:o}),this.cataloguesStore.updateCatalogue(l.gameSystem),this.cataloguesStore.setEdited(o,!1)}const s=e.filter(l=>l.catalogue);for(const l of s){const c=l.catalogue.gameSystemId;this.store.get_system(c).setCatalogue(l),electron||w.catalogues.put({content:l,id:_(l)}),this.cataloguesStore.updateCatalogue(l.catalogue),this.cataloguesStore.setEdited(_(l),!1)}delete this.$route.query.id},async editCatalogue(e){const t=g(e).id,s=g(e).gameSystemId||t;this.$router.push({name:"catalogue",query:{systemId:s,id:t}})}}});const rt={key:0,class:"p-10px"},it={class:"box"},ut=a("h3",null,"My Catalogues",-1),dt={class:"boutons"},ct={key:0},mt=a("p",{class:"info"},[h(" To return to this page, simply click on the 'New Recruit' icon located in the top-left corner of the screen. "),a("br"),h(" Returning to this page will not cause you to lose your changes. ")],-1),gt={class:"mx-10px box h-full pb-200px"},pt={class:"scrollable"},_t=["href"],ht=["src","title"],ft={key:0,class:"scrollable"},yt={key:1,class:"status mx-2 text-red"},bt={key:2,class:"status mx-2"};function vt(e,t,s,l,c,o){const n=H,u=ee,d=te,C=se,k=oe,S=Y("CataloguesCreate"),$=Y("CataloguesDetail"),U=Q;return r(),i(b,null,[e.electron?f("",!0):(r(),i("div",rt,[a("div",it,[ut,a("div",dt,[e.electron?(r(),F(n,{key:0,onUploaded:e.filesUploaded},null,8,["onUploaded"])):f("",!0),D(u,{onUploaded:e.filesUploaded},null,8,["onUploaded"]),D(d,{onUploaded:e.filesUploaded},null,8,["onUploaded"]),D(C)]),e.electron?(r(),i("div",ct," Note: if you modify an already imported file in another program, you will need to import it again ")):f("",!0)])])),mt,a("div",gt,[D(U,{split:!0,double:!0,showRight:e.selectedItem!=null,leftWidth:"calc(100% - 400px)",rightWidth:"400px"},{left:A(()=>[a("div",pt,[(r(!0),i(b,null,z(e.systems,p=>{var j,V;return r(),i("fieldset",null,[a("legend",null,[h(m(((j=p.gameSystem)==null?void 0:j.gameSystem.name)||"Unknown GameSystem")+" ",1),(V=p.github)!=null&&V.githubUrl?(r(),i("a",{key:0,href:p.github.githubUrl,target:"_blank"},[a("img",{class:"w-24px h-24px align-bottom",src:e.settings.theme==="dark"?"assets/icons/github-dark.png":"assets/icons/github-light.png",title:`using repo at ${p.github.githubUrl}`},null,8,ht)],8,_t)):f("",!0)]),D(k,{items:e.systemAndCatalogues(p),onItemClicked:e.itemClicked,onItemDoubleClicked:e.itemDoubleClicked,onNew:N=>e.newCatalogue(p),modelValue:e.selectedItem,"onUpdate:modelValue":t[0]||(t[0]=N=>e.selectedItem=N)},null,8,["items","onItemClicked","onItemDoubleClicked","onNew","modelValue"])])}),256))])]),right:A(()=>[e.selectedItem?(r(),i("div",ft,[e.mode==="create"?(r(),F(S,{key:0,onCreate:e.createCatalogue,catalogue:e.selectedItem},null,8,["onCreate","catalogue"])):(r(),F($,{key:1,onDelete:e.deleteCatalogue,onEdit:e.editCatalogue,catalogue:e.selectedItem},null,8,["onDelete","onEdit","catalogue"]))])):f("",!0)]),_:1},8,["showRight"]),e.store.unsavedCount&&e.$route.name=="index"?(r(),F(fe,{key:0,to:"#titlebar-content"},[e.store.unsavedCount?(r(),i("button",{key:0,class:"bouton save ml-10px !w-100px",onClick:t[1]||(t[1]=(...p)=>e.saveAll&&e.saveAll(...p))},"Save All")):e.failed?(r(),i("span",yt,"failed to save")):(r(),i("span",bt,"saved"))])):f("",!0)])],64)}const It=T(nt,[["render",vt]]);export{It as default};
