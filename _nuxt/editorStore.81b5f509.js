var Ni=Object.defineProperty;var Oi=(e,t,r)=>t in e?Ni(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var b=(e,t,r)=>(Oi(e,typeof t!="symbol"?t+"":t,r),r);import{ae as Ts,af as ee,ag as xe,ah as Ti,ai as Br,aj as Ai,ak as qe,al as Fr,j as Y,am as Pi,V as Li,an as Je,ao as vr,ap as $i,aq as Gi,ar as Ri,as as zn,at as qn,a8 as vn,a2 as As,ad as Ps,au as Bi,av as jn,aw as Fi,ac as Ki,ax as Mi,ay as Ui,a5 as zi,az as qi,q as br,S as he,aA as wr,aB as ji}from"./entry.5567fa53.js";function Wi(e){if(!e.constraints)return e;const t=[];for(const n of e.constraints)if(n.type==="exactly"){const s={...n,id:n.id+"-min",type:"min"},i={...n,id:n.id+"-max",type:"max"};t.push(s,i)}else t.push(n);const r=Ts(e);return r.constraints=t,r}function Vi(e){if(!e.modifiers&&!e.modifierGroups||!e.constraintsIterator)return e;const t={};for(const i of e.constraintsIterator())i.type==="exactly"&&(t[i.id]=i);function r(i){const o=[];for(const c of i)if(c.field in t){const a={...c,field:c.field+"-min"},l={...c,field:c.field+"-max"};o.push(a,l)}else o.push(c);return o}function n(i){const o=[];for(const c of i){const a={...c};a.modifiers&&(a.modifiers=r(a.modifiers)),a.modifierGroups&&(a.modifierGroups=n(a.modifierGroups)),o.push(a)}return o}const s=Ts(e);return s.modifiers&&(s.modifiers=r(s.modifiers)),s.modifierGroups&&(s.modifierGroups=n(s.modifierGroups)),s}const Di=["modifiers","modifierGroups","constraints","entryLinks","categoryLinks","selectionEntries","selectionEntryGroups","infoLinks","infoGroups","rules","profiles"],Ls=["profile","rule","infoLink","infoGroup","selectionEntry","selectionEntryGroup","entryLink","profiles","rules","infoLinks","infoGroups","entryLinks","selectionEntries","selectionEntryLinks","selectionEntryGroups","categoryLinks","costTypes","profileTypes","characteristicTypes","categoryEntries","categories","forceEntries","forces","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","rules","rootRules","publications","catalogueLinks","constraints","characteristics","costs"],Ji=["conditions","conditionGroups","modifiers","modifierGroups","repeats"],bn=new Set([...Ls,...Ji]),Hi=new Set(Ls);function ye(e){if(e.isCatalogue&&e.isCatalogue())return e;if(e.gameSystem)return e.gameSystem;if(e.catalogue)return e.catalogue;throw Error("getDataObject data argument is not a valid system or catalogue")}function Wn(e){if(e.isCatalogue&&e.isCatalogue()){if(e.id&&e.gameSystemId)return`${e.gameSystemId}-${e.id}`;if(e.id)return`${e.id}`}if(e.catalogue)return`${e.catalogue.gameSystemId}-${e.catalogue.id}`;if(e.gameSystem)return e.gameSystem.id;throw Error("getDataId data argument is not a valid system or catalogue")}class R{constructor(t){b(this,"id");b(this,"type");b(this,"subType");b(this,"shared");b(this,"import");b(this,"collective");b(this,"comment");b(this,"publicationId");b(this,"typeName");b(this,"typeId");b(this,"categoryEntryId");b(this,"name");b(this,"hidden");b(this,"value");b(this,"page");b(this,"defaultAmount");b(this,"profiles");b(this,"rules");b(this,"infoLinks");b(this,"infoGroups");b(this,"publications");b(this,"costs");b(this,"selectionEntries");b(this,"selectionEntryGroups");b(this,"entryLinks");b(this,"profileTypes");b(this,"categoryEntries");b(this,"categoryLinks");b(this,"forceEntries");b(this,"sharedSelectionEntryGroups");b(this,"sharedSelectionEntries");b(this,"sharedProfiles");b(this,"sharedRules");b(this,"sharedInfoGroups");b(this,"target");b(this,"modifiers");b(this,"modifierGroups");b(this,"constraints");b(this,"repeats");b(this,"conditions");b(this,"conditionGroups");b(this,"catalogue");b(this,"extra_constraints");b(this,"childs");b(this,"loaded");b(this,"collective_recursive");b(this,"limited_to_one");b(this,"associations");b(this,"associationConstraints");b(this,"flatten");b(this,"collapsible");b(this,"sortIndex");return Object.setPrototypeOf(t,Object.getPrototypeOf(this))}get url(){return"%{main_catalogue|catalogue}/%{id}/%{getName}"}process(){this.loaded||(this.collective_recursive=this.isCollectiveRecursive(),this.limited_to_one=!this.canAmountBeAbove1(),this.loaded=!0)}toJson(){return jt(this)}getCatalogue(){return this.catalogue}getGameSystem(){return this.getCatalogue().getGameSystem()}get[Symbol.toStringTag](){return globalThis.isEditor?"Object":"ObjectNoObserve"}isGroup(){return!1}isForce(){return!1}isCatalogue(){return!1}isLink(){return!1}isCategory(){return!1}isRoster(){return!1}isQuantifiable(){return!1}isEntry(){return!1}isIdUnique(){return!1}isRule(){return!1}isProfile(){return!1}isInfoGroup(){return!1}isUnit(){for(const t of this.categoryLinks||[])if(t.primary)return!0;return!1}getId(){return this.id}getType(){return this.subType??this.type}getTypeName(){return this.typeName}getCategoryEntryId(){return this.categoryEntryId}getHidden(){return this.hidden}getPage(){return this.page}getName(){return this.name}getDefaultAmount(){return this.defaultAmount}isCollective(){return this.collective}isCollectiveRecursive(){const t=[...this.selectionsIterator()];for(;t.length;){const r=t.pop();if(!r.isCollective()&&!r.isGroup())return!1;t.push(...r.selectionsIterator())}return!0}isEmptyNode(){for(const t of Di)if(this[t]!==void 0)return!1;return!0}*forcesIterator(){}*associationsIterator(){this.associations&&(yield*this.associations)}*profilesIterator(){var t;for(const r of It(this))r.profiles&&(yield*r.profiles),r.infoLinks&&(yield*(t=r.infoLinks)==null?void 0:t.filter(n=>n.type==="profile").map(n=>n.target))}*rulesIterator(){var t;for(const r of It(this))r.rules&&(yield*r.rules),r.infoLinks&&(yield*(t=r.infoLinks)==null?void 0:t.filter(n=>n.type==="rule").map(n=>n.target))}*constraintsIterator(){this.constraints&&(yield*this.constraints)}*extraConstraintsIterator(){this.extra_constraints&&(yield*this.extra_constraints)}*modifierGroupsIterator(){this.modifierGroups&&(yield*this.modifierGroups)}*modifiersIterator(){this.modifiers&&(yield*this.modifiers)}*modifierGroupsIteratorRecursive(){yield this,this.isLink()&&(yield this.target);for(const t of this.modifierGroupsIterator())yield t,yield*tr(t.modifierGroups)}*selectionsIterator(){this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*localSelectionsIterator(){this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*nodesIterator(){this.isLink()&&(yield*this.target.nodesIterator()),this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.isLink()&&(yield*this.target.entriesIterator()),this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks),this.childs&&(yield*this.childs)}*iterateSelectionEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups)}*iterateSelectionEntriesWithRoot(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups)}*iterateRootEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.forceEntries&&(yield*this.forceEntries)}*iterateAllRootEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.forceEntries&&(yield*this.forceEntries)}*categoryLinksIterator(){this.categoryLinks&&(yield*this.categoryLinks)}*infoLinksIterator(){this.infoLinks&&(yield*this.infoLinks)}*infoGroupsIterator(){this.infoGroups&&(yield*this.infoGroups)}*infoRulesIterator(){if(this.isForce()){const t=this.getGameSystem();t.rules&&(yield*t.rules);const r=this.main_catalogue;r.rules&&(yield*r.rules)}this.rules&&(yield*this.rules)}*infoProfilesIterator(){this.profiles&&(yield*this.profiles)}forEachCond(t,r=0){if(t(this,0)===void 0)for(const n of this.selectionsIterator())n.forEachCond(t,r+1)}forEach(t){t(this);for(const r of this.selectionsIterator())r.forEach(t)}forEachNode(t){t(this);for(const r of this.nodesIterator())r.forEachNode(t)}forEachNodeCb(t){const r=[this],n=new Set;for(;r.length;){const s=r.pop();if(!n.has(s.id)){if(n.add(s.id),t(s),s.childs){r.push(...s.childs);continue}if(s.target){const i=s.target;i.selectionEntries&&r.push(...i.selectionEntries),i.selectionEntryGroups&&r.push(...i.selectionEntryGroups),i.entryLinks&&r.push(...i.entryLinks)}s.selectionEntries&&r.push(...s.selectionEntries),s.selectionEntryGroups&&r.push(...s.selectionEntryGroups),s.entryLinks&&r.push(...s.entryLinks)}}}forEachObjectWhitelist(t,r=bn){const n=[this];for(;n.length;){const s=n.pop();for(const i in s){const o=s[i];if(r.has(i)&&ee(o))if(Array.isArray(o)){if(o.length&&ee(o[0]))for(let c=0;c<o.length;c++){const a=o[c];t(a,s),n.push(a)}}else t(o,s),n.push(o)}}}forEachObject(t,r=new Set){const n=[this];for(;n.length;){const s=n.pop();for(const i of Object.keys(s)){const o=s[i];if(!r.has(i)&&ee(o))if(Array.isArray(o)){if(o.length&&ee(o[0]))for(let c=o.length;c--;){const a=o[c];t(a,s),n.push(a)}}else t(o,s),n.push(o)}}}findOption(t){for(const r of this.selectionsIterator())if(t(r))return r}findOptionRecursive(t){const r=[...this.selectionsIterator()];for(;r.length;){const n=r.pop();if(t(n))return n}}getCosts(){return this.costs||[]}getPrimaryCategory(){for(const t of this.categoryLinks||[])if(t.primary)return t.targetId;return this.getCategoryEntryId()??Oe}getPrimaryCategoryLink(){for(const t of this.categoryLinks||[])if(t.primary)return t}getPackedConstraint(t){const r=Object.assign({},t);r.name=this.getName(),r.parent=this;const n=t.shared||this instanceof $s;r.childId=this.isLink()&&n?this.targetId:this.id,r.modifiers=[];for(const s of this.modifiersIterator())(s.field===t.id||s.field==="hidden"&&t.type==="min")&&r.modifiers.push(s);r.modifierGroups=[];for(const s of this.modifierGroupsIterator())e:for(const i of tr([s]))for(const o of i.modifiers||[])if(o.field===t.id||o.field==="hidden"&&t.type==="min"){r.modifierGroups.push(s);break e}return r}getBoundConstraint(t){const r=this.getPackedConstraint(t);return r.scope="self",r}getChildBoundConstraints(t){const r=[];for(const n of this.selectionsIterator())if(!(t&&n.isGroup())){for(const s of n.constraintsIterator())(s.type==="min"||s.type==="exactly")&&s.scope==="parent"&&r.push(n.getBoundConstraint(s));n.isGroup()&&r.push(...n.getChildBoundConstraints())}return r}canAmountBeAbove1(){const t=Yi(this.constraintsIterator(),[...this.modifierGroupsIterator(),{modifiers:[...this.modifiersIterator()]}]);return!t.length||t.includes(-1)?!0:Math.min(...t)>1}hasOption(t){let r;return this.forEachCond(n=>(n.getName()===t&&(r=!0),r)),!!r}}class _r extends R{isEntry(){return!0}isQuantifiable(){return!0}isIdUnique(){return!0}}class Er extends R{getDefaultSelectionEntryId(){return this.defaultSelectionEntryId}isGroup(){return!0}isIdUnique(){return!0}}class et extends R{constructor(){super(...arguments);b(this,"targetId")}isLink(){return!0}isGroup(){var r;return(r=this.target)==null?void 0:r.isGroup()}isCategory(){var r;return(r=this.target)==null?void 0:r.isCategory()}isQuantifiable(){var r;return(r=this.target)==null?void 0:r.isQuantifiable()}isEntry(){var r;return(r=this.target)==null?void 0:r.isEntry()}isIdUnique(){return!1}isProfile(){var r;return((r=this.target)==null?void 0:r.isProfile())||!1}isRule(){var r;return((r=this.target)==null?void 0:r.isRule())||!1}isInfoGroup(){var r;return((r=this.target)==null?void 0:r.isInfoGroup())||!1}isUnit(){if(this.target.isUnit())return!0;for(const r of this.categoryLinks||[])if(r.primary)return!0;return!1}getId(){return this.targetId}getType(){var r;return(r=this.target)==null?void 0:r.getType()}getPage(){var r;return this.page||((r=this.target)==null?void 0:r.page)}getHidden(){return this.target.hidden||this.hidden}getDefaultSelectionEntryId(){var r;return this.defaultSelectionEntryId||((r=this.target)==null?void 0:r.getDefaultSelectionEntryId())}getCategoryEntryId(){var r;return this.categoryEntryId??((r=this.target)==null?void 0:r.categoryEntryId)}get associationConstraints(){return this.target.associationConstraints}getAssociations(){return this.associations||this.target.associations}isCollective(){var r;return super.isCollective()||((r=this.target)==null?void 0:r.isCollective())}*extraConstraintsIterator(){yield*this.target.extraConstraintsIterator(),yield*super.extraConstraintsIterator()}*associationsIterator(){yield*this.target.associationsIterator(),yield*super.associationsIterator()}*rulesIterator(){yield*this.target.rulesIterator(),yield*super.rulesIterator()}*profilesIterator(){yield*this.target.profilesIterator(),yield*super.profilesIterator()}*constraintsIterator(){this.target&&(yield*this.target.constraintsIterator()),yield*super.constraintsIterator()}*modifierGroupsIterator(){yield*this.target.modifierGroupsIterator(),yield*super.modifierGroupsIterator()}*modifiersIterator(){yield*this.target.modifiersIterator(),yield*super.modifiersIterator()}*selectionsIterator(){yield*this.target.selectionsIterator(),yield*super.selectionsIterator()}*categoryLinksIterator(){yield*this.target.categoryLinksIterator(),yield*super.categoryLinksIterator()}*infoLinksIterator(){yield*this.target.infoLinksIterator(),yield*super.infoLinksIterator()}*infoGroupsIterator(){yield*this.target.infoGroupsIterator(),yield*super.infoGroupsIterator()}*infoRulesIterator(){yield*this.target.infoRulesIterator(),yield*super.infoRulesIterator()}*infoProfilesIterator(){yield*this.target.infoProfilesIterator(),yield*super.infoProfilesIterator()}getDefaultAmount(){return this.defaultAmount===void 0?this.target.defaultAmount:this.defaultAmount}getName(){var r;return((r=this.target)==null?void 0:r.name)||this.name}getParent(){return this.parent}getPrimaryCategory(){for(const r of this.categoryLinks||[])if(r.primary)return r.targetId;for(const r of this.target.categoryLinks||[])if(r.primary)return r.targetId;return this.getCategoryEntryId()??Oe}getPrimaryCategoryLink(){for(const r of this.categoryLinks||[])if(r.primary)return r;for(const r of this.target.categoryLinks||[])if(r.primary)return r}getCosts(){var n;const r={};if((n=this.target)!=null&&n.costs)for(const s of this.target.costs)r[s.typeId]=s;if(this.costs)for(const s of this.costs)r[s.typeId]=s;return Object.values(r)}}et.prototype.keyInfoCache={};class Xi extends et{getTypeName(){var t;return(t=this.target)==null?void 0:t.typeName}}class $s extends et{constructor(){super(...arguments);b(this,"primary");b(this,"main_catalogue")}get units(){return this.target.units}*selectionsIterator(){yield*this.target.units}isEmpty(){return this.target.isEmpty()}}const Oe="(No Category)",kr="(Illegal Units)";class pt extends R{constructor(){super(...arguments);b(this,"units");b(this,"main_catalogue")}isCategory(){return!0}*selectionsIterator(){yield*this.units}isEmpty(){return!this.units.length}isIdUnique(){return!this.isEmptyNode()}}class Ir extends R{constructor(){super(...arguments);b(this,"categories");b(this,"forces");b(this,"main_catalogue")}isForce(){return!0}isEntry(){return!0}isIdUnique(){return!0}*selectionsIterator(){yield*this.categories,this.forces&&(yield*this.forces)}*rulesIterator(){var r;for(const n of It(this))n.rules&&(yield*n.rules),n.infoLinks&&(yield*(r=n.infoLinks)==null?void 0:r.filter(s=>s.type==="rule").map(s=>s.target));this.main_catalogue&&(yield*this.main_catalogue.rulesIterator())}generateForces(r){const n=[];for(const s of this.forceEntries||[]){const i=xe(s);i.main_catalogue=this.main_catalogue;const o=[];for(const c of s.categoryLinks||[])c.targetId in r&&o.push(r[c.targetId]);i.categories=o,this.main_catalogue.index[i.id]=i,n.push(i)}return this.forces=n,n}isEmpty(){for(const r of this.categories)if(!r.isEmpty())return!1;return!0}*forcesIterator(){this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const r of this.forces)yield r,yield*r.forcesIteratorRecursive()}}const xr=1/0;function Yi(e,t){var s,i,o,c;const r=[];function n(a){r.push(a)}for(const a of e){const l=r.length;if(a.field!=="selections"||a.type!=="max")continue;if(a.value>1){n(a.value);continue}let u=a.value;for(const f of tr(t))for(const d of f.modifiers||[])if(d.field===a.id){if(d.type==="increment"){if((s=f.repeats)!=null&&s.length||(i=d.repeats)!=null&&i.length){n(xr);continue}if(u+=d.value,u>1){n(u);continue}}if(d.type==="decrement"&&d.value<0){if((o=f.repeats)!=null&&o.length||(c=d.repeats)!=null&&c.length){n(xr);continue}if(u-=d.value,u>1){n(u);continue}}if(d.type==="set"&&d.value>1){if(d.value===-1){n(xr);continue}n(d.value)}}l===r.length&&n(u)}return r}class Qi extends R{}class gt extends R{isProfile(){return!0}getTypeName(){return this.typeName}isIdUnique(){return!0}}class Vn extends R{constructor(){super(...arguments);b(this,"originalValue")}getLabel(){var r;return this.catalogue?((r=this.catalogue.findOptionById(this.typeId))==null?void 0:r.getName())??this.typeId:this.typeId}getTypeName(){return this.getLabel()}getName(){return`${this.getLabel()} = ${this.$text}`}}class Sr extends R{isInfoGroup(){return!0}isIdUnique(){return!0}}const Dn=new Set(["any","model","unit","upgrade","mount","crew"]);class Ke extends R{}class Kr extends Ke{}class wn extends R{}class Gs extends R{}class qt extends R{getDescription(){return Array.isArray(this.description)?this.description.join(`
`):this.description}isRule(){return!0}isIdUnique(){return!0}}function*It(e){yield e;for(const t of e.infoGroups||[])yield*It(t);for(const t of e.infoLinks||[])t.type==="infoGroup"&&(yield*It(t.target))}function*tr(e){if(e)for(const t of e)yield t,yield*tr(t.modifierGroups)}const Zi=["costTypes","costs","categoryEntries","forceEntries","sharedSelectionEntries","selectionEntries","sharedSelectionEntryGroups","selectionEntryGroups","entryLinks","infoLinks","categoryLinks","catalogueLinks","sharedProfiles","profiles","profileTypes","characteristics","characteristicTypes","sharedInfoGroups","infoGroups","sharedRules","rules","publications","associations","modifierGroups","modifiers","constraints","conditionGroups","conditions","repeats"],_n=new Set(Zi),st=new Set([..._n,"defaultAmount","id","import","importRootEntries","name","hidden","field","scope","value","percentValue","shared","includeChildSelections","includeChildForces","childId","type","targetId","primary","typeId","collective","$text","page","typeName","defaultSelectionEntryId","revision","battleScribeVersion","authorName","authorContact","authorUrl","library","gameSystemId","gameSystemRevision","xmlns","readme","description","comment","publicationDate","publisher","publisherId","publisherUrl","shortName","repeats","roundUp","defaultCostLimit","publicationId","label","labelMembers","maxAssociationsPerMember","ids","min","max","of","flatten","collapsible","sortIndex","subType","arg","costTypeId","profileTypeId","characteristicTypeId","value"]);function Mr(e,t=!1){const r={catalogue:void 0,gameSystem:void 0},n={...e};e.gameSystemId?(r.catalogue=n,r.catalogue.type="catalogue",delete r.gameSystem):(r.gameSystem=n,r.gameSystem.type="gameSystem",delete r.catalogue);const s=t?ye(r):r;return JSON.stringify(s,(o,c)=>{if(!(Array.isArray(c)&&c.length===0)&&(c===n||st.has(o)||isFinite(Number(o))))return ee(c)?Wi(Vi(c)):c})}function jt(e,t){return JSON.stringify(e,function(n,s){if(!(Array.isArray(s)&&s.length===0)&&(st.has(n)||isFinite(Number(n))||t!=null&&t.has(n)))return s})}function eo(e,t,r){const n=(r==null?void 0:r.forceArray)===!1;return e=Array.isArray(e)&&(e==null?void 0:e.length)===1&&n?e[0]:e,JSON.stringify(e,function(i,o){if(st.has(i)||isFinite(Number(i))||t!=null&&t.has(i))return o},(r==null?void 0:r.formatted)===!0?2:void 0)}function Wt(e,t,r=bn){for(const n in e)if(r.has(n)){const s=e[n];if(Array.isArray(s)&&s.length&&ee(s[0]))for(let i=0;i<s.length;i++){const o=s[i];t(o,e),Wt(o,t,r)}}}const En=new Set(["force","roster","self","parent","ancestor","primary-category","force","roster","primary-catalogue"]),to=new Set(["any","unit","model","upgrade","mount","crew"]);function ro(e,t){if(En.has(t))return!0;const n=e.catalogue.findOptionById(t);if(n&&(n.isForce()||n.isCategory()||n.isCatalogue()))return!0;const s=[e];for(;s.length;){const i=s.pop();if(i.id===t)return!0;i.parent&&s.push(i.parent)}return!1}function Xe(e){return Ti(e,r=>!(r instanceof wn||r instanceof Ke||r instanceof Gs))}function no(e,t){if(!e||!t)return;const r=e.getCatalogue();if(e.parent){const s=Xe(e);if(s){for(const i of s.constraintsIterator())if(i.id===t)return i}}return r==null?void 0:r.findOptionById(t)}function $e(e,t){if(t===void 0)return"";if(e){if(`${t}`.startsWith("limit::"))return`limit::${$e(e,Br(`${t}`,"limit::"))}`;const r=e.catalogue||e,n=no(e,t);if(n){const i=n.type;if(i&&["min","max","exactly"].includes(i))return so(e,n);if(n.name)return n.isCategory&&n.isCategory()?`${n.name}`:n.url?`${n.name}`:n.name}const s=r.manager;if(s){const i=r.manager.findOptionById(t)||s.getCatalogueInfo({targetId:t});return(i==null?void 0:i.name)||t}}return t}function Jn(e,t,r=!1,n=$e){const s=t.type||"none",i=t.value===void 0?1:t.percentValue?`${t.value}%`:t.value,o=n(e,t.field),c=["selections","forces"].includes(o)?` ${o}`:` ${n(e,o)}`,a=n(e,t.childId||"")+(r?`(${t.childId||"any"})`:""),l=a&&c?"of ":"",u=n(e,t.scope),f=u===(e==null?void 0:e.getName())?"":`${u}`,d=t.includeChildSelections?" (recursive)":"",h=f?` in ${f}${d}`:"";switch(s){case"instanceOf":return`${f} is ${a}`;case"notInstanceOf":return`${f} is not ${a}`;case"atLeast":return`${i}+${c} ${l}${a}${h}`;case"greaterThan":return`${Number(i)+1}+${c} ${l}${a}${h}`;case"atMost":return`${i}${i===0?"":"-"}${c} ${l}${a}${h}`;case"lessThan":return`${Number(i)-1}${Number(i)-1===0?"":"-"}${c} ${l}${a}${h}`;case"equalTo":return`${i}${c} ${l}${a}${h}`;case"notEqualTo":return`not ${i}${c} ${l}${a}${h}`;case"none":return`${c} ${l}${a}${h}`;default:return`${s} ${i}${c} ${l}${a}${h}`}}function so(e,t,r=$e){if(!Ai(e.constraintsIterator(),t))return t.id;const n=t.field==="selections"?"":` ${r(e,t.field)}`,s=t.scope==="parent"?"":`(${r(e,t.scope)})`,i=t.childId?` ${r(e,t.childId)}`:"";return`${t.type}${n}${i}${s}`}function io(e,t,r=$e){var n;return`${t.type} ${r(e,t.field)} ${r(e,(n=t.value)==null?void 0:n.toString())}`}typeof $toRaw>"u"&&(globalThis.$toRaw=function(e){return e});class kn extends R{constructor(){super(...arguments);b(this,"targetId");b(this,"importRootEntries")}isLink(){return!1}}class Hn extends R{constructor(){super(...arguments);b(this,"shortName");b(this,"publisher");b(this,"publicationDate");b(this,"publisherUrl")}}class rr extends R{constructor(){super(...arguments);b(this,"library");b(this,"revision");b(this,"gameSystemId");b(this,"gameSystemRevision");b(this,"authorContact");b(this,"authorName");b(this,"authorUrl");b(this,"battleScribeVersion");b(this,"costTypes");b(this,"catalogueLinks");b(this,"gameSystem");b(this,"initialized");b(this,"loaded_wiki");b(this,"loaded_editor");b(this,"imports");b(this,"importsWithEntries");b(this,"index");b(this,"unresolvedLinks",{});b(this,"forces");b(this,"categories");b(this,"units");b(this,"roster_constraints");b(this,"manager");b(this,"book");b(this,"short");b(this,"version");b(this,"nrversion");b(this,"lastUpdated");b(this,"costIndex");b(this,"fullFilePath");b(this,"errors")}reset(){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.loaded_wiki;for(const r of this.imports||[])delete r.initialized,delete r.loaded,delete r.loaded_editor,delete r.loaded_wiki}init(r=!0){this.initialized||(this.initialized=!0,this.generateImports(r),this.resolveAllLinks(r),this.generateCostIndex())}process(){if(this.loaded)return;this.loaded=!0,this.init();const r=this.generateUnits(),n=this.generateCategories(r);this.categories=Object.values(n),this.generateForces(n,this.forcesIterator()),this.generateExtraConstraints()}processForWiki(r){if(this.loaded_wiki)return;this.loaded_wiki=!0,this.process();const n=r.rules||{};r.rules=n,this.imports.forEach(i=>{qe(i,"refs",this)});function s(i,o){i.parent=o,i.target&&qe(i.target,"refs",o),i instanceof qt&&(n[i.id]=i)}Wt(this,s,Hi);for(const i of this.forces||[]){i.parent=this;for(const o of i.categories)o.parent=i}}processForEditor(){this.loaded_editor||(this.loaded_editor=!0,this.init(!1),this.gameSystem&&qe(this.gameSystem,"refs",this),Wt(this,(r,n)=>{if(r.parent=n,r.catalogue=this,r.refs||(r.refs=[]),r.other_refs||(r.other_refs=[]),r.target&&qe(r.target,"refs",r),r.isProfile()&&!r.isLink()){const i=this.findOptionById(r.typeId);i&&qe(i,"refs",r)}const s=r.value;if(s){const i=this.findOptionById(s);i&&qe(i,"other_refs",r)}this.refreshErrors(r)},_n))}get url(){return"%{book}"}isCatalogue(){return!0}isGameSystem(){return this.gameSystemId===this.id||!this.gameSystemId}isIdUnique(){return!0}getCatalogue(){return this}getGameSystem(){return this.isGameSystem()?this:this.gameSystem}getSystemId(){return this.isGameSystem()?this.id:this.gameSystemId}addError(r,n){this.removeError(r,n.id),r.errors||(r.errors=[]),this.errors||(this.errors=[]),r.errors.push(n),this.errors.push(n)}onRemoveError(r,n=!0){var s,i;if(this.errors){const o=this.errors.indexOf(r);o>=0&&this.errors.splice(o,1)}if(r.other&&n){const o=r.other;(s=o.getCatalogue())==null||s.removeError(o,"duplicate-id-1",!1),(i=o.getCatalogue())==null||i.removeError(o,"duplicate-id-2",!1)}}removeErrors(r){var n;(n=r.errors)==null||n.forEach(s=>this.onRemoveError(s)),r instanceof Kr&&r.catalogue.updateConstraint(r,!0),delete r.errors}removeError(r,n,s=!0){var i;(i=r.errors)!=null&&i.length&&(r.errors=r.errors.filter(o=>(o.id===n&&this.onRemoveError(o,s),o.id!==n)))}*iterateCategoryEntries(){for(const r of this.imports)for(const n of r.categoryEntries||[])yield n;this.categoryEntries&&(yield*this.categoryEntries)}*iterateCostTypes(){for(const r of this.imports)for(const n of r.costTypes||[])yield n;this.costTypes&&(yield*this.costTypes)}*forcesIterator(){for(const r of this.imports)for(const n of r.forceEntries||[])yield n;this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const r of this.forces)yield r,yield*r.forcesIteratorRecursive()}*iterateProfileTypes(){for(const r of this.imports)r.profileTypes&&(yield*r.profileTypes);this.profileTypes&&(yield*this.profileTypes)}*iteratePublications(){for(const r of this.imports)for(const n of r.publications||[])yield n;for(const r of this.publications||[])yield r}*iterateSelectionEntries(){for(const r of this.importsWithEntries){for(const n of r.sharedSelectionEntries||[])yield n;for(const n of r.sharedSelectionEntryGroups||[])yield n}this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllImported(){const r=["sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","categoryEntries"],n=["rules","entryLinks","profiles","infoGroups","selectionEntries","selectionEntryGroups"];for(const s of this.importsWithEntries)for(const i of n)for(const o of s[i]||[])o.import!==!1&&(yield o);for(const s of this.imports)for(const i of r)for(const o of s[i]||[])yield o;for(const s of n)for(const i of this[s]||[])yield i;for(const s of r)for(const i of this[s]||[])yield i}*iterateSelectionEntriesWithRoot(){for(const r of this.importsWithEntries){for(const n of r.selectionEntries||[])n.import!==!1&&(yield n);for(const n of r.entryLinks||[])n.import!==!1&&(yield n);for(const n of r.sharedSelectionEntries||[])yield n;for(const n of r.sharedSelectionEntryGroups||[])yield n}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllRootEntries(){for(const r of this.importsWithEntries){for(const n of r.selectionEntries||[])n.import!==!1&&(yield n);for(const n of r.entryLinks||[])n.import!==!1&&(yield n)}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.selectionEntries&&(yield*this.selectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}forEachNode(r){if(r(this),this.childs)for(const n of this.childs)n.forEachNode(r)}*selectionsIterator(){yield*this.forces}findOptionById(r){var i;const n=this.index[r];if(n)return n;const s=(i=this.imports.find(o=>r in o.index))==null?void 0:i.index[r];if(s)return s;if(this.manager&&r)return this.manager.getLoadedCatalogue(r)??this.manager.getCatalogueInfo({targetId:r})}findOptionByIdGlobal(r){var i;const n=this.index[r];if(n)return n;const s=(i=this.imports.find(o=>r in o.index))==null?void 0:i.index[r];if(s)return s;if(this.manager){const o=this.manager.findOptionById(r);return o||this.manager.getCatalogueInfo({targetId:r})}}findOptionsById(r){const n=[];for(const s of[this,...this.imports])for(const i of Object.values(s.index))i.id&&i.id===r&&n.push(i);return n}findOptionsByText(r){var i,o,c;if(!r||!r.trim()){const a=[];for(const l of[this,...this.imports])for(const u of Object.values(l.index))if(u.getName){if(u.isLink()&&u.target&&u.isCategory()&&!((i=u.parent)!=null&&i.isForce()))continue;a.push(u)}else console.log(u);return a}const n=[],s=Fr(r);for(const a of[this,...this.imports])for(const l of Object.values(a.index)){const u=(o=l.getName)==null?void 0:o.call(l),f=l.id;if(u&&String(u).match(s)||f===r){if(l.isLink()&&l.target&&l.isCategory()&&!((c=l.parent)!=null&&c.isForce()))continue;n.push(l)}}return n}generateNonConflictingId(r){if(r&&this.findOptionByIdGlobal(r)===void 0)return r;for(;;){const n=Y();if(this.findOptionById(n)===void 0)return n}}generateCostIndex(){const r={};for(const n of this.imports)for(const s of n.costTypes||[])r[s.id]=s,this.index[s.id]=s;for(const n of this.costTypes||[])r[n.id]=n,this.index[n.id]=n;return this.costIndex=r,r}generateImports(r=!0){const n={},s={};this.gameSystem&&(this.gameSystem.init(r),n[this.gameSystem.id]=this.gameSystem,s[this.gameSystem.id]=this.gameSystem,this.gameSystem.import||(this.gameSystem.imports=[]));for(const i of this.catalogueLinks||[]){const o=i.target;if(o){o.init(r);for(const c of o.imports)s[c.id]=c;for(const c of o.importsWithEntries)n[c.id]=c;i.importRootEntries&&(n[o.id]=o),s[o.id]=o}}return this.imports=Object.values(s),this.importsWithEntries=Object.values(n),this.imports}generateForces(r,n,s){var o,c;s||(s=this);const i=[];for(const a of n){const l=xe(a);l.main_catalogue=this;const u=[];(c=(o=r[Oe])==null?void 0:o.units)!=null&&c.length&&u.push(r[Oe]);const f=new Set;for(const h of a.categoryLinks||[])if(h.targetId in r){const g=xe(h);g.main_catalogue=this;const p=r[g.targetId];g.target=p,g.childs=p.childs;for(const y of g.childs)f.add(y.id);u.push(g)}for(const h of a.categoryEntries||[])if(h.id in r){const g=r[h.id],p=xe(g);p.main_catalogue=this;for(const y of p.childs)f.add(y.id);u.push(p)}const d=this.units.filter(h=>!f.has(h.id));if(d.length){const h=xe(r[kr]);h.childs=d,h.units=d,u.push(h)}l.childs=u,l.categories=u,this.index[l.id]=l,l.forceEntries&&l.generateForces(r),this.generateForces(r,l.forcesIterator(),l),i.push(l)}return s.forces=i,s.childs=i,i}generateCategories(r){const n={},s=new Set;for(const a of this.iterateCategoryEntries()){const l=xe(a);l.main_catalogue=this;const u=r[l.id]||[];l.units=u,l.childs=u,this.index[a.id]=a,n[l.id]=l,s.add(l.id)}for(const a in r)if(!s.has(a)){const l=this.findOptionById(a);if(l){const u=xe(l);u.main_catalogue=this;const f=r[u.id]||[];u.units=f,u.childs=f,this.index[l.id]=l,n[u.id]=u}}const i=r[Oe]||[],o={name:"Uncategorized",id:Oe,hidden:!1,units:i,childs:i,catalogue:this};n[Oe]=Object.setPrototypeOf(o,pt.prototype);const c={name:"Illegal Units",id:kr,hidden:!0,units:[],childs:[],catalogue:this};return n[kr]=Object.setPrototypeOf(c,pt.prototype),n}generateUnits(){const r=[];for(const i of this.importsWithEntries){const o=i.isGameSystem();for(const c of i.selectionEntries||[])(o||c.import!==!1)&&r.push(c);for(const c of i.entryLinks||[])(o||c.import!==!1)&&r.push(c)}for(const i of this.selectionEntries||[])r.push(i);for(const i of this.entryLinks||[])r.push(i);const n=Pi(r,i=>i.getName());return this.units=n,Li(n,i=>i.getPrimaryCategory())}generateExtraConstraints(){const r={},n=[],s={},i=new Set,o={};function c(a,l,u){const f=l.target||l;for(const d of u){const h=`${d.id}::${l.id}`;switch(d.scope){case"parent":break;case"roster":r[h]=l.getBoundConstraint(d);break;case"force":n.push(l.getBoundConstraint(d));break;case"primary-category":case"primary-catalogue":break;default:if(i.has(d.scope)){Je(s,d.scope,f.getBoundConstraint(d));break}const g=a.index[d.scope];if(g){const p=g.extra_constraints||[];p.push(l.getBoundConstraint(d)),g.extra_constraints=p;break}break}}}for(const a of this.forcesIteratorRecursive())i.add(a.id);for(const a of this.categories)i.add(a.id);for(const a of this.categories){c(this,a,a.constraintsIterator());const l={};a.forEachNodeCb(u=>{var f;if(u&&!u.isForce()&&(!u.isGroup()&&!u.extra_constraints&&(u.extra_constraints=u.getChildBoundConstraints(!0)),!(u.isCategory()&&u.isLink())&&!(!u.constraints&&!((f=u.target)!=null&&f.constraints)))){for(const d of u.constraintsIterator())if(d.type==="min"||d.type==="exactly"){const h=`${d.id}::${u.id}`;switch(d.scope){case"parent":break;case"roster":r[h]=u.getBoundConstraint(d);break;case"force":l[h]=u.getBoundConstraint(d);break;case"primary-category":case"primary-catalogue":break;default:if(i.has(d.scope)){Je(s,d.scope,u.getBoundConstraint(d));break}const g=this.index[d.scope];if(g){const p=g.extra_constraints||[];p.push(u.getBoundConstraint(d)),g.extra_constraints=p;break}break}}}}),o[a.getId()]=Object.values(l)}for(const a of this.forcesIteratorRecursive()){const l=a.extra_constraints||[];l.push(...n),a.id in s&&l.push(...s[a.id]),l.length&&(a.extra_constraints=l);for(const u of a.categories)u.getId()in o&&l.push(...o[u.getId()]);l.length&&(a.extra_constraints=l)}for(const a of this.categories){const l=a.extra_constraints||[];a.id in s&&l.push(...s[a.id]),l.length&&(a.extra_constraints=l)}this.roster_constraints=Object.values(r)}async reload(r=this.manager){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.index;const n=this.isGameSystem()?"gameSystem":"catalogue",s=await r.loadData({[n]:this});return this.processForEditor(),s}refreshErrors(r,n=!1){var s,i;r.isLink()?r.target?(this.removeError(r,"no-target"),vr(this.unresolvedLinks,r.targetId,$toRaw(r)),vr(this.manager.unresolvedLinks,r.targetId,$toRaw(r))):(this.addError(r,{source:r,severity:"error",msg:`(${r.editorTypeName}) ${r.name} has no target`,id:"no-target"}),!((s=this.unresolvedLinks[r.targetId])!=null&&s.includes($toRaw(r)))&&!n&&Je(this.unresolvedLinks,r.targetId,$toRaw(r)),(i=this.manager.unresolvedLinks[r.targetId])!=null&&i.includes($toRaw(r))||Je(this.manager.unresolvedLinks,r.targetId,$toRaw(r))):r.isProfile()?r.typeId?this.removeError(r,"no-profile-type"):this.addError(r,{source:r,severity:"error",msg:"Profile has no type",id:"no-profile-type"}):r instanceof Ke&&this.updateCondition(r)}addToIndex(r){var n,s,i,o,c,a;if(r.id){if(r.catalogue=this,(s=(n=this.manager)==null?void 0:n.settings)!=null&&s.globalDuplicateIdError){const l=this.manager.index;if(l[r.id]&&l[r.id]!==r&&(r.isIdUnique()||l[r.id].isIdUnique())){const u=l[r.id],f=u.getCatalogue(),d=this!==f;f&&d&&(f.addError(u,{source:u,severity:"error",msg:`Duplicate id ${r.id} ${r.getName()}`,id:"duplicate-id-1",other:r,extra:f.name}),f.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${u.getName()}`,id:"duplicate-id-2",other:u,extra:this.name})),this.addError(u,{source:u,severity:"error",msg:`Duplicate id ${r.id}  ${r.getName()}`,id:"duplicate-id-1",other:r,extra:d?f.name:void 0}),this.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${u.getName()}`,id:"duplicate-id-2",other:u,extra:d?this.name:void 0})}l[r.id]=r}else if(this.index[r.id]&&this.index[r.id]!==r){const l=this.index[r.id];(r.isIdUnique()||l.isIdUnique()||r.getName()!==l.getName())&&(this.addError(l,{source:l,severity:"error",msg:`Duplicate id ${r.id} ${r.getName()}`,id:"duplicate-id-1",other:r}),this.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${l.getName()}`,id:"duplicate-id-2",other:l}))}if(this.index[r.id]=r,this.unresolvedLinks&&this.unresolvedLinks[r.id])for(const l of[...this.unresolvedLinks[r.id]])l.isLink()&&l.catalogue?this.updateLink(l):this.refreshErrors(l);if((i=this.manager)!=null&&i.unresolvedLinks&&((o=this.manager.unresolvedLinks[r.id])!=null&&o.length))for(const l of[...this.manager.unresolvedLinks[r.id]])l.isLink()?(c=l.catalogue)==null||c.updateLink(l):(a=l.catalogue)==null||a.refreshErrors(l)}}removeFromIndex(r){r.id&&$toRaw(this.index[r.id])===$toRaw(r)&&delete this.index[r.id],this.removeErrors(r);for(const n of r.refs||[])delete n.target,n.catalogue.refreshErrors(n);for(const n of r.other_refs||[])n.catalogue.refreshErrors(n,!0)}getIndexes(){const r=[];r.push(this.index);for(const n of this.imports)r.push(n.index);return r}resolveAllLinks(r=!0){const n=[],s=[],i=[];this.index=uo(),Wt(this,(a,l)=>{this.addToIndex(a),a.publicationId&&(delete a.publication,s.push(a)),a.isLink()&&(delete a.target,n.push(a),i.push(l)),co(a)},bn);const o=this.getIndexes(),c=oo(n,o,i,r);if(ao(s,o),!r){this.unresolvedLinks={};for(const a of c)Je(this.unresolvedLinks,a.targetId,$toRaw(a)),delete a.target}}removeRef(r,n){n.refs||(n.refs=[]);const s=n.refs.indexOf(r);s>=0&&n.refs.splice(s,1)}addRef(r,n){n.refs||(n.refs=[]),n.refs.indexOf(r)===-1&&n.refs.push(r)}hasOtherRef(r,n){return n.other_refs&&n.other_refs.includes(r)}removeOtherRef(r,n){n.other_refs||(n.other_refs=[]);const s=n.other_refs.indexOf(r);s>=0&&n.other_refs.splice(s,1)}addOtherRef(r,n){n.other_refs||(n.other_refs=[]),n.other_refs.indexOf(r)===-1&&n.other_refs.push(r)}updateLink(r){r.target&&this.removeRef(r,r.target);const n=Rs(r.targetId,this.getIndexes());if(n!=null&&n.isLink()){console.warn(`Failed to resolve link (target is a link): ${r.getName()}(${r.id})`),r.catalogue.addError(r,{id:"bad-link-target",msg:"Link target Cannot be a Link",source:r});return}else{if(r.catalogue.removeError(r,"bad-link-target"),r.target=n,r.target){this.addRef(r,r.target);const s=r.target.editorTypeName;s=="category"?delete r.type:r.type=s}return this.refreshErrors(r),r.target!==void 0}}updateConstraint(r,n=!1){var o,c,a,l;const s=new Set,i=new Set;for(const u of((o=r.parent)==null?void 0:o.constraintsIterator())||[])n&&r===u||(s.has(u.id)?i.add(u.id):s.add(u.id));for(const u of((c=r.parent)==null?void 0:c.constraintsIterator())||[])n&&r===u||(i.has(u.id)?(a=u.catalogue)==null||a.addError(u,{id:"duplicate-constraint-id",msg:"Duplicate constraints id",source:r}):(l=u.catalogue)==null||l.removeError(u,"duplicate-constraint-id"))}updateCondition(r,n){if(r.scope){const i=Xe(r);if(i&&!ro(i,r.scope)?this.addError(r,{source:r,id:"invalid-scope",msg:`Invalid scope ${r.scope}`}):this.removeError(r,"invalid-scope"),r.scope&&!En.has(r.scope)){const o=this.findOptionById(r.scope);o&&o.getCatalogue().addOtherRef(r,o)}}if(r instanceof Kr)return this.updateConstraint(r);const s=["instanceOf","notInstanceOf"].includes(r.type);if(n&&!Dn.has(n)){const i=s?this.findOptionByIdGlobal(n):this.findOptionById(n);i&&this.removeOtherRef(r,i)}if(r.childId){if(Dn.has(r.childId)){this.removeError(r,"id-not-exist");return}const i=s?this.findOptionByIdGlobal(r.childId):this.findOptionById(r.childId);if(i){this.hasOtherRef(r,i)||this.addOtherRef(r,i),this.removeError(r,"id-not-exist"),vr(this.manager.unresolvedLinks,r.childId,$toRaw(r));return}}this.addError(r,{source:r,severity:"warning",msg:"child id does not exist",id:"id-not-exist"}),$i(this.manager.unresolvedLinks,r.childId,$toRaw(r))}unlinkLink(r){r.target&&this.removeRef(r,r.target)}}function Rs(e,t){for(const r of t)if(e in r)return r[e]}function oo(e=[],t,r,n=!0){e.length;let s=0;for(;e.length!==s;){const i=e,o=r;s=i.length,e=[],r=[];for(let c=0;c<i.length;c++){const a=i[c],l=o[c],u=a.targetId,f=Rs(u,t);if(f){f.isLink()?console.warn(`Failed to resolve link (target is a link): ${a.getName()}(${a.id})`):a.target=f;continue}e.push(a),r.push(l)}}if(e.length&&n)for(let i=0;i<e.length;i++){const o=e[i],c=r[i];for(const[a,l]of Object.entries(c))if(l===o&&delete c[a],Array.isArray(l))for(const u in l)l[u]===o&&l.splice(u,1)}return e}function ao(e=[],t){for(const r of e)for(const n of t)if(r.publicationId in n){r.publication=n[r.publicationId];break}}function co(e){return e.shared!==!1&&e.childId!==void 0}let lo=class{get[Symbol.toStringTag](){return"ObjectNoObserve"}};function uo(){return new lo}function Bs(e){return e.arrayBuffer?e.arrayBuffer():new Promise((t,r)=>{const n=new FileReader;n.addEventListener("loadend",()=>{t(n.result)}),n.addEventListener("error",r),n.readAsArrayBuffer(e)})}async function fo(e){const t=await Bs(e);return new Uint8Array(t)}function Fs(e){return typeof Blob<"u"&&e instanceof Blob}function xt(e){return typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer}const ho=typeof process<"u"&&process.versions&&typeof process.versions.node<"u"&&typeof process.versions.electron>"u";function po(e){return e.byteOffset===0&&e.byteLength===e.buffer.byteLength}class Xn{constructor(t){this.typedArray=t instanceof ArrayBuffer||xt(t)?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}async getLength(){return this.typedArray.byteLength}async read(t,r){return new Uint8Array(this.typedArray.buffer,this.typedArray.byteOffset+t,r)}}class Yn{constructor(t){this.blob=t}async getLength(){return this.blob.size}async read(t,r){const n=this.blob.slice(t,t+r),s=await Bs(n);return new Uint8Array(s)}async sliceAsBlob(t,r,n=""){return this.blob.slice(t,t+r,n)}}function go(e,t){var r=Uint8Array;if(e[0]==3&&e[1]==0)return t||new r(0);var n=mo,s=Ks,i=yo,o=Ms,c=t==null;c&&(t=new r(e.length>>>2<<3));for(var a=0,l=0,u=0,f=0,d=0,h=0,g=0,p=0,y=0,m,v;a==0;){if(a=n(e,y,1),l=n(e,y+1,2),y+=3,l==0){y&7&&(y+=8-(y&7));var w=(y>>>3)+4,k=e[w-4]|e[w-3]<<8;c&&(t=Cr(t,p+k)),t.set(new r(e.buffer,e.byteOffset+w,k),p),y=w+k<<3,p+=k;continue}if(c&&(t=Cr(t,p+(1<<17))),l==1&&(m=N.flmap,v=N.fdmap,h=512-1,g=32-1),l==2){u=s(e,y,5)+257,f=s(e,y+5,5)+1,d=s(e,y+10,4)+4,y+=14;for(var _=0;_<38;_+=2)N.itree[_]=0,N.itree[_+1]=0;for(var E=1,_=0;_<d;_++){var I=s(e,y+_*3,3);N.itree[(N.ordr[_]<<1)+1]=I,I>E&&(E=I)}y+=3*d,yt(N.itree,E),mt(N.itree,E,N.imap),m=N.lmap,v=N.dmap,y=i(N.imap,(1<<E)-1,u+f,e,y,N.ttree);var T=Qn(N.ttree,0,u,N.ltree);h=(1<<T)-1;var S=Qn(N.ttree,u,f,N.dtree);g=(1<<S)-1,yt(N.ltree,T),mt(N.ltree,T,m),yt(N.dtree,S),mt(N.dtree,S,v)}for(;;){var P=m[o(e,y)&h];y+=P&15;var A=P>>>4;if(!(A>>>8))t[p++]=A;else{if(A==256)break;var U=p+A-254;if(A>264){var F=N.ldef[A-257];U=p+(F>>>3)+s(e,y,F&7),y+=F&7}var $=v[o(e,y)&g];y+=$&15;var de=$>>>4,re=N.ddef[de],z=(re>>>4)+n(e,y,re&15);for(y+=re&15,c&&(t=Cr(t,p+(1<<17)));p<U;)t[p]=t[p++-z],t[p]=t[p++-z],t[p]=t[p++-z],t[p]=t[p++-z];p=U}}}return t.length==p?t:t.slice(0,p)}function Cr(e,t){var r=e.length;if(t<=r)return e;var n=new Uint8Array(Math.max(r<<1,t));return n.set(e,0),n}function yo(e,t,r,n,s,i){for(var o=Ks,c=Ms,a=0;a<r;){var l=e[c(n,s)&t];s+=l&15;var u=l>>>4;if(u<=15)i[a]=u,a++;else{var f=0,d=0;u==16?(d=3+o(n,s,2),s+=2,f=i[a-1]):u==17?(d=3+o(n,s,3),s+=3):u==18&&(d=11+o(n,s,7),s+=7);for(var h=a+d;a<h;)i[a]=f,a++}}return s}function Qn(e,t,r,n){for(var s=0,i=0,o=n.length>>>1;i<r;){var c=e[i+t];n[i<<1]=0,n[(i<<1)+1]=c,c>s&&(s=c),i++}for(;i<o;)n[i<<1]=0,n[(i<<1)+1]=0,i++;return s}function yt(e,t){for(var r=e.length,n,s,i,o,c,a=N.bl_count,o=0;o<=t;o++)a[o]=0;for(o=1;o<r;o+=2)a[e[o]]++;var l=N.next_code;for(n=0,a[0]=0,s=1;s<=t;s++)n=n+a[s-1]<<1,l[s]=n;for(i=0;i<r;i+=2)c=e[i+1],c!=0&&(e[i]=l[c],l[c]++)}function mt(e,t,r){for(var n=e.length,s=N.rev15,i=0;i<n;i+=2)if(e[i+1]!=0)for(var o=i>>1,c=e[i+1],a=o<<4|c,l=t-c,u=e[i]<<l,f=u+(1<<l);u!=f;){var d=s[u]>>>15-t;r[d]=a,u++}}function Zn(e,t){for(var r=N.rev15,n=15-t,s=0;s<e.length;s+=2){var i=e[s]<<t-e[s+1];e[s]=r[i]>>>n}}function Ks(e,t,r){return(e[t>>>3]|e[(t>>>3)+1]<<8)>>>(t&7)&(1<<r)-1}function mo(e,t,r){return(e[t>>>3]|e[(t>>>3)+1]<<8|e[(t>>>3)+2]<<16)>>>(t&7)&(1<<r)-1}function Ms(e,t){return(e[t>>>3]|e[(t>>>3)+1]<<8|e[(t>>>3)+2]<<16)>>>(t&7)}const N=function(){var e=Uint16Array,t=Uint32Array;return{next_code:new e(16),bl_count:new e(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new e(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new t(32),flmap:new e(512),fltree:[],fdmap:new e(32),fdtree:[],lmap:new e(32768),ltree:[],ttree:[],dmap:new e(32768),dtree:[],imap:new e(512),itree:[],rev15:new e(32768),lhst:new t(286),dhst:new t(30),ihst:new t(19),lits:new t(15e3),strt:new e(65536),prev:new e(32768)}}();(function(){for(var e=32768,t=0;t<e;t++){var r=t;r=(r&2863311530)>>>1|(r&1431655765)<<1,r=(r&3435973836)>>>2|(r&858993459)<<2,r=(r&4042322160)>>>4|(r&252645135)<<4,r=(r&4278255360)>>>8|(r&16711935)<<8,N.rev15[t]=(r>>>16|r<<16)>>>17}function n(s,i,o){for(;i--!=0;)s.push(0,o)}for(var t=0;t<32;t++)N.ldef[t]=N.of0[t]<<3|N.exb[t],N.ddef[t]=N.df0[t]<<4|N.dxb[t];n(N.fltree,144,8),n(N.fltree,255-143,9),n(N.fltree,279-255,7),n(N.fltree,287-279,8),yt(N.fltree,9),mt(N.fltree,9,N.flmap),Zn(N.fltree,9),n(N.fdtree,32,5),yt(N.fdtree,5),mt(N.fdtree,5,N.fdmap),Zn(N.fdtree,5),n(N.itree,19,0),n(N.ltree,286,0),n(N.dtree,30,0),n(N.ttree,320,0)})();const es={table:function(){for(var e=new Uint32Array(256),t=0;t<256;t++){for(var r=t,n=0;n<8;n++)r&1?r=3988292384^r>>>1:r=r>>>1;e[t]=r}return e}(),update:function(e,t,r,n){for(var s=0;s<n;s++)e=es.table[(e^t[r+s])&255]^e>>>8;return e},crc:function(e,t,r){return es.update(4294967295,e,t,r)^4294967295}};function vo(e,t){return go(e,t)}const ts={numWorkers:1,workerURL:"",useWorkers:!1};let bo=0;const Vt=[];function Nr(e){return new Promise((t,r)=>{const n=new Worker(e);n.onmessage=s=>{s.data==="start"?(n.onerror=void 0,n.onmessage=void 0,t(n)):r(new Error(`unexpected message: ${s.data}`))},n.onerror=r})}function wo(e,t){return e.require?e.require(t):{}}(function(){if(ho){const{Worker:e}=wo(module,"worker_threads");return{async createWorker(t){return new e(t)},addEventListener(t,r){t.on("message",n=>{r({target:t,data:n})})},async terminate(t){await t.terminate()}}}else return{async createWorker(e){try{return await Nr(e)}catch{console.warn("could not load worker:",e)}let t;try{const r=await fetch(e,{mode:"cors"});if(!r.ok)throw new Error(`could not load: ${e}`);t=await r.text(),e=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));const n=await Nr(e);return ts.workerURL=e,n}catch{console.warn("could not load worker via fetch:",e)}if(t!==void 0)try{e=`data:application/javascript;base64,${btoa(t)}`;const r=await Nr(e);return ts.workerURL=e,r}catch{console.warn("could not load worker via dataURI")}throw console.warn("workers will not be used"),new Error("can not start workers")},addEventListener(e,t){e.addEventListener("message",t)},async terminate(e){e.terminate()}}})();function _o(e,t,r,n){const s=new Uint8Array(t);vo(e,s),n(r?new Blob([s],{type:r}):s.buffer)}async function Eo(){if(Vt.length!==0)for(;Vt.length;){const{src:e,uncompressedSize:t,type:r,resolve:n}=Vt.shift();let s=e;Fs(e)&&(s=await fo(e)),_o(s,t,r,n)}}function Us(e,t,r){return new Promise((n,s)=>{Vt.push({src:e,uncompressedSize:t,type:r,resolve:n,reject:s,id:bo++}),Eo()})}function ko(e,t){const r=e&31,n=(e>>5&15)-1,s=(e>>9&127)+1980,i=0,o=(t&31)*2,c=t>>5&63,a=t>>11&31;return new Date(s,n,r,a,c,o,i)}class Io{constructor(t,r){this._reader=t,this._rawEntry=r,this.name=r.name,this.nameBytes=r.nameBytes,this.size=r.uncompressedSize,this.compressedSize=r.compressedSize,this.comment=r.comment,this.commentBytes=r.commentBytes,this.compressionMethod=r.compressionMethod,this.lastModDate=ko(r.lastModFileDate,r.lastModFileTime),this.isDirectory=r.uncompressedSize===0&&r.name.endsWith("/"),this.encrypted=!!(r.generalPurposeBitFlag&1),this.externalFileAttributes=r.externalFileAttributes,this.versionMadeBy=r.versionMadeBy}async blob(t="application/octet-stream"){return await Go(this._reader,this._rawEntry,t)}async arrayBuffer(){return await $o(this._reader,this._rawEntry)}async text(){const t=await this.arrayBuffer();return vt(new Uint8Array(t))}async json(){const t=await this.text();return JSON.parse(t)}}const Or=22,xo=65535,So=101010256,Co=101075792;async function tt(e,t,r){return await e.read(t,r)}async function Ur(e,t,r,n){return e.sliceAsBlob?await e.sliceAsBlob(t,r,n):await e.read(t,r)}const No={unsigned(){return 0}};function j(e,t){return e[t]+e[t+1]*256}function D(e,t){return e[t]+e[t+1]*256+e[t+2]*65536+e[t+3]*16777216}function Ae(e,t){return D(e,t)+D(e,t+4)*4294967296}const Oo=new TextDecoder;function vt(e,t){return xt(e.buffer)&&(e=new Uint8Array(e)),Oo.decode(e)}async function To(e,t){const r=Math.min(Or+xo,t),n=t-r,s=await tt(e,n,r);for(let i=r-Or;i>=0;--i){if(D(s,i)!==So)continue;const o=new Uint8Array(s.buffer,s.byteOffset+i,s.byteLength-i),c=j(o,4);if(c!==0)throw new Error(`multi-volume zip files are not supported. This is volume: ${c}`);const a=j(o,10),l=D(o,12),u=D(o,16),f=j(o,20),d=o.length-Or;if(f!==d)throw new Error(`invalid comment length. expected: ${d}, actual: ${f}`);const h=new Uint8Array(o.buffer,o.byteOffset+22,f),g=vt(h);return a===65535||u===4294967295?await Po(e,n+i,g,h):await zs(e,u,l,a,g,h)}throw new Error("could not find end of central directory. maybe not zip file")}const Ao=117853008;async function Po(e,t,r,n){const s=t-20,i=await tt(e,s,20);if(D(i,0)!==Ao)throw new Error("invalid zip64 end of central directory locator signature");const o=Ae(i,8),c=await tt(e,o,56);if(D(c,0)!==Co)throw new Error("invalid zip64 end of central directory record signature");const a=Ae(c,32),l=Ae(c,40),u=Ae(c,48);return zs(e,u,l,a,r,n)}const Lo=33639248;async function zs(e,t,r,n,s,i){let o=0;const c=await tt(e,t,r),a=[];for(let u=0;u<n;++u){const f=c.subarray(o,o+46),d=D(f,0);if(d!==Lo)throw new Error(`invalid central directory file header signature: 0x${d.toString(16)}`);const h={versionMadeBy:j(f,4),versionNeededToExtract:j(f,6),generalPurposeBitFlag:j(f,8),compressionMethod:j(f,10),lastModFileTime:j(f,12),lastModFileDate:j(f,14),crc32:D(f,16),compressedSize:D(f,20),uncompressedSize:D(f,24),fileNameLength:j(f,28),extraFieldLength:j(f,30),fileCommentLength:j(f,32),internalFileAttributes:j(f,36),externalFileAttributes:D(f,38),relativeOffsetOfLocalHeader:D(f,42)};if(h.generalPurposeBitFlag&64)throw new Error("strong encryption is not supported");o+=46;const g=c.subarray(o,o+h.fileNameLength+h.extraFieldLength+h.fileCommentLength);h.nameBytes=g.slice(0,h.fileNameLength),h.name=vt(h.nameBytes);const p=h.fileNameLength+h.extraFieldLength,y=g.slice(h.fileNameLength,p);h.extraFields=[];let m=0;for(;m<y.length-3;){const w=j(y,m+0),k=j(y,m+2),_=m+4,E=_+k;if(E>y.length)throw new Error("extra field length exceeds extra field buffer size");h.extraFields.push({id:w,data:y.slice(_,E)}),m=E}if(h.commentBytes=g.slice(p,p+h.fileCommentLength),h.comment=vt(h.commentBytes),o+=g.length,h.uncompressedSize===4294967295||h.compressedSize===4294967295||h.relativeOffsetOfLocalHeader===4294967295){const w=h.extraFields.find(E=>E.id===1);if(!w)throw new Error("expected zip64 extended information extra field");const k=w.data;let _=0;if(h.uncompressedSize===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include uncompressed size");h.uncompressedSize=Ae(k,_),_+=8}if(h.compressedSize===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include compressed size");h.compressedSize=Ae(k,_),_+=8}if(h.relativeOffsetOfLocalHeader===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include relative header offset");h.relativeOffsetOfLocalHeader=Ae(k,_),_+=8}}const v=h.extraFields.find(w=>w.id===28789&&w.data.length>=6&&w.data[0]===1&&D(w.data,1),No.unsigned(h.nameBytes));if(v&&(h.fileName=vt(v.data.slice(5))),h.compressionMethod===0){let w=h.uncompressedSize;if(h.generalPurposeBitFlag&1&&(w+=12),h.compressedSize!==w)throw new Error(`compressed size mismatch for stored file: ${h.compressedSize} != ${w}`)}a.push(h)}return{zip:{comment:s,commentBytes:i},entries:a.map(u=>new Io(e,u))}}async function qs(e,t){if(t.generalPurposeBitFlag&1)throw new Error("encrypted entries not supported");const r=await tt(e,t.relativeOffsetOfLocalHeader,30),n=await e.getLength(),s=D(r,0);if(s!==67324752)throw new Error(`invalid local file header signature: 0x${s.toString(16)}`);const i=j(r,26),o=j(r,28),c=t.relativeOffsetOfLocalHeader+r.length+i+o;let a;if(t.compressionMethod===0)a=!1;else if(t.compressionMethod===8)a=!0;else throw new Error(`unsupported compression method: ${t.compressionMethod}`);const l=c,u=l+t.compressedSize;if(t.compressedSize!==0&&u>n)throw new Error(`file data overflows file bounds: ${l} +  ${t.compressedSize}  > ${n}`);return{decompress:a,fileDataStart:l}}async function $o(e,t){const{decompress:r,fileDataStart:n}=await qs(e,t);if(!r){const o=await tt(e,n,t.compressedSize);return po(o)?o.buffer:o.slice().buffer}const s=await Ur(e,n,t.compressedSize);return await Us(s,t.uncompressedSize)}async function Go(e,t,r){const{decompress:n,fileDataStart:s}=await qs(e,t);if(!n){const c=await Ur(e,s,t.compressedSize,r);return Fs(c)?c:new Blob([xt(c.buffer)?new Uint8Array(c):c],{type:r})}const i=await Ur(e,s,t.compressedSize);return await Us(i,t.uncompressedSize,r)}async function Ro(e){let t;if(typeof Blob<"u"&&e instanceof Blob)t=new Yn(e);else if(e instanceof ArrayBuffer||e&&e.buffer&&e.buffer instanceof ArrayBuffer)t=new Xn(e);else if(xt(e)||xt(e.buffer))t=new Xn(e);else if(typeof e=="string"){const n=await fetch(e);if(!n.ok)throw new Error(`failed http request ${e}, status: ${n.status}: ${n.statusText}`);const s=await n.blob();t=new Yn(s)}else if(typeof e.getLength=="function"&&typeof e.read=="function")t=e;else throw new Error("unsupported source type");const r=await t.getLength();if(r>Number.MAX_SAFE_INTEGER)throw new Error(`file too large. size: ${r}. Only file sizes up 4503599627370496 bytes are supported`);return await To(t,r)}async function js(e){const{zip:t,entries:r}=await Ro(e);return{zip:t,entries:Object.fromEntries(r.map(n=>[n.name,n]))}}var In={},xn={};(function(e){const t=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",r=t+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",n="["+t+"]["+r+"]*",s=new RegExp("^"+n+"$"),i=function(c,a){const l=[];let u=a.exec(c);for(;u;){const f=[];f.startIndex=a.lastIndex-u[0].length;const d=u.length;for(let h=0;h<d;h++)f.push(u[h]);l.push(f),u=a.exec(c)}return l},o=function(c){const a=s.exec(c);return!(a===null||typeof a>"u")};e.isExist=function(c){return typeof c<"u"},e.isEmptyObject=function(c){return Object.keys(c).length===0},e.merge=function(c,a,l){if(a){const u=Object.keys(a),f=u.length;for(let d=0;d<f;d++)l==="strict"?c[u[d]]=[a[u[d]]]:c[u[d]]=a[u[d]]}},e.getValue=function(c){return e.isExist(c)?c:""},e.isName=o,e.getAllMatches=i,e.nameRegexp=n})(xn);const Sn=xn,Bo={allowBooleanAttributes:!1,unpairedTags:[]};In.validate=function(e,t){t=Object.assign({},Bo,t);const r=[];let n=!1,s=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let i=0;i<e.length;i++)if(e[i]==="<"&&e[i+1]==="?"){if(i+=2,i=ns(e,i),i.err)return i}else if(e[i]==="<"){let o=i;if(i++,e[i]==="!"){i=ss(e,i);continue}else{let c=!1;e[i]==="/"&&(c=!0,i++);let a="";for(;i<e.length&&e[i]!==">"&&e[i]!==" "&&e[i]!=="	"&&e[i]!==`
`&&e[i]!=="\r";i++)a+=e[i];if(a=a.trim(),a[a.length-1]==="/"&&(a=a.substring(0,a.length-1),i--),!Wo(a)){let f;return a.trim().length===0?f="Invalid space after '<'.":f="Tag '"+a+"' is an invalid name.",K("InvalidTag",f,X(e,i))}const l=Mo(e,i);if(l===!1)return K("InvalidAttr","Attributes for '"+a+"' have open quote.",X(e,i));let u=l.value;if(i=l.index,u[u.length-1]==="/"){const f=i-u.length;u=u.substring(0,u.length-1);const d=is(u,t);if(d===!0)n=!0;else return K(d.err.code,d.err.msg,X(e,f+d.err.line))}else if(c)if(l.tagClosed){if(u.trim().length>0)return K("InvalidTag","Closing tag '"+a+"' can't have attributes or invalid starting.",X(e,o));{const f=r.pop();if(a!==f.tagName){let d=X(e,f.tagStartPos);return K("InvalidTag","Expected closing tag '"+f.tagName+"' (opened in line "+d.line+", col "+d.col+") instead of closing tag '"+a+"'.",X(e,o))}r.length==0&&(s=!0)}}else return K("InvalidTag","Closing tag '"+a+"' doesn't have proper closing.",X(e,i));else{const f=is(u,t);if(f!==!0)return K(f.err.code,f.err.msg,X(e,i-u.length+f.err.line));if(s===!0)return K("InvalidXml","Multiple possible root nodes found.",X(e,i));t.unpairedTags.indexOf(a)!==-1||r.push({tagName:a,tagStartPos:o}),n=!0}for(i++;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="!"){i++,i=ss(e,i);continue}else if(e[i+1]==="?"){if(i=ns(e,++i),i.err)return i}else break;else if(e[i]==="&"){const f=qo(e,i);if(f==-1)return K("InvalidChar","char '&' is not expected.",X(e,i));i=f}else if(s===!0&&!rs(e[i]))return K("InvalidXml","Extra text at the end",X(e,i));e[i]==="<"&&i--}}else{if(rs(e[i]))continue;return K("InvalidChar","char '"+e[i]+"' is not expected.",X(e,i))}if(n){if(r.length==1)return K("InvalidTag","Unclosed tag '"+r[0].tagName+"'.",X(e,r[0].tagStartPos));if(r.length>0)return K("InvalidXml","Invalid '"+JSON.stringify(r.map(i=>i.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return K("InvalidXml","Start tag expected.",1);return!0};function rs(e){return e===" "||e==="	"||e===`
`||e==="\r"}function ns(e,t){const r=t;for(;t<e.length;t++)if(e[t]=="?"||e[t]==" "){const n=e.substr(r,t-r);if(t>5&&n==="xml")return K("InvalidXml","XML declaration allowed only at the start of the document.",X(e,t));if(e[t]=="?"&&e[t+1]==">"){t++;break}else continue}return t}function ss(e,t){if(e.length>t+5&&e[t+1]==="-"&&e[t+2]==="-"){for(t+=3;t<e.length;t++)if(e[t]==="-"&&e[t+1]==="-"&&e[t+2]===">"){t+=2;break}}else if(e.length>t+8&&e[t+1]==="D"&&e[t+2]==="O"&&e[t+3]==="C"&&e[t+4]==="T"&&e[t+5]==="Y"&&e[t+6]==="P"&&e[t+7]==="E"){let r=1;for(t+=8;t<e.length;t++)if(e[t]==="<")r++;else if(e[t]===">"&&(r--,r===0))break}else if(e.length>t+9&&e[t+1]==="["&&e[t+2]==="C"&&e[t+3]==="D"&&e[t+4]==="A"&&e[t+5]==="T"&&e[t+6]==="A"&&e[t+7]==="["){for(t+=8;t<e.length;t++)if(e[t]==="]"&&e[t+1]==="]"&&e[t+2]===">"){t+=2;break}}return t}const Fo='"',Ko="'";function Mo(e,t){let r="",n="",s=!1;for(;t<e.length;t++){if(e[t]===Fo||e[t]===Ko)n===""?n=e[t]:n!==e[t]||(n="");else if(e[t]===">"&&n===""){s=!0;break}r+=e[t]}return n!==""?!1:{value:r,index:t,tagClosed:s}}const Uo=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function is(e,t){const r=Sn.getAllMatches(e,Uo),n={};for(let s=0;s<r.length;s++){if(r[s][1].length===0)return K("InvalidAttr","Attribute '"+r[s][2]+"' has no space in starting.",ct(r[s]));if(r[s][3]!==void 0&&r[s][4]===void 0)return K("InvalidAttr","Attribute '"+r[s][2]+"' is without value.",ct(r[s]));if(r[s][3]===void 0&&!t.allowBooleanAttributes)return K("InvalidAttr","boolean attribute '"+r[s][2]+"' is not allowed.",ct(r[s]));const i=r[s][2];if(!jo(i))return K("InvalidAttr","Attribute '"+i+"' is an invalid name.",ct(r[s]));if(!n.hasOwnProperty(i))n[i]=1;else return K("InvalidAttr","Attribute '"+i+"' is repeated.",ct(r[s]))}return!0}function zo(e,t){let r=/\d/;for(e[t]==="x"&&(t++,r=/[\da-fA-F]/);t<e.length;t++){if(e[t]===";")return t;if(!e[t].match(r))break}return-1}function qo(e,t){if(t++,e[t]===";")return-1;if(e[t]==="#")return t++,zo(e,t);let r=0;for(;t<e.length;t++,r++)if(!(e[t].match(/\w/)&&r<20)){if(e[t]===";")break;return-1}return t}function K(e,t,r){return{err:{code:e,msg:t,line:r.line||r,col:r.col}}}function jo(e){return Sn.isName(e)}function Wo(e){return Sn.isName(e)}function X(e,t){const r=e.substring(0,t).split(/\r?\n/);return{line:r.length,col:r[r.length-1].length+1}}function ct(e){return e.startIndex+e[1].length}var Cn={};const Ws={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,r){return e}},Vo=function(e){return Object.assign({},Ws,e)};Cn.buildOptions=Vo;Cn.defaultOptions=Ws;class Do{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,r){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:r})}addChild(t){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,[":@"]:t[":@"]}):this.child.push({[t.tagname]:t.child})}}var Jo=Do;function Ho(e,t){const r={};if(e[t+3]==="O"&&e[t+4]==="C"&&e[t+5]==="T"&&e[t+6]==="Y"&&e[t+7]==="P"&&e[t+8]==="E"){t=t+9;let n=1,s=!1,i=!1,o="";for(;t<e.length;t++)if(e[t]==="<"&&!i){if(s&&Qo(e,t))t+=7,[entityName,val,t]=Xo(e,t+1),val.indexOf("&")===-1&&(r[entityName]={regx:RegExp(`&${entityName};`,"g"),val});else if(s&&Zo(e,t))t+=8;else if(s&&ea(e,t))t+=8;else if(s&&ta(e,t))t+=9;else if(Yo)i=!0;else throw new Error("Invalid DOCTYPE");n++,o=""}else if(e[t]===">"){if(i?e[t-1]==="-"&&e[t-2]==="-"&&(i=!1,n--):n--,n===0)break}else e[t]==="["?s=!0:o+=e[t];if(n!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:t}}function Xo(e,t){let r="";for(;t<e.length&&e[t]!=="'"&&e[t]!=='"';t++)r+=e[t];if(r=r.trim(),r.indexOf(" ")!==-1)throw new Error("External entites are not supported");const n=e[t++];let s="";for(;t<e.length&&e[t]!==n;t++)s+=e[t];return[r,s,t]}function Yo(e,t){return e[t+1]==="!"&&e[t+2]==="-"&&e[t+3]==="-"}function Qo(e,t){return e[t+1]==="!"&&e[t+2]==="E"&&e[t+3]==="N"&&e[t+4]==="T"&&e[t+5]==="I"&&e[t+6]==="T"&&e[t+7]==="Y"}function Zo(e,t){return e[t+1]==="!"&&e[t+2]==="E"&&e[t+3]==="L"&&e[t+4]==="E"&&e[t+5]==="M"&&e[t+6]==="E"&&e[t+7]==="N"&&e[t+8]==="T"}function ea(e,t){return e[t+1]==="!"&&e[t+2]==="A"&&e[t+3]==="T"&&e[t+4]==="T"&&e[t+5]==="L"&&e[t+6]==="I"&&e[t+7]==="S"&&e[t+8]==="T"}function ta(e,t){return e[t+1]==="!"&&e[t+2]==="N"&&e[t+3]==="O"&&e[t+4]==="T"&&e[t+5]==="A"&&e[t+6]==="T"&&e[t+7]==="I"&&e[t+8]==="O"&&e[t+9]==="N"}var ra=Ho;const na=/^[-+]?0x[a-fA-F0-9]+$/,sa=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt);!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);const ia={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function oa(e,t={}){if(t=Object.assign({},ia,t),!e||typeof e!="string")return e;let r=e.trim();if(t.skipLike!==void 0&&t.skipLike.test(r))return e;if(t.hex&&na.test(r))return Number.parseInt(r,16);{const n=sa.exec(r);if(n){const s=n[1],i=n[2];let o=aa(n[3]);const c=n[4]||n[6];if(!t.leadingZeros&&i.length>0&&s&&r[2]!==".")return e;if(!t.leadingZeros&&i.length>0&&!s&&r[1]!==".")return e;{const a=Number(r),l=""+a;return l.search(/[eE]/)!==-1||c?t.eNotation?a:e:r.indexOf(".")!==-1?l==="0"&&o===""||l===o||s&&l==="-"+o?a:e:i?o===l||s+o===l?a:e:r===l||r===s+l?a:e}}else return e}}function aa(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substr(0,e.length-1))),e}var ca=oa;const Nn=xn,lt=Jo,la=ra,ua=ca;"<((!\\[CDATA\\[([\\s\\S]*?)(]]>))|((NAME:)?(NAME))([^>]*)>|((\\/)(NAME)\\s*>))([^<]*)".replace(/NAME/g,Nn.nameRegexp);let fa=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"}},this.addExternalEntities=da,this.parseXml=ma,this.parseTextData=ha,this.resolveNameSpace=pa,this.buildAttributesMap=ya,this.isItStopNode=_a,this.replaceEntitiesValue=ba,this.readStopNodeData=ka,this.saveTextToParentTag=wa,this.addChild=va}};function da(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];this.lastEntities[n]={regex:new RegExp("&"+n+";","g"),val:e[n]}}}function ha(e,t,r,n,s,i,o){if(e!==void 0&&(this.options.trimValues&&!n&&(e=e.trim()),e.length>0)){o||(e=this.replaceEntitiesValue(e));const c=this.options.tagValueProcessor(t,e,r,s,i);return c==null?e:typeof c!=typeof e||c!==e?c:this.options.trimValues?qr(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?qr(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function pa(e){if(this.options.removeNSPrefix){const t=e.split(":"),r=e.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(e=r+t[1])}return e}const ga=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function ya(e,t,r){if(!this.options.ignoreAttributes&&typeof e=="string"){const n=Nn.getAllMatches(e,ga),s=n.length,i={};for(let o=0;o<s;o++){const c=this.resolveNameSpace(n[o][1]);let a=n[o][4],l=this.options.attributeNamePrefix+c;if(c.length)if(this.options.transformAttributeName&&(l=this.options.transformAttributeName(l)),l==="__proto__"&&(l="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const u=this.options.attributeValueProcessor(c,a,t);u==null?i[l]=a:typeof u!=typeof a||u!==a?i[l]=u:i[l]=qr(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(i[l]=!0)}if(!Object.keys(i).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=i,o}return i}}const ma=function(e){e=e.replace(/\r\n?/g,`
`);const t=new lt("!xml");let r=t,n="",s="";for(let i=0;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="/"){const c=Pe(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,c).trim();if(this.options.removeNSPrefix){const f=a.indexOf(":");f!==-1&&(a=a.substr(f+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),r&&(n=this.saveTextToParentTag(n,r,s));const l=s.substring(s.lastIndexOf(".")+1);if(a&&this.options.unpairedTags.indexOf(a)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let u=0;l&&this.options.unpairedTags.indexOf(l)!==-1?(u=s.lastIndexOf(".",s.lastIndexOf(".")-1),this.tagsNodeStack.pop()):u=s.lastIndexOf("."),s=s.substring(0,u),r=this.tagsNodeStack.pop(),n="",i=c}else if(e[i+1]==="?"){let c=zr(e,i,!1,"?>");if(!c)throw new Error("Pi Tag is not closed.");if(n=this.saveTextToParentTag(n,r,s),!(this.options.ignoreDeclaration&&c.tagName==="?xml"||this.options.ignorePiTags)){const a=new lt(c.tagName);a.add(this.options.textNodeName,""),c.tagName!==c.tagExp&&c.attrExpPresent&&(a[":@"]=this.buildAttributesMap(c.tagExp,s,c.tagName)),this.addChild(r,a,s)}i=c.closeIndex+1}else if(e.substr(i+1,3)==="!--"){const c=Pe(e,"-->",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,c-2);n=this.saveTextToParentTag(n,r,s),r.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=c}else if(e.substr(i+1,2)==="!D"){const c=la(e,i);this.docTypeEntities=c.entities,i=c.i}else if(e.substr(i+1,2)==="!["){const c=Pe(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,c);if(n=this.saveTextToParentTag(n,r,s),this.options.cdataPropName)r.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]);else{let l=this.parseTextData(a,r.tagname,s,!0,!1,!0);l==null&&(l=""),r.add(this.options.textNodeName,l)}i=c+2}else{let c=zr(e,i,this.options.removeNSPrefix),a=c.tagName,l=c.tagExp,u=c.attrExpPresent,f=c.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),r&&n&&r.tagname!=="!xml"&&(n=this.saveTextToParentTag(n,r,s,!1));const d=r;if(d&&this.options.unpairedTags.indexOf(d.tagname)!==-1&&(r=this.tagsNodeStack.pop(),s=s.substring(0,s.lastIndexOf("."))),a!==t.tagname&&(s+=s?"."+a:a),this.isItStopNode(this.options.stopNodes,s,a)){let h="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)i=c.closeIndex;else if(this.options.unpairedTags.indexOf(a)!==-1)i=c.closeIndex;else{const p=this.readStopNodeData(e,a,f+1);if(!p)throw new Error(`Unexpected end of ${a}`);i=p.i,h=p.tagContent}const g=new lt(a);a!==l&&u&&(g[":@"]=this.buildAttributesMap(l,s,a)),h&&(h=this.parseTextData(h,a,s,!0,u,!0,!0)),s=s.substr(0,s.lastIndexOf(".")),g.add(this.options.textNodeName,h),this.addChild(r,g,s)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){a[a.length-1]==="/"?(a=a.substr(0,a.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const h=new lt(a);a!==l&&u&&(h[":@"]=this.buildAttributesMap(l,s,a)),this.addChild(r,h,s),s=s.substr(0,s.lastIndexOf("."))}else{const h=new lt(a);this.tagsNodeStack.push(r),a!==l&&u&&(h[":@"]=this.buildAttributesMap(l,s,a)),this.addChild(r,h,s),r=h}n="",i=f}}else n+=e[i];return t.child};function va(e,t,r){const n=this.options.updateTag(t.tagname,r,t[":@"]);n===!1||(typeof n=="string"&&(t.tagname=n),e.addChild(t))}const ba=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const r=this.docTypeEntities[t];e=e.replace(r.regx,r.val)}for(let t in this.lastEntities){const r=this.lastEntities[t];e=e.replace(r.regex,r.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const r=this.htmlEntities[t];e=e.replace(r.regex,r.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function wa(e,t,r,n){return e&&(n===void 0&&(n=Object.keys(t.child).length===0),e=this.parseTextData(e,t.tagname,r,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,n),e!==void 0&&e!==""&&t.add(this.options.textNodeName,e),e=""),e}function _a(e,t,r){const n="*."+r;for(const s in e){const i=e[s];if(n===i||t===i)return!0}return!1}function Ea(e,t,r=">"){let n,s="";for(let i=t;i<e.length;i++){let o=e[i];if(n)o===n&&(n="");else if(o==='"'||o==="'")n=o;else if(o===r[0])if(r[1]){if(e[i+1]===r[1])return{data:s,index:i}}else return{data:s,index:i};else o==="	"&&(o=" ");s+=o}}function Pe(e,t,r,n){const s=e.indexOf(t,r);if(s===-1)throw new Error(n);return s+t.length-1}function zr(e,t,r,n=">"){const s=Ea(e,t+1,n);if(!s)return;let i=s.data;const o=s.index,c=i.search(/\s/);let a=i,l=!0;if(c!==-1&&(a=i.substr(0,c).replace(/\s\s*$/,""),i=i.substr(c+1)),r){const u=a.indexOf(":");u!==-1&&(a=a.substr(u+1),l=a!==s.data.substr(u+1))}return{tagName:a,tagExp:i,closeIndex:o,attrExpPresent:l}}function ka(e,t,r){const n=r;let s=1;for(;r<e.length;r++)if(e[r]==="<")if(e[r+1]==="/"){const i=Pe(e,">",r,`${t} is not closed`);if(e.substring(r+2,i).trim()===t&&(s--,s===0))return{tagContent:e.substring(n,r),i};r=i}else if(e[r+1]==="?")r=Pe(e,"?>",r+1,"StopNode is not closed.");else if(e.substr(r+1,3)==="!--")r=Pe(e,"-->",r+3,"StopNode is not closed.");else if(e.substr(r+1,2)==="![")r=Pe(e,"]]>",r,"StopNode is not closed.")-2;else{const i=zr(e,r,">");i&&((i&&i.tagName)===t&&i.tagExp[i.tagExp.length-1]!=="/"&&s++,r=i.closeIndex)}}function qr(e,t,r){if(t&&typeof e=="string"){const n=e.trim();return n==="true"?!0:n==="false"?!1:ua(e,r)}else return Nn.isExist(e)?e:""}var Ia=fa,Vs={};function xa(e,t){return Ds(e,t)}function Ds(e,t,r){let n;const s={};for(let i=0;i<e.length;i++){const o=e[i],c=Sa(o);let a="";if(r===void 0?a=c:a=r+"."+c,c===t.textNodeName)n===void 0?n=o[c]:n+=""+o[c];else{if(c===void 0)continue;if(o[c]){let l=Ds(o[c],t,a);const u=Na(l,t);o[":@"]?Ca(l,o[":@"],a,t):Object.keys(l).length===1&&l[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?l=l[t.textNodeName]:Object.keys(l).length===0&&(t.alwaysCreateTextNode?l[t.textNodeName]="":l=""),s[c]!==void 0&&s.hasOwnProperty(c)?(Array.isArray(s[c])||(s[c]=[s[c]]),s[c].push(l)):t.isArray(c,a,u)?s[c]=[l]:s[c]=l}}}return typeof n=="string"?n.length>0&&(s[t.textNodeName]=n):n!==void 0&&(s[t.textNodeName]=n),s}function Sa(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];if(n!==":@")return n}}function Ca(e,t,r,n){if(t){const s=Object.keys(t),i=s.length;for(let o=0;o<i;o++){const c=s[o];n.isArray(c,r+"."+c,!0,!0)?e[c]=[t[c]]:e[c]=t[c]}}}function Na(e,t){const{textNodeName:r}=t,n=Object.keys(e).length;return!!(n===0||n===1&&(e[r]||typeof e[r]=="boolean"||e[r]===0))}Vs.prettify=xa;const{buildOptions:Oa}=Cn,Ta=Ia,{prettify:Aa}=Vs,Pa=In;let La=class{constructor(t){this.externalEntities={},this.options=Oa(t)}parse(t,r){if(typeof t!="string")if(t.toString)t=t.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(r){r===!0&&(r={});const i=Pa.validate(t,r);if(i!==!0)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const n=new Ta(this.options);n.addExternalEntities(this.externalEntities);const s=n.parseXml(t);return this.options.preserveOrder||s===void 0?s:Aa(s,this.options)}addEntity(t,r){if(r.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(r==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=r}};var $a=La;const Ga=`
`;function Ra(e,t){let r="";return t.format&&t.indentBy.length>0&&(r=Ga),Js(e,t,"",r)}function Js(e,t,r,n){let s="",i=!1;for(let o=0;o<e.length;o++){const c=e[o],a=Ba(c);let l="";if(r.length===0?l=a:l=`${r}.${a}`,a===t.textNodeName){let g=c[a];Fa(l,t)||(g=t.tagValueProcessor(a,g),g=Hs(g,t)),i&&(s+=n),s+=g,i=!1;continue}else if(a===t.cdataPropName){i&&(s+=n),s+=`<![CDATA[${c[a][0][t.textNodeName]}]]>`,i=!1;continue}else if(a===t.commentPropName){s+=n+`<!--${c[a][0][t.textNodeName]}-->`,i=!0;continue}else if(a[0]==="?"){const g=os(c[":@"],t),p=a==="?xml"?"":n;let y=c[a][0][t.textNodeName];y=y.length!==0?" "+y:"",s+=p+`<${a}${y}${g}?>`,i=!0;continue}let u=n;u!==""&&(u+=t.indentBy);const f=os(c[":@"],t),d=n+`<${a}${f}`,h=Js(c[a],t,l,u);t.unpairedTags.indexOf(a)!==-1?t.suppressUnpairedNode?s+=d+">":s+=d+"/>":(!h||h.length===0)&&t.suppressEmptyNode?s+=d+"/>":h&&h.endsWith(">")?s+=d+`>${h}${n}</${a}>`:(s+=d+">",h&&n!==""&&(h.includes("/>")||h.includes("</"))?s+=n+t.indentBy+h+n:s+=h,s+=`</${a}>`),i=!0}return s}function Ba(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];if(n!==":@")return n}}function os(e,t){let r="";if(e&&!t.ignoreAttributes)for(let n in e){let s=t.attributeValueProcessor(n,e[n]);s=Hs(s,t),s===!0&&t.suppressBooleanAttributes?r+=` ${n.substr(t.attributeNamePrefix.length)}`:r+=` ${n.substr(t.attributeNamePrefix.length)}="${s}"`}return r}function Fa(e,t){e=e.substr(0,e.length-t.textNodeName.length-1);let r=e.substr(e.lastIndexOf(".")+1);for(let n in t.stopNodes)if(t.stopNodes[n]===e||t.stopNodes[n]==="*."+r)return!0;return!1}function Hs(e,t){if(e&&e.length>0&&t.processEntities)for(let r=0;r<t.entities.length;r++){const n=t.entities[r];e=e.replace(n.regex,n.val)}return e}var Ka=Ra;const Ma=Ka,Ua={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Ee(e){this.options=Object.assign({},Ua,e),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=ja),this.processTextOrObjNode=za,this.options.format?(this.indentate=qa,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}Ee.prototype.build=function(e){return this.options.preserveOrder?Ma(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0).val)};Ee.prototype.j2x=function(e,t){let r="",n="";for(let s in e)if(!(typeof e[s]>"u"))if(e[s]===null)s[0]==="?"?n+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:n+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)n+=this.buildTextValNode(e[s],s,"",t);else if(typeof e[s]!="object"){const i=this.isAttribute(s);if(i)r+=this.buildAttrPairStr(i,""+e[s]);else if(s===this.options.textNodeName){let o=this.options.tagValueProcessor(s,""+e[s]);n+=this.replaceEntitiesValue(o)}else n+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const i=e[s].length;let o="";for(let c=0;c<i;c++){const a=e[s][c];typeof a>"u"||(a===null?s[0]==="?"?n+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:n+=this.indentate(t)+"<"+s+"/"+this.tagEndChar:typeof a=="object"?this.options.oneListGroup?o+=this.j2x(a,t+1).val:o+=this.processTextOrObjNode(a,s,t):o+=this.buildTextValNode(a,s,"",t))}this.options.oneListGroup&&(o=this.buildObjectNode(o,s,"",t)),n+=o}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const i=Object.keys(e[s]),o=i.length;for(let c=0;c<o;c++)r+=this.buildAttrPairStr(i[c],""+e[s][i[c]])}else n+=this.processTextOrObjNode(e[s],s,t);return{attrStr:r,val:n}};Ee.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&t==="true"?" "+e:" "+e+'="'+t+'"'};function za(e,t,r){const n=this.j2x(e,r+1);return e[this.options.textNodeName]!==void 0&&Object.keys(e).length===1?this.buildTextValNode(e[this.options.textNodeName],t,n.attrStr,r):this.buildObjectNode(n.val,t,n.attrStr,r)}Ee.prototype.buildObjectNode=function(e,t,r,n){if(e==="")return t[0]==="?"?this.indentate(n)+"<"+t+r+"?"+this.tagEndChar:this.indentate(n)+"<"+t+r+this.closeTag(t)+this.tagEndChar;{let s="</"+t+this.tagEndChar,i="";return t[0]==="?"&&(i="?",s=""),r&&e.indexOf("<")===-1?this.indentate(n)+"<"+t+r+i+">"+e+s:this.options.commentPropName!==!1&&t===this.options.commentPropName&&i.length===0?this.indentate(n)+`<!--${e}-->`+this.newLine:this.indentate(n)+"<"+t+r+i+this.tagEndChar+e+this.indentate(n)+s}};Ee.prototype.closeTag=function(e){let t="";return this.options.unpairedTags.indexOf(e)!==-1?this.options.suppressUnpairedNode||(t="/"):this.options.suppressEmptyNode?t="/":t=`></${e}`,t};Ee.prototype.buildTextValNode=function(e,t,r,n){if(this.options.cdataPropName!==!1&&t===this.options.cdataPropName)return this.indentate(n)+`<![CDATA[${e}]]>`+this.newLine;if(this.options.commentPropName!==!1&&t===this.options.commentPropName)return this.indentate(n)+`<!--${e}-->`+this.newLine;if(t[0]==="?")return this.indentate(n)+"<"+t+r+"?"+this.tagEndChar;{let s=this.options.tagValueProcessor(t,e);return s=this.replaceEntitiesValue(s),s===""?this.indentate(n)+"<"+t+r+this.closeTag(t)+this.tagEndChar:this.indentate(n)+"<"+t+r+">"+s+"</"+t+this.tagEndChar}};Ee.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const r=this.options.entities[t];e=e.replace(r.regex,r.val)}return e};function qa(e){return this.options.indentBy.repeat(e)}function ja(e){return e.startsWith(this.options.attributeNamePrefix)?e.substr(this.attrPrefixLen):!1}var Wa=Ee;const Va=In,Da=$a,Ja=Wa;var Xs={XMLParser:Da,XMLValidator:Va,XMLBuilder:Ja};const Ha={catalogueLinks:{allowedChildrens:[]},publications:{allowedChildrens:[]},costTypes:{allowedChildrens:[]},profileTypes:{allowedChildrens:["characteristicTypes"]},categoryEntries:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups"]},categoryLinks:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups"]},forceEntries:{allowedChildrens:["forceEntries","categoryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","costs"]},entryLinks:{allowedChildrens:"type"},selectionEntryGroups:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","categoryLinks","costs"]},sharedSelectionEntryGroups:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","categoryLinks","costs"]},selectionEntries:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","associations","constraints","modifiers","modifierGroups","categoryLinks","costs"]},sharedSelectionEntries:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","associations","constraints","modifiers","modifierGroups","categoryLinks","costs"]},associations:{allowedChildrens:[]},sharedRules:{allowedChildrens:["modifiers","modifierGroups"]},rule:{allowedChildrens:["modifiers","modifierGroups"]},rules:{allowedChildrens:["modifiers","modifierGroups"]},profile:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},profiles:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},sharedProfiles:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},infoGroup:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},infoGroups:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},sharedInfoGroups:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},infoLinks:{allowedChildrens:"type"},modifiers:{allowedChildrens:["conditions","conditionGroups","repeats"]},modifierGroups:{allowedChildrens:["modifiers","modifierGroups","conditions","conditionGroups","repeats"]},conditions:{allowedChildrens:[]},conditionGroups:{allowedChildrens:["conditions","conditionGroups"]},catalogue:{allowedChildrens:["catalogueLinks","publications","costTypes","profileTypes","categoryEntries","forceEntries","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","selectionEntries","entryLinks","infoLinks","infoGroups","rules"]},gameSystem:{allowedChildrens:["publications","costTypes","profileTypes","categoryEntries","forceEntries","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","selectionEntries","entryLinks","infoLinks","infoGroups","rules"]}},Ge={categories:"category",catalogueLinks:"catalogueLink",categoryEntries:"categoryEntry",categoryLinks:"categoryLink",characteristics:"characteristic",characteristicTypes:"characteristicType",conditions:"condition",conditionGroups:"conditionGroup",constraints:"constraint",costs:"cost",costLimits:"costLimit",costTypes:"costType",entryLinks:"entryLink",forceEntries:"forceEntry",infoGroups:"infoGroup",infoLinks:"infoLink",forces:"force",modifiers:"modifier",modifierGroups:"modifierGroup",profiles:"profile",profileTypes:"profileType",publications:"publication",repeats:"repeat",rules:"rule",selections:"selection",selectionEntries:"selectionEntry",selectionEntryGroups:"selectionEntryGroup",sharedInfoGroups:"infoGroup",sharedProfiles:"profile",sharedRules:"rule",sharedSelectionEntries:"selectionEntry",sharedSelectionEntryGroups:"selectionEntryGroup",associations:"association"},pr=new Set(["description","readme","comment"]),as=/&(?:amp|lt|gt|quot|#39|apos);/g,Xa={"&amp;":"&","&apos;":"'","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},cs=e=>as.test(e)?e.replace(as,t=>Xa[t]):e,On={};for(const e in Ge)On[Ge[e]]=e;const rt={};for(const[e,t]of Object.entries(Ha))typeof t.allowedChildrens=="string"?rt[e]=t.allowedChildrens:rt[e]=new Set(t.allowedChildrens);function Ya(e){switch(e){case"true":return!0;case"false":return!1;default:if(isNaN(e))return e;const t=parseFloat(e);return isFinite(t)&&e.includes("+")==!1?t:e}}function Qa(e){const t={allowBooleanAttributes:!0,ignoreAttributes:!1,attributeNamePrefix:"",textNodeName:"$text",processEntities:!1,parseTagValue:!1,ignoreDeclaration:!0,alwaysCreateTextNode:!0,isArray:(r,n,s,i)=>!i&&r in On,attributeValueProcessor:(r,n)=>Ya(cs(n)),tagValueProcessor:(r,n)=>cs(n)};return new Xs.XMLParser(t).parse(e)}async function kl(e,t){const r=await js(e),n={};console.log("unzipping folder",r,"path",t);for(const s in r.entries){const i=r.entries[s];if(i.isDirectory)continue;const o=Br(Br(s,t),"/");if(o.startsWith("."))continue;const c=Ys(o)?await i.arrayBuffer():await i.text();n[o]=c}return n}async function Za(e){if(typeof e=="string"){var t=new TextEncoder;e=t.encode(e)}const r=await js(e);for(const n of Object.values(r.entries))return await n.text();throw"unzipFile failed: No Entries"}const ec=["gstz","zip","catz"],tc=["gst","gstz","xml","zip","cat","catz","json"];function Il(e){const t=e.lastIndexOf(".");return t===-1?e:e.substring(0,t)}function gr(e){return e.split(".").pop().toLowerCase()}function Ys(e){const t=gr(e);return ec.includes(t)}function rc(e){const t=gr(e);return!!tc.includes(t)}const ls={sharedRules:"shareRule",sharedProfiles:"sharedProfile",sharedInfoGroups:"sharedInfoGroup",sharedSelectionEntries:"sharedSelectionEntry",sharedSelectionEntryGroups:"sharedSelectionEntryGroup"};function jr(e){var t,r;for(let n in e)if(e[n]==="")delete e[n];else if(Ge[n]&&e[n])if(n in ls){const s=e[n][Ge[n]],i=e[n][ls[n]];e[n]=[...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]],(t=e[n])==null||t.forEach(jr)}else{const s=e[n][Ge[n]];Array.isArray(s)?(e[n]=s,(r=e[n])==null||r.forEach(jr)):ee(e[n])&&delete e[n]}else pr.has(n)&&(e[n]=e[n].$text??"");return e}function Wr(e,t){const r=rt[t],n=typeof r=="string"?rt[e[r]]:r;for(let s in e)s in Ge&&Array.isArray(e[s])&&(n&&!n.has(s)?delete e[s]:e[s].forEach(i=>Wr(i,s)))}const us=new Set;function fs(e,t){let r=rt[t];if(typeof r=="string"){const n=e[r];if(n){const s=ic(n);if(typeof s!="string"||s===r)return us;r=rt[s]}}return r||us}function ds(e){const t=Qa(e);jr(ye(t));const r=t.catalogue?"catalogue":"gameSystem";t.catalogue?(t.playable=1,t.id=Gi(t.catalogue.id),t.include=[1e3]):(t.playable=0,t.id=1e3);const n=t[r];return t.name=n.name,t.short=Ri(n.name),t.playable=!n.library,t.version=n.battleScribeVersion,t.nrversion=n.revision,t}async function nc(e,t){switch(t=gr(t),t){case"xml":case"cat":case"gst":return ds(e);case"zip":case"catz":case"gstz":return ds(await Za(e));case"json":return JSON.parse(e);default:throw new Error("Extension not supported "+t)}}function sc(e){return Ge[e]}function ic(e){return On[e]}const Qs=new Set(["?xml","$text","_"]);function oc(e){for(const[t,r]of Object.entries(e))pr.has(t)?e[t]=Array.isArray(r)?r:[r]:Array.isArray(r)&&!Qs.has(t)&&(e[t]=[{[sc(t)]:r}])}function ac(e){return zn(e,t=>{typeof t=="object"&&oc(t)}),zn(e,t=>{if(typeof t=="object")for(const[r,n]of Object.entries(t))Array.isArray(n)||Qs.has(r)||pr.has(r)||ee(n)||(t[`_${r}`]=n,delete t[r])}),e}function cc(e){const t=JSON.parse(Mr(e));ac(t);const r={textNodeName:"$text",format:!0,attributeNamePrefix:"_",ignoreAttributes:!1,suppressBooleanAttributes:!1,suppressEmptyNode:!0};return t.gameSystem&&(t.gameSystem._xmlns="http://www.battlescribe.net/schema/gameSystemSchema"),t.catalogue&&(t.catalogue._xmlns="http://www.battlescribe.net/schema/catalogueSchema"),`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
`+new Xs.XMLBuilder(r).build(t)}const lc=[{type:"publications",name:"Publications",icon:"publication.png"},{type:"costTypes",name:"Cost Types",icon:"cost.png"},{type:"profileTypes",name:"Profile Types",icon:"profileType.png"},{type:"categoryEntries",name:"Category Entries",icon:"category.png"},{type:"forceEntries",name:"Force Entries",icon:"force.png"},{type:"sharedSelectionEntries",name:"Shared Selection Entries",icon:"selectionEntryLink.png"},{type:"sharedSelectionEntryGroups",name:"Shared Selection Entry Groups",icon:"shared_groups.png"},{type:"sharedProfiles",name:"Shared Profiles",icon:"shared_profiles.png"},{type:"sharedRules",name:"Shared Rules",icon:"shared_rules.png"},{type:"sharedInfoGroups",name:"Shared Info Groups",icon:"infoGroup.png"},{type:"rules",links:"infoLinks",name:"Root Rules",icon:"rule.png"},{type:"selectionEntries",links:"entryLinks",name:"Root Selection Entries",icon:"selectionEntry.png"}],xl=[{type:"catalogueLinks",name:"Catalogue Links",icon:"catalogueLink.png"},...lc];function je(e,t){switch(e){case"selectionEntry":return"Entry";case"selectionEntryGroup":return"Group";case"selectionEntryLink":return"Entry (link)";case"selectionEntryGroupLink":return"Group (link)";case"force":return"Force";case"category":return"Category";case"categoryLink":return"Category (link)";case"catalogueLink":return"Catalogue (link)";case"publication":return"Publication";case"costType":return"Cost Type";case"costs":return"Cost";case"link":return"Link";case"profileType":return"Profile Type";case"profile":return"Profile";case"rule":return"Rule";case"infoLink":return"Info (link)";case"infoGroup":return"Info Group";case"profileLink":return"Profile";case"ruleLink":return"Rule (link)";case"infoGroupLink":return"Info Group (link)";case"characteristic":return"Characteristic";case"characteristicType":return"Characteristic Type";case"constraint":return"Constraint";case"condition":return"Condition";case"modifier":return"Modifier";case"modifierGroup":return"Modifier Group";case"repeat":return"Repeat";case"conditionGroup":return"Condition Group";case"catalogue":return"Catalogue";case"gameSystem":return"Game System";default:return console.warn("unknown getTypeLabel key",e),e}}function Se(e,t){switch(e){case"selectionEntries":return"selectionEntry";case"selectionEntryGroups":return"selectionEntryGroup";case"sharedSelectionEntries":return t!=null&&t.targetId?"selectionEntryLink":"selectionEntry";case"sharedSelectionEntryGroups":return t!=null&&t.targetId?"selectionEntryLink":"selectionEntryGroup";case"entryLinks":return t!=null&&t.target?t.target.editorTypeName+"Link":"link";case"forceEntries":return"force";case"categoryEntries":return"category";case"categoryLinks":return"categoryLink";case"catalogueLinks":return"catalogueLink";case"publications":return"publication";case"costTypes":return"costType";case"costs":return"cost";case"profileTypes":return"profileType";case"profiles":return"profile";case"rules":return"rule";case"characteristics":return"characteristic";case"characteristicTypes":return"characteristicType";case"sharedProfiles":return"profile";case"sharedRules":return"rule";case"sharedInfoGroups":return"infoGroup";case"infoLinks":return t?`${t.type||"info"}Link`:"infoLink";case"infoGroups":return"infoGroup";case"associations":return"association";case"constraints":return"constraint";case"conditions":return"condition";case"modifiers":return"modifier";case"modifierGroups":return"modifierGroup";case"repeats":return"repeat";case"conditionGroups":return"conditionGroup";case"catalogue":case"gameSystem":return e;default:return console.warn("unknown getTypeName key",e),e}}function Sl(e,t=!0,r=!0){var o,c,a,l,u;const n=e.parentKey,s=[];switch(n){case"infoLinks":["profiles","sharedProfiles"].includes((o=e.target)==null?void 0:o.parentKey)&&r&&s.push(e.target.typeName);break;case"sharedProfiles":case"profiles":r&&s.push(e.typeName);break;case"selectionEntries":case"sharedSelectionEntries":e.isEntry()&&e.getType()!=="upgrade"&&r&&s.push(e.getType());break;case"entryLinks":e.target&&e.isEntry()&&e.getType()!=="upgrade"&&r&&s.push(e.getType());break;case"modifierGroups":s.push(`(${(((c=e.modifiers)==null?void 0:c.length)||0)+(((a=e.modifierGroups)==null?void 0:a.length)||0)})`);break}const i=(((l=e.refs)==null?void 0:l.length)??0)+(((u=e.other_refs)==null?void 0:u.length)??0);if(i&&t){const f=i===1?"":"s";s.push(`(${i||0} ref${f})`)}return e.comment&&e.comment[0]&&s.push("# "+e.comment),e.isCollective&&e.isCollective()&&s.push("(collective)"),s.join(" ")}function nr(e){const t=e.parentKey;switch(t){case"selectionEntries":case"sharedSelectionEntries":case"selectionEntryGroups":case"sharedSelectionEntryGroups":case"entryLinks":case"forceEntries":case"categoryLinks":case"categoryEntries":case"sharedInfoGroups":case"infoGroups":case"catalogueLinks":case"publications":case"profileTypes":case"catalogue":case"gameSystem":case"rules":case"sharedRules":case"costs":case"costTypes":case"sharedProfiles":case"profiles":case"characteristics":case"characteristicTypes":return e.getName();case"modifiers":return io(Xe(e),e);case"repeats":{const r=e,n=Xe(e);return n||console.error("no parent for repeat",e),`Repeat ${r.repeats} times for every ${r.value} ${$e(n,r.field)} in ${$e(n,r.scope)} of ${r.childId?$e(n,r.childId):" any"}`}case"conditions":return Jn(Xe(e),e);case"constraints":return Jn(Xe(e),e);case"modifierGroups":return"Modify...";case"conditionGroups":return`${e.type.toUpperCase()}`;case"infoLinks":return e.target?nr(e.target):e.getName();case"associations":return e.name;default:return console.log(t,e),t}}function sr(e,t){t(e);const r=[e];for(;r.length;){const n=r.pop();for(const s of Object.keys(n)){if(!st.has(s)||pr.has(s))continue;const i=n[s];if(i&&Array.isArray(i))for(const o of i)r.push(o),t(o,s,n)}}}function uc(e){const t=e.parent;if(t){const r=t[e.parentKey],n=r.indexOf(e);n!==-1&&r.splice(n,1)}}function ut(e,t){const r=e.catalogue;sr(e,(n,s,i)=>{if(r.removeFromIndex(n),n.isLink&&n.isLink()&&(r.unlinkLink(n),delete n.target),n instanceof gt&&n.typeId){const o=n.catalogue.findOptionById(n.typeId);o&&n.catalogue.removeRef(n,o)}if(n instanceof Ke){const o=n.scope,c=n.childId;if(!En.has(o)){const a=n.catalogue.findOptionById(n.scope);a&&n.catalogue.removeOtherRef(n,a)}if(!to.has(c)){const a=n.catalogue.findOptionById(n.childId);a&&n.catalogue.removeOtherRef(n,a)}}delete n.parent,delete n.catalogue}),t&&e instanceof kn&&r.reload(t)}function We(e,t,r,n){let s=!1;for(const i of Array.isArray(e)?e:[e])sr(i,(o,c,a)=>{if(ee(o)){if(o.parent=a||r,o.catalogue=t,t.addToIndex(o),o instanceof et&&t.updateLink(o),o instanceof gt&&o.typeId){const l=o.catalogue.findOptionById(o.typeId);l&&o.catalogue.addRef(o,l)}o instanceof kn&&o.targetId&&(s=!0),t.refreshErrors(o)}});s&&r&&(r.catalogue||r).reload(n)}function pe(e){if(!e.parent&&!e.isCatalogue())return[{id:e.id,key:e.parentKey,index:0}];const t=[];for(;e.parent;){const r=e.parent||e.catalogue;t.push({key:e.parentKey,index:r[e.parentKey].indexOf(e),id:e.id}),e=e.parent}return t.reverse(),t}function Cl(e){if(!e.parent&&!e.isCatalogue())return[{id:e.id,key:e.parentKey,index:0}];const t=[];do{const r=e.parent||e.catalogue;r?t.push({name:e.getName(),type:e.editorTypeName,label:e.getTypeName(),display:nr(e),key:e.parentKey,index:r[e.parentKey].indexOf(e),id:e.id}):t.push({name:e.getName(),display:nr(e),type:"catalogue",key:"catalogue",id:e.id,index:0}),e=e.parent}while(e);return t.reverse(),t}function hs(e,t,r){let n=e;for(let o=0;o<t.length-1;o++){const c=t[o];n=n[c.key][c.index]}const s=t[t.length-1];return n[s.key]||(n[s.key]=[]),n[s.key].splice(s.index,0,r),n}function Nl(e,t){let r=e;for(const n of t){if(r=r[n.key],!r)return;r=r[n.index]}return r}function Gt(e,t){let r=e;const n=t[t.length-1];for(const o of t)o!==n&&(r=r[o.key][o.index]);const i=r[n.key].splice(n.index,1)[0];if(!i)throw new Error("popAtEntryPath failed");return i}function ps(e,t){const r={},n=Array.isArray(t)?t:[t];for(const s of n)sr(s,(i,o,c)=>{if(i.id){const a=i.id,l=e.generateNonConflictingId(a);i.id=l,r[a]=l}});for(const s of n)sr(s,(i,o,c)=>{i instanceof Ke&&(i.scope in r&&(i.scope=r[i.scope]),i.childId in r&&(i.childId=r[i.childId])),i instanceof wn&&i.field in r&&(i.field=r[i.field])})}function gs(e,t,r){if(e.isCatalogue()){if(r)switch(t){case"sharedRules":case"rules":return["sharedRules","rules"].includes(r)?r:"";case"sharedProfiles":case"profiles":return["sharedProfiles","profiles"].includes(r)?r:"";case"sharedInfoGroups":case"infoGroups":return["sharedInfoGroups","infoGroups"].includes(r)?r:"";case"sharedSelectionEntries":case"selectionEntries":return["sharedSelectionEntries","selectionEntries"].includes(r)?r:"";case"sharedSelectionEntryGroups":case"selectionEntryGroups":return["sharedSelectionEntryGroups","selectionEntryGroups"].includes(r)?r:"";default:return t}}else switch(t){case"sharedRules":return"rules";case"sharedProfiles":return"profiles";case"sharedInfoGroups":return"infoGroups";case"sharedSelectionEntries":return"selectionEntries";case"sharedSelectionEntryGroups":return"selectionEntryGroups";default:return t}return t}class fc{get[Symbol.toStringTag](){return"ObjectNoObserve"}}function dc(){return new fc}const hc={};function pc(e,t,r){if(t in e)return e[t];class n extends R{get parentKey(){return t}get editorTypeName(){return Se(t,this)}toString(){return`${this.editorTypeName} - ${nr(this)}`}}return n.prototype.parentKey,Object.setPrototypeOf(n.prototype,Object.getPrototypeOf(r)),e[t]=n.prototype,n.prototype}function gc(e,t,r){Object.setPrototypeOf(r,pc(e,t,r))}const Dt={"*":R.prototype,catalogue:rr.prototype,catalogueLinks:kn.prototype,gameSystem:rr.prototype,forceEntries:Ir.prototype,forces:Ir.prototype,force:Ir.prototype,categoryEntries:pt.prototype,category:pt.prototype,categories:pt.prototype,link:et.prototype,infoLinks:Xi.prototype,categoryLinks:$s.prototype,entry:_r.prototype,selectionEntries:_r.prototype,entryLinks:et.prototype,sharedSelectionEntries:_r.prototype,group:Er.prototype,selectionEntryGroups:Er.prototype,sharedSelectionEntryGroups:Er.prototype,sharedRules:qt.prototype,rules:qt.prototype,rule:qt.prototype,profileTypes:Qi.prototype,sharedProfiles:gt.prototype,profiles:gt.prototype,profile:gt.prototype,characteristics:Vn.prototype,characteristic:Vn.prototype,characteristicTypes:R.prototype,characteristicType:R.prototype,sharedInfoGroups:Sr.prototype,infoGroups:Sr.prototype,infoGroup:Sr.prototype,publications:Hn.prototype,publication:Hn.prototype,repeats:Ke.prototype,conditions:Ke.prototype,constraints:Kr.prototype,modifiers:wn.prototype,modifierGroups:Gs.prototype};Object.values(Dt);function yc(e){return e in Dt?Dt[e]:Dt["*"]}function Vr(e,t){const r=yc(t);return r&&(Object.setPrototypeOf(e,r),e.post_init&&e.post_init(),globalThis.isEditor&&gc(e.keyInfoCache||hc,t,e)),e}function Ce(e){const t=[e];for(;t.length;){const r=t.pop();for(const n of Object.keys(r)){const s=r[n];if(ee(s))if(Array.isArray(s)){if(s.length&&ee(s[0]))for(let i=s.length;i--;){const o=s[i];qn(o)&&(Vr(o,n),t.push(o))}}else qn(s)&&(Vr(s,n),t.push(s))}}}const ys=vn("catalogues",{state:()=>({dict:{},version:1}),persist:{storage:globalThis.localStorage},actions:{get(e){return e in this.dict||(this.dict[e]={}),this.dict[e]},setEdited(e,t){this.get(e).edited=t},getEdited(e){return this.get(e).edited},setErrors(e,t){this.get(e).errors=t},getErrors(e){return this.get(e).errors},getDependents(e){return this.get(e).dependents},updateCatalogue(e){var s;const t=e.id,r=e.gameSystemId||e.id,n=(s=e.catalogueLinks)==null?void 0:s.map(i=>({targetId:i.targetId===r?r:`${r}-${i.targetId}`,sourceId:t===r?r:`${r}-${t}`,importRootEntries:i.importRootEntries,sourceName:e.name}));e.gameSystemId&&(n==null||n.push({targetId:e.gameSystemId,sourceId:t,importRootEntries:!0,sourceName:e.name})),this.setDependencies(t,n)},setDependencies(e,t){var n;const r=(n=this.get(e))==null?void 0:n.dependencies;if(r)for(const s of r)this.removeDependent(s.targetId,s);if(t)for(const s of t)this.addDependent(s.targetId,s);this.get(e).dependencies=t||[]},setDependents(e,t){this.get(e).dependents=t},addDependent(e,t){const r=this.get(e);r.dependents||(r.dependents=[]),r.dependents.push(t)},removeDependent(e,t){var n;const r=(n=this.get(e))==null?void 0:n.dependents;if(r){const s=r.findIndex(i=>i.sourceId===t.sourceId);s>=0&&r.splice(s,1)}}}}),mc={showImported:!1,ignoreProfilesRules:!1,filter:"",scroll:0,selection:void 0,mode:"edit"},Tr=vn("editor-ui",{state:()=>({catalogues:{}}),persist:{storage:globalThis.localStorage},actions:{collapse_level(e){var r;if(e>=0){const n=`depth-${e} collapsible-box opened`,s=document.documentElement.getElementsByClassName(n);if(s!=null&&s.length)for(var t=0;t<s.length;t++){const i=s[t];(r=ve(i))==null||r.close()}}},collapse_all(){this.collapse_level(1),this.collapse_level(0)},collapse_deepest(){const e="collapsible-box opened",t=document.documentElement.getElementsByClassName(e);let r=-1;if(t!=null&&t.length)for(var n=0;n<t.length;n++)t[n].classList.forEach(i=>{i.startsWith("depth-")&&(r=Math.max(r,parseInt(i.split("-")[1])))});this.collapse_level(r)},set_state(e,t){function r(i,o,c=0){const a=`depth-${c} collapsible-box opened`,l=i.getElementsByClassName(a);if(l!=null&&l.length)for(var u=0;u<l.length;u++){const f=l[u],d=Ne(ve(f)),h=d.parentKey,g=d.parent;let p=o;if(g){const y=g[h];if(!y||!Array.isArray(y))continue;const m=y.indexOf(d);h in o||(o[h]={});const v=o[h];m in v||(v[m]={}),p=v[m]}else{const y=[];for(let v=0;v<f.classList.length;v++)y.push(f.classList[v]);const m=y.filter(v=>st.has(v));for(const v of m)o[v]={},o[v][0]={},p=o[v][0]}r(f,p,c+1)}}const n={};r(document.documentElement,n);const s={...t,open:n};return this.$state.catalogues[e]=s,n},get_data(e){const t=this.$state.catalogues[e];return t||{}},get_root(e,t){let r=this.$state.catalogues[e];return!(!r||(r=r.open[t],!r))},get(e,t){if(!t.length)return!1;let r=this.$state.catalogues[e];if(!r)return!1;let n=r.open[t[0].key];if(!n||(n=n[0],!n))return!1;for(const s of t){const i=n[s.key];if(!i)return!1;const o=i[s.index];if(!o)return!1;n=o}return!0}}}),G=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,M=Object.keys,V=Array.isArray;function H(e,t){return typeof t!="object"||M(t).forEach(function(r){e[r]=t[r]}),e}typeof Promise>"u"||G.Promise||(G.Promise=Promise);const St=Object.getPrototypeOf,vc={}.hasOwnProperty;function Z(e,t){return vc.call(e,t)}function nt(e,t){typeof t=="function"&&(t=t(St(e))),(typeof Reflect>"u"?M:Reflect.ownKeys)(t).forEach(r=>{le(e,r,t[r])})}const Zs=Object.defineProperty;function le(e,t,r,n){Zs(e,t,H(r&&Z(r,"get")&&typeof r.get=="function"?{get:r.get,set:r.set,configurable:!0}:{value:r,configurable:!0,writable:!0},n))}function Ye(e){return{from:function(t){return e.prototype=Object.create(t.prototype),le(e.prototype,"constructor",e),{extend:nt.bind(null,e.prototype)}}}}const bc=Object.getOwnPropertyDescriptor;function Tn(e,t){let r;return bc(e,t)||(r=St(e))&&Tn(r,t)}const wc=[].slice;function ir(e,t,r){return wc.call(e,t,r)}function ei(e,t){return t(e)}function dt(e){if(!e)throw new Error("Assertion Failed")}function ti(e){G.setImmediate?setImmediate(e):setTimeout(e,0)}function ri(e,t){return e.reduce((r,n,s)=>{var i=t(n,s);return i&&(r[i[0]]=i[1]),r},{})}function ue(e,t){if(Z(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var r=[],n=0,s=t.length;n<s;++n){var i=ue(e,t[n]);r.push(i)}return r}var o=t.indexOf(".");if(o!==-1){var c=e[t.substr(0,o)];return c===void 0?void 0:ue(c,t.substr(o+1))}}function te(e,t,r){if(e&&t!==void 0&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){dt(typeof r!="string"&&"length"in r);for(var n=0,s=t.length;n<s;++n)te(e,t[n],r[n])}else{var i=t.indexOf(".");if(i!==-1){var o=t.substr(0,i),c=t.substr(i+1);if(c==="")r===void 0?V(e)&&!isNaN(parseInt(o))?e.splice(o,1):delete e[o]:e[o]=r;else{var a=e[o];a&&Z(e,o)||(a=e[o]={}),te(a,c,r)}}else r===void 0?V(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=r}}function ni(e){var t={};for(var r in e)Z(e,r)&&(t[r]=e[r]);return t}const _c=[].concat;function si(e){return _c.apply([],e)}const ii="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(si([8,16,32,64].map(e=>["Int","Uint","Float"].map(t=>t+e+"Array")))).filter(e=>G[e]),Ec=ii.map(e=>G[e]);ri(ii,e=>[e,!0]);let me=null;function Pt(e){me=typeof WeakMap<"u"&&new WeakMap;const t=Dr(e);return me=null,t}function Dr(e){if(!e||typeof e!="object")return e;let t=me&&me.get(e);if(t)return t;if(V(e)){t=[],me&&me.set(e,t);for(var r=0,n=e.length;r<n;++r)t.push(Dr(e[r]))}else if(Ec.indexOf(e.constructor)>=0)t=e;else{const i=St(e);for(var s in t=i===Object.prototype?{}:Object.create(i),me&&me.set(e,t),e)Z(e,s)&&(t[s]=Dr(e[s]))}return t}const{toString:kc}={};function Jr(e){return kc.call(e).slice(8,-1)}const Hr=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Ic=typeof Hr=="symbol"?function(e){var t;return e!=null&&(t=e[Hr])&&t.apply(e)}:function(){return null},He={};function ae(e){var t,r,n,s;if(arguments.length===1){if(V(e))return e.slice();if(this===He&&typeof e=="string")return[e];if(s=Ic(e)){for(r=[];!(n=s.next()).done;)r.push(n.value);return r}if(e==null)return[e];if(typeof(t=e.length)=="number"){for(r=new Array(t);t--;)r[t]=e[t];return r}return[e]}for(t=arguments.length,r=new Array(t);t--;)r[t]=arguments[t];return r}const An=typeof Symbol<"u"?e=>e[Symbol.toStringTag]==="AsyncFunction":()=>!1;var se=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function oi(e,t){se=e,ai=t}var ai=()=>!0;const xc=!new Error("").stack;function ze(){if(xc)try{throw ze.arguments,new Error}catch(e){return e}return new Error}function Xr(e,t){var r=e.stack;return r?(t=t||0,r.indexOf(e.name)===0&&(t+=(e.name+e.message).split(`
`).length),r.split(`
`).slice(t).filter(ai).map(n=>`
`+n).join("")):""}var ci=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Pn=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(ci),Sc={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Qe(e,t){this._e=ze(),this.name=e,this.message=t}function li(e,t){return e+". Errors: "+Object.keys(t).map(r=>t[r].toString()).filter((r,n,s)=>s.indexOf(r)===n).join(`
`)}function or(e,t,r,n){this._e=ze(),this.failures=t,this.failedKeys=n,this.successCount=r,this.message=li(e,t)}function bt(e,t){this._e=ze(),this.name="BulkError",this.failures=Object.keys(t).map(r=>t[r]),this.failuresByPos=t,this.message=li(e,t)}Ye(Qe).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Xr(this._e,2))}},toString:function(){return this.name+": "+this.message}}),Ye(or).from(Qe),Ye(bt).from(Qe);var Ln=Pn.reduce((e,t)=>(e[t]=t+"Error",e),{});const Cc=Qe;var O=Pn.reduce((e,t)=>{var r=t+"Error";function n(s,i){this._e=ze(),this.name=r,s?typeof s=="string"?(this.message=`${s}${i?`
 `+i:""}`,this.inner=i||null):typeof s=="object"&&(this.message=`${s.name} ${s.message}`,this.inner=s):(this.message=Sc[t]||r,this.inner=null)}return Ye(n).from(Cc),e[t]=n,e},{});O.Syntax=SyntaxError,O.Type=TypeError,O.Range=RangeError;var ms=ci.reduce((e,t)=>(e[t+"Error"]=O[t],e),{}),Jt=Pn.reduce((e,t)=>(["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=O[t]),e),{});function L(){}function Ct(e){return e}function Nc(e,t){return e==null||e===Ct?t:function(r){return t(e(r))}}function Me(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function Oc(e,t){return e===L?t:function(){var r=e.apply(this,arguments);r!==void 0&&(arguments[0]=r);var n=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var i=t.apply(this,arguments);return n&&(this.onsuccess=this.onsuccess?Me(n,this.onsuccess):n),s&&(this.onerror=this.onerror?Me(s,this.onerror):s),i!==void 0?i:r}}function Tc(e,t){return e===L?t:function(){e.apply(this,arguments);var r=this.onsuccess,n=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),r&&(this.onsuccess=this.onsuccess?Me(r,this.onsuccess):r),n&&(this.onerror=this.onerror?Me(n,this.onerror):n)}}function Ac(e,t){return e===L?t:function(r){var n=e.apply(this,arguments);H(r,n);var s=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=t.apply(this,arguments);return s&&(this.onsuccess=this.onsuccess?Me(s,this.onsuccess):s),i&&(this.onerror=this.onerror?Me(i,this.onerror):i),n===void 0?o===void 0?void 0:o:H(n,o)}}function Pc(e,t){return e===L?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function $n(e,t){return e===L?t:function(){var r=e.apply(this,arguments);if(r&&typeof r.then=="function"){for(var n=this,s=arguments.length,i=new Array(s);s--;)i[s]=arguments[s];return r.then(function(){return t.apply(n,i)})}return t.apply(this,arguments)}}Jt.ModifyError=or,Jt.DexieError=Qe,Jt.BulkError=bt;var Nt={};const[Yr,ar,Qr]=typeof Promise>"u"?[]:(()=>{let e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,St(e),e];const t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,St(t),e]})(),ui=ar&&ar.then,Ht=Yr&&Yr.constructor,Gn=!!Qr;var Zr=!1,Lc=Qr?()=>{Qr.then(Rt)}:G.setImmediate?setImmediate.bind(null,Rt):G.MutationObserver?()=>{var e=document.createElement("div");new MutationObserver(()=>{Rt(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:()=>{setTimeout(Rt,0)},wt=function(e,t){ht.push([e,t]),cr&&(Lc(),cr=!1)},en=!0,cr=!0,Re=[],Xt=[],tn=null,rn=Ct,Ze={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:bs,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(e=>{try{bs(e[0],e[1])}catch{}})}},C=Ze,ht=[],Be=0,Yt=[];function x(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=L,this._lib=!1;var t=this._PSD=C;if(se&&(this._stackHolder=ze(),this._prev=null,this._numPrev=0),typeof e!="function"){if(e!==Nt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&sn(this,this._value))}this._state=null,this._value=null,++t.ref,di(this,e)}const nn={get:function(){var e=C,t=lr;function r(n,s){var i=!e.global&&(e!==C||t!==lr);const o=i&&!fe();var c=new x((a,l)=>{Rn(this,new fi(ur(n,e,i,o),ur(s,e,i,o),a,l,e))});return se&&gi(c,this),c}return r.prototype=Nt,r},set:function(e){le(this,"then",e&&e.prototype===Nt?nn:{get:function(){return e},set:nn.set})}};function fi(e,t,r,n,s){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=r,this.reject=n,this.psd=s}function di(e,t){try{t(r=>{if(e._state===null){if(r===e)throw new TypeError("A promise cannot be resolved with itself.");var n=e._lib&&Lt();r&&typeof r.then=="function"?di(e,(s,i)=>{r instanceof x?r._then(s,i):r.then(s,i)}):(e._state=!0,e._value=r,hi(e)),n&&$t()}},sn.bind(null,e))}catch(r){sn(e,r)}}function sn(e,t){if(Xt.push(t),e._state===null){var r=e._lib&&Lt();t=rn(t),e._state=!1,e._value=t,se&&t!==null&&typeof t=="object"&&!t._promise&&function(n,s,i){try{n.apply(null,i)}catch(o){s&&s(o)}}(()=>{var n=Tn(t,"stack");t._promise=e,le(t,"stack",{get:()=>Zr?n&&(n.get?n.get.apply(t):n.value):e.stack})}),function(n){Re.some(s=>s._value===n._value)||Re.push(n)}(e),hi(e),r&&$t()}}function hi(e){var t=e._listeners;e._listeners=[];for(var r=0,n=t.length;r<n;++r)Rn(e,t[r]);var s=e._PSD;--s.ref||s.finalize(),Be===0&&(++Be,wt(()=>{--Be==0&&Bn()},[]))}function Rn(e,t){if(e._state!==null){var r=e._state?t.onFulfilled:t.onRejected;if(r===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Be,wt($c,[r,e,t])}else e._listeners.push(t)}function $c(e,t,r){try{tn=t;var n,s=t._value;t._state?n=e(s):(Xt.length&&(Xt=[]),n=e(s),Xt.indexOf(s)===-1&&function(i){for(var o=Re.length;o;)if(Re[--o]._value===i._value)return void Re.splice(o,1)}(t)),r.resolve(n)}catch(i){r.reject(i)}finally{tn=null,--Be==0&&Bn(),--r.psd.ref||r.psd.finalize()}}function pi(e,t,r){if(t.length===r)return t;var n="";if(e._state===!1){var s,i,o=e._value;o!=null?(s=o.name||"Error",i=o.message||o,n=Xr(o,0)):(s=o,i=""),t.push(s+(i?": "+i:"")+n)}return se&&((n=Xr(e._stackHolder,2))&&t.indexOf(n)===-1&&t.push(n),e._prev&&pi(e._prev,t,r)),t}function gi(e,t){var r=t?t._numPrev+1:0;r<100&&(e._prev=t,e._numPrev=r)}function Rt(){Lt()&&$t()}function Lt(){var e=en;return en=!1,cr=!1,e}function $t(){var e,t,r;do for(;ht.length>0;)for(e=ht,ht=[],r=e.length,t=0;t<r;++t){var n=e[t];n[0].apply(null,n[1])}while(ht.length>0);en=!0,cr=!0}function Bn(){var e=Re;Re=[],e.forEach(n=>{n._PSD.onunhandled.call(null,n._value,n)});for(var t=Yt.slice(0),r=t.length;r;)t[--r]()}function Bt(e){return new x(Nt,!1,e)}function B(e,t){var r=C;return function(){var n=Lt(),s=C;try{return we(r,!0),e.apply(this,arguments)}catch(i){t&&t(i)}finally{we(s,!1),n&&$t()}}}nt(x.prototype,{then:nn,_then:function(e,t){Rn(this,new fi(null,null,e,t,C))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=arguments[0],r=arguments[1];return typeof t=="function"?this.then(null,n=>n instanceof t?r(n):Bt(n)):this.then(null,n=>n&&n.name===t?r(n):Bt(n))},finally:function(e){return this.then(t=>(e(),t),t=>(e(),Bt(t)))},stack:{get:function(){if(this._stack)return this._stack;try{Zr=!0;var e=pi(this,[],20).join(`
From previous: `);return this._state!==null&&(this._stack=e),e}finally{Zr=!1}}},timeout:function(e,t){return e<1/0?new x((r,n)=>{var s=setTimeout(()=>n(new O.Timeout(t)),e);this.then(r,n).finally(clearTimeout.bind(null,s))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&le(x.prototype,Symbol.toStringTag,"Dexie.Promise"),Ze.env=yi(),nt(x,{all:function(){var e=ae.apply(null,arguments).map(Ft);return new x(function(t,r){e.length===0&&t([]);var n=e.length;e.forEach((s,i)=>x.resolve(s).then(o=>{e[i]=o,--n||t(e)},r))})},resolve:e=>{if(e instanceof x)return e;if(e&&typeof e.then=="function")return new x((r,n)=>{e.then(r,n)});var t=new x(Nt,!0,e);return gi(t,tn),t},reject:Bt,race:function(){var e=ae.apply(null,arguments).map(Ft);return new x((t,r)=>{e.map(n=>x.resolve(n).then(t,r))})},PSD:{get:()=>C,set:e=>C=e},totalEchoes:{get:()=>lr},newPSD:be,usePSD:ot,scheduler:{get:()=>wt,set:e=>{wt=e}},rejectionMapper:{get:()=>rn,set:e=>{rn=e}},follow:(e,t)=>new x((r,n)=>be((s,i)=>{var o=C;o.unhandleds=[],o.onunhandled=i,o.finalize=Me(function(){(function(c){function a(){c(),Yt.splice(Yt.indexOf(a),1)}Yt.push(a),++Be,wt(()=>{--Be==0&&Bn()},[])})(()=>{this.unhandleds.length===0?s():i(this.unhandleds[0])})},o.finalize),e()},t,r,n))}),Ht&&(Ht.allSettled&&le(x,"allSettled",function(){const e=ae.apply(null,arguments).map(Ft);return new x(t=>{e.length===0&&t([]);let r=e.length;const n=new Array(r);e.forEach((s,i)=>x.resolve(s).then(o=>n[i]={status:"fulfilled",value:o},o=>n[i]={status:"rejected",reason:o}).then(()=>--r||t(n)))})}),Ht.any&&typeof AggregateError<"u"&&le(x,"any",function(){const e=ae.apply(null,arguments).map(Ft);return new x((t,r)=>{e.length===0&&r(new AggregateError([]));let n=e.length;const s=new Array(n);e.forEach((i,o)=>x.resolve(i).then(c=>t(c),c=>{s[o]=c,--n||r(new AggregateError(s))}))})}));const W={awaits:0,echoes:0,id:0};var Gc=0,Qt=[],Ar=0,lr=0,Rc=0;function be(e,t,r,n){var s=C,i=Object.create(s);i.parent=s,i.ref=0,i.global=!1,i.id=++Rc;var o=Ze.env;i.env=Gn?{Promise:x,PromiseProp:{value:x,configurable:!0,writable:!0},all:x.all,race:x.race,allSettled:x.allSettled,any:x.any,resolve:x.resolve,reject:x.reject,nthen:vs(o.nthen,i),gthen:vs(o.gthen,i)}:{},t&&H(i,t),++s.ref,i.finalize=function(){--this.parent.ref||this.parent.finalize()};var c=ot(i,e,r,n);return i.ref===0&&i.finalize(),c}function it(){return W.id||(W.id=++Gc),++W.awaits,W.echoes+=100,W.id}function fe(){return!!W.awaits&&(--W.awaits==0&&(W.id=0),W.echoes=100*W.awaits,!0)}function Ft(e){return W.echoes&&e&&e.constructor===Ht?(it(),e.then(t=>(fe(),t),t=>(fe(),q(t)))):e}function Bc(e){++lr,W.echoes&&--W.echoes!=0||(W.echoes=W.id=0),Qt.push(C),we(e,!0)}function Fc(){var e=Qt[Qt.length-1];Qt.pop(),we(e,!1)}function we(e,t){var r=C;if((t?!W.echoes||Ar++&&e===C:!Ar||--Ar&&e===C)||mi(t?Bc.bind(null,e):Fc),e!==C&&(C=e,r===Ze&&(Ze.env=yi()),Gn)){var n=Ze.env.Promise,s=e.env;ar.then=s.nthen,n.prototype.then=s.gthen,(r.global||e.global)&&(Object.defineProperty(G,"Promise",s.PromiseProp),n.all=s.all,n.race=s.race,n.resolve=s.resolve,n.reject=s.reject,s.allSettled&&(n.allSettled=s.allSettled),s.any&&(n.any=s.any))}}function yi(){var e=G.Promise;return Gn?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(G,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:ar.then,gthen:e.prototype.then}:{}}function ot(e,t,r,n,s){var i=C;try{return we(e,!0),t(r,n,s)}finally{we(i,!1)}}function mi(e){ui.call(Yr,e)}function ur(e,t,r,n){return typeof e!="function"?e:function(){var s=C;r&&it(),we(t,!0);try{return e.apply(this,arguments)}finally{we(s,!1),n&&mi(fe)}}}function vs(e,t){return function(r,n){return e.call(this,ur(r,t),ur(n,t))}}(""+ui).indexOf("[native code]")===-1&&(it=fe=L);function bs(e,t){var r;try{r=t.onuncatched(e)}catch{}if(r!==!1)try{var n,s={promise:t,reason:e};if(G.document&&document.createEvent?((n=document.createEvent("Event")).initEvent("unhandledrejection",!0,!0),H(n,s)):G.CustomEvent&&H(n=new CustomEvent("unhandledrejection",{detail:s}),s),n&&G.dispatchEvent&&(dispatchEvent(n),!G.PromiseRejectionEvent&&G.onunhandledrejection))try{G.onunhandledrejection(n)}catch{}se&&n&&!n.defaultPrevented&&console.warn(`Unhandled rejection: ${e.stack||e}`)}catch{}}var q=x.reject;function on(e,t,r,n){if(e.idbdb&&(e._state.openComplete||C.letThrough||e._vip)){var s=e._createTransaction(t,r,e._dbSchema);try{s.create(),e._state.PR1398_maxLoop=3}catch(i){return i.name===Ln.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(()=>on(e,t,r,n))):q(i)}return s._promise(t,(i,o)=>be(()=>(C.trans=s,n(i,o,s)))).then(i=>s._completion.then(()=>i))}if(e._state.openComplete)return q(new O.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return q(new O.DatabaseClosed);e.open().catch(L)}return e._state.dbReadyPromise.then(()=>on(e,t,r,n))}const Le=String.fromCharCode(65535),ie="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",_t=[],yr=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Kc=yr,Mc=yr,vi=e=>!/(dexie\.js|dexie\.min\.js)/.test(e);function Ue(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}const bi={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Kt(e){return typeof e!="string"||/\./.test(e)?t=>t:t=>(t[e]===void 0&&e in t&&delete(t=Pt(t))[e],t)}class Uc{_trans(t,r,n){const s=this._tx||C.trans,i=this.name;function o(a,l,u){if(!u.schema[i])throw new O.NotFound("Table "+i+" not part of transaction");return r(u.idbtrans,u)}const c=Lt();try{return s&&s.db===this.db?s===C.trans?s._promise(t,o,n):be(()=>s._promise(t,o,n),{trans:s,transless:C.transless||C}):on(this.db,t,[this.name],o)}finally{c&&$t()}}get(t,r){return t&&t.constructor===Object?this.where(t).first(r):this._trans("readonly",n=>this.core.get({trans:n,key:t}).then(s=>this.hook.reading.fire(s))).then(r)}where(t){if(typeof t=="string")return new this.db.WhereClause(this,t);if(V(t))return new this.db.WhereClause(this,`[${t.join("+")}]`);const r=M(t);if(r.length===1)return this.where(r[0]).equals(t[r[0]]);const n=this.schema.indexes.concat(this.schema.primKey).filter(l=>l.compound&&r.every(u=>l.keyPath.indexOf(u)>=0)&&l.keyPath.every(u=>r.indexOf(u)>=0))[0];if(n&&this.db._maxKey!==Le)return this.where(n.name).equals(n.keyPath.map(l=>t[l]));!n&&se&&console.warn(`The query ${JSON.stringify(t)} on ${this.name} would benefit of a compound index [${r.join("+")}]`);const{idxByName:s}=this.schema,i=this.db._deps.indexedDB;function o(l,u){try{return i.cmp(l,u)===0}catch{return!1}}const[c,a]=r.reduce(([l,u],f)=>{const d=s[f],h=t[f];return[l||d,l||!d?Ue(u,d&&d.multi?g=>{const p=ue(g,f);return V(p)&&p.some(y=>o(h,y))}:g=>o(h,ue(g,f))):u]},[null,null]);return c?this.where(c.name).equals(t[c.keyPath]).filter(a):n?this.filter(a):this.where(r).equals("")}filter(t){return this.toCollection().and(t)}count(t){return this.toCollection().count(t)}offset(t){return this.toCollection().offset(t)}limit(t){return this.toCollection().limit(t)}each(t){return this.toCollection().each(t)}toArray(t){return this.toCollection().toArray(t)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(t){return new this.db.Collection(new this.db.WhereClause(this,V(t)?`[${t.join("+")}]`:t))}reverse(){return this.toCollection().reverse()}mapToClass(t){this.schema.mappedClass=t;const r=n=>{if(!n)return n;const s=Object.create(t.prototype);for(var i in n)if(Z(n,i))try{s[i]=n[i]}catch{}return s};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=r,this.hook("reading",r),t}defineClass(){return this.mapToClass(function(t){H(this,t)})}add(t,r){const{auto:n,keyPath:s}=this.schema.primKey;let i=t;return s&&n&&(i=Kt(s)(t)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"add",keys:r!=null?[r]:null,values:[i]})).then(o=>o.numFailures?x.reject(o.failures[0]):o.lastResult).then(o=>{if(s)try{te(t,s,o)}catch{}return o})}update(t,r){if(typeof t!="object"||V(t))return this.where(":id").equals(t).modify(r);{const n=ue(t,this.schema.primKey.keyPath);if(n===void 0)return q(new O.InvalidArgument("Given object does not contain its primary key"));try{typeof r!="function"?M(r).forEach(s=>{te(t,s,r[s])}):r(t,{value:t,primKey:n})}catch{}return this.where(":id").equals(n).modify(r)}}put(t,r){const{auto:n,keyPath:s}=this.schema.primKey;let i=t;return s&&n&&(i=Kt(s)(t)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"put",values:[i],keys:r!=null?[r]:null})).then(o=>o.numFailures?x.reject(o.failures[0]):o.lastResult).then(o=>{if(s)try{te(t,s,o)}catch{}return o})}delete(t){return this._trans("readwrite",r=>this.core.mutate({trans:r,type:"delete",keys:[t]})).then(r=>r.numFailures?x.reject(r.failures[0]):void 0)}clear(){return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"deleteRange",range:bi})).then(t=>t.numFailures?x.reject(t.failures[0]):void 0)}bulkGet(t){return this._trans("readonly",r=>this.core.getMany({keys:t,trans:r}).then(n=>n.map(s=>this.hook.reading.fire(s))))}bulkAdd(t,r,n){const s=Array.isArray(r)?r:void 0,i=(n=n||(s?void 0:r))?n.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&s)throw new O.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(s&&s.length!==t.length)throw new O.InvalidArgument("Arguments objects and keys must have the same length");const l=t.length;let u=a&&c?t.map(Kt(a)):t;return this.core.mutate({trans:o,type:"add",keys:s,values:u,wantResults:i}).then(({numFailures:f,results:d,lastResult:h,failures:g})=>{if(f===0)return i?d:h;throw new bt(`${this.name}.bulkAdd(): ${f} of ${l} operations failed`,g)})})}bulkPut(t,r,n){const s=Array.isArray(r)?r:void 0,i=(n=n||(s?void 0:r))?n.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&s)throw new O.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(s&&s.length!==t.length)throw new O.InvalidArgument("Arguments objects and keys must have the same length");const l=t.length;let u=a&&c?t.map(Kt(a)):t;return this.core.mutate({trans:o,type:"put",keys:s,values:u,wantResults:i}).then(({numFailures:f,results:d,lastResult:h,failures:g})=>{if(f===0)return i?d:h;throw new bt(`${this.name}.bulkPut(): ${f} of ${l} operations failed`,g)})})}bulkDelete(t){const r=t.length;return this._trans("readwrite",n=>this.core.mutate({trans:n,type:"delete",keys:t})).then(({numFailures:n,lastResult:s,failures:i})=>{if(n===0)return s;throw new bt(`${this.name}.bulkDelete(): ${n} of ${r} operations failed`,i)})}}function Et(e){var t={},r=function(c,a){if(a){for(var l=arguments.length,u=new Array(l-1);--l;)u[l-1]=arguments[l];return t[c].subscribe.apply(null,u),e}if(typeof c=="string")return t[c]};r.addEventType=i;for(var n=1,s=arguments.length;n<s;++n)i(arguments[n]);return r;function i(c,a,l){if(typeof c=="object")return o(c);a||(a=Pc),l||(l=L);var u={subscribers:[],fire:l,subscribe:function(f){u.subscribers.indexOf(f)===-1&&(u.subscribers.push(f),u.fire=a(u.fire,f))},unsubscribe:function(f){u.subscribers=u.subscribers.filter(function(d){return d!==f}),u.fire=u.subscribers.reduce(a,l)}};return t[c]=r[c]=u,u}function o(c){M(c).forEach(function(a){var l=c[a];if(V(l))i(a,c[a][0],c[a][1]);else{if(l!=="asap")throw new O.InvalidArgument("Invalid event config");var u=i(a,Ct,function(){for(var f=arguments.length,d=new Array(f);f--;)d[f]=arguments[f];u.subscribers.forEach(function(h){ti(function(){h.apply(null,d)})})})}})}}function ft(e,t){return Ye(t).from({prototype:e}),t}function Ve(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Pr(e,t){e.filter=Ue(e.filter,t)}function Lr(e,t,r){var n=e.replayFilter;e.replayFilter=n?()=>Ue(n(),t()):t,e.justLimit=r&&!n}function Zt(e,t){if(e.isPrimKey)return t.primaryKey;const r=t.getIndexByKeyPath(e.index);if(!r)throw new O.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return r}function ws(e,t,r){const n=Zt(e,t.schema);return t.openCursor({trans:r,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:n,range:e.range}})}function Mt(e,t,r,n){const s=e.replayFilter?Ue(e.filter,e.replayFilter()):e.filter;if(e.or){const i={},o=(c,a,l)=>{if(!s||s(a,l,d=>a.stop(d),d=>a.fail(d))){var u=a.primaryKey,f=""+u;f==="[object ArrayBuffer]"&&(f=""+new Uint8Array(u)),Z(i,f)||(i[f]=!0,t(c,a,l))}};return Promise.all([e.or._iterate(o,r),_s(ws(e,n,r),e.algorithm,o,!e.keysOnly&&e.valueMapper)])}return _s(ws(e,n,r),Ue(e.algorithm,s),t,!e.keysOnly&&e.valueMapper)}function _s(e,t,r,n){var s=B(n?(i,o,c)=>r(n(i),o,c):r);return e.then(i=>{if(i)return i.start(()=>{var o=()=>i.continue();t&&!t(i,c=>o=c,c=>{i.stop(c),o=L},c=>{i.fail(c),o=L})||s(i.value,i,c=>o=c),o()})})}function J(e,t){try{const r=Es(e),n=Es(t);if(r!==n)return r==="Array"?1:n==="Array"?-1:r==="binary"?1:n==="binary"?-1:r==="string"?1:n==="string"?-1:r==="Date"?1:n!=="Date"?NaN:-1;switch(r){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return function(s,i){const o=s.length,c=i.length,a=o<c?o:c;for(let l=0;l<a;++l)if(s[l]!==i[l])return s[l]<i[l]?-1:1;return o===c?0:o<c?-1:1}(ks(e),ks(t));case"Array":return function(s,i){const o=s.length,c=i.length,a=o<c?o:c;for(let l=0;l<a;++l){const u=J(s[l],i[l]);if(u!==0)return u}return o===c?0:o<c?-1:1}(e,t)}}catch{}return NaN}function Es(e){const t=typeof e;if(t!=="object")return t;if(ArrayBuffer.isView(e))return"binary";const r=Jr(e);return r==="ArrayBuffer"?"binary":r}function ks(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}class zc{_read(t,r){var n=this._ctx;return n.error?n.table._trans(null,q.bind(null,n.error)):n.table._trans("readonly",t).then(r)}_write(t){var r=this._ctx;return r.error?r.table._trans(null,q.bind(null,r.error)):r.table._trans("readwrite",t,"locked")}_addAlgorithm(t){var r=this._ctx;r.algorithm=Ue(r.algorithm,t)}_iterate(t,r){return Mt(this._ctx,t,r,this._ctx.table.core)}clone(t){var r=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return t&&H(n,t),r._ctx=n,r}raw(){return this._ctx.valueMapper=null,this}each(t){var r=this._ctx;return this._read(n=>Mt(r,t,n,r.table.core))}count(t){return this._read(r=>{const n=this._ctx,s=n.table.core;if(Ve(n,!0))return s.count({trans:r,query:{index:Zt(n,s.schema),range:n.range}}).then(o=>Math.min(o,n.limit));var i=0;return Mt(n,()=>(++i,!1),r,s).then(()=>i)}).then(t)}sortBy(t,r){const n=t.split(".").reverse(),s=n[0],i=n.length-1;function o(l,u){return u?o(l[n[u]],u-1):l[s]}var c=this._ctx.dir==="next"?1:-1;function a(l,u){var f=o(l,i),d=o(u,i);return f<d?-c:f>d?c:0}return this.toArray(function(l){return l.sort(a)}).then(r)}toArray(t){return this._read(r=>{var n=this._ctx;if(n.dir==="next"&&Ve(n,!0)&&n.limit>0){const{valueMapper:s}=n,i=Zt(n,n.table.core.schema);return n.table.core.query({trans:r,limit:n.limit,values:!0,query:{index:i,range:n.range}}).then(({result:o})=>s?o.map(s):o)}{const s=[];return Mt(n,i=>s.push(i),r,n.table.core).then(()=>s)}},t)}offset(t){var r=this._ctx;return t<=0||(r.offset+=t,Ve(r)?Lr(r,()=>{var n=t;return(s,i)=>n===0||(n===1?(--n,!1):(i(()=>{s.advance(n),n=0}),!1))}):Lr(r,()=>{var n=t;return()=>--n<0})),this}limit(t){return this._ctx.limit=Math.min(this._ctx.limit,t),Lr(this._ctx,()=>{var r=t;return function(n,s,i){return--r<=0&&s(i),r>=0}},!0),this}until(t,r){return Pr(this._ctx,function(n,s,i){return!t(n.value)||(s(i),r)}),this}first(t){return this.limit(1).toArray(function(r){return r[0]}).then(t)}last(t){return this.reverse().first(t)}filter(t){var r,n;return Pr(this._ctx,function(s){return t(s.value)}),r=this._ctx,n=t,r.isMatch=Ue(r.isMatch,n),this}and(t){return this.filter(t)}or(t){return new this.db.WhereClause(this._ctx.table,t,this)}reverse(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(t){var r=this._ctx;return r.keysOnly=!r.isMatch,this.each(function(n,s){t(s.key,s)})}eachUniqueKey(t){return this._ctx.unique="unique",this.eachKey(t)}eachPrimaryKey(t){var r=this._ctx;return r.keysOnly=!r.isMatch,this.each(function(n,s){t(s.primaryKey,s)})}keys(t){var r=this._ctx;r.keysOnly=!r.isMatch;var n=[];return this.each(function(s,i){n.push(i.key)}).then(function(){return n}).then(t)}primaryKeys(t){var r=this._ctx;if(r.dir==="next"&&Ve(r,!0)&&r.limit>0)return this._read(s=>{var i=Zt(r,r.table.core.schema);return r.table.core.query({trans:s,values:!1,limit:r.limit,query:{index:i,range:r.range}})}).then(({result:s})=>s).then(t);r.keysOnly=!r.isMatch;var n=[];return this.each(function(s,i){n.push(i.primaryKey)}).then(function(){return n}).then(t)}uniqueKeys(t){return this._ctx.unique="unique",this.keys(t)}firstKey(t){return this.limit(1).keys(function(r){return r[0]}).then(t)}lastKey(t){return this.reverse().firstKey(t)}distinct(){var t=this._ctx,r=t.index&&t.table.schema.idxByName[t.index];if(!r||!r.multi)return this;var n={};return Pr(this._ctx,function(s){var i=s.primaryKey.toString(),o=Z(n,i);return n[i]=!0,!o}),this}modify(t){var r=this._ctx;return this._write(n=>{var s;if(typeof t=="function")s=t;else{var i=M(t),o=i.length;s=function(p){for(var y=!1,m=0;m<o;++m){var v=i[m],w=t[v];ue(p,v)!==w&&(te(p,v,w),y=!0)}return y}}const c=r.table.core,{outbound:a,extractKey:l}=c.schema.primaryKey,u=this.db._options.modifyChunkSize||200,f=[];let d=0;const h=[],g=(p,y)=>{const{failures:m,numFailures:v}=y;d+=p-v;for(let w of M(m))f.push(m[w])};return this.clone().primaryKeys().then(p=>{const y=m=>{const v=Math.min(u,p.length-m);return c.getMany({trans:n,keys:p.slice(m,m+v),cache:"immutable"}).then(w=>{const k=[],_=[],E=a?[]:null,I=[];for(let S=0;S<v;++S){const P=w[S],A={value:Pt(P),primKey:p[m+S]};s.call(A,A.value,A)!==!1&&(A.value==null?I.push(p[m+S]):a||J(l(P),l(A.value))===0?(_.push(A.value),a&&E.push(p[m+S])):(I.push(p[m+S]),k.push(A.value)))}const T=Ve(r)&&r.limit===1/0&&(typeof t!="function"||t===$r)&&{index:r.index,range:r.range};return Promise.resolve(k.length>0&&c.mutate({trans:n,type:"add",values:k}).then(S=>{for(let P in S.failures)I.splice(parseInt(P),1);g(k.length,S)})).then(()=>(_.length>0||T&&typeof t=="object")&&c.mutate({trans:n,type:"put",keys:E,values:_,criteria:T,changeSpec:typeof t!="function"&&t}).then(S=>g(_.length,S))).then(()=>(I.length>0||T&&t===$r)&&c.mutate({trans:n,type:"delete",keys:I,criteria:T}).then(S=>g(I.length,S))).then(()=>p.length>m+v&&y(m+u))})};return y(0).then(()=>{if(f.length>0)throw new or("Error modifying one or more objects",f,d,h);return p.length})})})}delete(){var t=this._ctx,r=t.range;return Ve(t)&&(t.isPrimKey&&!Mc||r.type===3)?this._write(n=>{const{primaryKey:s}=t.table.core.schema,i=r;return t.table.core.count({trans:n,query:{index:s,range:i}}).then(o=>t.table.core.mutate({trans:n,type:"deleteRange",range:i}).then(({failures:c,lastResult:a,results:l,numFailures:u})=>{if(u)throw new or("Could not delete some values",Object.keys(c).map(f=>c[f]),o-u);return o-u}))}):this.modify($r)}}const $r=(e,t)=>t.value=null;function qc(e,t){return e<t?-1:e===t?0:1}function jc(e,t){return e>t?-1:e===t?0:1}function Q(e,t,r){var n=e instanceof _i?new e.Collection(e):e;return n._ctx.error=r?new r(t):new TypeError(t),n}function De(e){return new e.Collection(e,()=>wi("")).limit(0)}function Wc(e,t,r,n,s,i){for(var o=Math.min(e.length,n.length),c=-1,a=0;a<o;++a){var l=t[a];if(l!==n[a])return s(e[a],r[a])<0?e.substr(0,a)+r[a]+r.substr(a+1):s(e[a],n[a])<0?e.substr(0,a)+n[a]+r.substr(a+1):c>=0?e.substr(0,c)+t[c]+r.substr(c+1):null;s(e[a],l)<0&&(c=a)}return o<n.length&&i==="next"?e+r.substr(e.length):o<e.length&&i==="prev"?e.substr(0,r.length):c<0?null:e.substr(0,c)+n[c]+r.substr(c+1)}function Ut(e,t,r,n){var s,i,o,c,a,l,u,f=r.length;if(!r.every(p=>typeof p=="string"))return Q(e,"String expected.");function d(p){s=function(m){return m==="next"?v=>v.toUpperCase():v=>v.toLowerCase()}(p),i=function(m){return m==="next"?v=>v.toLowerCase():v=>v.toUpperCase()}(p),o=p==="next"?qc:jc;var y=r.map(function(m){return{lower:i(m),upper:s(m)}}).sort(function(m,v){return o(m.lower,v.lower)});c=y.map(function(m){return m.upper}),a=y.map(function(m){return m.lower}),l=p,u=p==="next"?"":n}d("next");var h=new e.Collection(e,()=>ge(c[0],a[f-1]+n));h._ondirectionchange=function(p){d(p)};var g=0;return h._addAlgorithm(function(p,y,m){var v=p.key;if(typeof v!="string")return!1;var w=i(v);if(t(w,a,g))return!0;for(var k=null,_=g;_<f;++_){var E=Wc(v,w,c[_],a[_],o,l);E===null&&k===null?g=_+1:(k===null||o(k,E)>0)&&(k=E)}return y(k!==null?function(){p.continue(k+u)}:m),!1}),h}function ge(e,t,r,n){return{type:2,lower:e,upper:t,lowerOpen:r,upperOpen:n}}function wi(e){return{type:1,lower:e,upper:e}}class _i{get Collection(){return this._ctx.table.db.Collection}between(t,r,n,s){n=n!==!1,s=s===!0;try{return this._cmp(t,r)>0||this._cmp(t,r)===0&&(n||s)&&(!n||!s)?De(this):new this.Collection(this,()=>ge(t,r,!n,!s))}catch{return Q(this,ie)}}equals(t){return t==null?Q(this,ie):new this.Collection(this,()=>wi(t))}above(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(t,void 0,!0))}aboveOrEqual(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(t,void 0,!1))}below(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(void 0,t,!1,!0))}belowOrEqual(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(void 0,t))}startsWith(t){return typeof t!="string"?Q(this,"String expected."):this.between(t,t+Le,!0,!0)}startsWithIgnoreCase(t){return t===""?this.startsWith(t):Ut(this,(r,n)=>r.indexOf(n[0])===0,[t],Le)}equalsIgnoreCase(t){return Ut(this,(r,n)=>r===n[0],[t],"")}anyOfIgnoreCase(){var t=ae.apply(He,arguments);return t.length===0?De(this):Ut(this,(r,n)=>n.indexOf(r)!==-1,t,"")}startsWithAnyOfIgnoreCase(){var t=ae.apply(He,arguments);return t.length===0?De(this):Ut(this,(r,n)=>n.some(s=>r.indexOf(s)===0),t,Le)}anyOf(){const t=ae.apply(He,arguments);let r=this._cmp;try{t.sort(r)}catch{return Q(this,ie)}if(t.length===0)return De(this);const n=new this.Collection(this,()=>ge(t[0],t[t.length-1]));n._ondirectionchange=i=>{r=i==="next"?this._ascending:this._descending,t.sort(r)};let s=0;return n._addAlgorithm((i,o,c)=>{const a=i.key;for(;r(a,t[s])>0;)if(++s,s===t.length)return o(c),!1;return r(a,t[s])===0||(o(()=>{i.continue(t[s])}),!1)}),n}notEqual(t){return this.inAnyRange([[-(1/0),t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const t=ae.apply(He,arguments);if(t.length===0)return new this.Collection(this);try{t.sort(this._ascending)}catch{return Q(this,ie)}const r=t.reduce((n,s)=>n?n.concat([[n[n.length-1][1],s]]):[[-(1/0),s]],null);return r.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(r,{includeLowers:!1,includeUppers:!1})}inAnyRange(t,r){const n=this._cmp,s=this._ascending,i=this._descending,o=this._min,c=this._max;if(t.length===0)return De(this);if(!t.every(v=>v[0]!==void 0&&v[1]!==void 0&&s(v[0],v[1])<=0))return Q(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",O.InvalidArgument);const a=!r||r.includeLowers!==!1,l=r&&r.includeUppers===!0;let u,f=s;function d(v,w){return f(v[0],w[0])}try{u=t.reduce(function(v,w){let k=0,_=v.length;for(;k<_;++k){const E=v[k];if(n(w[0],E[1])<0&&n(w[1],E[0])>0){E[0]=o(E[0],w[0]),E[1]=c(E[1],w[1]);break}}return k===_&&v.push(w),v},[]),u.sort(d)}catch{return Q(this,ie)}let h=0;const g=l?v=>s(v,u[h][1])>0:v=>s(v,u[h][1])>=0,p=a?v=>i(v,u[h][0])>0:v=>i(v,u[h][0])>=0;let y=g;const m=new this.Collection(this,()=>ge(u[0][0],u[u.length-1][1],!a,!l));return m._ondirectionchange=v=>{v==="next"?(y=g,f=s):(y=p,f=i),u.sort(d)},m._addAlgorithm((v,w,k)=>{for(var _=v.key;y(_);)if(++h,h===u.length)return w(k),!1;return!!function(E){return!g(E)&&!p(E)}(_)||(this._cmp(_,u[h][1])===0||this._cmp(_,u[h][0])===0||w(()=>{f===s?v.continue(u[h][0]):v.continue(u[h][1])}),!1)}),m}startsWithAnyOf(){const t=ae.apply(He,arguments);return t.every(r=>typeof r=="string")?t.length===0?De(this):this.inAnyRange(t.map(r=>[r,r+Le])):Q(this,"startsWithAnyOf() only works with strings")}}function ne(e){return B(function(t){return Ot(t),e(t.target.error),!1})}function Ot(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}const _e=Et(null,"storagemutated");class Vc{_lock(){return dt(!C.global),++this._reculock,this._reculock!==1||C.global||(C.lockOwnerFor=this),this}_unlock(){if(dt(!C.global),--this._reculock==0)for(C.global||(C.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{ot(t[1],t[0])}catch{}}return this}_locked(){return this._reculock&&C.lockOwnerFor!==this}create(t){if(!this.mode)return this;const r=this.db.idbdb,n=this.db._state.dbOpenError;if(dt(!this.idbtrans),!t&&!r)switch(n&&n.name){case"DatabaseClosedError":throw new O.DatabaseClosed(n);case"MissingAPIError":throw new O.MissingAPI(n.message,n);default:throw new O.OpenFailed(n)}if(!this.active)throw new O.TransactionInactive;return dt(this._completion._state===null),(t=this.idbtrans=t||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=B(s=>{Ot(s),this._reject(t.error)}),t.onabort=B(s=>{Ot(s),this.active&&this._reject(new O.Abort(t.error)),this.active=!1,this.on("abort").fire(s)}),t.oncomplete=B(()=>{this.active=!1,this._resolve(),"mutatedParts"in t&&_e.storagemutated.fire(t.mutatedParts)}),this}_promise(t,r,n){if(t==="readwrite"&&this.mode!=="readwrite")return q(new O.ReadOnly("Transaction is readonly"));if(!this.active)return q(new O.TransactionInactive);if(this._locked())return new x((i,o)=>{this._blockedFuncs.push([()=>{this._promise(t,r,n).then(i,o)},C])});if(n)return be(()=>{var i=new x((o,c)=>{this._lock();const a=r(o,c,this);a&&a.then&&a.then(o,c)});return i.finally(()=>this._unlock()),i._lib=!0,i});var s=new x((i,o)=>{var c=r(i,o,this);c&&c.then&&c.then(i,o)});return s._lib=!0,s}_root(){return this.parent?this.parent._root():this}waitFor(t){var r=this._root();const n=x.resolve(t);if(r._waitingFor)r._waitingFor=r._waitingFor.then(()=>n);else{r._waitingFor=n,r._waitingQueue=[];var s=r.idbtrans.objectStore(r.storeNames[0]);(function o(){for(++r._spinCount;r._waitingQueue.length;)r._waitingQueue.shift()();r._waitingFor&&(s.get(-1/0).onsuccess=o)})()}var i=r._waitingFor;return new x((o,c)=>{n.then(a=>r._waitingQueue.push(B(o.bind(null,a))),a=>r._waitingQueue.push(B(c.bind(null,a)))).finally(()=>{r._waitingFor===i&&(r._waitingFor=null)})})}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new O.Abort))}table(t){const r=this._memoizedTables||(this._memoizedTables={});if(Z(r,t))return r[t];const n=this.schema[t];if(!n)throw new O.NotFound("Table "+t+" not part of transaction");const s=new this.db.Table(t,n,this);return s.core=this.db.core.table(t),r[t]=s,s}}function an(e,t,r,n,s,i,o){return{name:e,keyPath:t,unique:r,multi:n,auto:s,compound:i,src:(r&&!o?"&":"")+(n?"*":"")+(s?"++":"")+Ei(t)}}function Ei(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function ki(e,t,r){return{name:e,primKey:t,indexes:r,mappedClass:null,idxByName:ri(r,n=>[n.name,n])}}let Tt=e=>{try{return e.only([[]]),Tt=()=>[[]],[[]]}catch{return Tt=()=>Le,Le}};function cn(e){return e==null?()=>{}:typeof e=="string"?function(t){return t.split(".").length===1?r=>r[t]:r=>ue(r,t)}(e):t=>ue(t,e)}function Is(e){return[].slice.call(e)}let Dc=0;function kt(e){return e==null?":id":typeof e=="string"?e:`[${e.join("+")}]`}function Jc(e,t,r){function n(a){if(a.type===3)return null;if(a.type===4)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:l,upper:u,lowerOpen:f,upperOpen:d}=a;return l===void 0?u===void 0?null:t.upperBound(u,!!d):u===void 0?t.lowerBound(l,!!f):t.bound(l,u,!!f,!!d)}const{schema:s,hasGetAll:i}=function(a,l){const u=Is(a.objectStoreNames);return{schema:{name:a.name,tables:u.map(f=>l.objectStore(f)).map(f=>{const{keyPath:d,autoIncrement:h}=f,g=V(d),p=d==null,y={},m={name:f.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:p,compound:g,keyPath:d,autoIncrement:h,unique:!0,extractKey:cn(d)},indexes:Is(f.indexNames).map(v=>f.index(v)).map(v=>{const{name:w,unique:k,multiEntry:_,keyPath:E}=v,I={name:w,compound:V(E),keyPath:E,unique:k,multiEntry:_,extractKey:cn(E)};return y[kt(E)]=I,I}),getIndexByKeyPath:v=>y[kt(v)]};return y[":id"]=m.primaryKey,d!=null&&(y[kt(d)]=m.primaryKey),m})},hasGetAll:u.length>0&&"getAll"in l.objectStore(u[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(e,r),o=s.tables.map(a=>function(l){const u=l.name;return{name:u,schema:l,mutate:function({trans:f,type:d,keys:h,values:g,range:p}){return new Promise((y,m)=>{y=B(y);const v=f.objectStore(u),w=v.keyPath==null,k=d==="put"||d==="add";if(!k&&d!=="delete"&&d!=="deleteRange")throw new Error("Invalid operation type: "+d);const{length:_}=h||g||{length:1};if(h&&g&&h.length!==g.length)throw new Error("Given keys array must have same length as given values array.");if(_===0)return y({numFailures:0,failures:{},results:[],lastResult:void 0});let E;const I=[],T=[];let S=0;const P=U=>{++S,Ot(U)};if(d==="deleteRange"){if(p.type===4)return y({numFailures:S,failures:T,results:[],lastResult:void 0});p.type===3?I.push(E=v.clear()):I.push(E=v.delete(n(p)))}else{const[U,F]=k?w?[g,h]:[g,null]:[h,null];if(k)for(let $=0;$<_;++$)I.push(E=F&&F[$]!==void 0?v[d](U[$],F[$]):v[d](U[$])),E.onerror=P;else for(let $=0;$<_;++$)I.push(E=v[d](U[$])),E.onerror=P}const A=U=>{const F=U.target.result;I.forEach(($,de)=>$.error!=null&&(T[de]=$.error)),y({numFailures:S,failures:T,results:d==="delete"?h:I.map($=>$.result),lastResult:F})};E.onerror=U=>{P(U),A(U)},E.onsuccess=A})},getMany:({trans:f,keys:d})=>new Promise((h,g)=>{h=B(h);const p=f.objectStore(u),y=d.length,m=new Array(y);let v,w=0,k=0;const _=I=>{const T=I.target;m[T._pos]=T.result,++k===w&&h(m)},E=ne(g);for(let I=0;I<y;++I)d[I]!=null&&(v=p.get(d[I]),v._pos=I,v.onsuccess=_,v.onerror=E,++w);w===0&&h(m)}),get:({trans:f,key:d})=>new Promise((h,g)=>{h=B(h);const p=f.objectStore(u).get(d);p.onsuccess=y=>h(y.target.result),p.onerror=ne(g)}),query:function(f){return d=>new Promise((h,g)=>{h=B(h);const{trans:p,values:y,limit:m,query:v}=d,w=m===1/0?void 0:m,{index:k,range:_}=v,E=p.objectStore(u),I=k.isPrimaryKey?E:E.index(k.name),T=n(_);if(m===0)return h({result:[]});if(f){const S=y?I.getAll(T,w):I.getAllKeys(T,w);S.onsuccess=P=>h({result:P.target.result}),S.onerror=ne(g)}else{let S=0;const P=y||!("openKeyCursor"in I)?I.openCursor(T):I.openKeyCursor(T),A=[];P.onsuccess=U=>{const F=P.result;return F?(A.push(y?F.value:F.primaryKey),++S===m?h({result:A}):void F.continue()):h({result:A})},P.onerror=ne(g)}})}(i),openCursor:function({trans:f,values:d,query:h,reverse:g,unique:p}){return new Promise((y,m)=>{y=B(y);const{index:v,range:w}=h,k=f.objectStore(u),_=v.isPrimaryKey?k:k.index(v.name),E=g?p?"prevunique":"prev":p?"nextunique":"next",I=d||!("openKeyCursor"in _)?_.openCursor(n(w),E):_.openKeyCursor(n(w),E);I.onerror=ne(m),I.onsuccess=B(T=>{const S=I.result;if(!S)return void y(null);S.___id=++Dc,S.done=!1;const P=S.continue.bind(S);let A=S.continuePrimaryKey;A&&(A=A.bind(S));const U=S.advance.bind(S),F=()=>{throw new Error("Cursor not stopped")};S.trans=f,S.stop=S.continue=S.continuePrimaryKey=S.advance=()=>{throw new Error("Cursor not started")},S.fail=B(m),S.next=function(){let $=1;return this.start(()=>$--?this.continue():this.stop()).then(()=>this)},S.start=$=>{const de=new Promise((z,ke)=>{z=B(z),I.onerror=ne(ke),S.fail=ke,S.stop=at=>{S.stop=S.continue=S.continuePrimaryKey=S.advance=F,z(at)}}),re=()=>{if(I.result)try{$()}catch(z){S.fail(z)}else S.done=!0,S.start=()=>{throw new Error("Cursor behind last entry")},S.stop()};return I.onsuccess=B(z=>{I.onsuccess=re,re()}),S.continue=P,S.continuePrimaryKey=A,S.advance=U,re(),de},y(S)},m)})},count({query:f,trans:d}){const{index:h,range:g}=f;return new Promise((p,y)=>{const m=d.objectStore(u),v=h.isPrimaryKey?m:m.index(h.name),w=n(g),k=w?v.count(w):v.count();k.onsuccess=B(_=>p(_.target.result)),k.onerror=ne(y)})}}}(a)),c={};return o.forEach(a=>c[a.name]=a),{stack:"dbcore",transaction:e.transaction.bind(e),table(a){if(!c[a])throw new Error(`Table '${a}' not found`);return c[a]},MIN_KEY:-1/0,MAX_KEY:Tt(t),schema:s}}function ln({_novip:e},t){const r=t.db,n=function(s,i,{IDBKeyRange:o,indexedDB:c},a){return{dbcore:function(u,f){return f.reduce((d,{create:h})=>({...d,...h(d)}),u)}(Jc(i,o,a),s.dbcore)}}(e._middlewares,r,e._deps,t);e.core=n.dbcore,e.tables.forEach(s=>{const i=s.name;e.core.schema.tables.some(o=>o.name===i)&&(s.core=e.core.table(i),e[i]instanceof e.Table&&(e[i].core=s.core))})}function fr({_novip:e},t,r,n){r.forEach(s=>{const i=n[s];t.forEach(o=>{const c=Tn(o,s);(!c||"value"in c&&c.value===void 0)&&(o===e.Transaction.prototype||o instanceof e.Transaction?le(o,s,{get(){return this.table(s)},set(a){Zs(this,s,{value:a,writable:!0,configurable:!0,enumerable:!0})}}):o[s]=new e.Table(s,i))})})}function un({_novip:e},t){t.forEach(r=>{for(let n in r)r[n]instanceof e.Table&&delete r[n]})}function Hc(e,t){return e._cfg.version-t._cfg.version}function Xc(e,t,r,n){const s=e._dbSchema,i=e._createTransaction("readwrite",e._storeNames,s);i.create(r),i._completion.catch(n);const o=i._reject.bind(i),c=C.transless||C;be(()=>{C.trans=i,C.transless=c,t===0?(M(s).forEach(a=>{Gr(r,a,s[a].primKey,s[a].indexes)}),ln(e,r),x.follow(()=>e.on.populate.fire(i)).catch(o)):function({_novip:a},l,u,f){const d=[],h=a._versions;let g=a._dbSchema=dn(a,a.idbdb,f),p=!1;function y(){return d.length?x.resolve(d.shift()(u.idbtrans)).then(y):x.resolve()}return h.filter(m=>m._cfg.version>=l).forEach(m=>{d.push(()=>{const v=g,w=m._cfg.dbschema;hn(a,v,f),hn(a,w,f),g=a._dbSchema=w;const k=Ii(v,w);k.add.forEach(E=>{Gr(f,E[0],E[1].primKey,E[1].indexes)}),k.change.forEach(E=>{if(E.recreate)throw new O.Upgrade("Not yet support for changing primary key");{const I=f.objectStore(E.name);E.add.forEach(T=>fn(I,T)),E.change.forEach(T=>{I.deleteIndex(T.name),fn(I,T)}),E.del.forEach(T=>I.deleteIndex(T))}});const _=m._cfg.contentUpgrade;if(_&&m._cfg.version>l){ln(a,f),u._memoizedTables={},p=!0;let E=ni(w);k.del.forEach(P=>{E[P]=v[P]}),un(a,[a.Transaction.prototype]),fr(a,[a.Transaction.prototype],M(E),E),u.schema=E;const I=An(_);let T;I&&it();const S=x.follow(()=>{if(T=_(u),T&&I){var P=fe.bind(null,null);T.then(P,P)}});return T&&typeof T.then=="function"?x.resolve(T):S.then(()=>T)}}),d.push(v=>{(!p||!Kc)&&function(w,k){[].slice.call(k.db.objectStoreNames).forEach(_=>w[_]==null&&k.db.deleteObjectStore(_))}(m._cfg.dbschema,v),un(a,[a.Transaction.prototype]),fr(a,[a.Transaction.prototype],a._storeNames,a._dbSchema),u.schema=a._dbSchema})}),y().then(()=>{var m,v;v=f,M(m=g).forEach(w=>{v.db.objectStoreNames.contains(w)||Gr(v,w,m[w].primKey,m[w].indexes)})})}(e,t,i,r).catch(o)})}function Ii(e,t){const r={del:[],add:[],change:[]};let n;for(n in e)t[n]||r.del.push(n);for(n in t){const s=e[n],i=t[n];if(s){const o={name:n,def:i,recreate:!1,del:[],add:[],change:[]};if(""+(s.primKey.keyPath||"")!=""+(i.primKey.keyPath||"")||s.primKey.auto!==i.primKey.auto&&!yr)o.recreate=!0,r.change.push(o);else{const c=s.idxByName,a=i.idxByName;let l;for(l in c)a[l]||o.del.push(l);for(l in a){const u=c[l],f=a[l];u?u.src!==f.src&&o.change.push(f):o.add.push(f)}(o.del.length>0||o.add.length>0||o.change.length>0)&&r.change.push(o)}}else r.add.push([n,i])}return r}function Gr(e,t,r,n){const s=e.db.createObjectStore(t,r.keyPath?{keyPath:r.keyPath,autoIncrement:r.auto}:{autoIncrement:r.auto});return n.forEach(i=>fn(s,i)),s}function fn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function dn(e,t,r){const n={};return ir(t.objectStoreNames,0).forEach(s=>{const i=r.objectStore(s);let o=i.keyPath;const c=an(Ei(o),o||"",!1,!1,!!i.autoIncrement,o&&typeof o!="string",!0),a=[];for(let u=0;u<i.indexNames.length;++u){const f=i.index(i.indexNames[u]);o=f.keyPath;var l=an(f.name,o,!!f.unique,!!f.multiEntry,!1,o&&typeof o!="string",!1);a.push(l)}n[s]=ki(s,c,a)}),n}function hn({_novip:e},t,r){const n=r.db.objectStoreNames;for(let s=0;s<n.length;++s){const i=n[s],o=r.objectStore(i);e._hasGetAll="getAll"in o;for(let c=0;c<o.indexNames.length;++c){const a=o.indexNames[c],l=o.index(a).keyPath,u=typeof l=="string"?l:"["+ir(l).join("+")+"]";if(t[i]){const f=t[i].idxByName[u];f&&(f.name=a,delete t[i].idxByName[u],t[i].idxByName[a]=f)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&G.WorkerGlobalScope&&G instanceof G.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}class Yc{_parseStoresSpec(t,r){M(t).forEach(n=>{if(t[n]!==null){var s=t[n].split(",").map((o,c)=>{const a=(o=o.trim()).replace(/([&*]|\+\+)/g,""),l=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return an(a,l||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),V(l),c===0)}),i=s.shift();if(i.multi)throw new O.Schema("Primary key cannot be multi-valued");s.forEach(o=>{if(o.auto)throw new O.Schema("Only primary key can be marked as autoIncrement (++)");if(!o.keyPath)throw new O.Schema("Index must have a name and cannot be an empty string")}),r[n]=ki(n,i,s)}})}stores(t){const r=this.db;this._cfg.storesSource=this._cfg.storesSource?H(this._cfg.storesSource,t):t;const n=r._versions,s={};let i={};return n.forEach(o=>{H(s,o._cfg.storesSource),i=o._cfg.dbschema={},o._parseStoresSpec(s,i)}),r._dbSchema=i,un(r,[r._allTables,r,r.Transaction.prototype]),fr(r,[r._allTables,r,r.Transaction.prototype,this._cfg.tables],M(i),i),r._storeNames=M(i),this}upgrade(t){return this._cfg.contentUpgrade=$n(this._cfg.contentUpgrade||L,t),this}}function Fn(e,t){let r=e._dbNamesDB;return r||(r=e._dbNamesDB=new Fe("__dbnames",{addons:[],indexedDB:e,IDBKeyRange:t}),r.version(1).stores({dbnames:"name"})),r.table("dbnames")}function Kn(e){return e&&typeof e.databases=="function"}function pn(e){return be(function(){return C.letThrough=!0,e()})}function Qc(){var e;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(t){var r=function(){return indexedDB.databases().finally(t)};e=setInterval(r,100),r()}).finally(function(){return clearInterval(e)}):Promise.resolve()}function Zc(e){const t=e._state,{indexedDB:r}=e._deps;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(()=>t.dbOpenError?q(t.dbOpenError):e);se&&(t.openCanceller._stackHolder=ze()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;const n=t.openCanceller;function s(){if(t.openCanceller!==n)throw new O.DatabaseClosed("db.open() was cancelled")}let i=t.dbReadyResolve,o=null,c=!1;return x.race([n,(typeof navigator>"u"?x.resolve():Qc()).then(()=>new x((a,l)=>{if(s(),!r)throw new O.MissingAPI;const u=e.name,f=t.autoSchema?r.open(u):r.open(u,Math.round(10*e.verno));if(!f)throw new O.MissingAPI;f.onerror=ne(l),f.onblocked=B(e._fireOnBlocked),f.onupgradeneeded=B(d=>{if(o=f.transaction,t.autoSchema&&!e._options.allowEmptyDB){f.onerror=Ot,o.abort(),f.result.close();const g=r.deleteDatabase(u);g.onsuccess=g.onerror=B(()=>{l(new O.NoSuchDatabase(`Database ${u} doesnt exist`))})}else{o.onerror=ne(l);var h=d.oldVersion>Math.pow(2,62)?0:d.oldVersion;c=h<1,e._novip.idbdb=f.result,Xc(e,h/10,o,l)}},l),f.onsuccess=B(()=>{o=null;const d=e._novip.idbdb=f.result,h=ir(d.objectStoreNames);if(h.length>0)try{const p=d.transaction((g=h).length===1?g[0]:g,"readonly");t.autoSchema?function({_novip:y},m,v){y.verno=m.version/10;const w=y._dbSchema=dn(0,m,v);y._storeNames=ir(m.objectStoreNames,0),fr(y,[y._allTables],M(w),w)}(e,d,p):(hn(e,e._dbSchema,p),function(y,m){const v=Ii(dn(0,y.idbdb,m),y._dbSchema);return!(v.add.length||v.change.some(w=>w.add.length||w.change.length))}(e,p)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),ln(e,p)}catch{}var g;_t.push(e),d.onversionchange=B(p=>{t.vcFired=!0,e.on("versionchange").fire(p)}),d.onclose=B(p=>{e.on("close").fire(p)}),c&&function({indexedDB:p,IDBKeyRange:y},m){!Kn(p)&&m!=="__dbnames"&&Fn(p,y).put({name:m}).catch(L)}(e._deps,u),a()},l)}))]).then(()=>(s(),t.onReadyBeingFired=[],x.resolve(pn(()=>e.on.ready.fire(e.vip))).then(function a(){if(t.onReadyBeingFired.length>0){let l=t.onReadyBeingFired.reduce($n,L);return t.onReadyBeingFired=[],x.resolve(pn(()=>l(e.vip))).then(a)}}))).finally(()=>{t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(()=>e).catch(a=>{t.dbOpenError=a;try{o&&o.abort()}catch{}return n===t.openCanceller&&e._close(),q(a)}).finally(()=>{t.openComplete=!0,i()})}function gn(e){var t=i=>e.next(i),r=s(t),n=s(i=>e.throw(i));function s(i){return o=>{var c=i(o),a=c.value;return c.done?a:a&&typeof a.then=="function"?a.then(r,n):V(a)?Promise.all(a).then(r,n):r(a)}}return s(t)()}function el(e,t,r){var n=arguments.length;if(n<2)throw new O.InvalidArgument("Too few arguments");for(var s=new Array(n-1);--n;)s[n-1]=arguments[n];r=s.pop();var i=si(s);return[e,i,r]}function xi(e,t,r,n,s){return x.resolve().then(()=>{const i=C.transless||C,o=e._createTransaction(t,r,e._dbSchema,n),c={trans:o,transless:i};if(n)o.idbtrans=n.idbtrans;else try{o.create(),e._state.PR1398_maxLoop=3}catch(f){return f.name===Ln.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(()=>xi(e,t,r,null,s))):q(f)}const a=An(s);let l;a&&it();const u=x.follow(()=>{if(l=s.call(o,o),l)if(a){var f=fe.bind(null,null);l.then(f,f)}else typeof l.next=="function"&&typeof l.throw=="function"&&(l=gn(l))},c);return(l&&typeof l.then=="function"?x.resolve(l).then(f=>o.active?f:q(new O.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))):u.then(()=>l)).then(f=>(n&&o._resolve(),o._completion.then(()=>f))).catch(f=>(o._reject(f),q(f)))})}function zt(e,t,r){const n=V(e)?e.slice():[e];for(let s=0;s<r;++s)n.push(t);return n}const tl={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return{...e,table(t){const r=e.table(t),{schema:n}=r,s={},i=[];function o(u,f,d){const h=kt(u),g=s[h]=s[h]||[],p=u==null?0:typeof u=="string"?1:u.length,y=f>0,m={...d,isVirtual:y,keyTail:f,keyLength:p,extractKey:cn(u),unique:!y&&d.unique};return g.push(m),m.isPrimaryKey||i.push(m),p>1&&o(p===2?u[0]:u.slice(0,p-1),f+1,d),g.sort((v,w)=>v.keyTail-w.keyTail),m}const c=o(n.primaryKey.keyPath,0,n.primaryKey);s[":id"]=[c];for(const u of n.indexes)o(u.keyPath,0,u);function a(u){const f=u.query.index;return f.isVirtual?{...u,query:{index:f,range:(d=u.query.range,h=f.keyTail,{type:d.type===1?2:d.type,lower:zt(d.lower,d.lowerOpen?e.MAX_KEY:e.MIN_KEY,h),lowerOpen:!0,upper:zt(d.upper,d.upperOpen?e.MIN_KEY:e.MAX_KEY,h),upperOpen:!0})}}:u;var d,h}return{...r,schema:{...n,primaryKey:c,indexes:i,getIndexByKeyPath:function(u){const f=s[kt(u)];return f&&f[0]}},count:u=>r.count(a(u)),query:u=>r.query(a(u)),openCursor(u){const{keyTail:f,isVirtual:d,keyLength:h}=u.query.index;return d?r.openCursor(a(u)).then(g=>g&&function(p){return Object.create(p,{continue:{value:function(m){m!=null?p.continue(zt(m,u.reverse?e.MAX_KEY:e.MIN_KEY,f)):u.unique?p.continue(p.key.slice(0,h).concat(u.reverse?e.MIN_KEY:e.MAX_KEY,f)):p.continue()}},continuePrimaryKey:{value(m,v){p.continuePrimaryKey(zt(m,e.MAX_KEY,f),v)}},primaryKey:{get:()=>p.primaryKey},key:{get(){const m=p.key;return h===1?m[0]:m.slice(0,h)}},value:{get:()=>p.value}})}(g)):r.openCursor(u)}}}}}};function Mn(e,t,r,n){return r=r||{},n=n||"",M(e).forEach(s=>{if(Z(t,s)){var i=e[s],o=t[s];if(typeof i=="object"&&typeof o=="object"&&i&&o){const c=Jr(i);c!==Jr(o)?r[n+s]=t[s]:c==="Object"?Mn(i,o,r,n+s+"."):i!==o&&(r[n+s]=t[s])}else i!==o&&(r[n+s]=t[s])}else r[n+s]=void 0}),M(t).forEach(s=>{Z(e,s)||(r[n+s]=t[s])}),r}const rl={stack:"dbcore",name:"HooksMiddleware",level:2,create:e=>({...e,table(t){const r=e.table(t),{primaryKey:n}=r.schema;return{...r,mutate(i){const o=C.trans,{deleting:c,creating:a,updating:l}=o.table(t).hook;switch(i.type){case"add":if(a.fire===L)break;return o._promise("readwrite",()=>u(i),!0);case"put":if(a.fire===L&&l.fire===L)break;return o._promise("readwrite",()=>u(i),!0);case"delete":if(c.fire===L)break;return o._promise("readwrite",()=>u(i),!0);case"deleteRange":if(c.fire===L)break;return o._promise("readwrite",()=>function(d){return f(d.trans,d.range,1e4)}(i),!0)}return r.mutate(i);function u(d){const h=C.trans,g=d.keys||function(p,y){return y.type==="delete"?y.keys:y.keys||y.values.map(p.extractKey)}(n,d);if(!g)throw new Error("Keys missing");return(d=d.type==="add"||d.type==="put"?{...d,keys:g}:{...d}).type!=="delete"&&(d.values=[...d.values]),d.keys&&(d.keys=[...d.keys]),function(p,y,m){return y.type==="add"?Promise.resolve([]):p.getMany({trans:y.trans,keys:m,cache:"immutable"})}(r,d,g).then(p=>{const y=g.map((m,v)=>{const w=p[v],k={onerror:null,onsuccess:null};if(d.type==="delete")c.fire.call(k,m,w,h);else if(d.type==="add"||w===void 0){const _=a.fire.call(k,m,d.values[v],h);m==null&&_!=null&&(m=_,d.keys[v]=m,n.outbound||te(d.values[v],n.keyPath,m))}else{const _=Mn(w,d.values[v]),E=l.fire.call(k,_,m,w,h);if(E){const I=d.values[v];Object.keys(E).forEach(T=>{Z(I,T)?I[T]=E[T]:te(I,T,E[T])})}}return k});return r.mutate(d).then(({failures:m,results:v,numFailures:w,lastResult:k})=>{for(let _=0;_<g.length;++_){const E=v?v[_]:g[_],I=y[_];E==null?I.onerror&&I.onerror(m[_]):I.onsuccess&&I.onsuccess(d.type==="put"&&p[_]?d.values[_]:E)}return{failures:m,results:v,numFailures:w,lastResult:k}}).catch(m=>(y.forEach(v=>v.onerror&&v.onerror(m)),Promise.reject(m)))})}function f(d,h,g){return r.query({trans:d,values:!1,query:{index:n,range:h},limit:g}).then(({result:p})=>u({type:"delete",keys:p,trans:d}).then(y=>y.numFailures>0?Promise.reject(y.failures[0]):p.length<g?{failures:[],numFailures:0,lastResult:void 0}:f(d,{...h,lower:p[p.length-1],lowerOpen:!0},g)))}}}}})};function Si(e,t,r){try{if(!t||t.keys.length<e.length)return null;const n=[];for(let s=0,i=0;s<t.keys.length&&i<e.length;++s)J(t.keys[s],e[i])===0&&(n.push(r?Pt(t.values[s]):t.values[s]),++i);return n.length===e.length?n:null}catch{return null}}const nl={stack:"dbcore",level:-1,create:e=>({table:t=>{const r=e.table(t);return{...r,getMany:n=>{if(!n.cache)return r.getMany(n);const s=Si(n.keys,n.trans._cache,n.cache==="clone");return s?x.resolve(s):r.getMany(n).then(i=>(n.trans._cache={keys:n.keys,values:n.cache==="clone"?Pt(i):i},i))},mutate:n=>(n.type!=="add"&&(n.trans._cache=null),r.mutate(n))}}})};function Un(e){return!("from"in e)}const oe=function(e,t){if(!this){const r=new oe;return e&&"d"in e&&H(r,e),r}H(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0})};function At(e,t,r){const n=J(t,r);if(isNaN(n))return;if(n>0)throw RangeError();if(Un(e))return H(e,{from:t,to:r,d:1});const s=e.l,i=e.r;if(J(r,e.from)<0)return s?At(s,t,r):e.l={from:t,to:r,d:1,l:null,r:null},xs(e);if(J(t,e.to)>0)return i?At(i,t,r):e.r={from:t,to:r,d:1,l:null,r:null},xs(e);J(t,e.from)<0&&(e.from=t,e.l=null,e.d=i?i.d+1:1),J(r,e.to)>0&&(e.to=r,e.r=null,e.d=e.l?e.l.d+1:1);const o=!e.r;s&&!e.l&&dr(e,s),i&&o&&dr(e,i)}function dr(e,t){Un(t)||function r(n,{from:s,to:i,l:o,r:c}){At(n,s,i),o&&r(n,o),c&&r(n,c)}(e,t)}function sl(e,t){const r=yn(t);let n=r.next();if(n.done)return!1;let s=n.value;const i=yn(e);let o=i.next(s.from),c=o.value;for(;!n.done&&!o.done;){if(J(c.from,s.to)<=0&&J(c.to,s.from)>=0)return!0;J(s.from,c.from)<0?s=(n=r.next(c.from)).value:c=(o=i.next(s.from)).value}return!1}function yn(e){let t=Un(e)?null:{s:0,n:e};return{next(r){const n=arguments.length>0;for(;t;)switch(t.s){case 0:if(t.s=1,n)for(;t.n.l&&J(r,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!n||J(r,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function xs(e){var t,r;const n=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((r=e.l)===null||r===void 0?void 0:r.d)||0),s=n>1?"r":n<-1?"l":"";if(s){const i=s==="r"?"l":"r",o={...e},c=e[s];e.from=c.from,e.to=c.to,e[s]=c[s],o[s]=c[i],e[i]=o,o.d=Ss(o)}e.d=Ss(e)}function Ss({r:e,l:t}){return(e?t?Math.max(e.d,t.d):e.d:t?t.d:0)+1}nt(oe.prototype,{add(e){return dr(this,e),this},addKey(e){return At(this,e,e),this},addKeys(e){return e.forEach(t=>At(this,t,t)),this},[Hr](){return yn(this)}});const il={stack:"dbcore",level:0,create:e=>{const t=e.schema.name,r=new oe(e.MIN_KEY,e.MAX_KEY);return{...e,table:n=>{const s=e.table(n),{schema:i}=s,{primaryKey:o}=i,{extractKey:c,outbound:a}=o,l={...s,mutate:d=>{const h=d.trans,g=h.mutatedParts||(h.mutatedParts={}),p=E=>{const I=`idb://${t}/${n}/${E}`;return g[I]||(g[I]=new oe)},y=p(""),m=p(":dels"),{type:v}=d;let[w,k]=d.type==="deleteRange"?[d.range]:d.type==="delete"?[d.keys]:d.values.length<50?[[],d.values]:[];const _=d.trans._cache;return s.mutate(d).then(E=>{if(V(w)){v!=="delete"&&(w=E.results),y.addKeys(w);const I=Si(w,_);I||v==="add"||m.addKeys(w),(I||k)&&function(T,S,P,A){function U(F){const $=T(F.name||"");function de(z){return z!=null?F.extractKey(z):null}const re=z=>F.multiEntry&&V(z)?z.forEach(ke=>$.addKey(ke)):$.addKey(z);(P||A).forEach((z,ke)=>{const at=P&&de(P[ke]),mr=A&&de(A[ke]);J(at,mr)!==0&&(at!=null&&re(at),mr!=null&&re(mr))})}S.indexes.forEach(U)}(p,i,I,k)}else if(w){const I={from:w.lower,to:w.upper};m.add(I),y.add(I)}else y.add(r),m.add(r),i.indexes.forEach(I=>p(I.name).add(r));return E})}},u=({query:{index:d,range:h}})=>{var g,p;return[d,new oe((g=h.lower)!==null&&g!==void 0?g:e.MIN_KEY,(p=h.upper)!==null&&p!==void 0?p:e.MAX_KEY)]},f={get:d=>[o,new oe(d.key)],getMany:d=>[o,new oe().addKeys(d.keys)],count:u,query:u,openCursor:u};return M(f).forEach(d=>{l[d]=function(h){const{subscr:g}=C;if(g){const p=k=>{const _=`idb://${t}/${n}/${k}`;return g[_]||(g[_]=new oe)},y=p(""),m=p(":dels"),[v,w]=f[d](h);if(p(v.name||"").add(w),!v.isPrimaryKey){if(d!=="count"){const k=d==="query"&&a&&h.values&&s.query({...h,values:!1});return s[d].apply(this,arguments).then(_=>{if(d==="query"){if(a&&h.values)return k.then(({result:I})=>(y.addKeys(I),_));const E=h.values?_.result.map(c):_.result;h.values?y.addKeys(E):m.addKeys(E)}else if(d==="openCursor"){const E=_,I=h.values;return E&&Object.create(E,{key:{get:()=>(m.addKey(E.primaryKey),E.key)},primaryKey:{get(){const T=E.primaryKey;return m.addKey(T),T}},value:{get:()=>(I&&y.addKey(E.primaryKey),E.value)}})}return _})}m.add(r)}}return s[d].apply(this,arguments)}}),l}}}};class Fe{constructor(t,r){this._middlewares={},this.verno=0;const n=Fe.dependencies;this._options=r={addons:Fe.addons,autoOpen:!0,indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange,...r},this._deps={indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange};const{addons:s}=r;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const i={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:L,dbReadyPromise:null,cancelOpen:L,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};var o;i.dbReadyPromise=new x(c=>{i.dbReadyResolve=c}),i.openCanceller=new x((c,a)=>{i.cancelOpen=a}),this._state=i,this.name=t,this.on=Et(this,"populate","blocked","versionchange","close",{ready:[$n,L]}),this.on.ready.subscribe=ei(this.on.ready.subscribe,c=>(a,l)=>{Fe.vip(()=>{const u=this._state;if(u.openComplete)u.dbOpenError||x.resolve().then(a),l&&c(a);else if(u.onReadyBeingFired)u.onReadyBeingFired.push(a),l&&c(a);else{c(a);const f=this;l||c(function d(){f.on.ready.unsubscribe(a),f.on.ready.unsubscribe(d)})}})}),this.Collection=(o=this,ft(zc.prototype,function(c,a){this.db=o;let l=bi,u=null;if(a)try{l=a()}catch(g){u=g}const f=c._ctx,d=f.table,h=d.hook.reading.fire;this._ctx={table:d,index:f.index,isPrimKey:!f.index||d.schema.primKey.keyPath&&f.index===d.schema.primKey.name,range:l,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:u,or:f.or,valueMapper:h!==Ct?h:null}})),this.Table=function(c){return ft(Uc.prototype,function(a,l,u){this.db=c,this._tx=u,this.name=a,this.schema=l,this.hook=c._allTables[a]?c._allTables[a].hook:Et(null,{creating:[Oc,L],reading:[Nc,Ct],updating:[Ac,L],deleting:[Tc,L]})})}(this),this.Transaction=function(c){return ft(Vc.prototype,function(a,l,u,f,d){this.db=c,this.mode=a,this.storeNames=l,this.schema=u,this.chromeTransactionDurability=f,this.idbtrans=null,this.on=Et(this,"complete","error","abort"),this.parent=d||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new x((h,g)=>{this._resolve=h,this._reject=g}),this._completion.then(()=>{this.active=!1,this.on.complete.fire()},h=>{var g=this.active;return this.active=!1,this.on.error.fire(h),this.parent?this.parent._reject(h):g&&this.idbtrans&&this.idbtrans.abort(),q(h)})})}(this),this.Version=function(c){return ft(Yc.prototype,function(a){this.db=c,this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}(this),this.WhereClause=function(c){return ft(_i.prototype,function(a,l,u){this.db=c,this._ctx={table:a,index:l===":id"?null:l,or:u};const f=c._deps.indexedDB;if(!f)throw new O.MissingAPI;this._cmp=this._ascending=f.cmp.bind(f),this._descending=(d,h)=>f.cmp(h,d),this._max=(d,h)=>f.cmp(d,h)>0?d:h,this._min=(d,h)=>f.cmp(d,h)<0?d:h,this._IDBKeyRange=c._deps.IDBKeyRange})}(this),this.on("versionchange",c=>{c.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()}),this.on("blocked",c=>{!c.newVersion||c.newVersion<c.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${c.oldVersion/10}`)}),this._maxKey=Tt(r.IDBKeyRange),this._createTransaction=(c,a,l,u)=>new this.Transaction(c,a,l,this._options.chromeTransactionDurability,u),this._fireOnBlocked=c=>{this.on("blocked").fire(c),_t.filter(a=>a.name===this.name&&a!==this&&!a._state.vcFired).map(a=>a.on("versionchange").fire(c))},this.use(tl),this.use(rl),this.use(il),this.use(nl),this.vip=Object.create(this,{_vip:{value:!0}}),s.forEach(c=>c(this))}version(t){if(isNaN(t)||t<.1)throw new O.Type("Given version is not a positive number");if(t=Math.round(10*t)/10,this.idbdb||this._state.isBeingOpened)throw new O.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);const r=this._versions;var n=r.filter(s=>s._cfg.version===t)[0];return n||(n=new this.Version(t),r.push(n),r.sort(Hc),n.stores({}),this._state.autoSchema=!1,n)}_whenReady(t){return this.idbdb&&(this._state.openComplete||C.letThrough||this._vip)?t():new x((r,n)=>{if(this._state.openComplete)return n(new O.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void n(new O.DatabaseClosed);this.open().catch(L)}this._state.dbReadyPromise.then(r,n)}).then(t)}use({stack:t,create:r,level:n,name:s}){s&&this.unuse({stack:t,name:s});const i=this._middlewares[t]||(this._middlewares[t]=[]);return i.push({stack:t,create:r,level:n??10,name:s}),i.sort((o,c)=>o.level-c.level),this}unuse({stack:t,name:r,create:n}){return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(s=>n?s.create!==n:!!r&&s.name!==r)),this}open(){return Zc(this)}_close(){const t=this._state,r=_t.indexOf(this);if(r>=0&&_t.splice(r,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}t.dbReadyPromise=new x(n=>{t.dbReadyResolve=n}),t.openCanceller=new x((n,s)=>{t.cancelOpen=s})}close(){this._close();const t=this._state;this._options.autoOpen=!1,t.dbOpenError=new O.DatabaseClosed,t.isBeingOpened&&t.cancelOpen(t.dbOpenError)}delete(){const t=arguments.length>0,r=this._state;return new x((n,s)=>{const i=()=>{this.close();var o=this._deps.indexedDB.deleteDatabase(this.name);o.onsuccess=B(()=>{(function({indexedDB:c,IDBKeyRange:a},l){!Kn(c)&&l!=="__dbnames"&&Fn(c,a).delete(l).catch(L)})(this._deps,this.name),n()}),o.onerror=ne(s),o.onblocked=this._fireOnBlocked};if(t)throw new O.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(i):i()})}backendDB(){return this.idbdb}isOpen(){return this.idbdb!==null}hasBeenClosed(){const t=this._state.dbOpenError;return t&&t.name==="DatabaseClosed"}hasFailed(){return this._state.dbOpenError!==null}dynamicallyOpened(){return this._state.autoSchema}get tables(){return M(this._allTables).map(t=>this._allTables[t])}transaction(){const t=el.apply(this,arguments);return this._transaction.apply(this,t)}_transaction(t,r,n){let s=C.trans;s&&s.db===this&&t.indexOf("!")===-1||(s=null);const i=t.indexOf("?")!==-1;let o,c;t=t.replace("!","").replace("?","");try{if(c=r.map(l=>{var u=l instanceof this.Table?l.name:l;if(typeof u!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return u}),t=="r"||t==="readonly")o="readonly";else{if(t!="rw"&&t!="readwrite")throw new O.InvalidArgument("Invalid transaction mode: "+t);o="readwrite"}if(s){if(s.mode==="readonly"&&o==="readwrite"){if(!i)throw new O.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s=null}s&&c.forEach(l=>{if(s&&s.storeNames.indexOf(l)===-1){if(!i)throw new O.SubTransaction("Table "+l+" not included in parent transaction.");s=null}}),i&&s&&!s.active&&(s=null)}}catch(l){return s?s._promise(null,(u,f)=>{f(l)}):q(l)}const a=xi.bind(null,this,o,c,s,n);return s?s._promise(o,a,"lock"):C.trans?ot(C.transless,()=>this._whenReady(a)):this._whenReady(a)}table(t){if(!Z(this._allTables,t))throw new O.InvalidTable(`Table ${t} does not exist`);return this._allTables[t]}}const ol=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable";class al{constructor(t){this._subscribe=t}subscribe(t,r,n){return this._subscribe(t&&typeof t!="function"?t:{next:t,error:r,complete:n})}[ol](){return this}}function Ci(e,t){return M(t).forEach(r=>{dr(e[r]||(e[r]=new oe),t[r])}),e}function cl(e){return new al(t=>{const r=An(e);let n=!1,s={},i={};const o={get closed(){return n},unsubscribe:()=>{n=!0,_e.storagemutated.unsubscribe(u)}};t.start&&t.start(o);let c=!1,a=!1;function l(){return M(i).some(d=>s[d]&&sl(s[d],i[d]))}const u=d=>{Ci(s,d),l()&&f()},f=()=>{if(c||n)return;s={};const d={},h=function(g){r&&it();const p=()=>be(e,{subscr:g,trans:null}),y=C.trans?ot(C.transless,p):p();return r&&y.then(fe,fe),y}(d);a||(_e("storagemutated",u),a=!0),c=!0,Promise.resolve(h).then(g=>{c=!1,n||(l()?f():(s={},i=d,t.next&&t.next(g)))},g=>{c=!1,t.error&&t.error(g),o.unsubscribe()})};return f(),o})}let mn;try{mn={indexedDB:G.indexedDB||G.mozIndexedDB||G.webkitIndexedDB||G.msIndexedDB,IDBKeyRange:G.IDBKeyRange||G.webkitIDBKeyRange}}catch{mn={indexedDB:null,IDBKeyRange:null}}const Ie=Fe;function er(e){let t=ce;try{ce=!0,_e.storagemutated.fire(e)}finally{ce=t}}nt(Ie,{...Jt,delete:e=>new Ie(e,{addons:[]}).delete(),exists:e=>new Ie(e,{addons:[]}).open().then(t=>(t.close(),!0)).catch("NoSuchDatabaseError",()=>!1),getDatabaseNames(e){try{return function({indexedDB:t,IDBKeyRange:r}){return Kn(t)?Promise.resolve(t.databases()).then(n=>n.map(s=>s.name).filter(s=>s!=="__dbnames")):Fn(t,r).toCollection().primaryKeys()}(Ie.dependencies).then(e)}catch{return q(new O.MissingAPI)}},defineClass:()=>function(e){H(this,e)},ignoreTransaction:e=>C.trans?ot(C.transless,e):e(),vip:pn,async:function(e){return function(){try{var t=gn(e.apply(this,arguments));return t&&typeof t.then=="function"?t:x.resolve(t)}catch(r){return q(r)}}},spawn:function(e,t,r){try{var n=gn(e.apply(r,t||[]));return n&&typeof n.then=="function"?n:x.resolve(n)}catch(s){return q(s)}},currentTransaction:{get:()=>C.trans||null},waitFor:function(e,t){const r=x.resolve(typeof e=="function"?Ie.ignoreTransaction(e):e).timeout(t||6e4);return C.trans?C.trans.waitFor(r):r},Promise:x,debug:{get:()=>se,set:e=>{oi(e,e==="dexie"?()=>!0:vi)}},derive:Ye,extend:H,props:nt,override:ei,Events:Et,on:_e,liveQuery:cl,extendObservabilitySet:Ci,getByKeyPath:ue,setByKeyPath:te,delByKeyPath:function(e,t){typeof t=="string"?te(e,t,void 0):"length"in t&&[].map.call(t,function(r){te(e,r,void 0)})},shallowClone:ni,deepClone:Pt,getObjectDiff:Mn,cmp:J,asap:ti,minKey:-(1/0),addons:[],connections:_t,errnames:Ln,dependencies:mn,semVer:"3.2.3",version:"3.2.3".split(".").map(e=>parseInt(e)).reduce((e,t,r)=>e+t/Math.pow(10,2*r))}),Ie.maxKey=Tt(Ie.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(_e("storagemutated",e=>{if(!ce){let t;yr?(t=document.createEvent("CustomEvent"),t.initCustomEvent("x-storagemutated-1",!0,!0,e)):t=new CustomEvent("x-storagemutated-1",{detail:e}),ce=!0,dispatchEvent(t),ce=!1}}),addEventListener("x-storagemutated-1",({detail:e})=>{ce||er(e)}));let ce=!1;if(typeof BroadcastChannel<"u"){const e=new BroadcastChannel("x-storagemutated-1");typeof e.unref=="function"&&e.unref(),_e("storagemutated",t=>{ce||e.postMessage(t)}),e.onmessage=t=>{t.data&&er(t.data)}}else if(typeof self<"u"&&typeof navigator<"u"){_e("storagemutated",t=>{try{ce||(typeof localStorage<"u"&&localStorage.setItem("x-storagemutated-1",JSON.stringify({trig:Math.random(),changedParts:t})),typeof self.clients=="object"&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(r=>r.postMessage({type:"x-storagemutated-1",changedParts:t})))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",t=>{if(t.key==="x-storagemutated-1"){const r=JSON.parse(t.newValue);r&&er(r.changedParts)}});const e=self.document&&navigator.serviceWorker;e&&e.addEventListener("message",function({data:t}){t&&t.type==="x-storagemutated-1"&&er(t.changedParts)})}x.rejectionMapper=function(e,t){if(!e||e instanceof Qe||e instanceof TypeError||e instanceof SyntaxError||!e.name||!ms[e.name])return e;var r=new ms[e.name](t||e.message,e);return"stack"in e&&le(r,"stack",{get:function(){return this.inner.stack}}),r},oi(se,vi);class ll extends Fe{constructor(){super("nr-editor");b(this,"catalogues");b(this,"systems");this.version(5).stores({catalogues:"id, content.catalogue.id, content.catalogue.gameSystemId",systems:"id"})}}const Te=new ll;function Ol(e){const t=/^(?:(http(s?)?:\/\/)?github.com\/)?([^\/]+)\/([^\/]+)$/,r=e.match(t);if(!r)return null;const[,n="https://",s,i,o]=r;return!i||!o?null:`https://github.com/${i}/${o}`}function ul(e){const t=/^(?:https?:\/\/)?(?:www\.)?github\.com\/([^/]+)\/([^/]+)(?:\/)?$/,r=e.match(t);if(!r)throw new Error("Invalid GitHub URL format: "+e);const[,n,s]=r;return{githubUrl:e,githubRepo:`${n}/${s}`,githubOwner:n,githubName:s}}async function Cs(e,t){try{const r=e.split("/"),n=r[r.length-2],s=r[r.length-1].replace(".git",""),i=`https://api.github.com/repos/${n}/${s}/contents/${encodeURIComponent(t)}`;console.log(`Querying github api at ${i}`);const o=await $fetch(i,{headers:{"User-Agent":"New Recruit Data Editor (Electron)",Accept:"application/vnd.github.v3+json"}});if(!o||!(o!=null&&o.download_url))throw new Error("No download_url found");console.log(`Downloading file at ${o==null?void 0:o.download_url}`);const c=await $fetch(o.download_url,{headers:{"User-Agent":"New Recruit Data Editor (Electron)",Accept:"application/vnd.github.v3+json"}});return console.log(`Downloaded file, length: ${c.length}`),c}catch(r){throw r}}async function fl(e,t,r){try{return await Cs(e,t)}catch(n){if(!r)throw n;return await Cs(e,r)}}async function dl(e,t){if(t.fullFilePath)try{const r=As(t.fullFilePath),n=r.endsWith("z")?Ps(r,"z"):void 0,s=await fl(e.githubUrl,r,n),i=/revision="(\d+)"/,o=s.match(i);if(o){const c=(Number(o[1])||0)+1;return console.log(`Revision of ${t.name}: ${t.revision} -> ${c}`),c}}catch(r){console.error(r)}return t.revision||1}function Ns(e,t){if(e)return e[t]||e["*"]}async function hr(e,t,r,n){if(!t.catalogue&&!t.gameSystem)throw Error("invalid loadBsData argument: no .catalogue or .gameSystem in data");const s=t.catalogue?"catalogue":"gameSystem",i=s==="gameSystem",o=s==="catalogue",c=t[s],a=c;if(a.loaded||a.loaded_editor)return a;Ce(c);const l=Vr(c,s);if(l.manager=e,o){const f={targetId:l.gameSystemId},d=e.getLoadedCatalogue(f,r);if(d)l.gameSystem=d;else{const h=await e.getData(f,r),g=e.getLoadedCatalogue(f,r);g?l.gameSystem=g:l.gameSystem=await hr(e,h,r)}}const u=[];for(const f of(l==null?void 0:l.catalogueLinks)||[]){if(!f.targetId){console.warn(`invalid link: no targetId in link: ${f}, found in ${c.name}`);continue}if(f.targetId===l.id){f.target=l;continue}const d=e.getLoadedCatalogue(f,r);if(d){f.target=d;continue}const h=e.getData(f,r).then(g=>{const p=e.getLoadedCatalogue(f,r);if(p){f.target=p;return}return hr(e,g,r).then(y=>f.target=y)});u.push(h)}return await Promise.all(u),i&&e.addLoadedSystem(l),o&&e.addLoadedCatalogue(l),l}class hl{constructor(){b(this,"catalogues",{});b(this,"unresolvedLinks");b(this,"settings")}async getData(t,r){throw new Error("Method not implemented.")}getCatalogueInfo(t){}findOptionById(t){}getLoadedCatalogue(t,r){const n=typeof t=="string"?t:t.targetId||t.name,s=Ns(r,n)||"default",i=this.catalogues[n];return i?i[s]:void 0}addLoadedCatalogue(t,r){const n=Ns(r,t.id)||"default";this.catalogues[t.name]||(this.catalogues[t.name]={}),this.catalogues[t.id]||(this.catalogues[t.id]={}),this.catalogues[t.name][n]=t,this.catalogues[t.id][n]=t}addLoadedSystem(t,r){return this.addLoadedCatalogue(t,r)}unloadAll(){this.catalogues={}}async loadData(t,r){const n=await hr(this,t,r);return n.process(),n}async loadCatalogue(t,r,n){const s=this.getLoadedCatalogue(t,r);if(s&&!n)return s;const i=await this.getData(t,r);if(i)return await this.loadData(i,r);throw Error(`Couldn't load catalogue: couldn't getData ${t}`)}}class Os extends hl{constructor(){super(...arguments);b(this,"gameSystem",null);b(this,"catalogueFiles",dc());b(this,"allLoaded");b(this,"loadedCatalogues",{});b(this,"github");b(this,"unresolvedLinks",{});b(this,"index",{})}async loadData(r,n){return await hr(this,r,n)}findOptionById(r){for(const n of Object.values(this.loadedCatalogues))if(n.index&&n.index[r])return n.index[r]}unloadAll(){super.unloadAll();for(const r of Object.values(this.loadedCatalogues))r.reset();this.loadedCatalogues={},delete this.allLoaded}async loadAll(r){var i,o;let n=Object.values(this.catalogueFiles).length+1,s=0;if(this.allLoaded||console.log("Loading all catalogues in",(o=(i=this.gameSystem)==null?void 0:i.gameSystem)==null?void 0:o.name),this.gameSystem){r&&await r(s,n,`Loading ${this.gameSystem.gameSystem.name}`),(await this.loadCatalogue({targetId:this.gameSystem.gameSystem.id})).processForEditor(),s++;for(const a of Object.values(this.catalogueFiles))r&&await r(s,n,`Loading ${a.catalogue.name}`),(await this.loadCatalogue({targetId:a.catalogue.id})).processForEditor(),s++,r&&await r(s,n,`Loading ${a.catalogue.name}`)}this.allLoaded=!0}getLoadedCatalogue(r,n){const s=r.targetId||r.name;return this.loadedCatalogues[s]}addLoadedCatalogue(r,n){this.loadedCatalogues[r.id]=r}getAllLoadedCatalogues(){var n;return((n=this.gameSystem)==null?void 0:n.gameSystem.id)?Object.values(this.loadedCatalogues):[]}getId(){var r;return(r=this.gameSystem)==null?void 0:r.gameSystem.id}getCatalogueInfo(r){var n,s;if(((n=this.gameSystem)==null?void 0:n.gameSystem.id)===r.targetId)return(s=this.gameSystem)==null?void 0:s.gameSystem;for(const i of Object.values(this.catalogueFiles))if(i.catalogue.id===r.targetId)return i.catalogue}getAllCatalogueFiles(){return[...this.gameSystem?[this.gameSystem]:[],...Object.values(this.catalogueFiles)]}setSystem(r){this.gameSystem=r}setCatalogue(r){const n=r.catalogue.id;this.catalogueFiles[n]=r}removeCatalogue(r){for(const[n,s]of Object.entries(this.catalogueFiles))s.catalogue.id===r.catalogue.id&&delete this.catalogueFiles[n]}async getData(r,n){var c;if(r.targetId==((c=this.gameSystem)==null?void 0:c.gameSystem.id))return this.gameSystem;if(r.targetId in this.catalogueFiles)return this.catalogueFiles[r.targetId];const s=await Te.catalogues.get({"content.catalogue.id":r.targetId});if(s)return s.content;const i=await Te.systems.get(r.targetId);if(i)return i.content;const o=r.name?`name ${r.name}`:`id ${r.targetId}`;throw Error(`Couldn't import catalogue with ${o}, perhaps it wasnt uploaded?`)}}const pl=!1;function ve(e){return e.vnode}function Ne(e){if(e instanceof R)return e;const t=e.$parent;if(t.item)return t.item;const r=t.$parent;return r.item?r.item:r.$parent.item}function gl(e){e.isSaving=!0}function yl(e){if(e.isSaving){e.isSaving=!1;return}e.isChangedOnDisk=!0}function ml(e){e.isChangedOnDisk&&(e.isChangedOnDisk=!1),e.isSaving===void 0&&(e.isSaving=!1)}const Rr=new Set(["select","showInEditor","showChildsInEditor"]),Tl=vn("editor",{state:()=>({selections:[],selectedEntries:[],selectedElementGroup:null,selectedElement:null,selectedItem:null,filter:"",filterRegex:RegExp(""),filtered:[],undoStack:[],undoStackPos:-1,historyStack:[],historyStackPos:0,clipboard:[],mode:"edit",clipboardmode:"json",gameSystems:{},gameSystemsLoaded:!1,unsavedChanges:{},unsavedCount:0}),actions:{async create_system(e,t,r){console.log("Creating system with name:",e);const n=`sys-${Y()}`,s=this.get_system(n),i=t?`${Ps(t.replaceAll("\\","/"),"/")}/${e}`:"";if(electron){if(!i)throw new Error("No folder specified");Bi(i)}const o={gameSystem:{id:n,name:e,battleScribeVersion:"2.03",revision:1,categoryEntries:[{name:"Default Category",id:"default-category"}],forceEntries:[{name:"Default Force",hidden:!1,id:"default-force",categoryLinks:[{name:"Default Category",hidden:!1,id:"default-force-category-link",targetId:"default-category"}]}],selectionEntries:[{type:"upgrade",import:!0,name:"Default Root Entry",hidden:!1,id:"default-entry",categoryLinks:[{targetId:"default-category",id:"default-category-link",primary:!0,name:"Default Category",hidden:!1}]}]}};return i&&(o.gameSystem.fullFilePath=`${i}/${e}.${r||"gst"}`),s.setSystem(o),this.get_catalogue_state(o).incremented=!0,this.saveCatalogue(o),s},saveCatalogueInDb(e){const t=Mr(e);!!!e.gameSystemId?Te.systems.put({content:JSON.parse(t),path:e.fullFilePath,id:e.id}):Te.catalogues.put({content:JSON.parse(t),path:e.fullFilePath,id:`${e.gameSystemId}-${e.id}`})},async saveCatalogueInFiles(e){const t=e.fullFilePath;if(!t){console.error(`No path included in the catalogue ${e.name} to save at`);return}const r=gr(t);if(t.endsWith(".json")){const n=Mr(e);await jn(t,n)}else{const n=cc(e),s=Ys(r),o=As(t).replace(".gstz",".gst").replace(".catz",".cat"),c=s?await Fi(o,n,"uint8array"):n;await jn(t,c)}},saveCatalogue(e){const t=this.get_catalogue_state(e),r=ye(e);gl(t),electron?this.saveCatalogueInFiles(r):this.saveCatalogueInDb(r),ml(t)},async load_systems_from_folder(e,t){var c,a;if(!globalThis.electron)throw new Error("Not running in electron");const r=await Ki(e);if(!(r!=null&&r.length))return;console.log("Loading",r.length,"files");const n=[],s=[],i=[],o=r.filter(l=>rc(l.name));for(const l of o)try{t&&await t(s.length,o.length,l.path);const u=await nc(l.data,l.name.endsWith("json")?"json":"xml");if(!u.catalogue&&!u.gameSystem)continue;const f=ye(u);f.fullFilePath=l.path.replaceAll("\\","/");const d=(c=u==null?void 0:u.gameSystem)==null?void 0:c.id,h=(a=u==null?void 0:u.catalogue)==null?void 0:a.id;if(d){const g=this.get_system(d);g.setSystem(globalThis.$markRaw?globalThis.$markRaw(u):u),i.push(g),n.push(d)}if(h){const g=this.get_system(u.catalogue.gameSystemId);g.catalogueFiles[h]=globalThis.$markRaw?globalThis.$markRaw(u):u}s.push(u)}catch(u){console.error(`Error loading ${l.name}`,u)}t&&await t(s.length,o.length);for(const l of i)t&&await t(0,0,"Checking for github integration"),await this.load_system(l);return n},async load_systems_from_db(e=!1){if(!this.gameSystemsLoaded&&!e){this.gameSystemsLoaded=!0;let t=await Te.systems.offset(0).keys();for(let r of t)r in this.gameSystems||this.load_system_from_db(r)}},async load_system_from_db(e){const t=await Te.systems.get(e),r=t==null?void 0:t.content;if(!r)throw new Error("System not found "+e);r.gameSystem.fullFilePath||(r.gameSystem.fullFilePath=t.path);const n=await Te.catalogues.where({"content.catalogue.gameSystemId":e}),s=this.get_system(r.gameSystem.id);s.setSystem(r);for(let{content:i,path:o}of await n.toArray()){const c=i.catalogue.id;i.catalogue.fullFilePath||(i.catalogue.fullFilePath=o),s.catalogueFiles[c]=Mi(i)}this.load_system(s,!0)},async load_system(e,t=!1){var r,n;if(e.gameSystem){const s=ys();if(await e.unloadAll(),!t)for(const a of e.getAllCatalogueFiles()){const l=this.get_catalogue_state(a);l&&(l.changed=!1,l.unsaved=!1,l.isChangedOnDisk=!1),s.updateCatalogue(ye(a)),s.setEdited(ye(a).id,!1)}const i=e.gameSystem.gameSystem.publications,o=i==null?void 0:i.find(a=>{var l;return((l=a.name)==null?void 0:l.trim().toLowerCase())==="github"}),c=e.gameSystem.gameSystem.fullFilePath;if(c&&pl)try{const a=await Ui(zi(c));a&&a!=="origin"&&(console.log("remote:",a),e.github={...ul(a),discovered:!0})}catch(a){console.error(a)}o&&o.publisherUrl&&(e.github={githubUrl:o.publisherUrl},o.shortName&&o.shortName.includes("/")&&(e.github.githubRepo=o.shortName,e.github.githubOwner=(r=o.shortName)==null?void 0:r.split("/")[0],e.github.githubName=(n=o.shortName)==null?void 0:n.split("/")[1]))}for(const s of e.getAllCatalogueFiles()){const i=ye(s);i.fullFilePath&&qi(i.fullFilePath,()=>{this.on_file_changed(s)})}},on_file_changed(e){console.log(ye(e).name,"changed"),yl(this.get_catalogue_state(e))},async get_or_load_system(e){return e in this.gameSystems||(this.gameSystems[e]=new Os,await this.load_system_from_db(e)),this.gameSystems[e]},get_system(e){if(!(e in this.gameSystems)){const t=new Os;t.settings=br(),this.gameSystems[e]=t}return this.gameSystems[e]},delete_system(e){delete this.gameSystems[e]},get_catalogue_state(e){const t=Wn(e);return this.unsavedChanges[t]||(this.unsavedChanges[t]={changed:!1,unsaved:!1}),this.unsavedChanges[t]},set_catalogue_changed(e,t=!0){const r=this.get_catalogue_state(e);t?(r.changed=!0,r.unsaved||(this.unsavedCount+=1,r.unsaved=t)):r.unsaved=t},async save_catalogue(e,t,r){const n=this.get_catalogue_state(t),s=t.revision;r==="github"&&e.github&&(t.revision=await dl(e.github,t)),r==="yes"&&!(n!=null&&n.incremented)&&(t.revision=t.revision?t.revision+1:1,n.incremented=!0),r==="no"&&(n.incremented=!0),this.saveCatalogue(t);const i=ys(),o=Wn(t);return i.updateCatalogue(t),i.setEdited(o,!0),n!=null&&n.unsaved&&(this.unsavedCount--,n.unsaved=!1),t.revision!==s},async prompt_revision(e){const t=br(),r=e instanceof rr?e.manager:e;for(const n of e instanceof rr?[e]:r.getAllLoadedCatalogues()){const s=this.get_catalogue_state(n);if(s!=null&&s.unsaved&&!s.incremented)return r.github?t.githubAutoIncrement&&!navigator.onLine?await(globalThis.customPrompt&&globalThis.customPrompt({html:`<span>Would you like to increase the revision of this catalogue?<span><br/>
  <span class="gray">Note: This is shown because Github cannot be accessed as your are offline</span>`,cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no":t.githubAutoIncrement?"github":await(globalThis.customPrompt&&globalThis.customPrompt({html:"<span>Would you like to increase the revision of this catalogue?<span><br/>",cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no":await(globalThis.customPrompt&&globalThis.customPrompt({html:`<span>Would you like to increase the revision of this catalogue?<span><br/>
  <span class="gray">Note: You can enable automatic revision increments by integrating with GitHub.<br/>This can be achieved by adding a publication in the GameSystem named "GitHub" with the repository's GitHub URL as the Publication URL.`,cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no"}},async save_all(e){var n,s,i;let t=!1,r=0;br();try{for(const o of Object.values(this.gameSystems)){if(e&&((s=(n=o.gameSystem)==null?void 0:n.gameSystem)==null?void 0:s.id)!==e)continue;const c=await this.prompt_revision(o);for(const a of o.getAllLoadedCatalogues())(i=this.get_catalogue_state(a))!=null&&i.unsaved&&await this.save_catalogue(o,a,c)&&(r+=1)}}catch(o){notify({text:`Failed to save: ${o.name}: ${o.message}`,type:"error"}),t=!0}return r&&notify(`Incremented ${r} catalogue's revision`),t},set_filter(e){this.$state.filter=e,this.filterRegex=Fr(e)},init(e){this.catalogueComponent=e,globalThis.$store=this},rerender_catalogue(){this.catalogueComponent&&(this.catalogueComponent.key+=1)},unselect(e){const t=[],r=[];for(const n of this.selections)e===void 0||he(n.obj)===he(e)?r.push(n):t.push(n);for(const n of this.selectedEntries)e===void 0||he(n.obj)===he(e)?r.push(n):t.push(n);this.selections=t;for(const n of r)n.onunselected&&n.onunselected(),n.obj===this.selectedItem&&(this.selectedItem=null)},is_selected(e){return e instanceof R?this.selectedEntries.find(t=>t.obj===e)!==void 0:this.selections.find(t=>t.obj===e)!==void 0},select(e,t,r){this.is_selected(e)||(e instanceof R?this.selectedEntries.push({obj:e,onunselected:t,payload:r}):this.selections.push({obj:e,onunselected:t,payload:r}))},do_select(e,t,r){const n=Array.isArray(r)?r:[r],s=this.selectedElementGroup,i=this.selectedElement;if(this.selectedElement=t,this.selectedElementGroup=r,e!=null&&e.shiftKey&&he(r)===he(s)){const o=n.findIndex(u=>u===he(i)),c=n.findIndex(u=>u===he(this.selectedElement)),a=Math.min(o,c),l=Math.max(o,c);for(let u=a;u<=l;u++)n[u].select();return}!(e!=null&&e.ctrlKey)&&!(e!=null&&e.metaKey)&&this.unselect(),e!=null&&e.ctrlKey&&this.is_selected(t)?this.unselect(t):(t.select(),this.selectedItem=t,this.mode="edit")},do_rightclick_select(e,t,r){this.is_selected(t)||this.do_select(e,t,r)},clear_selections(){this.unselect()},get_selections(){const e=this.selections.map(t=>Ne(t.obj));return this.selectedEntries.forEach(t=>e.push(t.obj)),e},get_selections_with_payload(){const e=this.selections.map(t=>({obj:Ne(t.obj),payload:t.payload}));return this.selectedEntries.forEach(t=>e.push({obj:t.obj,payload:t.payload})),e},get_selected(){return this.selectedItem&&Ne(this.selectedItem)},set_selections(e){this.clear_selections();const t=Array.isArray(e)?e:[e];this.selectedEntries=t.map(r=>({obj:r,onunselected:()=>null}))},toggle_selections(){const e=this.get_selections();if(this.filter&&e.find(t=>!t.showChildsInEditor))e.forEach(t=>this.show(t,!1));else{const t=this.selections.map(r=>r.obj);t.find(r=>r.collapsed===!0)?t.filter(r=>r.collapsed===!0).forEach(r=>r.open()):t.filter(r=>r.collapsed===!1).forEach(r=>r.close())}},async do_action(e,t,r){let n;try{n=await r()}catch(s){console.error(s);return}if(this.undoStackPos<this.undoStack.length){const s=this.undoStack.length-this.undoStackPos-1;this.undoStack.splice(this.undoStackPos+1,s,{type:e,undo:t,redo:r})}else this.undoStack.push({type:e,undo:t,redo:r});return this.undoStackPos+=1,n},async set_clipboard(e,t){if(this.clipboardmode==="json"){const r=e.map(s=>({parentKey:s.parentKey,...s,sortIndex:void 0})),n=eo(r,new Set(["parentKey"]),{forceArray:!1,formatted:!0});t!=null&&t.clipboardData?t.clipboardData.setData("text/plain",n):await navigator.clipboard.writeText(n)}else this.clipboard=e},async get_clipboard(e){if(this.clipboardmode==="json")if(e!=null&&e.clipboardData){const t=e.clipboardData.getData("text/plain");return t?JSON.parse(t):[]}else{const t=await navigator.clipboard.readText();return JSON.parse(t)}return this.clipboard},can_undo(){return!!this.undoStack[this.undoStackPos]},async undo(){if(!this.can_undo())return;const e=this.undoStack[this.undoStackPos];e&&(await e.undo(),this.undoStackPos--)},can_redo(){return!!this.undoStack[this.undoStackPos+1]},async redo(){if(!this.can_redo())return;const e=this.undoStack[this.undoStackPos+1];e&&(await e.redo(),this.undoStackPos++)},async cut(e){await this.set_clipboard(this.get_selections(),e),this.remove()},async copy(e){await this.set_clipboard(this.get_selections(),e)},async paste(e){this.add(await this.get_clipboard(e))},async pasteLink(){const e=await this.get_clipboard();if(!e||!e.parentKey||Array.isArray(e))return;const r=this.get_selections()[0];if(!r)return;const n=r.getCatalogue().findOptionById(e.id);if(n){const s={parentKey:n.isGroup()||n.isEntry()?"entryLinks":"infoLinks",targetId:n.id,id:Y(),type:n.editorTypeName,name:n.getName(),hidden:n.hidden,select:!0};this.add(s)}},async duplicate(){const e=this.get_selections();if(!e.length)return;const t=e[0].getCatalogue(),r=t.getSystemId();let n=[];const s=()=>{n=[];for(const o of e){const c=JSON.parse(jt(o,Rr));if(!o.parent)continue;const a=o.parent[o.parentKey];if(!Array.isArray(a))throw new Error(`Couldn't duplicate: parent[${o.parentKey}] is not an array`);Ce({[o.parentKey]:c}),ps(t,c),a.push(c),We(c,t,o.parent,this.get_system(r)),n.push(c)}},i=()=>{for(const o of n)Gt(t,pe(o)),ut(o)};await this.do_action("dupe",i,s),this.set_catalogue_changed(t,!0)},remove(e){let t=[];if(e)for(const a of Array.isArray(e)?e:[e])t.push(a);else{const a=this.get_selections();if(!a.length)return;for(const l of a)t.push(l)}const r=t[0].getCatalogue(),n=r.getSystemId();let s=[],i=[];const o=async()=>{const a=t,l=this.get_system(n);i=[],s=[];for(const u of a){const f=pe(u),d=Gt(r,f);i.push(d),s.push(f),ut(d,l)}i.reverse(),s.reverse()},c=async()=>{for(const[a,l]of ji(s,i)){const u=hs(r,a,l);We(l,r,u,this.get_system(n))}};this.do_action("remove",c,o),this.set_catalogue_changed(r,!0),this.unselect()},async add(e,t,r){let n=[];if(r?(r=Array.isArray(r)?r:[r],n=r.map(f=>({obj:f}))):n=this.get_selections_with_payload(),!n.length){console.error("Couldn't add: no selection or parent(s) provided");return}const s=Array.isArray(e)?e:[e];if(!s.length){console.error("Couldn't add: no data provided");return}const i=n[0].obj.getCatalogue(),o=i.getSystemId();let c=[];const a=async()=>{var f;c=[];for(const d of n){const h=d.obj,g=d.payload;await this.open(h,!0);const p=[];for(const y of s){const m=gs(h,t||y.parentKey,g);if(!m){console.warn("Couldn't create",t||y.parentKey,"in",g);continue}h[m]||(h[m]=[]);const v=h[m];if(!Array.isArray(v))continue;if(!((f=fs(h,h.parentKey))!=null&&f.has(m))){console.warn("Couldn't add",m,"to a",h.parentKey,"because it is not allowed");continue}const w=y instanceof R?jt(y,Rr):JSON.stringify(y),k=JSON.parse(w);Wr(k,m),delete k.parentKey,Ce({[m]:k}),p.push({key:m,entry:k})}ps(i,p.map(y=>y.entry));for(const{key:y,entry:m}of p){h[y]||(h[y]=[]);const v=h[y];if(!Array.isArray(v))continue;this.filtered.push(m),m.showChildsInEditor=!0;let w=m;for(;w;)w.showInEditor=!0,w=w.parent;v.push(m),We(m,i,h,this.get_system(o)),c.push(m)}}return c[0]},l=()=>{for(const f of c)Gt(i,pe(f)),ut(f)},u=await this.do_action("add",l,a);return this.set_catalogue_changed(i,!0),u},open_selected(){for(const e of this.selections)e.obj.open()},get_initial_object(e,t){switch(e){case"costTypes":return{name:`New ${je(Se(e))}`,id:Y(),defaultCostLimit:-1};case"repeats":return{value:1,repeats:1,field:"selections",scope:"parent",childId:"any",shared:!0,roundUp:!1,id:Y()};case"constraints":{const s=(t==null?void 0:t.parentKey)==="associations",i={type:"min",value:1,field:t!=null&&t.isForce()?"forces":"selections",scope:"parent",shared:!0,id:Y()};return s&&(i.childId="any"),i}case"conditions":return{type:"atLeast",value:1,field:"selections",scope:"parent",childId:"any",shared:!0};case"modifiers":return{type:"set",value:!0,field:"hidden"};case"modifierGroups":case"conditionGroups":return{type:"and"};case"sharedSelectionEntries":case"selectionEntries":return{type:"upgrade",import:!0,name:`New ${je(Se(e))}`,hidden:!1,id:Y()};case"entryLinks":return{import:!0,name:`New ${je(Se(e))}`,hidden:!1,id:Y()};case"associations":return{min:1,max:1,scope:"parent",childId:"any",ids:[],name:"New Association",id:Y()};case"sharedProfiles":case"profiles":const r=t==null?void 0:t.getCatalogue().iterateProfileTypes().next().value;return{name:(!t||t!=null&&t.isCatalogue()||t==null?void 0:t.getName())||"New Profile",typeId:r==null?void 0:r.id,typeName:r==null?void 0:r.name,hidden:!1,id:Y(),characteristics:[]};case"catalogueLinks":return{type:"catalogue",name:`New ${je(Se(e))}`,id:Y()};case"categoryLinks":return{type:"category",name:`New ${je(Se(e))}`,hidden:!1,id:Y()};default:return{name:`New ${je(Se(e))}`,hidden:!1,id:Y()}}},fix_object(e,t){const r={...this.get_initial_object(e),...t};for(const n in r){const s=r[n];Array.isArray(s)&&_n.has(n)&&(r[n]=r[n].map(i=>this.fix_object(n,i)))}return r},async create(e,t){const r=this.fix_object(e,t);r.select=!0;const n=await this.add(r,e);return this.open_selected(),n},async create_child(e,t,r){const n=this.fix_object(e,r);n.select=!0;const s=await this.add(n,e,t);return this.open_selected(),s},add_node(e,t,r){var a;const n=gs(t,e);if(!n)throw new Error(`Invalid key: ${e} in ${t.editorTypeName}`);const s=t.getCatalogue(),i=s.getSystemId(),o={...this.fix_object(n,r),...r};t[n]||(t[n]=[]);const c=t[n];if(Array.isArray(c)){if(!((a=fs(t,t.parentKey))!=null&&a.has(n))){console.warn("Couldn't add",n,"to a",t.parentKey,"because it is not allowed");return}return Wr(o,n),delete o.parentKey,Ce({[n]:o}),c.push(o),We(o,s,t,this.get_system(i)),this.set_catalogue_changed(s),o}},del_node(e){e.catalogue&&this.set_catalogue_changed(e.catalogue);try{const t=e.catalogue,r=t.manager,n=pe(e),s=Gt(t,n);ut(s,r)}catch{console.error("Failed to delete",e)}},can_move(e){return!e.isLink()},edit_node(e,t){const r=JSON.parse(e.toJson());Object.assign(r,t),Ce({[e.parentKey]:r}),Object.assign(e,r),this.set_catalogue_changed(e.catalogue)},get_move_targets(e){const t=e.catalogue;if(!t||e.isLink())return;const r=[];if(!e.parentKey.startsWith("shared")&&this.move_to_key(e,"shared")?r.push({target:t,type:"shared"}):e.parentKey.startsWith("shared")&&this.move_to_key(e,"root")&&r.push({target:t,type:"root"}),this.move_to_key(e,"shared"))for(const n of t.imports)r.push({target:n,type:"shared"});if(this.move_to_key(e,"root"))for(const n of t.imports)r.push({target:n,type:"root"});return r},move_to_key(e,t){if(t==="shared")switch(e.editorTypeName){case"infoGroup":return"sharedInfoGroups";case"rule":return"sharedRules";case"profile":return"sharedProfiles";case"selectionEntry":return"sharedSelectionEntries";case"selectionEntryGroup":return"sharedSelectionEntryGroups";default:return""}switch(e.editorTypeName){case"infoGroup":return"infoGroups";case"rule":return"rules";case"profile":return"";case"category":return"categoryEntries";case"profileType":return"profileTypes";case"costType":return"costTypes";case"selectionEntry":return"selectionEntries";case"selectionEntryGroup":return"";default:return e.parentKey}},move(e,t,r,n){(()=>{const i=this.move_to_key(e,n);if(!i){console.error("Could not find key for move",e.editorTypeName,n);return}const o=e.parent,c=pe(e);uc(e),ut(e);const a=JSON.parse(jt(e,Rr));Ce({[i]:a}),r[i]||(r[i]=[]),r[i].push(a),We(a,r,r,this.get_system(r.getSystemId()));const u=["rule","infoGroup","profile","selectionEntry","selectionEntryGroup"].includes(e.editorTypeName),f=!e.parentKey.startsWith("shared");if(u&&f){const d={targetId:a.id,id:t.generateNonConflictingId(),type:e.editorTypeName,name:e.getName(),hidden:e.hidden,select:!0};e.isEntry()&&(d.collective=e.collective);const h=e.isGroup()||e.isEntry()?"entryLinks":"infoLinks";Ce({[h]:d}),c[c.length-1].key=h,hs(t,c,d),We(d,t,o,this.get_system(t.getSystemId()))}})(),this.set_catalogue_changed(t,!0),this.set_catalogue_changed(r,!0)},async open(e,t,r){var l;let n=document.getElementById("editor-entries");if(!n)return;async function s(u){const f=ve(u);Ne(f).showInEditor=!0,f.open(),await f.$nextTick()}async function i(u){const f=ve(u);f.close(),await f.$nextTick()}const o=pe(e);if(!(o!=null&&o.length))return;if(n=n.getElementsByClassName(`depth-0 ${o[0].key}`)[0],!n){r!==!0&&console.error("Couldn't find root element for",o[0].key,"in",e.catalogue.getName());return}await this.show(e,!1),await s(n);const c=[];wr(e,u=>{c.push(u)}),c.pop(),c.reverse(),c.push(e),c[0].parentKey==="sharedProfiles"&&c.unshift({parentKey:`label-${c[0].typeName??"Untyped"}`});const a=c[c.length-1];for(let u=0;u<c.length;u++){const f=c[u],d=n.getElementsByClassName(`depth-${u+1} ${f.parentKey}`);let h;if(f.parentKey.startsWith("label-"))h=d[0];else{const g=[];for(let p=0;p<d.length;p++)g.push(d[p]);h=g.find(p=>$toRaw(Ne(ve(p)))===$toRaw(f))}h||r!==!0&&console.error("Couldn't find path to",e.getName(),e,"parent:",(l=e.parent)==null?void 0:l.getName()),h&&(n=h),f!==a&&await s(n),f===a&&(t===!1?await i(n):t===!0&&await s(n))}return n},async goto_catalogue(e,t){var o,c,a;const r=this.$router;if(!r)throw new Error("Cannot follow link to another catalogue without $router set");const s=((o=r.currentRoute)==null?void 0:o.query)??((a=(c=r.currentRoute)==null?void 0:c.value)==null?void 0:a.query),i=(s==null?void 0:s.id)||(s==null?void 0:s.systemId);return e!==i?(r.push({name:"catalogue",query:{systemId:t||e,id:e}}),this.$nextTick=new Promise((l,u)=>{this.$nextTickResolve=l}),await this.$nextTick,!0):!1},async show(e,t=!0){this.filtered.includes(e)||this.filtered.push(e),e.showInEditor=!0,e.showChildsInEditor=!0,t&&(e.highlight=!0),wr(e,r=>{r.showInEditor=!0})},async goto(e){const t=e.getCatalogue();this.put_current_state_in_history();const r=Tr();r.get_data(t.id).selection=pe(e),await this.goto_catalogue(t.id,t.gameSystemId),this.show(e,!1),await this.scrollto(e)},async scroll_to_el(e){e.scrollIntoView({block:"center",inline:"start",behavior:"instant"})},async scrollto(e){const t=await this.open(e);if(t){const r=ve(t);this.do_select(null,r,r),this.scroll_to_el(t)}else setTimeout(async()=>{const r=await this.open(e);if(r){const n=ve(r);this.do_select(null,n,n),this.scroll_to_el(r)}},50)},can_goto(e){return e?typeof e=="object"&&e instanceof R:!1},can_follow(e){return!!(e!=null&&e.target)},async follow(e){e!=null&&e.target&&await this.goto(e.target)},async move_up(e){if(e.parent){const t=e.parent[e.parentKey],r=t.indexOf(e);if(r>0){const n=t.splice(r,1)[0];t.splice(r-1,0,n)}}},async move_down(e){if(e.parent){const t=e.parent[e.parentKey],r=t.indexOf(e);if(r>=0&&r<t.length-1){const n=t.splice(r,1)[0];t.splice(r+1,0,n)}}},get_leftpanel_open_collapsible_boxes(){function e(r,n,s=0){const i=`depth-${s} collapsible-box opened`,o=r.getElementsByClassName(i);if(o!=null&&o.length)for(var c=0;c<o.length;c++){const a=o[c],l=Ne(ve(a)),u=l.parentKey,f=l.parent;if(f){const d=f[u];if(!d||!Array.isArray(d))continue;const h=d.indexOf(l);u in n||(n[u]={}),h in n[u]||(n[u][h]={}),e(a,n[u][h],s+1)}else{const d=[];for(var c=0;c<a.classList.length;c++){const p=a.classList[c];d.push(p)}const h=d.filter(g=>st.has(g)||g.startsWith("label-"));for(const g of h)n[g]={},n[g][0]={};e(a,n[h[0]][0],s+1)}}}const t={};return e(document.documentElement,t),t},get_leftpanel_state(){if(!this.catalogueComponent)return{};const e={},t=this.catalogueComponent.$refs.leftpanel;for(const r of Object.keys(mc))e[r]=t[r];return e},get_current_state(){var r;const e=this.get_selected(),t=(r=this.catalogueComponent)==null?void 0:r.cat;return{...this.get_leftpanel_state(),mode:this.mode,open:this.get_leftpanel_open_collapsible_boxes(),selection:e?pe(e):void 0,catalogueId:t==null?void 0:t.id,systemId:t==null?void 0:t.gameSystemId}},save_state(){if(this.catalogueComponent&&this.catalogueComponent.cat){const e=this.catalogueComponent.cat.id,t=Tr(),r=this.get_current_state();t.set_state(e,r)}},async load_state(e){this.catalogueComponent&&(Tr().set_state(e.catalogueId,e),this.mode=e.mode||"edit",await this.goto_catalogue(e.catalogueId,e.systemId)||(this.catalogueComponent.load_state(e),this.rerender_catalogue()))},put_state_in_history(e){if(this.historyStackPos<this.historyStack.length){const t=this.historyStack.length-this.historyStackPos;this.historyStack.splice(this.historyStackPos,t,e)}else this.historyStack.push(e);this.historyStackPos=this.historyStack.length},put_current_state_in_history(){this.catalogueComponent&&this.catalogueComponent.cat&&this.put_state_in_history(this.get_current_state())},can_back(){return this.historyStackPos>0},async back(){this.can_back()&&(this.historyStack[this.historyStackPos]=this.get_current_state(),this.historyStackPos-=1,this.load_state(this.historyStack[this.historyStackPos]))},can_forward(){if(this.historyStack[this.historyStack.length-1])return this.historyStackPos<this.historyStack.length-1},async forward(){this.can_forward()&&(this.historyStackPos+=1,this.load_state(this.historyStack[this.historyStackPos]))},async update_catalogue_search(e,t){const{filter:r,ignoreProfilesRules:n}=t,s=this.filtered;for(const i of s)delete i.showInEditor,delete i.showChildsInEditor,delete i.highlight,wr(i,o=>{delete o.showInEditor,delete i.showChildsInEditor});if(r.length>1){this.set_filter(r),this.filtered=e.findOptionsByText(r),n&&(this.filtered=this.filtered.filter(i=>!i.isProfile()&&!i.isRule()&&!i.isInfoGroup()));for(const i of this.filtered)this.show(i);if(await(globalThis.$nextTick&&globalThis.$nextTick()),this.filtered.length<300){for(const i of this.filtered)if(i.parent)try{await this.open(i,!1,!0)}catch{continue}}}else this.set_filter(""),this.filtered=[];return this.filtered},async system_search(e,t,r=1e3){const n=[],{filter:s}=t;if(!s)return null;const i=Fr(s);let o=!1;await e.loadAll();for(const a of e.getAllLoadedCatalogues())if(a.forEachObjectWhitelist((l,u)=>{var f;try{if(n.length>=r||l.targetId&&l.target&&l.target.isCategory()&&!(u!=null&&u.isForce()))return;const d=(f=l.getName)==null?void 0:f.call(l),h=l.$text,g=l.description,p=l.id;(p===s||d&&String(d).match(i)||p===s||h&&String(h).match(i)||g&&String(g).match(i))&&n.push(l)}catch(d){console.error("Error while searching:",d)}}),n.length>=r){o=!0;break}console.log("Search for",`"${s}"`,"found",n.length,"results");const c={};for(const a of n)Je(c,a.catalogue.name,a);return{grouped:c,all:n,more:o}},async open_catalogue(e,t){const r=await this.get_or_load_system(e);let n=r.getLoadedCatalogue({targetId:t||e});n||(n=await r.loadCatalogue({targetId:t||e})),globalThis.$catalogue=n,n.processForEditor();for(const s of n.imports)s.processForEditor();return{system:r,catalogue:n}},add_child(...e){return this.add_node(...e)},del_child(...e){return this.del_node(...e)},edit_child(...e){return this.edit_node(...e)}}});export{Wn as A,cc as B,Il as C,Te as D,mc as L,Qi as P,nr as a,Xe as b,ye as c,Cl as d,Ne as e,ve as f,Sl as g,Tr as h,Se as i,je as j,pe as k,no as l,fs as m,lc as n,xl as o,Nl as p,ys as q,dl as r,Vr as s,rc as t,Tl as u,Ys as v,nc as w,gr as x,Ol as y,kl as z};
//# sourceMappingURL=editorStore.81b5f509.js.map
