var $i=Object.defineProperty;var Gi=(e,t,r)=>t in e?$i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var b=(e,t,r)=>(Gi(e,typeof t!="symbol"?t+"":t,r),r);import{a5 as As,a6 as ee,a7 as xe,a8 as Ri,a9 as Rr,aa as Bi,ab as Ue,ac as Br,j as X,ad as Fi,J as Ki,ae as De,af as br,ag as Mi,ah as Ui,ai as zi,aj as Un,ak as zn,a3 as vn,e as qi,p as zt,al as qt,am as Ps,a4 as $s,an as Wi,ao as qn,ap as ji,B as pe,aq as Di}from"./entry.592442ae.js";function Vi(e){if(!e.constraints)return e;const t=[];for(const n of e.constraints)if(n.type==="exactly"){const s={...n,id:n.id+"-min",type:"min"},i={...n,id:n.id+"-max",type:"max"};t.push(s,i)}else t.push(n);const r=As(e);return r.constraints=t,r}function Ji(e){if(!e.modifiers&&!e.modifierGroups||!e.constraintsIterator)return e;const t={};for(const i of e.constraintsIterator())i.type==="exactly"&&(t[i.id]=i);function r(i){const o=[];for(const c of i)if(c.field in t){const a={...c,field:c.field+"-min"},l={...c,field:c.field+"-max"};o.push(a,l)}else o.push(c);return o}function n(i){const o=[];for(const c of i){const a={...c};a.modifiers&&(a.modifiers=r(a.modifiers)),a.modifierGroups&&(a.modifierGroups=n(a.modifierGroups)),o.push(a)}return o}const s=As(e);return s.modifiers&&(s.modifiers=r(s.modifiers)),s.modifierGroups&&(s.modifierGroups=n(s.modifierGroups)),s}const Hi=["modifiers","modifierGroups","constraints","entryLinks","categoryLinks","selectionEntries","selectionEntryGroups","infoLinks","infoGroups","rules","profiles"],Gs=["profile","rule","infoLink","infoGroup","selectionEntry","selectionEntryGroup","entryLink","profiles","rules","infoLinks","infoGroups","entryLinks","selectionEntries","selectionEntryLinks","selectionEntryGroups","categoryLinks","costTypes","profileTypes","characteristicTypes","categoryEntries","categories","forceEntries","forces","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","rules","rootRules","publications","catalogueLinks","constraints","characteristics","costs"],Xi=["conditions","conditionGroups","modifiers","modifierGroups","repeats"],bn=new Set([...Gs,...Xi]),Yi=new Set(Gs);function ye(e){if(e.isCatalogue&&e.isCatalogue())return e;if(e.gameSystem)return e.gameSystem;if(e.catalogue)return e.catalogue;throw Error("getDataObject data argument is not a valid system or catalogue")}function Wn(e){if(e.isCatalogue&&e.isCatalogue()){if(e.id&&e.gameSystemId)return`${e.gameSystemId}-${e.id}`;if(e.id)return`${e.id}`}if(e.catalogue)return`${e.catalogue.gameSystemId}-${e.catalogue.id}`;if(e.gameSystem)return e.gameSystem.id;throw Error("getDataId data argument is not a valid system or catalogue")}class R{constructor(t){b(this,"id");b(this,"type");b(this,"subType");b(this,"shared");b(this,"import");b(this,"collective");b(this,"comment");b(this,"publicationId");b(this,"typeName");b(this,"typeId");b(this,"categoryEntryId");b(this,"name");b(this,"hidden");b(this,"value");b(this,"page");b(this,"defaultAmount");b(this,"profiles");b(this,"rules");b(this,"infoLinks");b(this,"infoGroups");b(this,"publications");b(this,"costs");b(this,"selectionEntries");b(this,"selectionEntryGroups");b(this,"entryLinks");b(this,"profileTypes");b(this,"categoryEntries");b(this,"categoryLinks");b(this,"forceEntries");b(this,"sharedSelectionEntryGroups");b(this,"sharedSelectionEntries");b(this,"sharedProfiles");b(this,"sharedRules");b(this,"sharedInfoGroups");b(this,"target");b(this,"modifiers");b(this,"modifierGroups");b(this,"constraints");b(this,"repeats");b(this,"conditions");b(this,"conditionGroups");b(this,"catalogue");b(this,"extra_constraints");b(this,"childs");b(this,"loaded");b(this,"collective_recursive");b(this,"limited_to_one");b(this,"associations");b(this,"associationConstraints");b(this,"flatten");b(this,"sortIndex");return Object.setPrototypeOf(t,Object.getPrototypeOf(this))}get url(){return"%{main_catalogue|catalogue}/%{id}/%{getName}"}process(){this.loaded||(this.collective_recursive=this.isCollectiveRecursive(),this.limited_to_one=!this.canAmountBeAbove1(),this.loaded=!0)}toJson(){return jt(this)}getCatalogue(){return this.catalogue}getGameSystem(){return this.getCatalogue().getGameSystem()}get[Symbol.toStringTag](){return globalThis.isEditor?"Object":"ObjectNoObserve"}isGroup(){return!1}isForce(){return!1}isCatalogue(){return!1}isLink(){return!1}isCategory(){return!1}isRoster(){return!1}isQuantifiable(){return!1}isEntry(){return!1}isIdUnique(){return!1}isRule(){return!1}isProfile(){return!1}isInfoGroup(){return!1}isUnit(){for(const t of this.categoryLinks||[])if(t.primary)return!0;return!1}getId(){return this.id}getType(){return this.subType??this.type}getTypeName(){return this.typeName}getCategoryEntryId(){return this.categoryEntryId}getHidden(){return this.hidden}getPage(){return this.page}getName(){return this.name}getDefaultAmount(){return this.defaultAmount}isCollective(){return this.collective}isCollectiveRecursive(){const t=[...this.selectionsIterator()];for(;t.length;){const r=t.pop();if(!r.isCollective()&&!r.isGroup())return!1;t.push(...r.selectionsIterator())}return!0}isEmptyNode(){for(const t of Hi)if(this[t]!==void 0)return!1;return!0}*forcesIterator(){}*associationsIterator(){this.associations&&(yield*this.associations)}*profilesIterator(){var t;for(const r of kt(this))r.profiles&&(yield*r.profiles),r.infoLinks&&(yield*(t=r.infoLinks)==null?void 0:t.filter(n=>n.type==="profile").map(n=>n.target))}*rulesIterator(){var t;for(const r of kt(this))r.rules&&(yield*r.rules),r.infoLinks&&(yield*(t=r.infoLinks)==null?void 0:t.filter(n=>n.type==="rule").map(n=>n.target))}*constraintsIterator(){this.constraints&&(yield*this.constraints)}*extraConstraintsIterator(){this.extra_constraints&&(yield*this.extra_constraints)}*modifierGroupsIterator(){this.modifierGroups&&(yield*this.modifierGroups)}*modifiersIterator(){this.modifiers&&(yield*this.modifiers)}*modifierGroupsIteratorRecursive(){yield this,this.isLink()&&(yield this.target);for(const t of this.modifierGroupsIterator())yield t,yield*nr(t.modifierGroups)}*selectionsIterator(){this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*localSelectionsIterator(){this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*nodesIterator(){this.isLink()&&(yield*this.target.nodesIterator()),this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.isLink()&&(yield*this.target.entriesIterator()),this.selectionEntries&&(yield*this.selectionEntries),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks),this.childs&&(yield*this.childs)}*iterateSelectionEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups)}*iterateSelectionEntriesWithRoot(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups)}*iterateRootEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.forceEntries&&(yield*this.forceEntries)}*iterateAllRootEntries(){this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.forceEntries&&(yield*this.forceEntries)}*categoryLinksIterator(){this.categoryLinks&&(yield*this.categoryLinks)}*infoLinksIterator(){this.infoLinks&&(yield*this.infoLinks)}*infoGroupsIterator(){this.infoGroups&&(yield*this.infoGroups)}*infoRulesIterator(){if(this.isForce()){const t=this.getGameSystem();t.rules&&(yield*t.rules);const r=this.main_catalogue;r.rules&&(yield*r.rules)}this.rules&&(yield*this.rules)}*infoProfilesIterator(){this.profiles&&(yield*this.profiles)}forEachCond(t,r=0){if(t(this,0)===void 0)for(const n of this.selectionsIterator())n.forEachCond(t,r+1)}forEach(t){t(this);for(const r of this.selectionsIterator())r.forEach(t)}forEachNode(t){t(this);for(const r of this.nodesIterator())r.forEachNode(t)}forEachNodeCb(t){const r=[this],n=new Set;for(;r.length;){const s=r.pop();if(!n.has(s.id)){if(n.add(s.id),t(s),s.childs){r.push(...s.childs);continue}if(s.target){const i=s.target;i.selectionEntries&&r.push(...i.selectionEntries),i.selectionEntryGroups&&r.push(...i.selectionEntryGroups),i.entryLinks&&r.push(...i.entryLinks)}s.selectionEntries&&r.push(...s.selectionEntries),s.selectionEntryGroups&&r.push(...s.selectionEntryGroups),s.entryLinks&&r.push(...s.entryLinks)}}}forEachObjectWhitelist(t,r=bn){const n=[this];for(;n.length;){const s=n.pop();for(const i in s){const o=s[i];if(r.has(i)&&ee(o))if(Array.isArray(o)){if(o.length&&ee(o[0]))for(let c=0;c<o.length;c++){const a=o[c];t(a,s),n.push(a)}}else t(o,s),n.push(o)}}}forEachObject(t,r=new Set){const n=[this];for(;n.length;){const s=n.pop();for(const i of Object.keys(s)){const o=s[i];if(!r.has(i)&&ee(o))if(Array.isArray(o)){if(o.length&&ee(o[0]))for(let c=o.length;c--;){const a=o[c];t(a,s),n.push(a)}}else t(o,s),n.push(o)}}}findOption(t){for(const r of this.selectionsIterator())if(t(r))return r}findOptionRecursive(t){const r=[...this.selectionsIterator()];for(;r.length;){const n=r.pop();if(t(n))return n}}getCosts(){return this.costs||[]}getPrimaryCategory(){for(const t of this.categoryLinks||[])if(t.primary)return t.targetId;return this.getCategoryEntryId()??Ce}getPrimaryCategoryLink(){for(const t of this.categoryLinks||[])if(t.primary)return t}getBoundConstraint(t){const r=Object.assign({},t);r.name=this.getName(),r.parent=this;const n=t.shared||this instanceof Rs;r.childId=this.isLink()&&n?this.targetId:this.id,r.scope="self",r.modifiers=[];for(const s of this.modifiersIterator())(s.field===t.id||s.field==="hidden")&&r.modifiers.push(s);r.modifierGroups=[];for(const s of this.modifierGroupsIterator())e:for(const i of nr([s]))for(const o of i.modifiers||[])if(o.field===t.id||o.field==="hidden"){r.modifierGroups.push(s);break e}return r}getChildBoundConstraints(t){const r=[];for(const n of this.selectionsIterator())if(!(t&&n.isGroup())){for(const s of n.constraintsIterator())(s.type==="min"||s.type==="exactly")&&s.scope==="parent"&&r.push(n.getBoundConstraint(s));n.isGroup()&&r.push(...n.getChildBoundConstraints())}return r}canAmountBeAbove1(){const t=Zi(this.constraintsIterator(),[...this.modifierGroupsIterator(),{modifiers:[...this.modifiersIterator()]}]);return!t.length||t.includes(-1)?!0:Math.min(...t)>1}hasOption(t){let r;return this.forEachCond(n=>(n.getName()===t&&(r=!0),r)),!!r}}class wr extends R{isEntry(){return!0}isQuantifiable(){return!0}isIdUnique(){return!0}}class _r extends R{getDefaultSelectionEntryId(){return this.defaultSelectionEntryId}isGroup(){return!0}isIdUnique(){return!0}}class et extends R{constructor(){super(...arguments);b(this,"targetId")}isLink(){return!0}isGroup(){var r;return(r=this.target)==null?void 0:r.isGroup()}isCategory(){var r;return(r=this.target)==null?void 0:r.isCategory()}isQuantifiable(){var r;return(r=this.target)==null?void 0:r.isQuantifiable()}isEntry(){var r;return(r=this.target)==null?void 0:r.isEntry()}isIdUnique(){return!1}isProfile(){var r;return((r=this.target)==null?void 0:r.isProfile())||!1}isRule(){var r;return((r=this.target)==null?void 0:r.isRule())||!1}isInfoGroup(){var r;return((r=this.target)==null?void 0:r.isInfoGroup())||!1}isUnit(){if(this.target.isUnit())return!0;for(const r of this.categoryLinks||[])if(r.primary)return!0;return!1}getId(){return this.targetId}getType(){var r;return(r=this.target)==null?void 0:r.getType()}getPage(){var r;return this.page||((r=this.target)==null?void 0:r.page)}getHidden(){return this.target.hidden||this.hidden}getDefaultSelectionEntryId(){var r;return this.defaultSelectionEntryId||((r=this.target)==null?void 0:r.getDefaultSelectionEntryId())}getCategoryEntryId(){var r;return this.categoryEntryId??((r=this.target)==null?void 0:r.categoryEntryId)}get associationConstraints(){return this.target.associationConstraints}get associations(){var r;return(r=this.target)==null?void 0:r.associations}isCollective(){var r;return super.isCollective()||((r=this.target)==null?void 0:r.isCollective())}*extraConstraintsIterator(){yield*this.target.extraConstraintsIterator(),yield*super.extraConstraintsIterator()}*associationsIterator(){yield*this.target.associationsIterator(),yield*super.associationsIterator()}*rulesIterator(){yield*this.target.rulesIterator(),yield*super.rulesIterator()}*profilesIterator(){yield*this.target.profilesIterator(),yield*super.profilesIterator()}*constraintsIterator(){this.target&&(yield*this.target.constraintsIterator()),yield*super.constraintsIterator()}*modifierGroupsIterator(){yield*this.target.modifierGroupsIterator(),yield*super.modifierGroupsIterator()}*modifiersIterator(){yield*this.target.modifiersIterator(),yield*super.modifiersIterator()}*selectionsIterator(){yield*this.target.selectionsIterator(),yield*super.selectionsIterator()}*categoryLinksIterator(){yield*this.target.categoryLinksIterator(),yield*super.categoryLinksIterator()}*infoLinksIterator(){yield*this.target.infoLinksIterator(),yield*super.infoLinksIterator()}*infoGroupsIterator(){yield*this.target.infoGroupsIterator(),yield*super.infoGroupsIterator()}*infoRulesIterator(){yield*this.target.infoRulesIterator(),yield*super.infoRulesIterator()}*infoProfilesIterator(){yield*this.target.infoProfilesIterator(),yield*super.infoProfilesIterator()}getDefaultAmount(){return this.defaultAmount===void 0?this.target.defaultAmount:this.defaultAmount}getName(){var r;return((r=this.target)==null?void 0:r.name)||this.name}getParent(){return this.parent}getPrimaryCategory(){for(const r of this.categoryLinks||[])if(r.primary)return r.targetId;for(const r of this.target.categoryLinks||[])if(r.primary)return r.targetId;return this.getCategoryEntryId()??Ce}getPrimaryCategoryLink(){for(const r of this.categoryLinks||[])if(r.primary)return r;for(const r of this.target.categoryLinks||[])if(r.primary)return r}getCosts(){var n;const r={};if((n=this.target)!=null&&n.costs)for(const s of this.target.costs)r[s.typeId]=s;if(this.costs)for(const s of this.costs)r[s.typeId]=s;return Object.values(r)}}et.prototype.keyInfoCache={};class Qi extends et{getTypeName(){var t;return(t=this.target)==null?void 0:t.typeName}}class Rs extends et{constructor(){super(...arguments);b(this,"primary");b(this,"main_catalogue")}get units(){return this.target.units}*selectionsIterator(){yield*this.target.units}isEmpty(){return this.target.isEmpty()}}const Ce="(No Category)",Er="(Illegal Units)";class ht extends R{constructor(){super(...arguments);b(this,"units");b(this,"main_catalogue")}isCategory(){return!0}*selectionsIterator(){yield*this.units}isEmpty(){return!this.units.length}isIdUnique(){return!this.isEmptyNode()}}class kr extends R{constructor(){super(...arguments);b(this,"categories");b(this,"forces");b(this,"main_catalogue")}isForce(){return!0}isEntry(){return!0}isIdUnique(){return!0}*selectionsIterator(){yield*this.categories,this.forces&&(yield*this.forces)}*rulesIterator(){var r;for(const n of kt(this))n.rules&&(yield*n.rules),n.infoLinks&&(yield*(r=n.infoLinks)==null?void 0:r.filter(s=>s.type==="rule").map(s=>s.target));this.main_catalogue&&(yield*this.main_catalogue.rulesIterator())}generateForces(r){const n=[];for(const s of this.forceEntries||[]){const i=xe(s);i.main_catalogue=this.main_catalogue;const o=[];for(const c of s.categoryLinks||[])c.targetId in r&&o.push(r[c.targetId]);i.categories=o,this.main_catalogue.index[i.id]=i,n.push(i)}return this.forces=n,n}isEmpty(){for(const r of this.categories)if(!r.isEmpty())return!1;return!0}*forcesIterator(){this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const r of this.forces)yield r,yield*r.forcesIteratorRecursive()}}const Ir=1/0;function Zi(e,t){var s,i,o,c;const r=[];function n(a){r.push(a)}for(const a of e){const l=r.length;if(a.field!=="selections"||a.type!=="max")continue;if(a.value>1){n(a.value);continue}let u=a.value;for(const f of nr(t))for(const d of f.modifiers||[])if(d.field===a.id){if(d.type==="increment"){if((s=f.repeats)!=null&&s.length||(i=d.repeats)!=null&&i.length){n(Ir);continue}if(u+=d.value,u>1){n(u);continue}}if(d.type==="decrement"&&d.value<0){if((o=f.repeats)!=null&&o.length||(c=d.repeats)!=null&&c.length){n(Ir);continue}if(u-=d.value,u>1){n(u);continue}}if(d.type==="set"&&d.value>1){if(d.value===-1){n(Ir);continue}n(d.value)}}l===r.length&&n(u)}return r}class eo extends R{}class pt extends R{isProfile(){return!0}getTypeName(){return this.typeName}isIdUnique(){return!0}}class jn extends R{constructor(){super(...arguments);b(this,"originalValue")}getLabel(){var r;return this.catalogue?((r=this.catalogue.findOptionById(this.typeId))==null?void 0:r.getName())??this.typeId:this.typeId}getTypeName(){return this.getLabel()}getName(){return`${this.getLabel()} = ${this.$text}`}}class xr extends R{isInfoGroup(){return!0}isIdUnique(){return!0}}const Dn=new Set(["any","model","unit","upgrade","mount","crew"]);class Be extends R{}class Fr extends Be{}class wn extends R{}class Bs extends R{}class Wt extends R{getDescription(){return Array.isArray(this.description)?this.description.join(`
`):this.description}isRule(){return!0}isIdUnique(){return!0}}function*kt(e){yield e;for(const t of e.infoGroups||[])yield*kt(t);for(const t of e.infoLinks||[])t.type==="infoGroup"&&(yield*kt(t.target))}function*nr(e){if(e)for(const t of e)yield t,yield*nr(t.modifierGroups)}const Fs=new Set(["costTypes","costs","categoryEntries","forceEntries","sharedSelectionEntries","selectionEntries","sharedSelectionEntryGroups","selectionEntryGroups","entryLinks","infoLinks","categoryLinks","catalogueLinks","sharedProfiles","profiles","profileTypes","characteristics","characteristicTypes","sharedInfoGroups","infoGroups","sharedRules","rules","publications","associations","modifierGroups","modifiers","constraints","conditionGroups","conditions","repeats"]),st=new Set([...Fs,"defaultAmount","id","import","importRootEntries","name","hidden","field","scope","value","percentValue","shared","includeChildSelections","includeChildForces","childId","type","targetId","primary","typeId","collective","$text","page","typeName","defaultSelectionEntryId","revision","battleScribeVersion","authorName","authorContact","authorUrl","library","gameSystemId","gameSystemRevision","xmlns","readme","description","comment","publicationDate","publisher","publisherId","publisherUrl","shortName","repeats","roundUp","defaultCostLimit","publicationId","label","labelMembers","maxAssociationsPerMember","ids","min","max","of","flatten","sortIndex","subType","costTypeId","profileTypeId","characteristicTypeId","value"]);function Kr(e,t=!1){const r={catalogue:void 0,gameSystem:void 0},n={...e};e.gameSystemId?(r.catalogue=n,r.catalogue.type="catalogue",delete r.gameSystem):(r.gameSystem=n,r.gameSystem.type="gameSystem",delete r.catalogue);const s=t?ye(r):r;return JSON.stringify(s,(o,c)=>{if(!(Array.isArray(c)&&c.length===0)&&(c===n||st.has(o)||isFinite(Number(o))))return ee(c)?Vi(Ji(c)):c})}function jt(e,t){return JSON.stringify(e,function(n,s){if(!(Array.isArray(s)&&s.length===0)&&(st.has(n)||isFinite(Number(n))||t!=null&&t.has(n)))return s})}function to(e,t,r){const n=(r==null?void 0:r.forceArray)===!1;return e=Array.isArray(e)&&(e==null?void 0:e.length)===1&&n?e[0]:e,JSON.stringify(e,function(i,o){if(st.has(i)||isFinite(Number(i))||t!=null&&t.has(i))return o},(r==null?void 0:r.formatted)===!0?2:void 0)}function Dt(e,t,r=bn){for(const n in e)if(r.has(n)){const s=e[n];if(Array.isArray(s)&&s.length&&ee(s[0]))for(let i=0;i<s.length;i++){const o=s[i];t(o,e),Dt(o,t,r)}}}const _n=new Set(["force","roster","self","parent","ancestor","primary-category","force","roster","primary-catalogue"]),ro=new Set(["any","unit","model","upgrade","mount","crew"]);function no(e,t){if(_n.has(t))return!0;const n=e.catalogue.findOptionById(t);if(n&&(n.isForce()||n.isCategory()||n.isCatalogue()))return!0;const s=[e];for(;s.length;){const i=s.pop();if(i.id===t)return!0;i.parent&&s.push(i.parent)}return!1}function Xe(e){return Ri(e,r=>!(r instanceof wn||r instanceof Be||r instanceof Bs))}function so(e,t){if(!e||!t)return;const r=e.getCatalogue();if(e.parent){const s=Xe(e);if(s){for(const i of s.constraintsIterator())if(i.id===t)return i}}return r==null?void 0:r.findOptionById(t)}function Ae(e,t){if(t===void 0)return"";if(e){if(t.startsWith("limit::"))return`limit::${Ae(e,Rr(t,"limit::"))}`;const r=e.catalogue||e,n=so(e,t);if(n){const i=n.type;if(i&&["min","max","exactly"].includes(i))return io(e,n);if(n.name)return n.isCategory&&n.isCategory()?`${n.name}`:n.url?`${n.name}`:n.name}const s=r.manager;if(s){const i=r.manager.findOptionById(t)||s.getCatalogueInfo({targetId:t});return(i==null?void 0:i.name)||t}}return t}function Vn(e,t,r=!1,n=Ae){const s=t.type||"none",i=t.value===void 0?1:t.percentValue?`${t.value}%`:t.value,o=n(e,t.field),c=["selections","forces"].includes(o)?` ${o}`:` ${n(e,o)}`,a=n(e,t.childId||"")+(r?`(${t.childId||"any"})`:""),l=a&&c?"of ":"",u=n(e,t.scope),f=u===(e==null?void 0:e.getName())?"":`${u}`,d=t.includeChildSelections?" (recursive)":"",h=f?` in ${f}${d}`:"";switch(s){case"instanceOf":return`${f} is ${a}`;case"notInstanceOf":return`${f} is not ${a}`;case"atLeast":return`${i}+${c} ${l}${a}${h}`;case"greaterThan":return`${Number(i)+1}+${c} ${l}${a}${h}`;case"atMost":return`${i}${i===0?"":"-"}${c} ${l}${a}${h}`;case"lessThan":return`${Number(i)-1}${Number(i)-1===0?"":"-"}${c} ${l}${a}${h}`;case"equalTo":return`${i}${c} ${l}${a}${h}`;case"notEqualTo":return`not ${i}${c} ${l}${a}${h}`;case"none":return`${c} ${l}${a}${h}`;default:return`${s} ${i}${c} ${l}${a}${h}`}}function io(e,t,r=Ae){if(!Bi(e.constraintsIterator(),t))return t.id;const n=t.field==="selections"?"":` ${r(e,t.field)}`,s=t.scope==="parent"?"":`(${r(e,t.scope)})`,i=t.childId?` ${r(e,t.childId)}`:"";return`${t.type}${n}${i}${s}`}function oo(e,t,r=Ae){var n;return`${t.type} ${r(e,t.field)} ${r(e,(n=t.value)==null?void 0:n.toString())}`}typeof $toRaw>"u"&&(globalThis.$toRaw=function(e){return e});class En extends R{constructor(){super(...arguments);b(this,"targetId");b(this,"importRootEntries")}isLink(){return!1}}class Jn extends R{constructor(){super(...arguments);b(this,"shortName");b(this,"publisher");b(this,"publicationDate");b(this,"publisherUrl")}}class sr extends R{constructor(){super(...arguments);b(this,"library");b(this,"revision");b(this,"gameSystemId");b(this,"gameSystemRevision");b(this,"authorContact");b(this,"authorName");b(this,"authorUrl");b(this,"battleScribeVersion");b(this,"costTypes");b(this,"catalogueLinks");b(this,"gameSystem");b(this,"initialized");b(this,"loaded_wiki");b(this,"loaded_editor");b(this,"imports");b(this,"importsWithEntries");b(this,"index");b(this,"unresolvedLinks",{});b(this,"forces");b(this,"categories");b(this,"units");b(this,"roster_constraints");b(this,"manager");b(this,"book");b(this,"short");b(this,"version");b(this,"nrversion");b(this,"lastUpdated");b(this,"costIndex");b(this,"fullFilePath");b(this,"errors")}reset(){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.loaded_wiki;for(const r of this.imports||[])delete r.initialized,delete r.loaded,delete r.loaded_editor,delete r.loaded_wiki}init(r=!0){this.initialized||(this.initialized=!0,this.generateImports(r),this.resolveAllLinks(r),this.generateCostIndex())}process(){if(this.loaded)return;this.loaded=!0,this.init();const r=this.generateUnits(),n=this.generateCategories(r);this.categories=Object.values(n),this.generateForces(n),this.generateExtraConstraints(),console.log("processed",this.name)}processForWiki(r){if(this.loaded_wiki)return;this.loaded_wiki=!0,this.process();const n=r.rules||{};r.rules=n,this.imports.forEach(i=>{Ue(i,"links",this)});function s(i,o){i.parent=o,i.target&&Ue(i.target,"links",o),i instanceof Wt&&(n[i.id]=i)}Dt(this,s,Yi);for(const i of this.forces||[]){i.parent=this;for(const o of i.categories)o.parent=i}}processForEditor(){this.loaded_editor||(this.loaded_editor=!0,this.init(!1),this.gameSystem&&Ue(this.gameSystem,"links",this),Dt(this,(r,n)=>{if(r.parent=n,r.catalogue=this,r.links||(r.links=[]),r.other_links||(r.other_links=[]),r.target&&Ue(r.target,"links",r),r.isProfile()&&!r.isLink()){const i=this.findOptionById(r.typeId);i&&Ue(i,"links",r)}const s=r.value;if(s){const i=this.findOptionById(s);i&&Ue(i,"other_links",r)}this.refreshErrors(r)},Fs))}get url(){return"%{book}"}isCatalogue(){return!0}isGameSystem(){return this.gameSystemId===this.id||!this.gameSystemId}isIdUnique(){return!0}getCatalogue(){return this}getGameSystem(){return this.isGameSystem()?this:this.gameSystem}getSystemId(){return this.isGameSystem()?this.id:this.gameSystemId}addError(r,n){this.removeError(r,n.id),r.errors||(r.errors=[]),this.errors||(this.errors=[]),r.errors.push(n),this.errors.push(n)}onRemoveError(r,n=!0){if(this.errors){const s=this.errors.indexOf(r);s>=0&&this.errors.splice(s,1)}if(r.other&&n){const s=r.other;s.getCatalogue().removeError(s,"duplicate-id-1",!1),s.getCatalogue().removeError(s,"duplicate-id-2",!1)}}removeErrors(r){var n;(n=r.errors)==null||n.forEach(s=>this.onRemoveError(s)),r instanceof Fr&&r.catalogue.updateConstraint(r,!0),delete r.errors}removeError(r,n,s=!0){var i;(i=r.errors)!=null&&i.length&&(r.errors=r.errors.filter(o=>(o.id===n&&this.onRemoveError(o,s),o.id!==n)))}*iterateCategoryEntries(){for(const r of this.imports)for(const n of r.categoryEntries||[])yield n;this.categoryEntries&&(yield*this.categoryEntries)}*iterateCostTypes(){for(const r of this.imports)for(const n of r.costTypes||[])yield n;this.costTypes&&(yield*this.costTypes)}*forcesIterator(){for(const r of this.imports)for(const n of r.forceEntries||[])yield n;this.forceEntries&&(yield*this.forceEntries)}*forcesIteratorRecursive(){if(this.forces)for(const r of this.forces)yield r,yield*r.forcesIteratorRecursive()}*iterateProfileTypes(){for(const r of this.importsWithEntries)r.profileTypes&&(yield*r.profileTypes);this.profileTypes&&(yield*this.profileTypes)}*iteratePublications(){for(const r of this.imports)for(const n of r.publications||[])yield n;for(const r of this.publications||[])yield r}*iterateSelectionEntries(){for(const r of this.importsWithEntries){for(const n of r.sharedSelectionEntries||[])yield n;for(const n of r.sharedSelectionEntryGroups||[])yield n}this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllImported(){const r=["sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","categoryEntries"],n=["rules","entryLinks","profiles","infoGroups","selectionEntries","selectionEntryGroups"];for(const s of this.importsWithEntries)for(const i of n)for(const o of s[i]||[])o.import!==!1&&(yield o);for(const s of this.imports)for(const i of r)for(const o of s[i]||[])yield o;for(const s of n)for(const i of this[s]||[])yield i;for(const s of r)for(const i of this[s]||[])yield i}*iterateSelectionEntriesWithRoot(){for(const r of this.importsWithEntries){for(const n of r.selectionEntries||[])n.import!==!1&&(yield n);for(const n of r.entryLinks||[])n.import!==!1&&(yield n);for(const n of r.sharedSelectionEntries||[])yield n;for(const n of r.sharedSelectionEntryGroups||[])yield n}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks),this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups)}*iterateAllRootEntries(){for(const r of this.importsWithEntries){for(const n of r.selectionEntries||[])n.import!==!1&&(yield n);for(const n of r.entryLinks||[])n.import!==!1&&(yield n)}this.selectionEntries&&(yield*this.selectionEntries),this.entryLinks&&(yield*this.entryLinks)}*entriesIterator(){this.sharedSelectionEntries&&(yield*this.sharedSelectionEntries),this.selectionEntries&&(yield*this.selectionEntries),this.sharedSelectionEntryGroups&&(yield*this.sharedSelectionEntryGroups),this.selectionEntryGroups&&(yield*this.selectionEntryGroups),this.entryLinks&&(yield*this.entryLinks)}forEachNode(r){if(r(this),this.childs)for(const n of this.childs)n.forEachNode(r)}*selectionsIterator(){yield*this.forces}findOptionById(r){var i;const n=this.index[r];if(n)return n;const s=(i=this.imports.find(o=>r in o.index))==null?void 0:i.index[r];if(s)return s;if(this.manager&&r)return this.manager.getLoadedCatalogue(r)??this.manager.getCatalogueInfo({targetId:r})}findOptionByIdGlobal(r){var i;const n=this.index[r];if(n)return n;const s=(i=this.imports.find(o=>r in o.index))==null?void 0:i.index[r];if(s)return s;if(this.manager){const o=this.manager.findOptionById(r);return o||this.manager.getCatalogueInfo({targetId:r})}}findOptionsById(r){const n=[];for(const s of[this,...this.imports])for(const i of Object.values(s.index))i.id&&i.id===r&&n.push(i);return n}findOptionsByText(r){var i,o,c;if(!r||!r.trim()){const a=[];for(const l of[this,...this.imports])for(const u of Object.values(l.index))if(u.getName){if(u.isLink()&&u.target&&u.isCategory()&&!((i=u.parent)!=null&&i.isForce()))continue;a.push(u)}else console.log(u);return a}const n=[],s=Br(r);for(const a of[this,...this.imports])for(const l of Object.values(a.index)){const u=(o=l.getName)==null?void 0:o.call(l),f=l.id;if(u&&String(u).match(s)||f===r){if(l.isLink()&&l.target&&l.isCategory()&&!((c=l.parent)!=null&&c.isForce()))continue;n.push(l)}}return n}generateNonConflictingId(){for(;;){const r=X();if(this.findOptionById(r)===void 0)return r}}generateCostIndex(){const r={};for(const n of this.imports)for(const s of n.costTypes||[])r[s.id]=s,this.index[s.id]=s;for(const n of this.costTypes||[])r[n.id]=n,this.index[n.id]=n;return this.costIndex=r,r}generateImports(r=!0){const n={},s={};this.gameSystem&&(this.gameSystem.init(r),n[this.gameSystem.id]=this.gameSystem,s[this.gameSystem.id]=this.gameSystem,this.gameSystem.import||(this.gameSystem.imports=[]));for(const i of this.catalogueLinks||[]){const o=i.target;if(o){o.init(r);for(const c of o.imports)s[c.id]=c;for(const c of o.importsWithEntries)n[c.id]=c;i.importRootEntries&&(n[o.id]=o),s[o.id]=o}}return this.imports=Object.values(s),this.importsWithEntries=Object.values(n),this.imports}generateForces(r){var s,i;const n=[];for(const o of this.forcesIterator()){const c=xe(o);c.main_catalogue=this;const a=[];(i=(s=r[Ce])==null?void 0:s.units)!=null&&i.length&&a.push(r[Ce]);const l=new Set;for(const f of o.categoryLinks||[])if(f.targetId in r){const d=xe(f);d.main_catalogue=this;const h=r[d.targetId];d.target=h,d.childs=h.childs;for(const g of d.childs)l.add(g.id);a.push(d)}for(const f of o.categoryEntries||[])if(f.id in r){const d=r[f.id],h=xe(d);h.main_catalogue=this;for(const g of h.childs)l.add(g.id);a.push(h)}const u=this.units.filter(f=>!l.has(f.id));if(u.length){const f=xe(r[Er]);f.childs=u,f.units=u,a.push(f)}c.childs=a,c.categories=a,this.index[c.id]=c,c.forceEntries&&c.generateForces(r),n.push(c)}return this.forces=n,this.childs=n,n}generateCategories(r){const n={},s=new Set;for(const a of this.iterateCategoryEntries()){const l=xe(a);l.main_catalogue=this;const u=r[l.id]||[];l.units=u,l.childs=u,this.index[a.id]=a,n[l.id]=l,s.add(l.id)}for(const a in r)if(!s.has(a)){const l=this.findOptionById(a);if(l){const u=xe(l);u.main_catalogue=this;const f=r[u.id]||[];u.units=f,u.childs=f,this.index[l.id]=l,n[u.id]=u}}const i=r[Ce]||[],o={name:"Uncategorized",id:Ce,hidden:!1,units:i,childs:i,catalogue:this};n[Ce]=Object.setPrototypeOf(o,ht.prototype);const c={name:"Illegal Units",id:Er,hidden:!0,units:[],childs:[],catalogue:this};return n[Er]=Object.setPrototypeOf(c,ht.prototype),n}generateUnits(){const r=[];for(const i of this.importsWithEntries){const o=i.isGameSystem();for(const c of i.selectionEntries||[])(o||c.import!==!1)&&r.push(c);for(const c of i.entryLinks||[])(o||c.import!==!1)&&r.push(c)}for(const i of this.selectionEntries||[])r.push(i);for(const i of this.entryLinks||[])r.push(i);const n=Fi(r,i=>i.getName());return this.units=n,Ki(n,i=>i.getPrimaryCategory())}generateExtraConstraints(){const r={},n=[],s={},i=new Set,o={};function c(a,l,u){const f=l.target||l;for(const d of u){const h=`${d.id}::${l.id}`;switch(d.scope){case"parent":break;case"roster":r[h]=l.getBoundConstraint(d);break;case"force":n.push(l.getBoundConstraint(d));break;case"primary-category":case"primary-catalogue":break;default:if(i.has(d.scope)){De(s,d.scope,f.getBoundConstraint(d));break}const g=a.index[d.scope];if(g){const p=g.extra_constraints||[];p.push(l.getBoundConstraint(d)),g.extra_constraints=p;break}break}}}for(const a of this.forcesIteratorRecursive())i.add(a.id);for(const a of this.categories)i.add(a.id);for(const a of this.categories){c(this,a,a.constraintsIterator());const l={};a.forEachNodeCb(u=>{var f;if(u&&!u.isForce()&&(!u.isGroup()&&!u.extra_constraints&&(u.extra_constraints=u.getChildBoundConstraints(!0)),!(u.isCategory()&&u.isLink())&&!(!u.constraints&&!((f=u.target)!=null&&f.constraints)))){for(const d of u.constraintsIterator())if(d.type==="min"||d.type==="exactly"){const h=`${d.id}::${u.id}`;switch(d.scope){case"parent":break;case"roster":r[h]=u.getBoundConstraint(d);break;case"force":l[h]=u.getBoundConstraint(d);break;case"primary-category":case"primary-catalogue":break;default:if(i.has(d.scope)){De(s,d.scope,u.getBoundConstraint(d));break}const g=this.index[d.scope];if(g){const p=g.extra_constraints||[];p.push(u.getBoundConstraint(d)),g.extra_constraints=p;break}break}}}}),o[a.getId()]=Object.values(l)}for(const a of this.forcesIteratorRecursive()){const l=a.extra_constraints||[];l.push(...n),a.id in s&&l.push(...s[a.id]),l.length&&(a.extra_constraints=l);for(const u of a.categories)u.getId()in o&&l.push(...o[u.getId()]);l.length&&(a.extra_constraints=l)}for(const a of this.categories){const l=a.extra_constraints||[];a.id in s&&l.push(...s[a.id]),l.length&&(a.extra_constraints=l)}this.roster_constraints=Object.values(r)}async reload(r=this.manager){delete this.initialized,delete this.loaded,delete this.loaded_editor,delete this.index;const n=this.isGameSystem()?"gameSystem":"catalogue",s=await r.loadData({[n]:this});return this.processForEditor(),s}refreshErrors(r,n=!1){var s,i;r.isLink()?r.target?(this.removeError(r,"no-target"),br(this.unresolvedLinks,r.targetId,$toRaw(r)),br(this.manager.unresolvedLinks,r.targetId,$toRaw(r))):(this.addError(r,{source:r,severity:"error",msg:`(${r.editorTypeName}) ${r.name} has no target`,id:"no-target"}),!((s=this.unresolvedLinks[r.targetId])!=null&&s.includes($toRaw(r)))&&!n&&De(this.unresolvedLinks,r.targetId,$toRaw(r)),(i=this.manager.unresolvedLinks[r.targetId])!=null&&i.includes($toRaw(r))||De(this.manager.unresolvedLinks,r.targetId,$toRaw(r))):r.isProfile()?r.typeId?this.removeError(r,"no-profile-type"):this.addError(r,{source:r,severity:"error",msg:"Profile has no type",id:"no-profile-type"}):r instanceof Be&&this.updateCondition(r)}addToIndex(r){var n,s,i,o,c,a;if(r.id){if(r.catalogue=this,(s=(n=this.manager)==null?void 0:n.settings)!=null&&s.globalDuplicateIdError){const l=this.manager.index;if(l[r.id]&&l[r.id]!==r&&(r.isIdUnique()||l[r.id].isIdUnique())){const u=l[r.id],f=u.getCatalogue(),d=this!==f;f&&d&&(f.addError(u,{source:u,severity:"error",msg:`Duplicate id ${r.id} ${r.getName()}`,id:"duplicate-id-1",other:r,extra:f.name}),f.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${u.getName()}`,id:"duplicate-id-2",other:u,extra:this.name})),this.addError(u,{source:u,severity:"error",msg:`Duplicate id ${r.id}  ${r.getName()}`,id:"duplicate-id-1",other:r,extra:d?f.name:void 0}),this.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${u.getName()}`,id:"duplicate-id-2",other:u,extra:d?this.name:void 0})}l[r.id]=r}else if(this.index[r.id]&&this.index[r.id]!==r){const l=this.index[r.id];(r.isIdUnique()||l.isIdUnique()||r.getName()!==l.getName())&&(this.addError(l,{source:l,severity:"error",msg:`Duplicate id ${r.id} ${r.getName()}`,id:"duplicate-id-1",other:r}),this.addError(r,{source:r,severity:"error",msg:`Duplicate id ${r.id} ${l.getName()}`,id:"duplicate-id-2",other:l}))}if(this.index[r.id]=r,this.unresolvedLinks&&this.unresolvedLinks[r.id])for(const l of[...this.unresolvedLinks[r.id]])l.isLink()?this.updateLink(l):this.refreshErrors(l);if((i=this.manager)!=null&&i.unresolvedLinks&&((o=this.manager.unresolvedLinks[r.id])!=null&&o.length))for(const l of[...this.manager.unresolvedLinks[r.id]])l.isLink()?(c=l.catalogue)==null||c.updateLink(l):(a=l.catalogue)==null||a.refreshErrors(l)}}removeFromIndex(r){r.id&&$toRaw(this.index[r.id])===$toRaw(r)&&delete this.index[r.id],this.removeErrors(r);for(const n of r.links||[])delete n.target,n.catalogue.refreshErrors(n);for(const n of r.other_links||[])n.catalogue.refreshErrors(n,!0)}getIndexes(){const r=[];r.push(this.index);for(const n of this.imports)r.push(n.index);return r}resolveAllLinks(r=!0){const n=[],s=[],i=[];this.index=fo(),Dt(this,(a,l)=>{this.addToIndex(a),a.publicationId&&(delete a.publication,s.push(a)),a.isLink()&&(delete a.target,n.push(a),i.push(l)),lo(a)},bn);const o=this.getIndexes(),c=ao(n,o,i,r);if(co(s,o),!r){this.unresolvedLinks={};for(const a of c)De(this.unresolvedLinks,a.targetId,$toRaw(a)),delete a.target}}removeRef(r,n){n.links||(n.links=[]);const s=n.links.indexOf(r);s>=0&&n.links.splice(s,1)}addRef(r,n){n.links||(n.links=[]),n.links.indexOf(r)===-1&&n.links.push(r)}hasOtherRef(r,n){return n.other_links&&n.other_links.includes(r)}removeOtherRef(r,n){n.other_links||(n.other_links=[]);const s=n.other_links.indexOf(r);s>=0&&n.other_links.splice(s,1)}addOtherRef(r,n){n.other_links||(n.other_links=[]),n.other_links.indexOf(r)===-1&&n.other_links.push(r)}updateLink(r){r.target&&this.removeRef(r,r.target);const n=Ks(r.targetId,this.getIndexes());if(n!=null&&n.isLink()){console.warn(`Failed to resolve link (target is a link): ${r.getName()}(${r.id})`),r.catalogue.addError(r,{id:"bad-link-target",msg:"Link target Cannot be a Link",source:r});return}else{if(r.catalogue.removeError(r,"bad-link-target"),r.target=n,r.target){this.addRef(r,r.target);const s=r.target.editorTypeName;s=="category"?delete r.type:r.type=s}return this.refreshErrors(r),r.target!==void 0}}updateConstraint(r,n=!1){var o,c,a,l;const s=new Set,i=new Set;for(const u of((o=r.parent)==null?void 0:o.constraintsIterator())||[])n&&r===u||(s.has(u.id)?i.add(u.id):s.add(u.id));for(const u of((c=r.parent)==null?void 0:c.constraintsIterator())||[])n&&r===u||(i.has(u.id)?(a=u.catalogue)==null||a.addError(u,{id:"duplicate-constraint-id",msg:"Duplicate constraints id",source:r}):(l=u.catalogue)==null||l.removeError(u,"duplicate-constraint-id"))}updateCondition(r,n){if(r.scope){const i=Xe(r);if(i&&!no(i,r.scope)?this.addError(r,{source:r,id:"invalid-scope",msg:`Invalid scope ${r.scope}`}):this.removeError(r,"invalid-scope"),r.scope&&!_n.has(r.scope)){const o=this.findOptionById(r.scope);o&&o.getCatalogue().addOtherRef(r,o)}}if(r instanceof Fr)return this.updateConstraint(r);const s=["instanceOf","notInstanceOf"].includes(r.type);if(n&&!Dn.has(n)){const i=s?this.findOptionByIdGlobal(n):this.findOptionById(n);i&&this.removeOtherRef(r,i)}if(r.childId){if(Dn.has(r.childId)){this.removeError(r,"id-not-exist");return}const i=s?this.findOptionByIdGlobal(r.childId):this.findOptionById(r.childId);if(i){this.hasOtherRef(r,i)||this.addOtherRef(r,i),this.removeError(r,"id-not-exist"),br(this.manager.unresolvedLinks,r.childId,$toRaw(r));return}}this.addError(r,{source:r,severity:"warning",msg:"child id does not exist",id:"id-not-exist"}),Mi(this.manager.unresolvedLinks,r.childId,$toRaw(r))}unlinkLink(r){r.target&&this.removeRef(r,r.target)}}function Ks(e,t){for(const r of t)if(e in r)return r[e]}function ao(e=[],t,r,n=!0){e.length;let s=0;for(;e.length!==s;){const i=e,o=r;s=i.length,e=[],r=[];for(let c=0;c<i.length;c++){const a=i[c],l=o[c],u=a.targetId,f=Ks(u,t);if(f){f.isLink()?console.warn(`Failed to resolve link (target is a link): ${a.getName()}(${a.id})`):a.target=f;continue}e.push(a),r.push(l)}}if(e.length&&n)for(let i=0;i<e.length;i++){const o=e[i],c=r[i];for(const[a,l]of Object.entries(c))if(l===o&&delete c[a],Array.isArray(l))for(const u in l)l[u]===o&&l.splice(u,1)}return e}function co(e=[],t){for(const r of e)for(const n of t)if(r.publicationId in n){r.publication=n[r.publicationId];break}}function lo(e){return e.shared!==!1&&e.childId!==void 0}let uo=class{get[Symbol.toStringTag](){return"ObjectNoObserve"}};function fo(){return new uo}function Ms(e){return e.arrayBuffer?e.arrayBuffer():new Promise((t,r)=>{const n=new FileReader;n.addEventListener("loadend",()=>{t(n.result)}),n.addEventListener("error",r),n.readAsArrayBuffer(e)})}async function ho(e){const t=await Ms(e);return new Uint8Array(t)}function Us(e){return typeof Blob<"u"&&e instanceof Blob}function It(e){return typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer}const po=typeof process<"u"&&process.versions&&typeof process.versions.node<"u"&&typeof process.versions.electron>"u";function go(e){return e.byteOffset===0&&e.byteLength===e.buffer.byteLength}class Hn{constructor(t){this.typedArray=t instanceof ArrayBuffer||It(t)?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}async getLength(){return this.typedArray.byteLength}async read(t,r){return new Uint8Array(this.typedArray.buffer,this.typedArray.byteOffset+t,r)}}class Xn{constructor(t){this.blob=t}async getLength(){return this.blob.size}async read(t,r){const n=this.blob.slice(t,t+r),s=await Ms(n);return new Uint8Array(s)}async sliceAsBlob(t,r,n=""){return this.blob.slice(t,t+r,n)}}function yo(e,t){var r=Uint8Array;if(e[0]==3&&e[1]==0)return t||new r(0);var n=vo,s=zs,i=mo,o=qs,c=t==null;c&&(t=new r(e.length>>>2<<3));for(var a=0,l=0,u=0,f=0,d=0,h=0,g=0,p=0,y=0,m,v;a==0;){if(a=n(e,y,1),l=n(e,y+1,2),y+=3,l==0){y&7&&(y+=8-(y&7));var w=(y>>>3)+4,k=e[w-4]|e[w-3]<<8;c&&(t=Sr(t,p+k)),t.set(new r(e.buffer,e.byteOffset+w,k),p),y=w+k<<3,p+=k;continue}if(c&&(t=Sr(t,p+(1<<17))),l==1&&(m=N.flmap,v=N.fdmap,h=512-1,g=32-1),l==2){u=s(e,y,5)+257,f=s(e,y+5,5)+1,d=s(e,y+10,4)+4,y+=14;for(var _=0;_<38;_+=2)N.itree[_]=0,N.itree[_+1]=0;for(var E=1,_=0;_<d;_++){var I=s(e,y+_*3,3);N.itree[(N.ordr[_]<<1)+1]=I,I>E&&(E=I)}y+=3*d,gt(N.itree,E),yt(N.itree,E,N.imap),m=N.lmap,v=N.dmap,y=i(N.imap,(1<<E)-1,u+f,e,y,N.ttree);var T=Yn(N.ttree,0,u,N.ltree);h=(1<<T)-1;var S=Yn(N.ttree,u,f,N.dtree);g=(1<<S)-1,gt(N.ltree,T),yt(N.ltree,T,m),gt(N.dtree,S),yt(N.dtree,S,v)}for(;;){var A=m[o(e,y)&h];y+=A&15;var L=A>>>4;if(!(L>>>8))t[p++]=L;else{if(L==256)break;var U=p+L-254;if(L>264){var F=N.ldef[L-257];U=p+(F>>>3)+s(e,y,F&7),y+=F&7}var $=v[o(e,y)&g];y+=$&15;var he=$>>>4,re=N.ddef[he],z=(re>>>4)+n(e,y,re&15);for(y+=re&15,c&&(t=Sr(t,p+(1<<17)));p<U;)t[p]=t[p++-z],t[p]=t[p++-z],t[p]=t[p++-z],t[p]=t[p++-z];p=U}}}return t.length==p?t:t.slice(0,p)}function Sr(e,t){var r=e.length;if(t<=r)return e;var n=new Uint8Array(Math.max(r<<1,t));return n.set(e,0),n}function mo(e,t,r,n,s,i){for(var o=zs,c=qs,a=0;a<r;){var l=e[c(n,s)&t];s+=l&15;var u=l>>>4;if(u<=15)i[a]=u,a++;else{var f=0,d=0;u==16?(d=3+o(n,s,2),s+=2,f=i[a-1]):u==17?(d=3+o(n,s,3),s+=3):u==18&&(d=11+o(n,s,7),s+=7);for(var h=a+d;a<h;)i[a]=f,a++}}return s}function Yn(e,t,r,n){for(var s=0,i=0,o=n.length>>>1;i<r;){var c=e[i+t];n[i<<1]=0,n[(i<<1)+1]=c,c>s&&(s=c),i++}for(;i<o;)n[i<<1]=0,n[(i<<1)+1]=0,i++;return s}function gt(e,t){for(var r=e.length,n,s,i,o,c,a=N.bl_count,o=0;o<=t;o++)a[o]=0;for(o=1;o<r;o+=2)a[e[o]]++;var l=N.next_code;for(n=0,a[0]=0,s=1;s<=t;s++)n=n+a[s-1]<<1,l[s]=n;for(i=0;i<r;i+=2)c=e[i+1],c!=0&&(e[i]=l[c],l[c]++)}function yt(e,t,r){for(var n=e.length,s=N.rev15,i=0;i<n;i+=2)if(e[i+1]!=0)for(var o=i>>1,c=e[i+1],a=o<<4|c,l=t-c,u=e[i]<<l,f=u+(1<<l);u!=f;){var d=s[u]>>>15-t;r[d]=a,u++}}function Qn(e,t){for(var r=N.rev15,n=15-t,s=0;s<e.length;s+=2){var i=e[s]<<t-e[s+1];e[s]=r[i]>>>n}}function zs(e,t,r){return(e[t>>>3]|e[(t>>>3)+1]<<8)>>>(t&7)&(1<<r)-1}function vo(e,t,r){return(e[t>>>3]|e[(t>>>3)+1]<<8|e[(t>>>3)+2]<<16)>>>(t&7)&(1<<r)-1}function qs(e,t){return(e[t>>>3]|e[(t>>>3)+1]<<8|e[(t>>>3)+2]<<16)>>>(t&7)}const N=function(){var e=Uint16Array,t=Uint32Array;return{next_code:new e(16),bl_count:new e(16),ordr:[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],of0:[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,999,999,999],exb:[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0],ldef:new e(32),df0:[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,65535,65535],dxb:[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0],ddef:new t(32),flmap:new e(512),fltree:[],fdmap:new e(32),fdtree:[],lmap:new e(32768),ltree:[],ttree:[],dmap:new e(32768),dtree:[],imap:new e(512),itree:[],rev15:new e(32768),lhst:new t(286),dhst:new t(30),ihst:new t(19),lits:new t(15e3),strt:new e(65536),prev:new e(32768)}}();(function(){for(var e=32768,t=0;t<e;t++){var r=t;r=(r&2863311530)>>>1|(r&1431655765)<<1,r=(r&3435973836)>>>2|(r&858993459)<<2,r=(r&4042322160)>>>4|(r&252645135)<<4,r=(r&4278255360)>>>8|(r&16711935)<<8,N.rev15[t]=(r>>>16|r<<16)>>>17}function n(s,i,o){for(;i--!=0;)s.push(0,o)}for(var t=0;t<32;t++)N.ldef[t]=N.of0[t]<<3|N.exb[t],N.ddef[t]=N.df0[t]<<4|N.dxb[t];n(N.fltree,144,8),n(N.fltree,255-143,9),n(N.fltree,279-255,7),n(N.fltree,287-279,8),gt(N.fltree,9),yt(N.fltree,9,N.flmap),Qn(N.fltree,9),n(N.fdtree,32,5),gt(N.fdtree,5),yt(N.fdtree,5,N.fdmap),Qn(N.fdtree,5),n(N.itree,19,0),n(N.ltree,286,0),n(N.dtree,30,0),n(N.ttree,320,0)})();const Zn={table:function(){for(var e=new Uint32Array(256),t=0;t<256;t++){for(var r=t,n=0;n<8;n++)r&1?r=3988292384^r>>>1:r=r>>>1;e[t]=r}return e}(),update:function(e,t,r,n){for(var s=0;s<n;s++)e=Zn.table[(e^t[r+s])&255]^e>>>8;return e},crc:function(e,t,r){return Zn.update(4294967295,e,t,r)^4294967295}};function bo(e,t){return yo(e,t)}const es={numWorkers:1,workerURL:"",useWorkers:!1};let wo=0;const Vt=[];function Cr(e){return new Promise((t,r)=>{const n=new Worker(e);n.onmessage=s=>{s.data==="start"?(n.onerror=void 0,n.onmessage=void 0,t(n)):r(new Error(`unexpected message: ${s.data}`))},n.onerror=r})}function _o(e,t){return e.require?e.require(t):{}}(function(){if(po){const{Worker:e}=_o(module,"worker_threads");return{async createWorker(t){return new e(t)},addEventListener(t,r){t.on("message",n=>{r({target:t,data:n})})},async terminate(t){await t.terminate()}}}else return{async createWorker(e){try{return await Cr(e)}catch{console.warn("could not load worker:",e)}let t;try{const r=await fetch(e,{mode:"cors"});if(!r.ok)throw new Error(`could not load: ${e}`);t=await r.text(),e=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));const n=await Cr(e);return es.workerURL=e,n}catch{console.warn("could not load worker via fetch:",e)}if(t!==void 0)try{e=`data:application/javascript;base64,${btoa(t)}`;const r=await Cr(e);return es.workerURL=e,r}catch{console.warn("could not load worker via dataURI")}throw console.warn("workers will not be used"),new Error("can not start workers")},addEventListener(e,t){e.addEventListener("message",t)},async terminate(e){e.terminate()}}})();function Eo(e,t,r,n){const s=new Uint8Array(t);bo(e,s),n(r?new Blob([s],{type:r}):s.buffer)}async function ko(){if(Vt.length!==0)for(;Vt.length;){const{src:e,uncompressedSize:t,type:r,resolve:n}=Vt.shift();let s=e;Us(e)&&(s=await ho(e)),Eo(s,t,r,n)}}function Ws(e,t,r){return new Promise((n,s)=>{Vt.push({src:e,uncompressedSize:t,type:r,resolve:n,reject:s,id:wo++}),ko()})}function Io(e,t){const r=e&31,n=(e>>5&15)-1,s=(e>>9&127)+1980,i=0,o=(t&31)*2,c=t>>5&63,a=t>>11&31;return new Date(s,n,r,a,c,o,i)}class xo{constructor(t,r){this._reader=t,this._rawEntry=r,this.name=r.name,this.nameBytes=r.nameBytes,this.size=r.uncompressedSize,this.compressedSize=r.compressedSize,this.comment=r.comment,this.commentBytes=r.commentBytes,this.compressionMethod=r.compressionMethod,this.lastModDate=Io(r.lastModFileDate,r.lastModFileTime),this.isDirectory=r.uncompressedSize===0&&r.name.endsWith("/"),this.encrypted=!!(r.generalPurposeBitFlag&1),this.externalFileAttributes=r.externalFileAttributes,this.versionMadeBy=r.versionMadeBy}async blob(t="application/octet-stream"){return await Ro(this._reader,this._rawEntry,t)}async arrayBuffer(){return await Go(this._reader,this._rawEntry)}async text(){const t=await this.arrayBuffer();return mt(new Uint8Array(t))}async json(){const t=await this.text();return JSON.parse(t)}}const Nr=22,So=65535,Co=101010256,No=101075792;async function tt(e,t,r){return await e.read(t,r)}async function Mr(e,t,r,n){return e.sliceAsBlob?await e.sliceAsBlob(t,r,n):await e.read(t,r)}const Oo={unsigned(){return 0}};function W(e,t){return e[t]+e[t+1]*256}function V(e,t){return e[t]+e[t+1]*256+e[t+2]*65536+e[t+3]*16777216}function Oe(e,t){return V(e,t)+V(e,t+4)*4294967296}const To=new TextDecoder;function mt(e,t){return It(e.buffer)&&(e=new Uint8Array(e)),To.decode(e)}async function Lo(e,t){const r=Math.min(Nr+So,t),n=t-r,s=await tt(e,n,r);for(let i=r-Nr;i>=0;--i){if(V(s,i)!==Co)continue;const o=new Uint8Array(s.buffer,s.byteOffset+i,s.byteLength-i),c=W(o,4);if(c!==0)throw new Error(`multi-volume zip files are not supported. This is volume: ${c}`);const a=W(o,10),l=V(o,12),u=V(o,16),f=W(o,20),d=o.length-Nr;if(f!==d)throw new Error(`invalid comment length. expected: ${d}, actual: ${f}`);const h=new Uint8Array(o.buffer,o.byteOffset+22,f),g=mt(h);return a===65535||u===4294967295?await Po(e,n+i,g,h):await js(e,u,l,a,g,h)}throw new Error("could not find end of central directory. maybe not zip file")}const Ao=117853008;async function Po(e,t,r,n){const s=t-20,i=await tt(e,s,20);if(V(i,0)!==Ao)throw new Error("invalid zip64 end of central directory locator signature");const o=Oe(i,8),c=await tt(e,o,56);if(V(c,0)!==No)throw new Error("invalid zip64 end of central directory record signature");const a=Oe(c,32),l=Oe(c,40),u=Oe(c,48);return js(e,u,l,a,r,n)}const $o=33639248;async function js(e,t,r,n,s,i){let o=0;const c=await tt(e,t,r),a=[];for(let u=0;u<n;++u){const f=c.subarray(o,o+46),d=V(f,0);if(d!==$o)throw new Error(`invalid central directory file header signature: 0x${d.toString(16)}`);const h={versionMadeBy:W(f,4),versionNeededToExtract:W(f,6),generalPurposeBitFlag:W(f,8),compressionMethod:W(f,10),lastModFileTime:W(f,12),lastModFileDate:W(f,14),crc32:V(f,16),compressedSize:V(f,20),uncompressedSize:V(f,24),fileNameLength:W(f,28),extraFieldLength:W(f,30),fileCommentLength:W(f,32),internalFileAttributes:W(f,36),externalFileAttributes:V(f,38),relativeOffsetOfLocalHeader:V(f,42)};if(h.generalPurposeBitFlag&64)throw new Error("strong encryption is not supported");o+=46;const g=c.subarray(o,o+h.fileNameLength+h.extraFieldLength+h.fileCommentLength);h.nameBytes=g.slice(0,h.fileNameLength),h.name=mt(h.nameBytes);const p=h.fileNameLength+h.extraFieldLength,y=g.slice(h.fileNameLength,p);h.extraFields=[];let m=0;for(;m<y.length-3;){const w=W(y,m+0),k=W(y,m+2),_=m+4,E=_+k;if(E>y.length)throw new Error("extra field length exceeds extra field buffer size");h.extraFields.push({id:w,data:y.slice(_,E)}),m=E}if(h.commentBytes=g.slice(p,p+h.fileCommentLength),h.comment=mt(h.commentBytes),o+=g.length,h.uncompressedSize===4294967295||h.compressedSize===4294967295||h.relativeOffsetOfLocalHeader===4294967295){const w=h.extraFields.find(E=>E.id===1);if(!w)throw new Error("expected zip64 extended information extra field");const k=w.data;let _=0;if(h.uncompressedSize===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include uncompressed size");h.uncompressedSize=Oe(k,_),_+=8}if(h.compressedSize===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include compressed size");h.compressedSize=Oe(k,_),_+=8}if(h.relativeOffsetOfLocalHeader===4294967295){if(_+8>k.length)throw new Error("zip64 extended information extra field does not include relative header offset");h.relativeOffsetOfLocalHeader=Oe(k,_),_+=8}}const v=h.extraFields.find(w=>w.id===28789&&w.data.length>=6&&w.data[0]===1&&V(w.data,1),Oo.unsigned(h.nameBytes));if(v&&(h.fileName=mt(v.data.slice(5))),h.compressionMethod===0){let w=h.uncompressedSize;if(h.generalPurposeBitFlag&1&&(w+=12),h.compressedSize!==w)throw new Error(`compressed size mismatch for stored file: ${h.compressedSize} != ${w}`)}a.push(h)}return{zip:{comment:s,commentBytes:i},entries:a.map(u=>new xo(e,u))}}async function Ds(e,t){if(t.generalPurposeBitFlag&1)throw new Error("encrypted entries not supported");const r=await tt(e,t.relativeOffsetOfLocalHeader,30),n=await e.getLength(),s=V(r,0);if(s!==67324752)throw new Error(`invalid local file header signature: 0x${s.toString(16)}`);const i=W(r,26),o=W(r,28),c=t.relativeOffsetOfLocalHeader+r.length+i+o;let a;if(t.compressionMethod===0)a=!1;else if(t.compressionMethod===8)a=!0;else throw new Error(`unsupported compression method: ${t.compressionMethod}`);const l=c,u=l+t.compressedSize;if(t.compressedSize!==0&&u>n)throw new Error(`file data overflows file bounds: ${l} +  ${t.compressedSize}  > ${n}`);return{decompress:a,fileDataStart:l}}async function Go(e,t){const{decompress:r,fileDataStart:n}=await Ds(e,t);if(!r){const o=await tt(e,n,t.compressedSize);return go(o)?o.buffer:o.slice().buffer}const s=await Mr(e,n,t.compressedSize);return await Ws(s,t.uncompressedSize)}async function Ro(e,t,r){const{decompress:n,fileDataStart:s}=await Ds(e,t);if(!n){const c=await Mr(e,s,t.compressedSize,r);return Us(c)?c:new Blob([It(c.buffer)?new Uint8Array(c):c],{type:r})}const i=await Mr(e,s,t.compressedSize);return await Ws(i,t.uncompressedSize,r)}async function Bo(e){let t;if(typeof Blob<"u"&&e instanceof Blob)t=new Xn(e);else if(e instanceof ArrayBuffer||e&&e.buffer&&e.buffer instanceof ArrayBuffer)t=new Hn(e);else if(It(e)||It(e.buffer))t=new Hn(e);else if(typeof e=="string"){const n=await fetch(e);if(!n.ok)throw new Error(`failed http request ${e}, status: ${n.status}: ${n.statusText}`);const s=await n.blob();t=new Xn(s)}else if(typeof e.getLength=="function"&&typeof e.read=="function")t=e;else throw new Error("unsupported source type");const r=await t.getLength();if(r>Number.MAX_SAFE_INTEGER)throw new Error(`file too large. size: ${r}. Only file sizes up 4503599627370496 bytes are supported`);return await Lo(t,r)}async function Vs(e){const{zip:t,entries:r}=await Bo(e);return{zip:t,entries:Object.fromEntries(r.map(n=>[n.name,n]))}}var kn={},In={};(function(e){const t=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",r=t+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",n="["+t+"]["+r+"]*",s=new RegExp("^"+n+"$"),i=function(c,a){const l=[];let u=a.exec(c);for(;u;){const f=[];f.startIndex=a.lastIndex-u[0].length;const d=u.length;for(let h=0;h<d;h++)f.push(u[h]);l.push(f),u=a.exec(c)}return l},o=function(c){const a=s.exec(c);return!(a===null||typeof a>"u")};e.isExist=function(c){return typeof c<"u"},e.isEmptyObject=function(c){return Object.keys(c).length===0},e.merge=function(c,a,l){if(a){const u=Object.keys(a),f=u.length;for(let d=0;d<f;d++)l==="strict"?c[u[d]]=[a[u[d]]]:c[u[d]]=a[u[d]]}},e.getValue=function(c){return e.isExist(c)?c:""},e.isName=o,e.getAllMatches=i,e.nameRegexp=n})(In);const xn=In,Fo={allowBooleanAttributes:!1,unpairedTags:[]};kn.validate=function(e,t){t=Object.assign({},Fo,t);const r=[];let n=!1,s=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let i=0;i<e.length;i++)if(e[i]==="<"&&e[i+1]==="?"){if(i+=2,i=rs(e,i),i.err)return i}else if(e[i]==="<"){let o=i;if(i++,e[i]==="!"){i=ns(e,i);continue}else{let c=!1;e[i]==="/"&&(c=!0,i++);let a="";for(;i<e.length&&e[i]!==">"&&e[i]!==" "&&e[i]!=="	"&&e[i]!==`
`&&e[i]!=="\r";i++)a+=e[i];if(a=a.trim(),a[a.length-1]==="/"&&(a=a.substring(0,a.length-1),i--),!Do(a)){let f;return a.trim().length===0?f="Invalid space after '<'.":f="Tag '"+a+"' is an invalid name.",K("InvalidTag",f,Y(e,i))}const l=Uo(e,i);if(l===!1)return K("InvalidAttr","Attributes for '"+a+"' have open quote.",Y(e,i));let u=l.value;if(i=l.index,u[u.length-1]==="/"){const f=i-u.length;u=u.substring(0,u.length-1);const d=ss(u,t);if(d===!0)n=!0;else return K(d.err.code,d.err.msg,Y(e,f+d.err.line))}else if(c)if(l.tagClosed){if(u.trim().length>0)return K("InvalidTag","Closing tag '"+a+"' can't have attributes or invalid starting.",Y(e,o));{const f=r.pop();if(a!==f.tagName){let d=Y(e,f.tagStartPos);return K("InvalidTag","Expected closing tag '"+f.tagName+"' (opened in line "+d.line+", col "+d.col+") instead of closing tag '"+a+"'.",Y(e,o))}r.length==0&&(s=!0)}}else return K("InvalidTag","Closing tag '"+a+"' doesn't have proper closing.",Y(e,i));else{const f=ss(u,t);if(f!==!0)return K(f.err.code,f.err.msg,Y(e,i-u.length+f.err.line));if(s===!0)return K("InvalidXml","Multiple possible root nodes found.",Y(e,i));t.unpairedTags.indexOf(a)!==-1||r.push({tagName:a,tagStartPos:o}),n=!0}for(i++;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="!"){i++,i=ns(e,i);continue}else if(e[i+1]==="?"){if(i=rs(e,++i),i.err)return i}else break;else if(e[i]==="&"){const f=Wo(e,i);if(f==-1)return K("InvalidChar","char '&' is not expected.",Y(e,i));i=f}else if(s===!0&&!ts(e[i]))return K("InvalidXml","Extra text at the end",Y(e,i));e[i]==="<"&&i--}}else{if(ts(e[i]))continue;return K("InvalidChar","char '"+e[i]+"' is not expected.",Y(e,i))}if(n){if(r.length==1)return K("InvalidTag","Unclosed tag '"+r[0].tagName+"'.",Y(e,r[0].tagStartPos));if(r.length>0)return K("InvalidXml","Invalid '"+JSON.stringify(r.map(i=>i.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return K("InvalidXml","Start tag expected.",1);return!0};function ts(e){return e===" "||e==="	"||e===`
`||e==="\r"}function rs(e,t){const r=t;for(;t<e.length;t++)if(e[t]=="?"||e[t]==" "){const n=e.substr(r,t-r);if(t>5&&n==="xml")return K("InvalidXml","XML declaration allowed only at the start of the document.",Y(e,t));if(e[t]=="?"&&e[t+1]==">"){t++;break}else continue}return t}function ns(e,t){if(e.length>t+5&&e[t+1]==="-"&&e[t+2]==="-"){for(t+=3;t<e.length;t++)if(e[t]==="-"&&e[t+1]==="-"&&e[t+2]===">"){t+=2;break}}else if(e.length>t+8&&e[t+1]==="D"&&e[t+2]==="O"&&e[t+3]==="C"&&e[t+4]==="T"&&e[t+5]==="Y"&&e[t+6]==="P"&&e[t+7]==="E"){let r=1;for(t+=8;t<e.length;t++)if(e[t]==="<")r++;else if(e[t]===">"&&(r--,r===0))break}else if(e.length>t+9&&e[t+1]==="["&&e[t+2]==="C"&&e[t+3]==="D"&&e[t+4]==="A"&&e[t+5]==="T"&&e[t+6]==="A"&&e[t+7]==="["){for(t+=8;t<e.length;t++)if(e[t]==="]"&&e[t+1]==="]"&&e[t+2]===">"){t+=2;break}}return t}const Ko='"',Mo="'";function Uo(e,t){let r="",n="",s=!1;for(;t<e.length;t++){if(e[t]===Ko||e[t]===Mo)n===""?n=e[t]:n!==e[t]||(n="");else if(e[t]===">"&&n===""){s=!0;break}r+=e[t]}return n!==""?!1:{value:r,index:t,tagClosed:s}}const zo=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function ss(e,t){const r=xn.getAllMatches(e,zo),n={};for(let s=0;s<r.length;s++){if(r[s][1].length===0)return K("InvalidAttr","Attribute '"+r[s][2]+"' has no space in starting.",ct(r[s]));if(r[s][3]!==void 0&&r[s][4]===void 0)return K("InvalidAttr","Attribute '"+r[s][2]+"' is without value.",ct(r[s]));if(r[s][3]===void 0&&!t.allowBooleanAttributes)return K("InvalidAttr","boolean attribute '"+r[s][2]+"' is not allowed.",ct(r[s]));const i=r[s][2];if(!jo(i))return K("InvalidAttr","Attribute '"+i+"' is an invalid name.",ct(r[s]));if(!n.hasOwnProperty(i))n[i]=1;else return K("InvalidAttr","Attribute '"+i+"' is repeated.",ct(r[s]))}return!0}function qo(e,t){let r=/\d/;for(e[t]==="x"&&(t++,r=/[\da-fA-F]/);t<e.length;t++){if(e[t]===";")return t;if(!e[t].match(r))break}return-1}function Wo(e,t){if(t++,e[t]===";")return-1;if(e[t]==="#")return t++,qo(e,t);let r=0;for(;t<e.length;t++,r++)if(!(e[t].match(/\w/)&&r<20)){if(e[t]===";")break;return-1}return t}function K(e,t,r){return{err:{code:e,msg:t,line:r.line||r,col:r.col}}}function jo(e){return xn.isName(e)}function Do(e){return xn.isName(e)}function Y(e,t){const r=e.substring(0,t).split(/\r?\n/);return{line:r.length,col:r[r.length-1].length+1}}function ct(e){return e.startIndex+e[1].length}var Sn={};const Js={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,r){return e}},Vo=function(e){return Object.assign({},Js,e)};Sn.buildOptions=Vo;Sn.defaultOptions=Js;class Jo{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,r){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:r})}addChild(t){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,[":@"]:t[":@"]}):this.child.push({[t.tagname]:t.child})}}var Ho=Jo;function Xo(e,t){const r={};if(e[t+3]==="O"&&e[t+4]==="C"&&e[t+5]==="T"&&e[t+6]==="Y"&&e[t+7]==="P"&&e[t+8]==="E"){t=t+9;let n=1,s=!1,i=!1,o="";for(;t<e.length;t++)if(e[t]==="<"&&!i){if(s&&Zo(e,t))t+=7,[entityName,val,t]=Yo(e,t+1),val.indexOf("&")===-1&&(r[entityName]={regx:RegExp(`&${entityName};`,"g"),val});else if(s&&ea(e,t))t+=8;else if(s&&ta(e,t))t+=8;else if(s&&ra(e,t))t+=9;else if(Qo)i=!0;else throw new Error("Invalid DOCTYPE");n++,o=""}else if(e[t]===">"){if(i?e[t-1]==="-"&&e[t-2]==="-"&&(i=!1,n--):n--,n===0)break}else e[t]==="["?s=!0:o+=e[t];if(n!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:t}}function Yo(e,t){let r="";for(;t<e.length&&e[t]!=="'"&&e[t]!=='"';t++)r+=e[t];if(r=r.trim(),r.indexOf(" ")!==-1)throw new Error("External entites are not supported");const n=e[t++];let s="";for(;t<e.length&&e[t]!==n;t++)s+=e[t];return[r,s,t]}function Qo(e,t){return e[t+1]==="!"&&e[t+2]==="-"&&e[t+3]==="-"}function Zo(e,t){return e[t+1]==="!"&&e[t+2]==="E"&&e[t+3]==="N"&&e[t+4]==="T"&&e[t+5]==="I"&&e[t+6]==="T"&&e[t+7]==="Y"}function ea(e,t){return e[t+1]==="!"&&e[t+2]==="E"&&e[t+3]==="L"&&e[t+4]==="E"&&e[t+5]==="M"&&e[t+6]==="E"&&e[t+7]==="N"&&e[t+8]==="T"}function ta(e,t){return e[t+1]==="!"&&e[t+2]==="A"&&e[t+3]==="T"&&e[t+4]==="T"&&e[t+5]==="L"&&e[t+6]==="I"&&e[t+7]==="S"&&e[t+8]==="T"}function ra(e,t){return e[t+1]==="!"&&e[t+2]==="N"&&e[t+3]==="O"&&e[t+4]==="T"&&e[t+5]==="A"&&e[t+6]==="T"&&e[t+7]==="I"&&e[t+8]==="O"&&e[t+9]==="N"}var na=Xo;const sa=/^[-+]?0x[a-fA-F0-9]+$/,ia=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;!Number.parseInt&&window.parseInt&&(Number.parseInt=window.parseInt);!Number.parseFloat&&window.parseFloat&&(Number.parseFloat=window.parseFloat);const oa={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function aa(e,t={}){if(t=Object.assign({},oa,t),!e||typeof e!="string")return e;let r=e.trim();if(t.skipLike!==void 0&&t.skipLike.test(r))return e;if(t.hex&&sa.test(r))return Number.parseInt(r,16);{const n=ia.exec(r);if(n){const s=n[1],i=n[2];let o=ca(n[3]);const c=n[4]||n[6];if(!t.leadingZeros&&i.length>0&&s&&r[2]!==".")return e;if(!t.leadingZeros&&i.length>0&&!s&&r[1]!==".")return e;{const a=Number(r),l=""+a;return l.search(/[eE]/)!==-1||c?t.eNotation?a:e:r.indexOf(".")!==-1?l==="0"&&o===""||l===o||s&&l==="-"+o?a:e:i?o===l||s+o===l?a:e:r===l||r===s+l?a:e}}else return e}}function ca(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substr(0,e.length-1))),e}var la=aa;const Cn=In,lt=Ho,ua=na,fa=la;"<((!\\[CDATA\\[([\\s\\S]*?)(]]>))|((NAME:)?(NAME))([^>]*)>|((\\/)(NAME)\\s*>))([^<]*)".replace(/NAME/g,Cn.nameRegexp);let da=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"}},this.addExternalEntities=ha,this.parseXml=va,this.parseTextData=pa,this.resolveNameSpace=ga,this.buildAttributesMap=ma,this.isItStopNode=Ea,this.replaceEntitiesValue=wa,this.readStopNodeData=Ia,this.saveTextToParentTag=_a,this.addChild=ba}};function ha(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];this.lastEntities[n]={regex:new RegExp("&"+n+";","g"),val:e[n]}}}function pa(e,t,r,n,s,i,o){if(e!==void 0&&(this.options.trimValues&&!n&&(e=e.trim()),e.length>0)){o||(e=this.replaceEntitiesValue(e));const c=this.options.tagValueProcessor(t,e,r,s,i);return c==null?e:typeof c!=typeof e||c!==e?c:this.options.trimValues?zr(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?zr(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function ga(e){if(this.options.removeNSPrefix){const t=e.split(":"),r=e.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(e=r+t[1])}return e}const ya=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function ma(e,t,r){if(!this.options.ignoreAttributes&&typeof e=="string"){const n=Cn.getAllMatches(e,ya),s=n.length,i={};for(let o=0;o<s;o++){const c=this.resolveNameSpace(n[o][1]);let a=n[o][4],l=this.options.attributeNamePrefix+c;if(c.length)if(this.options.transformAttributeName&&(l=this.options.transformAttributeName(l)),l==="__proto__"&&(l="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const u=this.options.attributeValueProcessor(c,a,t);u==null?i[l]=a:typeof u!=typeof a||u!==a?i[l]=u:i[l]=zr(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(i[l]=!0)}if(!Object.keys(i).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=i,o}return i}}const va=function(e){e=e.replace(/\r\n?/g,`
`);const t=new lt("!xml");let r=t,n="",s="";for(let i=0;i<e.length;i++)if(e[i]==="<")if(e[i+1]==="/"){const c=Te(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,c).trim();if(this.options.removeNSPrefix){const f=a.indexOf(":");f!==-1&&(a=a.substr(f+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),r&&(n=this.saveTextToParentTag(n,r,s));const l=s.substring(s.lastIndexOf(".")+1);if(a&&this.options.unpairedTags.indexOf(a)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let u=0;l&&this.options.unpairedTags.indexOf(l)!==-1?(u=s.lastIndexOf(".",s.lastIndexOf(".")-1),this.tagsNodeStack.pop()):u=s.lastIndexOf("."),s=s.substring(0,u),r=this.tagsNodeStack.pop(),n="",i=c}else if(e[i+1]==="?"){let c=Ur(e,i,!1,"?>");if(!c)throw new Error("Pi Tag is not closed.");if(n=this.saveTextToParentTag(n,r,s),!(this.options.ignoreDeclaration&&c.tagName==="?xml"||this.options.ignorePiTags)){const a=new lt(c.tagName);a.add(this.options.textNodeName,""),c.tagName!==c.tagExp&&c.attrExpPresent&&(a[":@"]=this.buildAttributesMap(c.tagExp,s,c.tagName)),this.addChild(r,a,s)}i=c.closeIndex+1}else if(e.substr(i+1,3)==="!--"){const c=Te(e,"-->",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,c-2);n=this.saveTextToParentTag(n,r,s),r.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=c}else if(e.substr(i+1,2)==="!D"){const c=ua(e,i);this.docTypeEntities=c.entities,i=c.i}else if(e.substr(i+1,2)==="!["){const c=Te(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,c);if(n=this.saveTextToParentTag(n,r,s),this.options.cdataPropName)r.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]);else{let l=this.parseTextData(a,r.tagname,s,!0,!1,!0);l==null&&(l=""),r.add(this.options.textNodeName,l)}i=c+2}else{let c=Ur(e,i,this.options.removeNSPrefix),a=c.tagName,l=c.tagExp,u=c.attrExpPresent,f=c.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),r&&n&&r.tagname!=="!xml"&&(n=this.saveTextToParentTag(n,r,s,!1));const d=r;if(d&&this.options.unpairedTags.indexOf(d.tagname)!==-1&&(r=this.tagsNodeStack.pop(),s=s.substring(0,s.lastIndexOf("."))),a!==t.tagname&&(s+=s?"."+a:a),this.isItStopNode(this.options.stopNodes,s,a)){let h="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)i=c.closeIndex;else if(this.options.unpairedTags.indexOf(a)!==-1)i=c.closeIndex;else{const p=this.readStopNodeData(e,a,f+1);if(!p)throw new Error(`Unexpected end of ${a}`);i=p.i,h=p.tagContent}const g=new lt(a);a!==l&&u&&(g[":@"]=this.buildAttributesMap(l,s,a)),h&&(h=this.parseTextData(h,a,s,!0,u,!0,!0)),s=s.substr(0,s.lastIndexOf(".")),g.add(this.options.textNodeName,h),this.addChild(r,g,s)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){a[a.length-1]==="/"?(a=a.substr(0,a.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const h=new lt(a);a!==l&&u&&(h[":@"]=this.buildAttributesMap(l,s,a)),this.addChild(r,h,s),s=s.substr(0,s.lastIndexOf("."))}else{const h=new lt(a);this.tagsNodeStack.push(r),a!==l&&u&&(h[":@"]=this.buildAttributesMap(l,s,a)),this.addChild(r,h,s),r=h}n="",i=f}}else n+=e[i];return t.child};function ba(e,t,r){const n=this.options.updateTag(t.tagname,r,t[":@"]);n===!1||(typeof n=="string"&&(t.tagname=n),e.addChild(t))}const wa=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const r=this.docTypeEntities[t];e=e.replace(r.regx,r.val)}for(let t in this.lastEntities){const r=this.lastEntities[t];e=e.replace(r.regex,r.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const r=this.htmlEntities[t];e=e.replace(r.regex,r.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function _a(e,t,r,n){return e&&(n===void 0&&(n=Object.keys(t.child).length===0),e=this.parseTextData(e,t.tagname,r,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,n),e!==void 0&&e!==""&&t.add(this.options.textNodeName,e),e=""),e}function Ea(e,t,r){const n="*."+r;for(const s in e){const i=e[s];if(n===i||t===i)return!0}return!1}function ka(e,t,r=">"){let n,s="";for(let i=t;i<e.length;i++){let o=e[i];if(n)o===n&&(n="");else if(o==='"'||o==="'")n=o;else if(o===r[0])if(r[1]){if(e[i+1]===r[1])return{data:s,index:i}}else return{data:s,index:i};else o==="	"&&(o=" ");s+=o}}function Te(e,t,r,n){const s=e.indexOf(t,r);if(s===-1)throw new Error(n);return s+t.length-1}function Ur(e,t,r,n=">"){const s=ka(e,t+1,n);if(!s)return;let i=s.data;const o=s.index,c=i.search(/\s/);let a=i,l=!0;if(c!==-1&&(a=i.substr(0,c).replace(/\s\s*$/,""),i=i.substr(c+1)),r){const u=a.indexOf(":");u!==-1&&(a=a.substr(u+1),l=a!==s.data.substr(u+1))}return{tagName:a,tagExp:i,closeIndex:o,attrExpPresent:l}}function Ia(e,t,r){const n=r;let s=1;for(;r<e.length;r++)if(e[r]==="<")if(e[r+1]==="/"){const i=Te(e,">",r,`${t} is not closed`);if(e.substring(r+2,i).trim()===t&&(s--,s===0))return{tagContent:e.substring(n,r),i};r=i}else if(e[r+1]==="?")r=Te(e,"?>",r+1,"StopNode is not closed.");else if(e.substr(r+1,3)==="!--")r=Te(e,"-->",r+3,"StopNode is not closed.");else if(e.substr(r+1,2)==="![")r=Te(e,"]]>",r,"StopNode is not closed.")-2;else{const i=Ur(e,r,">");i&&((i&&i.tagName)===t&&i.tagExp[i.tagExp.length-1]!=="/"&&s++,r=i.closeIndex)}}function zr(e,t,r){if(t&&typeof e=="string"){const n=e.trim();return n==="true"?!0:n==="false"?!1:fa(e,r)}else return Cn.isExist(e)?e:""}var xa=da,Hs={};function Sa(e,t){return Xs(e,t)}function Xs(e,t,r){let n;const s={};for(let i=0;i<e.length;i++){const o=e[i],c=Ca(o);let a="";if(r===void 0?a=c:a=r+"."+c,c===t.textNodeName)n===void 0?n=o[c]:n+=""+o[c];else{if(c===void 0)continue;if(o[c]){let l=Xs(o[c],t,a);const u=Oa(l,t);o[":@"]?Na(l,o[":@"],a,t):Object.keys(l).length===1&&l[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?l=l[t.textNodeName]:Object.keys(l).length===0&&(t.alwaysCreateTextNode?l[t.textNodeName]="":l=""),s[c]!==void 0&&s.hasOwnProperty(c)?(Array.isArray(s[c])||(s[c]=[s[c]]),s[c].push(l)):t.isArray(c,a,u)?s[c]=[l]:s[c]=l}}}return typeof n=="string"?n.length>0&&(s[t.textNodeName]=n):n!==void 0&&(s[t.textNodeName]=n),s}function Ca(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];if(n!==":@")return n}}function Na(e,t,r,n){if(t){const s=Object.keys(t),i=s.length;for(let o=0;o<i;o++){const c=s[o];n.isArray(c,r+"."+c,!0,!0)?e[c]=[t[c]]:e[c]=t[c]}}}function Oa(e,t){const{textNodeName:r}=t,n=Object.keys(e).length;return!!(n===0||n===1&&(e[r]||typeof e[r]=="boolean"||e[r]===0))}Hs.prettify=Sa;const{buildOptions:Ta}=Sn,La=xa,{prettify:Aa}=Hs,Pa=kn;let $a=class{constructor(t){this.externalEntities={},this.options=Ta(t)}parse(t,r){if(typeof t!="string")if(t.toString)t=t.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(r){r===!0&&(r={});const i=Pa.validate(t,r);if(i!==!0)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const n=new La(this.options);n.addExternalEntities(this.externalEntities);const s=n.parseXml(t);return this.options.preserveOrder||s===void 0?s:Aa(s,this.options)}addEntity(t,r){if(r.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(r==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=r}};var Ga=$a;const Ra=`
`;function Ba(e,t){let r="";return t.format&&t.indentBy.length>0&&(r=Ra),Ys(e,t,"",r)}function Ys(e,t,r,n){let s="",i=!1;for(let o=0;o<e.length;o++){const c=e[o],a=Fa(c);let l="";if(r.length===0?l=a:l=`${r}.${a}`,a===t.textNodeName){let g=c[a];Ka(l,t)||(g=t.tagValueProcessor(a,g),g=Qs(g,t)),i&&(s+=n),s+=g,i=!1;continue}else if(a===t.cdataPropName){i&&(s+=n),s+=`<![CDATA[${c[a][0][t.textNodeName]}]]>`,i=!1;continue}else if(a===t.commentPropName){s+=n+`<!--${c[a][0][t.textNodeName]}-->`,i=!0;continue}else if(a[0]==="?"){const g=is(c[":@"],t),p=a==="?xml"?"":n;let y=c[a][0][t.textNodeName];y=y.length!==0?" "+y:"",s+=p+`<${a}${y}${g}?>`,i=!0;continue}let u=n;u!==""&&(u+=t.indentBy);const f=is(c[":@"],t),d=n+`<${a}${f}`,h=Ys(c[a],t,l,u);t.unpairedTags.indexOf(a)!==-1?t.suppressUnpairedNode?s+=d+">":s+=d+"/>":(!h||h.length===0)&&t.suppressEmptyNode?s+=d+"/>":h&&h.endsWith(">")?s+=d+`>${h}${n}</${a}>`:(s+=d+">",h&&n!==""&&(h.includes("/>")||h.includes("</"))?s+=n+t.indentBy+h+n:s+=h,s+=`</${a}>`),i=!0}return s}function Fa(e){const t=Object.keys(e);for(let r=0;r<t.length;r++){const n=t[r];if(n!==":@")return n}}function is(e,t){let r="";if(e&&!t.ignoreAttributes)for(let n in e){let s=t.attributeValueProcessor(n,e[n]);s=Qs(s,t),s===!0&&t.suppressBooleanAttributes?r+=` ${n.substr(t.attributeNamePrefix.length)}`:r+=` ${n.substr(t.attributeNamePrefix.length)}="${s}"`}return r}function Ka(e,t){e=e.substr(0,e.length-t.textNodeName.length-1);let r=e.substr(e.lastIndexOf(".")+1);for(let n in t.stopNodes)if(t.stopNodes[n]===e||t.stopNodes[n]==="*."+r)return!0;return!1}function Qs(e,t){if(e&&e.length>0&&t.processEntities)for(let r=0;r<t.entities.length;r++){const n=t.entities[r];e=e.replace(n.regex,n.val)}return e}var Ma=Ba;const Ua=Ma,za={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function _e(e){this.options=Object.assign({},za,e),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=ja),this.processTextOrObjNode=qa,this.options.format?(this.indentate=Wa,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}_e.prototype.build=function(e){return this.options.preserveOrder?Ua(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0).val)};_e.prototype.j2x=function(e,t){let r="",n="";for(let s in e)if(!(typeof e[s]>"u"))if(e[s]===null)s[0]==="?"?n+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:n+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)n+=this.buildTextValNode(e[s],s,"",t);else if(typeof e[s]!="object"){const i=this.isAttribute(s);if(i)r+=this.buildAttrPairStr(i,""+e[s]);else if(s===this.options.textNodeName){let o=this.options.tagValueProcessor(s,""+e[s]);n+=this.replaceEntitiesValue(o)}else n+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const i=e[s].length;let o="";for(let c=0;c<i;c++){const a=e[s][c];typeof a>"u"||(a===null?s[0]==="?"?n+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:n+=this.indentate(t)+"<"+s+"/"+this.tagEndChar:typeof a=="object"?this.options.oneListGroup?o+=this.j2x(a,t+1).val:o+=this.processTextOrObjNode(a,s,t):o+=this.buildTextValNode(a,s,"",t))}this.options.oneListGroup&&(o=this.buildObjectNode(o,s,"",t)),n+=o}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const i=Object.keys(e[s]),o=i.length;for(let c=0;c<o;c++)r+=this.buildAttrPairStr(i[c],""+e[s][i[c]])}else n+=this.processTextOrObjNode(e[s],s,t);return{attrStr:r,val:n}};_e.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&t==="true"?" "+e:" "+e+'="'+t+'"'};function qa(e,t,r){const n=this.j2x(e,r+1);return e[this.options.textNodeName]!==void 0&&Object.keys(e).length===1?this.buildTextValNode(e[this.options.textNodeName],t,n.attrStr,r):this.buildObjectNode(n.val,t,n.attrStr,r)}_e.prototype.buildObjectNode=function(e,t,r,n){if(e==="")return t[0]==="?"?this.indentate(n)+"<"+t+r+"?"+this.tagEndChar:this.indentate(n)+"<"+t+r+this.closeTag(t)+this.tagEndChar;{let s="</"+t+this.tagEndChar,i="";return t[0]==="?"&&(i="?",s=""),r&&e.indexOf("<")===-1?this.indentate(n)+"<"+t+r+i+">"+e+s:this.options.commentPropName!==!1&&t===this.options.commentPropName&&i.length===0?this.indentate(n)+`<!--${e}-->`+this.newLine:this.indentate(n)+"<"+t+r+i+this.tagEndChar+e+this.indentate(n)+s}};_e.prototype.closeTag=function(e){let t="";return this.options.unpairedTags.indexOf(e)!==-1?this.options.suppressUnpairedNode||(t="/"):this.options.suppressEmptyNode?t="/":t=`></${e}`,t};_e.prototype.buildTextValNode=function(e,t,r,n){if(this.options.cdataPropName!==!1&&t===this.options.cdataPropName)return this.indentate(n)+`<![CDATA[${e}]]>`+this.newLine;if(this.options.commentPropName!==!1&&t===this.options.commentPropName)return this.indentate(n)+`<!--${e}-->`+this.newLine;if(t[0]==="?")return this.indentate(n)+"<"+t+r+"?"+this.tagEndChar;{let s=this.options.tagValueProcessor(t,e);return s=this.replaceEntitiesValue(s),s===""?this.indentate(n)+"<"+t+r+this.closeTag(t)+this.tagEndChar:this.indentate(n)+"<"+t+r+">"+s+"</"+t+this.tagEndChar}};_e.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const r=this.options.entities[t];e=e.replace(r.regex,r.val)}return e};function Wa(e){return this.options.indentBy.repeat(e)}function ja(e){return e.startsWith(this.options.attributeNamePrefix)?e.substr(this.attrPrefixLen):!1}var Da=_e;const Va=kn,Ja=Ga,Ha=Da;var Zs={XMLParser:Ja,XMLValidator:Va,XMLBuilder:Ha};const Xa={catalogueLinks:{allowedChildrens:[]},publications:{allowedChildrens:[]},costTypes:{allowedChildrens:[]},profileTypes:{allowedChildrens:["characteristicTypes"]},categoryEntries:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups"]},categoryLinks:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups"]},forceEntries:{allowedChildrens:["forceEntries","categoryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","costs"]},entryLinks:{allowedChildrens:"type"},selectionEntryGroups:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","categoryLinks","costs"]},sharedSelectionEntryGroups:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","constraints","modifiers","modifierGroups","categoryLinks","costs"]},selectionEntries:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","associations","constraints","modifiers","modifierGroups","categoryLinks","costs"]},sharedSelectionEntries:{allowedChildrens:["selectionEntries","selectionEntryGroups","entryLinks","profiles","rules","infoGroups","infoLinks","associations","constraints","modifiers","modifierGroups","categoryLinks","costs"]},associations:{allowedChildrens:["constraints","modifiers","modifierGroups"]},sharedRules:{allowedChildrens:["modifiers","modifierGroups"]},rule:{allowedChildrens:["modifiers","modifierGroups"]},rules:{allowedChildrens:["modifiers","modifierGroups"]},profile:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},profiles:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},sharedProfiles:{allowedChildrens:["modifiers","modifierGroups","characteristics"]},infoGroup:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},infoGroups:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},sharedInfoGroups:{allowedChildrens:["profiles","rules","infoGroups","infoLinks","modifiers","modifierGroups"]},infoLinks:{allowedChildrens:"type"},modifiers:{allowedChildrens:["conditions","conditionGroups","repeats"]},modifierGroups:{allowedChildrens:["modifiers","modifierGroups","conditions","conditionGroups","repeats"]},conditions:{allowedChildrens:[]},conditionGroups:{allowedChildrens:["conditions","conditionGroups"]},catalogue:{allowedChildrens:["catalogueLinks","publications","costTypes","profileTypes","categoryEntries","forceEntries","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","selectionEntries","entryLinks","infoLinks","infoGroups","rules"]},gameSystem:{allowedChildrens:["publications","costTypes","profileTypes","categoryEntries","forceEntries","sharedSelectionEntries","sharedSelectionEntryGroups","sharedProfiles","sharedRules","sharedInfoGroups","selectionEntries","entryLinks","infoLinks","infoGroups","rules"]}},Pe={categories:"category",catalogueLinks:"catalogueLink",categoryEntries:"categoryEntry",categoryLinks:"categoryLink",characteristics:"characteristic",characteristicTypes:"characteristicType",conditions:"condition",conditionGroups:"conditionGroup",constraints:"constraint",costs:"cost",costLimits:"costLimit",costTypes:"costType",entryLinks:"entryLink",forceEntries:"forceEntry",infoGroups:"infoGroup",infoLinks:"infoLink",forces:"force",modifiers:"modifier",modifierGroups:"modifierGroup",profiles:"profile",profileTypes:"profileType",publications:"publication",repeats:"repeat",rules:"rule",selections:"selection",selectionEntries:"selectionEntry",selectionEntryGroups:"selectionEntryGroup",sharedInfoGroups:"infoGroup",sharedProfiles:"profile",sharedRules:"rule",sharedSelectionEntries:"selectionEntry",sharedSelectionEntryGroups:"selectionEntryGroup",associations:"association"},gr=new Set(["description","readme","comment"]),os=/&(?:amp|lt|gt|quot|#39|apos);/g,Ya={"&amp;":"&","&apos;":"'","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},as=e=>os.test(e)?e.replace(os,t=>Ya[t]):e,Nn={};for(const e in Pe)Nn[Pe[e]]=e;const rt={};for(const[e,t]of Object.entries(Xa))typeof t.allowedChildrens=="string"?rt[e]=t.allowedChildrens:rt[e]=new Set(t.allowedChildrens);function Qa(e){const t={allowBooleanAttributes:!0,ignoreAttributes:!1,attributeNamePrefix:"",textNodeName:"$text",parseAttributeValue:!0,processEntities:!1,parseTagValue:!1,ignoreDeclaration:!0,alwaysCreateTextNode:!0,isArray:(r,n,s,i)=>!i&&r in Nn,attributeValueProcessor:(r,n)=>as(n),tagValueProcessor:(r,n)=>as(n)};return new Zs.XMLParser(t).parse(e)}async function Nl(e,t){const r=await Vs(e),n={};console.log("unzipping folder",r,"path",t);for(const s in r.entries){const i=r.entries[s];if(i.isDirectory)continue;const o=Rr(Rr(s,t),"/");if(o.startsWith("."))continue;const c=ei(o)?await i.arrayBuffer():await i.text();n[o]=c}return n}async function Za(e){if(typeof e=="string"){var t=new TextEncoder;e=t.encode(e)}const r=await Vs(e);for(const n of Object.values(r.entries))return await n.text();throw"unzipFile failed: No Entries"}const ec=["gstz","zip","catz"],tc=["gst","gstz","xml","zip","cat","catz","json"];function Ol(e){const t=e.lastIndexOf(".");return t===-1?e:e.substring(0,t)}function yr(e){return e.split(".").pop().toLowerCase()}function ei(e){const t=yr(e);return ec.includes(t)}function rc(e){const t=yr(e);return!!tc.includes(t)}const cs={sharedRules:"shareRule",sharedProfiles:"sharedProfile",sharedInfoGroups:"sharedInfoGroup",sharedSelectionEntries:"sharedSelectionEntry",sharedSelectionEntryGroups:"sharedSelectionEntryGroup"};function qr(e){var t,r;for(let n in e)if(e[n]==="")delete e[n];else if(Pe[n]&&e[n])if(n in cs){const s=e[n][Pe[n]],i=e[n][cs[n]];e[n]=[...Array.isArray(s)?s:[],...Array.isArray(i)?i:[]],(t=e[n])==null||t.forEach(qr)}else{const s=e[n][Pe[n]];Array.isArray(s)?(e[n]=s,(r=e[n])==null||r.forEach(qr)):ee(e[n])&&delete e[n]}else gr.has(n)&&(e[n]=e[n].$text??"");return e}function Wr(e,t){const r=rt[t],n=typeof r=="string"?rt[e[r]]:r;for(let s in e)s in Pe&&Array.isArray(e[s])&&(n&&!n.has(s)?delete e[s]:e[s].forEach(i=>Wr(i,s)))}const ls=new Set;function us(e,t){let r=rt[t];if(typeof r=="string"){const n=e[r];if(n){const s=ic(n);if(typeof s!="string"||s===r)return ls;r=rt[s]}}return r||ls}function fs(e){const t=Qa(e);qr(ye(t));const r=t.catalogue?"catalogue":"gameSystem";t.catalogue?(t.playable=1,t.id=Ui(t.catalogue.id),t.include=[1e3]):(t.playable=0,t.id=1e3);const n=t[r];return t.name=n.name,t.short=zi(n.name),t.playable=!n.library,t.version=n.battleScribeVersion,t.nrversion=n.revision,t}async function nc(e,t){switch(t=yr(t),t){case"xml":case"cat":case"gst":return fs(e);case"zip":case"catz":case"gstz":return fs(await Za(e));case"json":return JSON.parse(e);default:throw new Error("Extension not supported "+t)}}function sc(e){return Pe[e]}function ic(e){return Nn[e]}const ti=new Set(["?xml","$text","_"]);function oc(e){for(const[t,r]of Object.entries(e))gr.has(t)?e[t]=Array.isArray(r)?r:[r]:Array.isArray(r)&&!ti.has(t)&&(e[t]=[{[sc(t)]:r}])}function ac(e){return Un(e,t=>{typeof t=="object"&&oc(t)}),Un(e,t=>{if(typeof t=="object")for(const[r,n]of Object.entries(t))Array.isArray(n)||ti.has(r)||gr.has(r)||ee(n)||(t[`_${r}`]=n,delete t[r])}),e}function cc(e){const t=JSON.parse(Kr(e));ac(t);const r={textNodeName:"$text",format:!0,attributeNamePrefix:"_",ignoreAttributes:!1,suppressBooleanAttributes:!1,suppressEmptyNode:!0};return t.gameSystem&&(t.gameSystem._xmlns="http://www.battlescribe.net/schema/gameSystemSchema"),t.catalogue&&(t.catalogue._xmlns="http://www.battlescribe.net/schema/catalogueSchema"),`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
`+new Zs.XMLBuilder(r).build(t)}const lc=[{type:"publications",name:"Publications",icon:"publication.png"},{type:"costTypes",name:"Cost Types",icon:"cost.png"},{type:"profileTypes",name:"Profile Types",icon:"profileType.png"},{type:"categoryEntries",name:"Category Entries",icon:"category.png"},{type:"forceEntries",name:"Force Entries",icon:"force.png"},{type:"sharedSelectionEntries",name:"Shared Selection Entries",icon:"selectionEntryLink.png"},{type:"sharedSelectionEntryGroups",name:"Shared Selection Entry Groups",icon:"shared_groups.png"},{type:"sharedProfiles",name:"Shared Profiles",icon:"shared_profiles.png"},{type:"sharedRules",name:"Shared Rules",icon:"shared_rules.png"},{type:"sharedInfoGroups",name:"Shared Info Groups",icon:"infoGroup.png"},{type:"rules",links:"infoLinks",name:"Root Rules",icon:"rule.png"},{type:"selectionEntries",links:"entryLinks",name:"Root Selection Entries",icon:"selectionEntry.png"}],Tl=[{type:"catalogueLinks",name:"Catalogue Links",icon:"catalogueLink.png"},...lc];function ze(e,t){switch(e){case"selectionEntry":return"Entry";case"selectionEntryGroup":return"Group";case"selectionEntryLink":return"Entry (link)";case"selectionEntryGroupLink":return"Group (link)";case"force":return"Force";case"category":return"Category";case"categoryLink":return"Category (link)";case"catalogueLink":return"Catalogue (link)";case"publication":return"Publication";case"costType":return"Cost Type";case"costs":return"Cost";case"link":return"Link";case"profileType":return"Profile Type";case"profile":return"Profile";case"rule":return"Rule";case"infoLink":return"Info (link)";case"infoGroup":return"Info Group";case"profileLink":return"Profile";case"ruleLink":return"Rule (link)";case"infoGroupLink":return"Info Group (link)";case"characteristic":return"Characteristic";case"characteristicType":return"Characteristic Type";case"constraint":return"Constraint";case"condition":return"Condition";case"modifier":return"Modifier";case"modifierGroup":return"Modifier Group";case"repeat":return"Repeat";case"conditionGroup":return"Condition Group";case"catalogue":return"Catalogue";case"gameSystem":return"Game System";default:return console.warn("unknown getTypeLabel key",e),e}}function Se(e,t){switch(e){case"selectionEntries":return"selectionEntry";case"selectionEntryGroups":return"selectionEntryGroup";case"sharedSelectionEntries":return t!=null&&t.targetId?"selectionEntryLink":"selectionEntry";case"sharedSelectionEntryGroups":return t!=null&&t.targetId?"selectionEntryLink":"selectionEntryGroup";case"entryLinks":return t!=null&&t.target?t.target.editorTypeName+"Link":"link";case"forceEntries":return"force";case"categoryEntries":return"category";case"categoryLinks":return"categoryLink";case"catalogueLinks":return"catalogueLink";case"publications":return"publication";case"costTypes":return"costType";case"costs":return"cost";case"profileTypes":return"profileType";case"profiles":return"profile";case"rules":return"rule";case"characteristics":return"characteristic";case"characteristicTypes":return"characteristicType";case"sharedProfiles":return"profile";case"sharedRules":return"rule";case"sharedInfoGroups":return"infoGroup";case"infoLinks":return t?`${t.type||"info"}Link`:"infoLink";case"infoGroups":return"infoGroup";case"associations":return"association";case"constraints":return"constraint";case"conditions":return"condition";case"modifiers":return"modifier";case"modifierGroups":return"modifierGroup";case"repeats":return"repeat";case"conditionGroups":return"conditionGroup";case"catalogue":case"gameSystem":return e;default:return console.warn("unknown getTypeName key",e),e}}function Ll(e,t=!0,r=!0){var o,c,a,l,u;const n=e.parentKey,s=[];switch(n){case"infoLinks":["profiles","sharedProfiles"].includes((o=e.target)==null?void 0:o.parentKey)&&r&&s.push(e.target.typeName);break;case"sharedProfiles":case"profiles":r&&s.push(e.typeName);break;case"selectionEntries":case"sharedSelectionEntries":e.isEntry()&&e.getType()!=="upgrade"&&r&&s.push(e.getType());break;case"entryLinks":e.target&&e.isEntry()&&e.getType()!=="upgrade"&&r&&s.push(e.getType());break;case"modifierGroups":s.push(`(${(((c=e.modifiers)==null?void 0:c.length)||0)+(((a=e.modifierGroups)==null?void 0:a.length)||0)})`);break}const i=(((l=e.links)==null?void 0:l.length)??0)+(((u=e.other_links)==null?void 0:u.length)??0);if(i&&t){const f=i===1?"":"s";s.push(`(${i||0} ref${f})`)}return e.comment&&e.comment[0]&&s.push("# "+e.comment),e.isCollective&&e.isCollective()&&s.push("(collective)"),s.join(" ")}function jr(e){const t=e.parentKey;switch(t){case"selectionEntries":case"sharedSelectionEntries":case"selectionEntryGroups":case"sharedSelectionEntryGroups":case"entryLinks":case"forceEntries":case"categoryLinks":case"categoryEntries":case"sharedInfoGroups":case"infoGroups":case"catalogueLinks":case"publications":case"profileTypes":case"catalogue":case"gameSystem":case"rules":case"sharedRules":case"costs":case"costTypes":case"sharedProfiles":case"profiles":case"characteristics":case"characteristicTypes":return e.getName();case"modifiers":return oo(Xe(e),e);case"repeats":{const r=e,n=Xe(e);return n||console.error("no parent for repeat",e),`Repeat ${r.repeats} times for every ${r.value} ${Ae(n,r.field)} in ${Ae(n,r.scope)} of ${r.childId?Ae(n,r.childId):" any"}`}case"conditions":return Vn(Xe(e),e);case"constraints":return Vn(Xe(e),e);case"modifierGroups":return"Modify...";case"conditionGroups":return`${e.type.toUpperCase()}`;case"infoLinks":return e.target?jr(e.target):e.getName();case"associations":return`${e.label}`;default:return console.log(t,e),t}}function ir(e,t){t(e);const r=[e];for(;r.length;){const n=r.pop();for(const s of Object.keys(n)){if(!st.has(s)||gr.has(s))continue;const i=n[s];if(i&&Array.isArray(i))for(const o of i)r.push(o),t(o,s,n)}}}function uc(e){const t=e.parent;if(t){const r=t[e.parentKey],n=r.indexOf(e);n!==-1&&r.splice(n,1)}}function $t(e,t){const r=e.catalogue;ir(e,(n,s,i)=>{if(r.removeFromIndex(n),n.isLink&&n.isLink()&&(r.unlinkLink(n),delete n.target),n instanceof pt&&n.typeId){const o=n.catalogue.findOptionById(n.typeId);o&&n.catalogue.removeRef(n,o)}if(n instanceof Be){const o=n.scope,c=n.childId;if(!_n.has(o)){const a=n.catalogue.findOptionById(n.scope);a&&n.catalogue.removeOtherRef(n,a)}if(!ro.has(c)){const a=n.catalogue.findOptionById(n.childId);a&&n.catalogue.removeOtherRef(n,a)}}delete n.parent,delete n.catalogue}),t&&e instanceof En&&r.reload(t)}function qe(e,t,r,n){let s=!1;for(const i of Array.isArray(e)?e:[e])ir(i,(o,c,a)=>{if(ee(o)){if(o.parent=a||r,o.catalogue=t,t.addToIndex(o),o instanceof et&&t.updateLink(o),o instanceof pt&&o.typeId){const l=o.catalogue.findOptionById(o.typeId);l&&o.catalogue.addRef(o,l)}o instanceof En&&o.targetId&&(s=!0),t.refreshErrors(o)}});s&&r&&(r.catalogue||r).reload(n)}function ke(e){if(!e.parent&&!e.isCatalogue())return[{id:e.id,key:e.parentKey,index:0}];const t=[];for(;e.parent;){const r=e.parent||e.catalogue;t.push({key:e.parentKey,index:r[e.parentKey].indexOf(e),id:e.id}),e=e.parent}return t.reverse(),t}function Al(e){if(!e.parent&&!e.isCatalogue())return[{id:e.id,key:e.parentKey,index:0}];const t=[];do{const r=e.parent||e.catalogue;r?t.push({name:e.getName(),type:e.editorTypeName,label:e.getTypeName(),display:jr(e),key:e.parentKey,index:r[e.parentKey].indexOf(e),id:e.id}):t.push({name:e.getName(),display:jr(e),type:"catalogue",key:"catalogue",id:e.id,index:0}),e=e.parent}while(e);return t.reverse(),t}function ds(e,t,r){let n=e;for(let o=0;o<t.length-1;o++){const c=t[o];n=n[c.key][c.index]}const s=t[t.length-1];return n[s.key]||(n[s.key]=[]),n[s.key].splice(s.index,0,r),n}function fc(e,t){let r=e;for(const n of t){if(r=r[n.key],!r)return;r=r[n.index]}return r}function Or(e,t){let r=e;const n=t[t.length-1];for(const o of t)o!==n&&(r=r[o.key][o.index]);const i=r[n.key].splice(n.index,1)[0];if(!i)throw new Error("popAtEntryPath failed");return i}function hs(e,t){const r={};ir(t,(n,s,i)=>{if(n.id){const o=n.id,c=e.generateNonConflictingId();n.id=c,r[o]=c}}),ir(t,(n,s,i)=>{n instanceof Be&&(n.scope in r&&(n.scope=r[n.scope]),n.childId in r&&(n.childId=r[n.childId])),n instanceof wn&&n.field in r&&(n.field=r[n.field])})}function ps(e,t,r){if(e.isCatalogue()){if(r)switch(t){case"sharedRules":case"rules":return["sharedRules","rules"].includes(r)?r:"";case"sharedProfiles":case"profiles":return["sharedProfiles","profiles"].includes(r)?r:"";case"sharedInfoGroups":case"infoGroups":return["sharedInfoGroups","infoGroups"].includes(r)?r:"";case"sharedSelectionEntries":case"selectionEntries":return["sharedSelectionEntries","selectionEntries"].includes(r)?r:"";case"sharedSelectionEntryGroups":case"selectionEntryGroups":return["sharedSelectionEntryGroups","selectionEntryGroups"].includes(r)?r:"";default:return t}}else switch(t){case"sharedRules":return"rules";case"sharedProfiles":return"profiles";case"sharedInfoGroups":return"infoGroups";case"sharedSelectionEntries":return"selectionEntries";case"sharedSelectionEntryGroups":return"selectionEntryGroups";default:return t}return t}class dc{get[Symbol.toStringTag](){return"ObjectNoObserve"}}function hc(){return new dc}const pc={};function gc(e,t,r){if(t in e)return e[t];const n=class extends R{get parentKey(){return t}get editorTypeName(){return Se(t,this)}toString(){return`${this.editorTypeName} - ${this.getName()}`}};return n.prototype.parentKey,Object.setPrototypeOf(n.prototype,Object.getPrototypeOf(r)),e[t]=n.prototype,n.prototype}function yc(e,t,r){Object.setPrototypeOf(r,gc(e,t,r))}const Jt={"*":R.prototype,catalogue:sr.prototype,catalogueLinks:En.prototype,gameSystem:sr.prototype,forceEntries:kr.prototype,forces:kr.prototype,force:kr.prototype,categoryEntries:ht.prototype,category:ht.prototype,categories:ht.prototype,link:et.prototype,infoLinks:Qi.prototype,categoryLinks:Rs.prototype,entry:wr.prototype,selectionEntries:wr.prototype,entryLinks:et.prototype,sharedSelectionEntries:wr.prototype,group:_r.prototype,selectionEntryGroups:_r.prototype,sharedSelectionEntryGroups:_r.prototype,sharedRules:Wt.prototype,rules:Wt.prototype,rule:Wt.prototype,profileTypes:eo.prototype,sharedProfiles:pt.prototype,profiles:pt.prototype,profile:pt.prototype,characteristics:jn.prototype,characteristic:jn.prototype,characteristicTypes:R.prototype,characteristicType:R.prototype,sharedInfoGroups:xr.prototype,infoGroups:xr.prototype,infoGroup:xr.prototype,publications:Jn.prototype,publication:Jn.prototype,repeats:Be.prototype,conditions:Be.prototype,constraints:Fr.prototype,modifiers:wn.prototype,modifierGroups:Bs.prototype};Object.values(Jt);function mc(e){return e in Jt?Jt[e]:Jt["*"]}function Dr(e,t){const r=mc(t);return r&&(Object.setPrototypeOf(e,r),e.post_init&&e.post_init(),globalThis.isEditor&&yc(e.keyInfoCache||pc,t,e)),e}function Ve(e){const t=[e];for(;t.length;){const r=t.pop();for(const n of Object.keys(r)){const s=r[n];if(ee(s))if(Array.isArray(s)){if(s.length&&ee(s[0]))for(let i=s.length;i--;){const o=s[i];zn(o)&&(Dr(o,n),t.push(o))}}else zn(s)&&(Dr(s,n),t.push(s))}}}const gs=vn("catalogues",{state:()=>({dict:{},version:1}),persist:{storage:globalThis.localStorage},actions:{get(e){return e in this.dict||(this.dict[e]={}),this.dict[e]},setEdited(e,t){this.get(e).edited=t},getEdited(e){return this.get(e).edited},setErrors(e,t){this.get(e).errors=t},getErrors(e){return this.get(e).errors},getDependents(e){return this.get(e).dependents},updateCatalogue(e){var s;const t=e.id,r=e.gameSystemId||e.id,n=(s=e.catalogueLinks)==null?void 0:s.map(i=>({targetId:i.targetId===r?r:`${r}-${i.targetId}`,sourceId:t===r?r:`${r}-${t}`,importRootEntries:i.importRootEntries,sourceName:e.name}));e.gameSystemId&&(n==null||n.push({targetId:e.gameSystemId,sourceId:t,importRootEntries:!0,sourceName:e.name})),this.setDependencies(t,n)},setDependencies(e,t){var n;const r=(n=this.get(e))==null?void 0:n.dependencies;if(r)for(const s of r)this.removeDependent(s.targetId,s);if(t)for(const s of t)this.addDependent(s.targetId,s);this.get(e).dependencies=t||[]},setDependents(e,t){this.get(e).dependents=t},addDependent(e,t){const r=this.get(e);r.dependents||(r.dependents=[]),r.dependents.push(t)},removeDependent(e,t){var n;const r=(n=this.get(e))==null?void 0:n.dependents;if(r){const s=r.findIndex(i=>i.sourceId===t.sourceId);s>=0&&r.splice(s,1)}}}});function ri(e){return e.replaceAll("\\","/").split("/").slice(0,-1).join("/")}function ni(e){const t=e.replaceAll("\\","/").split("/");return t[t.length-1]}async function vc(e){return electron?await electron.invoke("getFolderFiles",e):[]}async function Pl(e){if(electron)try{const t=[];if(!await electron.invoke("isDirectory",e))return[];const n=await electron.invoke("readdirSync",e);for(const s of n){const i=`${e}/${s}`;try{if(await electron.invoke("isDirectory",i)){const c={name:s,path:i};t.push(c)}}catch(o){console.error("Error reading dir:",i,o);continue}}return t}catch(t){throw console.error("Error:",t),t}}async function ys(e,t){if(!electron)return;const r=ri(e);await electron.invoke("mkdirSync",r,{recursive:!0}),await electron.invoke("writeFileSync",e,t)}async function $l(e){if(electron)return await electron.invoke("unlinkSync",e)}async function Gl(e){if(electron)return electron.invoke("showOpenDialog",e)}async function Rl(e){if(electron)return electron.invoke("showMessageBoxSync",e)}async function Bl(){if(electron)return electron.invoke("closeWindow")}async function Fl(e){if(electron)return await electron.invoke("getPath",e)}async function bc(e){electron&&await electron.invoke("mkdirSync",e,{recursive:!0})}let ms=!1;const vs={};async function wc(e,t){electron&&(ms||(ms=!0,electron.on("fileChanged",(r,n,s)=>{const i=vs[n];i&&i(n,s)})),await electron.invoke("chokidarWatchFile",e),vs[e]=t)}async function _c(e){return electron?await electron.invoke("getFolderRemote",e):null}const Ht=vn("editor-ui",{state:()=>({catalogues:{}}),persist:{storage:globalThis.localStorage},actions:{collapse_level(e){var t;if(e>=0){const r=`depth-${e} collapsible-box opened`,n=document.documentElement.getElementsByClassName(r);if(n!=null&&n.length)for(const s of n)(t=ae(s))==null||t.close()}},collapse_all(){this.collapse_level(1),this.collapse_level(0)},collapse_deepest(){const e="collapsible-box opened",t=document.documentElement.getElementsByClassName(e);let r=-1;if(t!=null&&t.length)for(const n of t)n.classList.forEach(s=>{s.startsWith("depth-")&&(r=Math.max(r,parseInt(s.split("-")[1])))});this.collapse_level(r)},set_state(e,t){function r(i,o,c=0){const a=`depth-${c} collapsible-box opened`,l=i.getElementsByClassName(a);if(l!=null&&l.length)for(const u of l){const f=He(ae(u)),d=f.parentKey,h=f.parent;let g=o;if(h){const p=h[d];if(!p||!Array.isArray(p))continue;const y=p.indexOf(f);d in o||(o[d]={});const m=o[d];y in m||(m[y]={}),g=m[y]}else{const p=[...u.classList].filter(y=>st.has(y));for(const y of p)o[y]={},o[y][0]={},g=o[y][0]}r(u,g,c+1)}}const n={};r(document.documentElement,n);const s={...t,open:n};return this.$state.catalogues[e]=s,n},get_data(e){const t=this.$state.catalogues[e];return t||{}},get_root(e,t){let r=this.$state.catalogues[e];return!(!r||(r=r.open[t],!r))},get(e,t){if(!t.length)return!1;let r=this.$state.catalogues[e];if(!r)return!1;let n=r.open[t[0].key];if(!n||(n=n[0],!n))return!1;for(const s of t){const i=n[s.key];if(!i)return!1;const o=i[s.index];if(!o)return!1;n=o}return!0}}});const si={showImported:!1,ignoreProfilesRules:!1,filter:"",scroll:0,selection:void 0,mode:"edit"},Kl=qi({emits:["scrolltop"],setup(){return{store:El(),uistate:Ht(),settings:zt()}},data(){return{...si,...this.defaults,shouldScrollTo:void 0,shouldScrollToElement:void 0}},async mounted(){this.load(),addEventListener("keydown",this.keydown),addEventListener("copy",this.copy),addEventListener("paste",this.paste),addEventListener("cut",this.cut)},unmounted(){removeEventListener("keydown",this.keydown),removeEventListener("copy",this.copy),removeEventListener("paste",this.paste),removeEventListener("cut",this.cut)},props:{catalogue:{type:Object,required:!0},defaults:{type:Object,default:{}}},methods:{onscroll(e){this.scroll=e.target.scrollTop},load(){this.$nextTick(async()=>{if(this.shouldScrollTo=this.scroll,this.selection)try{let e=fc(this.catalogue,this.selection);const t=this.selection[this.selection.length-1];if(!e&&t.id&&(e=this.catalogue.findOptionById(t.id)),e){const r=await this.store.open(e);r&&(await ae(r).do_select(),this.store.mode=this.defaults.mode,this.shouldScrollToElement=r)}}catch(e){console.error(e)}})},async set_scroll(e){const t=this.$refs.scrollable;t&&(t.scrollTop=e),this.$nextTick(async()=>{const r=this.$refs.scrollable;r&&(r.scrollTop=e)})},async scroll_to(e){e.scrollIntoView({block:"nearest",inline:"center"}),this.$nextTick(async()=>{e.scrollIntoView({block:"nearest",inline:"center"})})},should_capture_copy(e){var t;return!((t=getSelection())!=null&&t.toString())},should_capture_paste(e){var r,n;const t=(((r=e.target)==null?void 0:r.tagName)||"").toLowerCase();return!(["input"].includes(t)||(n=e.target)!=null&&n.isContentEditable||this.$route.name!=="catalogue")},async cut(e){this.should_capture_copy(e)&&(e.preventDefault(),await this.store.cut(e))},async copy(e){this.should_capture_copy(e)&&(e.preventDefault(),await this.store.copy(e))},async paste(e){this.should_capture_paste(e)&&(e.preventDefault(),await this.store.paste(e))},async keydown(e){var n,s;if(this.$route.name!=="catalogue"||!e.target)return;const t=(s=(n=e.target)==null?void 0:n.tagName)==null?void 0:s.toLowerCase(),r=e.key.toLowerCase();e.ctrlKey&&r==="f"&&(e.preventDefault(),this.$refs["editor-searchbox"].focus()),r==="escape"&&(this.$refs["editor-searchbox"].blur(),this.store.filter="",this.store.update_catalogue_search(this.catalogue,this.filterData)),t==="body"&&(e.ctrlKey&&r==="z"&&(e.preventDefault(),await this.store.undo()),e.ctrlKey&&r==="y"&&(e.preventDefault(),await this.store.redo()),e.ctrlKey&&r==="d"&&(e.preventDefault(),await this.store.duplicate()),e.ctrlKey&&r==="l"&&(e.preventDefault(),await this.store.pasteLink()),r==="delete"&&(e.preventDefault(),await this.store.remove()))},async update(e){const{filter:t,ignoreProfilesRules:r}=e,n=this.store.filtered;for(const s of n)delete s.showInEditor,delete s.showChildsInEditor,delete s.highlight,qt(s,i=>{delete i.showInEditor,delete s.showChildsInEditor});if(t.length>1){this.store.set_filter(t),this.store.filtered=this.catalogue.findOptionsByText(t),r&&(this.store.filtered=this.store.filtered.filter(s=>!s.isProfile()&&!s.isRule()&&!s.isInfoGroup()));for(const s of this.store.filtered)this.store.show(s);if(await Ps(),this.store.filtered.length<300){for(const s of this.store.filtered)if(s.parent)try{await this.store.open(s,!1,!0)}catch{continue}}}else this.store.set_filter(""),this.store.filtered=[]}},computed:{filterData(){return{filter:this.filter.trim(),ignoreProfilesRules:this.ignoreProfilesRules}}},watch:{filterData:{handler(e){this.update(e)},immediate:!0},showImported:{immediate:!0,handler(e){e&&this.catalogue.imports.map(t=>t.processForEditor())}},shouldScrollTo(e){e!==void 0&&this.$nextTick(()=>{delete this.shouldScrollTo,this.set_scroll(e)})},shouldScrollToElement(e){e!==void 0&&this.$nextTick(()=>{delete this.shouldScrollTo,this.scroll_to(e)})}}});const G=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,M=Object.keys,D=Array.isArray;function H(e,t){return typeof t!="object"||M(t).forEach(function(r){e[r]=t[r]}),e}typeof Promise>"u"||G.Promise||(G.Promise=Promise);const xt=Object.getPrototypeOf,Ec={}.hasOwnProperty;function Z(e,t){return Ec.call(e,t)}function nt(e,t){typeof t=="function"&&(t=t(xt(e))),(typeof Reflect>"u"?M:Reflect.ownKeys)(t).forEach(r=>{ue(e,r,t[r])})}const ii=Object.defineProperty;function ue(e,t,r,n){ii(e,t,H(r&&Z(r,"get")&&typeof r.get=="function"?{get:r.get,set:r.set,configurable:!0}:{value:r,configurable:!0,writable:!0},n))}function Ye(e){return{from:function(t){return e.prototype=Object.create(t.prototype),ue(e.prototype,"constructor",e),{extend:nt.bind(null,e.prototype)}}}}const kc=Object.getOwnPropertyDescriptor;function On(e,t){let r;return kc(e,t)||(r=xt(e))&&On(r,t)}const Ic=[].slice;function or(e,t,r){return Ic.call(e,t,r)}function oi(e,t){return t(e)}function ft(e){if(!e)throw new Error("Assertion Failed")}function ai(e){G.setImmediate?setImmediate(e):setTimeout(e,0)}function ci(e,t){return e.reduce((r,n,s)=>{var i=t(n,s);return i&&(r[i[0]]=i[1]),r},{})}function fe(e,t){if(Z(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var r=[],n=0,s=t.length;n<s;++n){var i=fe(e,t[n]);r.push(i)}return r}var o=t.indexOf(".");if(o!==-1){var c=e[t.substr(0,o)];return c===void 0?void 0:fe(c,t.substr(o+1))}}function te(e,t,r){if(e&&t!==void 0&&(!("isFrozen"in Object)||!Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){ft(typeof r!="string"&&"length"in r);for(var n=0,s=t.length;n<s;++n)te(e,t[n],r[n])}else{var i=t.indexOf(".");if(i!==-1){var o=t.substr(0,i),c=t.substr(i+1);if(c==="")r===void 0?D(e)&&!isNaN(parseInt(o))?e.splice(o,1):delete e[o]:e[o]=r;else{var a=e[o];a&&Z(e,o)||(a=e[o]={}),te(a,c,r)}}else r===void 0?D(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=r}}function li(e){var t={};for(var r in e)Z(e,r)&&(t[r]=e[r]);return t}const xc=[].concat;function ui(e){return xc.apply([],e)}const fi="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(ui([8,16,32,64].map(e=>["Int","Uint","Float"].map(t=>t+e+"Array")))).filter(e=>G[e]),Sc=fi.map(e=>G[e]);ci(fi,e=>[e,!0]);let me=null;function Lt(e){me=typeof WeakMap<"u"&&new WeakMap;const t=Vr(e);return me=null,t}function Vr(e){if(!e||typeof e!="object")return e;let t=me&&me.get(e);if(t)return t;if(D(e)){t=[],me&&me.set(e,t);for(var r=0,n=e.length;r<n;++r)t.push(Vr(e[r]))}else if(Sc.indexOf(e.constructor)>=0)t=e;else{const i=xt(e);for(var s in t=i===Object.prototype?{}:Object.create(i),me&&me.set(e,t),e)Z(e,s)&&(t[s]=Vr(e[s]))}return t}const{toString:Cc}={};function Jr(e){return Cc.call(e).slice(8,-1)}const Hr=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Nc=typeof Hr=="symbol"?function(e){var t;return e!=null&&(t=e[Hr])&&t.apply(e)}:function(){return null},Je={};function ce(e){var t,r,n,s;if(arguments.length===1){if(D(e))return e.slice();if(this===Je&&typeof e=="string")return[e];if(s=Nc(e)){for(r=[];!(n=s.next()).done;)r.push(n.value);return r}if(e==null)return[e];if(typeof(t=e.length)=="number"){for(r=new Array(t);t--;)r[t]=e[t];return r}return[e]}for(t=arguments.length,r=new Array(t);t--;)r[t]=arguments[t];return r}const Tn=typeof Symbol<"u"?e=>e[Symbol.toStringTag]==="AsyncFunction":()=>!1;var se=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function di(e,t){se=e,hi=t}var hi=()=>!0;const Oc=!new Error("").stack;function Me(){if(Oc)try{throw Me.arguments,new Error}catch(e){return e}return new Error}function Xr(e,t){var r=e.stack;return r?(t=t||0,r.indexOf(e.name)===0&&(t+=(e.name+e.message).split(`
`).length),r.split(`
`).slice(t).filter(hi).map(n=>`
`+n).join("")):""}var pi=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ln=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(pi),Tc={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Qe(e,t){this._e=Me(),this.name=e,this.message=t}function gi(e,t){return e+". Errors: "+Object.keys(t).map(r=>t[r].toString()).filter((r,n,s)=>s.indexOf(r)===n).join(`
`)}function ar(e,t,r,n){this._e=Me(),this.failures=t,this.failedKeys=n,this.successCount=r,this.message=gi(e,t)}function vt(e,t){this._e=Me(),this.name="BulkError",this.failures=Object.keys(t).map(r=>t[r]),this.failuresByPos=t,this.message=gi(e,t)}Ye(Qe).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Xr(this._e,2))}},toString:function(){return this.name+": "+this.message}}),Ye(ar).from(Qe),Ye(vt).from(Qe);var An=Ln.reduce((e,t)=>(e[t]=t+"Error",e),{});const Lc=Qe;var O=Ln.reduce((e,t)=>{var r=t+"Error";function n(s,i){this._e=Me(),this.name=r,s?typeof s=="string"?(this.message=`${s}${i?`
 `+i:""}`,this.inner=i||null):typeof s=="object"&&(this.message=`${s.name} ${s.message}`,this.inner=s):(this.message=Tc[t]||r,this.inner=null)}return Ye(n).from(Lc),e[t]=n,e},{});O.Syntax=SyntaxError,O.Type=TypeError,O.Range=RangeError;var bs=pi.reduce((e,t)=>(e[t+"Error"]=O[t],e),{}),Xt=Ln.reduce((e,t)=>(["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=O[t]),e),{});function P(){}function St(e){return e}function Ac(e,t){return e==null||e===St?t:function(r){return t(e(r))}}function Fe(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function Pc(e,t){return e===P?t:function(){var r=e.apply(this,arguments);r!==void 0&&(arguments[0]=r);var n=this.onsuccess,s=this.onerror;this.onsuccess=null,this.onerror=null;var i=t.apply(this,arguments);return n&&(this.onsuccess=this.onsuccess?Fe(n,this.onsuccess):n),s&&(this.onerror=this.onerror?Fe(s,this.onerror):s),i!==void 0?i:r}}function $c(e,t){return e===P?t:function(){e.apply(this,arguments);var r=this.onsuccess,n=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),r&&(this.onsuccess=this.onsuccess?Fe(r,this.onsuccess):r),n&&(this.onerror=this.onerror?Fe(n,this.onerror):n)}}function Gc(e,t){return e===P?t:function(r){var n=e.apply(this,arguments);H(r,n);var s=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=t.apply(this,arguments);return s&&(this.onsuccess=this.onsuccess?Fe(s,this.onsuccess):s),i&&(this.onerror=this.onerror?Fe(i,this.onerror):i),n===void 0?o===void 0?void 0:o:H(n,o)}}function Rc(e,t){return e===P?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function Pn(e,t){return e===P?t:function(){var r=e.apply(this,arguments);if(r&&typeof r.then=="function"){for(var n=this,s=arguments.length,i=new Array(s);s--;)i[s]=arguments[s];return r.then(function(){return t.apply(n,i)})}return t.apply(this,arguments)}}Xt.ModifyError=ar,Xt.DexieError=Qe,Xt.BulkError=vt;var Ct={};const[Yr,cr,Qr]=typeof Promise>"u"?[]:(()=>{let e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,xt(e),e];const t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,xt(t),e]})(),yi=cr&&cr.then,Yt=Yr&&Yr.constructor,$n=!!Qr;var Zr=!1,Bc=Qr?()=>{Qr.then(Gt)}:G.setImmediate?setImmediate.bind(null,Gt):G.MutationObserver?()=>{var e=document.createElement("div");new MutationObserver(()=>{Gt(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:()=>{setTimeout(Gt,0)},bt=function(e,t){dt.push([e,t]),lr&&(Bc(),lr=!1)},en=!0,lr=!0,$e=[],Qt=[],tn=null,rn=St,Ze={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:_s,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(e=>{try{_s(e[0],e[1])}catch{}})}},C=Ze,dt=[],Ge=0,Zt=[];function x(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=P,this._lib=!1;var t=this._PSD=C;if(se&&(this._stackHolder=Me(),this._prev=null,this._numPrev=0),typeof e!="function"){if(e!==Ct)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&sn(this,this._value))}this._state=null,this._value=null,++t.ref,vi(this,e)}const nn={get:function(){var e=C,t=ur;function r(n,s){var i=!e.global&&(e!==C||t!==ur);const o=i&&!de();var c=new x((a,l)=>{Gn(this,new mi(fr(n,e,i,o),fr(s,e,i,o),a,l,e))});return se&&_i(c,this),c}return r.prototype=Ct,r},set:function(e){ue(this,"then",e&&e.prototype===Ct?nn:{get:function(){return e},set:nn.set})}};function mi(e,t,r,n,s){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=r,this.reject=n,this.psd=s}function vi(e,t){try{t(r=>{if(e._state===null){if(r===e)throw new TypeError("A promise cannot be resolved with itself.");var n=e._lib&&At();r&&typeof r.then=="function"?vi(e,(s,i)=>{r instanceof x?r._then(s,i):r.then(s,i)}):(e._state=!0,e._value=r,bi(e)),n&&Pt()}},sn.bind(null,e))}catch(r){sn(e,r)}}function sn(e,t){if(Qt.push(t),e._state===null){var r=e._lib&&At();t=rn(t),e._state=!1,e._value=t,se&&t!==null&&typeof t=="object"&&!t._promise&&function(n,s,i){try{n.apply(null,i)}catch(o){s&&s(o)}}(()=>{var n=On(t,"stack");t._promise=e,ue(t,"stack",{get:()=>Zr?n&&(n.get?n.get.apply(t):n.value):e.stack})}),function(n){$e.some(s=>s._value===n._value)||$e.push(n)}(e),bi(e),r&&Pt()}}function bi(e){var t=e._listeners;e._listeners=[];for(var r=0,n=t.length;r<n;++r)Gn(e,t[r]);var s=e._PSD;--s.ref||s.finalize(),Ge===0&&(++Ge,bt(()=>{--Ge==0&&Rn()},[]))}function Gn(e,t){if(e._state!==null){var r=e._state?t.onFulfilled:t.onRejected;if(r===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Ge,bt(Fc,[r,e,t])}else e._listeners.push(t)}function Fc(e,t,r){try{tn=t;var n,s=t._value;t._state?n=e(s):(Qt.length&&(Qt=[]),n=e(s),Qt.indexOf(s)===-1&&function(i){for(var o=$e.length;o;)if($e[--o]._value===i._value)return void $e.splice(o,1)}(t)),r.resolve(n)}catch(i){r.reject(i)}finally{tn=null,--Ge==0&&Rn(),--r.psd.ref||r.psd.finalize()}}function wi(e,t,r){if(t.length===r)return t;var n="";if(e._state===!1){var s,i,o=e._value;o!=null?(s=o.name||"Error",i=o.message||o,n=Xr(o,0)):(s=o,i=""),t.push(s+(i?": "+i:"")+n)}return se&&((n=Xr(e._stackHolder,2))&&t.indexOf(n)===-1&&t.push(n),e._prev&&wi(e._prev,t,r)),t}function _i(e,t){var r=t?t._numPrev+1:0;r<100&&(e._prev=t,e._numPrev=r)}function Gt(){At()&&Pt()}function At(){var e=en;return en=!1,lr=!1,e}function Pt(){var e,t,r;do for(;dt.length>0;)for(e=dt,dt=[],r=e.length,t=0;t<r;++t){var n=e[t];n[0].apply(null,n[1])}while(dt.length>0);en=!0,lr=!0}function Rn(){var e=$e;$e=[],e.forEach(n=>{n._PSD.onunhandled.call(null,n._value,n)});for(var t=Zt.slice(0),r=t.length;r;)t[--r]()}function Rt(e){return new x(Ct,!1,e)}function B(e,t){var r=C;return function(){var n=At(),s=C;try{return be(r,!0),e.apply(this,arguments)}catch(i){t&&t(i)}finally{be(s,!1),n&&Pt()}}}nt(x.prototype,{then:nn,_then:function(e,t){Gn(this,new mi(null,null,e,t,C))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=arguments[0],r=arguments[1];return typeof t=="function"?this.then(null,n=>n instanceof t?r(n):Rt(n)):this.then(null,n=>n&&n.name===t?r(n):Rt(n))},finally:function(e){return this.then(t=>(e(),t),t=>(e(),Rt(t)))},stack:{get:function(){if(this._stack)return this._stack;try{Zr=!0;var e=wi(this,[],20).join(`
From previous: `);return this._state!==null&&(this._stack=e),e}finally{Zr=!1}}},timeout:function(e,t){return e<1/0?new x((r,n)=>{var s=setTimeout(()=>n(new O.Timeout(t)),e);this.then(r,n).finally(clearTimeout.bind(null,s))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&ue(x.prototype,Symbol.toStringTag,"Dexie.Promise"),Ze.env=Ei(),nt(x,{all:function(){var e=ce.apply(null,arguments).map(Bt);return new x(function(t,r){e.length===0&&t([]);var n=e.length;e.forEach((s,i)=>x.resolve(s).then(o=>{e[i]=o,--n||t(e)},r))})},resolve:e=>{if(e instanceof x)return e;if(e&&typeof e.then=="function")return new x((r,n)=>{e.then(r,n)});var t=new x(Ct,!0,e);return _i(t,tn),t},reject:Rt,race:function(){var e=ce.apply(null,arguments).map(Bt);return new x((t,r)=>{e.map(n=>x.resolve(n).then(t,r))})},PSD:{get:()=>C,set:e=>C=e},totalEchoes:{get:()=>ur},newPSD:ve,usePSD:ot,scheduler:{get:()=>bt,set:e=>{bt=e}},rejectionMapper:{get:()=>rn,set:e=>{rn=e}},follow:(e,t)=>new x((r,n)=>ve((s,i)=>{var o=C;o.unhandleds=[],o.onunhandled=i,o.finalize=Fe(function(){(function(c){function a(){c(),Zt.splice(Zt.indexOf(a),1)}Zt.push(a),++Ge,bt(()=>{--Ge==0&&Rn()},[])})(()=>{this.unhandleds.length===0?s():i(this.unhandleds[0])})},o.finalize),e()},t,r,n))}),Yt&&(Yt.allSettled&&ue(x,"allSettled",function(){const e=ce.apply(null,arguments).map(Bt);return new x(t=>{e.length===0&&t([]);let r=e.length;const n=new Array(r);e.forEach((s,i)=>x.resolve(s).then(o=>n[i]={status:"fulfilled",value:o},o=>n[i]={status:"rejected",reason:o}).then(()=>--r||t(n)))})}),Yt.any&&typeof AggregateError<"u"&&ue(x,"any",function(){const e=ce.apply(null,arguments).map(Bt);return new x((t,r)=>{e.length===0&&r(new AggregateError([]));let n=e.length;const s=new Array(n);e.forEach((i,o)=>x.resolve(i).then(c=>t(c),c=>{s[o]=c,--n||r(new AggregateError(s))}))})}));const j={awaits:0,echoes:0,id:0};var Kc=0,er=[],Tr=0,ur=0,Mc=0;function ve(e,t,r,n){var s=C,i=Object.create(s);i.parent=s,i.ref=0,i.global=!1,i.id=++Mc;var o=Ze.env;i.env=$n?{Promise:x,PromiseProp:{value:x,configurable:!0,writable:!0},all:x.all,race:x.race,allSettled:x.allSettled,any:x.any,resolve:x.resolve,reject:x.reject,nthen:ws(o.nthen,i),gthen:ws(o.gthen,i)}:{},t&&H(i,t),++s.ref,i.finalize=function(){--this.parent.ref||this.parent.finalize()};var c=ot(i,e,r,n);return i.ref===0&&i.finalize(),c}function it(){return j.id||(j.id=++Kc),++j.awaits,j.echoes+=100,j.id}function de(){return!!j.awaits&&(--j.awaits==0&&(j.id=0),j.echoes=100*j.awaits,!0)}function Bt(e){return j.echoes&&e&&e.constructor===Yt?(it(),e.then(t=>(de(),t),t=>(de(),q(t)))):e}function Uc(e){++ur,j.echoes&&--j.echoes!=0||(j.echoes=j.id=0),er.push(C),be(e,!0)}function zc(){var e=er[er.length-1];er.pop(),be(e,!1)}function be(e,t){var r=C;if((t?!j.echoes||Tr++&&e===C:!Tr||--Tr&&e===C)||ki(t?Uc.bind(null,e):zc),e!==C&&(C=e,r===Ze&&(Ze.env=Ei()),$n)){var n=Ze.env.Promise,s=e.env;cr.then=s.nthen,n.prototype.then=s.gthen,(r.global||e.global)&&(Object.defineProperty(G,"Promise",s.PromiseProp),n.all=s.all,n.race=s.race,n.resolve=s.resolve,n.reject=s.reject,s.allSettled&&(n.allSettled=s.allSettled),s.any&&(n.any=s.any))}}function Ei(){var e=G.Promise;return $n?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(G,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:cr.then,gthen:e.prototype.then}:{}}function ot(e,t,r,n,s){var i=C;try{return be(e,!0),t(r,n,s)}finally{be(i,!1)}}function ki(e){yi.call(Yr,e)}function fr(e,t,r,n){return typeof e!="function"?e:function(){var s=C;r&&it(),be(t,!0);try{return e.apply(this,arguments)}finally{be(s,!1),n&&ki(de)}}}function ws(e,t){return function(r,n){return e.call(this,fr(r,t),fr(n,t))}}(""+yi).indexOf("[native code]")===-1&&(it=de=P);function _s(e,t){var r;try{r=t.onuncatched(e)}catch{}if(r!==!1)try{var n,s={promise:t,reason:e};if(G.document&&document.createEvent?((n=document.createEvent("Event")).initEvent("unhandledrejection",!0,!0),H(n,s)):G.CustomEvent&&H(n=new CustomEvent("unhandledrejection",{detail:s}),s),n&&G.dispatchEvent&&(dispatchEvent(n),!G.PromiseRejectionEvent&&G.onunhandledrejection))try{G.onunhandledrejection(n)}catch{}se&&n&&!n.defaultPrevented&&console.warn(`Unhandled rejection: ${e.stack||e}`)}catch{}}var q=x.reject;function on(e,t,r,n){if(e.idbdb&&(e._state.openComplete||C.letThrough||e._vip)){var s=e._createTransaction(t,r,e._dbSchema);try{s.create(),e._state.PR1398_maxLoop=3}catch(i){return i.name===An.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(()=>on(e,t,r,n))):q(i)}return s._promise(t,(i,o)=>ve(()=>(C.trans=s,n(i,o,s)))).then(i=>s._completion.then(()=>i))}if(e._state.openComplete)return q(new O.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return q(new O.DatabaseClosed);e.open().catch(P)}return e._state.dbReadyPromise.then(()=>on(e,t,r,n))}const Le=String.fromCharCode(65535),ie="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",wt=[],mr=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),qc=mr,Wc=mr,Ii=e=>!/(dexie\.js|dexie\.min\.js)/.test(e);function Ke(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}const xi={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Ft(e){return typeof e!="string"||/\./.test(e)?t=>t:t=>(t[e]===void 0&&e in t&&delete(t=Lt(t))[e],t)}class jc{_trans(t,r,n){const s=this._tx||C.trans,i=this.name;function o(a,l,u){if(!u.schema[i])throw new O.NotFound("Table "+i+" not part of transaction");return r(u.idbtrans,u)}const c=At();try{return s&&s.db===this.db?s===C.trans?s._promise(t,o,n):ve(()=>s._promise(t,o,n),{trans:s,transless:C.transless||C}):on(this.db,t,[this.name],o)}finally{c&&Pt()}}get(t,r){return t&&t.constructor===Object?this.where(t).first(r):this._trans("readonly",n=>this.core.get({trans:n,key:t}).then(s=>this.hook.reading.fire(s))).then(r)}where(t){if(typeof t=="string")return new this.db.WhereClause(this,t);if(D(t))return new this.db.WhereClause(this,`[${t.join("+")}]`);const r=M(t);if(r.length===1)return this.where(r[0]).equals(t[r[0]]);const n=this.schema.indexes.concat(this.schema.primKey).filter(l=>l.compound&&r.every(u=>l.keyPath.indexOf(u)>=0)&&l.keyPath.every(u=>r.indexOf(u)>=0))[0];if(n&&this.db._maxKey!==Le)return this.where(n.name).equals(n.keyPath.map(l=>t[l]));!n&&se&&console.warn(`The query ${JSON.stringify(t)} on ${this.name} would benefit of a compound index [${r.join("+")}]`);const{idxByName:s}=this.schema,i=this.db._deps.indexedDB;function o(l,u){try{return i.cmp(l,u)===0}catch{return!1}}const[c,a]=r.reduce(([l,u],f)=>{const d=s[f],h=t[f];return[l||d,l||!d?Ke(u,d&&d.multi?g=>{const p=fe(g,f);return D(p)&&p.some(y=>o(h,y))}:g=>o(h,fe(g,f))):u]},[null,null]);return c?this.where(c.name).equals(t[c.keyPath]).filter(a):n?this.filter(a):this.where(r).equals("")}filter(t){return this.toCollection().and(t)}count(t){return this.toCollection().count(t)}offset(t){return this.toCollection().offset(t)}limit(t){return this.toCollection().limit(t)}each(t){return this.toCollection().each(t)}toArray(t){return this.toCollection().toArray(t)}toCollection(){return new this.db.Collection(new this.db.WhereClause(this))}orderBy(t){return new this.db.Collection(new this.db.WhereClause(this,D(t)?`[${t.join("+")}]`:t))}reverse(){return this.toCollection().reverse()}mapToClass(t){this.schema.mappedClass=t;const r=n=>{if(!n)return n;const s=Object.create(t.prototype);for(var i in n)if(Z(n,i))try{s[i]=n[i]}catch{}return s};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=r,this.hook("reading",r),t}defineClass(){return this.mapToClass(function(t){H(this,t)})}add(t,r){const{auto:n,keyPath:s}=this.schema.primKey;let i=t;return s&&n&&(i=Ft(s)(t)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"add",keys:r!=null?[r]:null,values:[i]})).then(o=>o.numFailures?x.reject(o.failures[0]):o.lastResult).then(o=>{if(s)try{te(t,s,o)}catch{}return o})}update(t,r){if(typeof t!="object"||D(t))return this.where(":id").equals(t).modify(r);{const n=fe(t,this.schema.primKey.keyPath);if(n===void 0)return q(new O.InvalidArgument("Given object does not contain its primary key"));try{typeof r!="function"?M(r).forEach(s=>{te(t,s,r[s])}):r(t,{value:t,primKey:n})}catch{}return this.where(":id").equals(n).modify(r)}}put(t,r){const{auto:n,keyPath:s}=this.schema.primKey;let i=t;return s&&n&&(i=Ft(s)(t)),this._trans("readwrite",o=>this.core.mutate({trans:o,type:"put",values:[i],keys:r!=null?[r]:null})).then(o=>o.numFailures?x.reject(o.failures[0]):o.lastResult).then(o=>{if(s)try{te(t,s,o)}catch{}return o})}delete(t){return this._trans("readwrite",r=>this.core.mutate({trans:r,type:"delete",keys:[t]})).then(r=>r.numFailures?x.reject(r.failures[0]):void 0)}clear(){return this._trans("readwrite",t=>this.core.mutate({trans:t,type:"deleteRange",range:xi})).then(t=>t.numFailures?x.reject(t.failures[0]):void 0)}bulkGet(t){return this._trans("readonly",r=>this.core.getMany({keys:t,trans:r}).then(n=>n.map(s=>this.hook.reading.fire(s))))}bulkAdd(t,r,n){const s=Array.isArray(r)?r:void 0,i=(n=n||(s?void 0:r))?n.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&s)throw new O.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(s&&s.length!==t.length)throw new O.InvalidArgument("Arguments objects and keys must have the same length");const l=t.length;let u=a&&c?t.map(Ft(a)):t;return this.core.mutate({trans:o,type:"add",keys:s,values:u,wantResults:i}).then(({numFailures:f,results:d,lastResult:h,failures:g})=>{if(f===0)return i?d:h;throw new vt(`${this.name}.bulkAdd(): ${f} of ${l} operations failed`,g)})})}bulkPut(t,r,n){const s=Array.isArray(r)?r:void 0,i=(n=n||(s?void 0:r))?n.allKeys:void 0;return this._trans("readwrite",o=>{const{auto:c,keyPath:a}=this.schema.primKey;if(a&&s)throw new O.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(s&&s.length!==t.length)throw new O.InvalidArgument("Arguments objects and keys must have the same length");const l=t.length;let u=a&&c?t.map(Ft(a)):t;return this.core.mutate({trans:o,type:"put",keys:s,values:u,wantResults:i}).then(({numFailures:f,results:d,lastResult:h,failures:g})=>{if(f===0)return i?d:h;throw new vt(`${this.name}.bulkPut(): ${f} of ${l} operations failed`,g)})})}bulkDelete(t){const r=t.length;return this._trans("readwrite",n=>this.core.mutate({trans:n,type:"delete",keys:t})).then(({numFailures:n,lastResult:s,failures:i})=>{if(n===0)return s;throw new vt(`${this.name}.bulkDelete(): ${n} of ${r} operations failed`,i)})}}function _t(e){var t={},r=function(c,a){if(a){for(var l=arguments.length,u=new Array(l-1);--l;)u[l-1]=arguments[l];return t[c].subscribe.apply(null,u),e}if(typeof c=="string")return t[c]};r.addEventType=i;for(var n=1,s=arguments.length;n<s;++n)i(arguments[n]);return r;function i(c,a,l){if(typeof c=="object")return o(c);a||(a=Rc),l||(l=P);var u={subscribers:[],fire:l,subscribe:function(f){u.subscribers.indexOf(f)===-1&&(u.subscribers.push(f),u.fire=a(u.fire,f))},unsubscribe:function(f){u.subscribers=u.subscribers.filter(function(d){return d!==f}),u.fire=u.subscribers.reduce(a,l)}};return t[c]=r[c]=u,u}function o(c){M(c).forEach(function(a){var l=c[a];if(D(l))i(a,c[a][0],c[a][1]);else{if(l!=="asap")throw new O.InvalidArgument("Invalid event config");var u=i(a,St,function(){for(var f=arguments.length,d=new Array(f);f--;)d[f]=arguments[f];u.subscribers.forEach(function(h){ai(function(){h.apply(null,d)})})})}})}}function ut(e,t){return Ye(t).from({prototype:e}),t}function We(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Lr(e,t){e.filter=Ke(e.filter,t)}function Ar(e,t,r){var n=e.replayFilter;e.replayFilter=n?()=>Ke(n(),t()):t,e.justLimit=r&&!n}function tr(e,t){if(e.isPrimKey)return t.primaryKey;const r=t.getIndexByKeyPath(e.index);if(!r)throw new O.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return r}function Es(e,t,r){const n=tr(e,t.schema);return t.openCursor({trans:r,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:n,range:e.range}})}function Kt(e,t,r,n){const s=e.replayFilter?Ke(e.filter,e.replayFilter()):e.filter;if(e.or){const i={},o=(c,a,l)=>{if(!s||s(a,l,d=>a.stop(d),d=>a.fail(d))){var u=a.primaryKey,f=""+u;f==="[object ArrayBuffer]"&&(f=""+new Uint8Array(u)),Z(i,f)||(i[f]=!0,t(c,a,l))}};return Promise.all([e.or._iterate(o,r),ks(Es(e,n,r),e.algorithm,o,!e.keysOnly&&e.valueMapper)])}return ks(Es(e,n,r),Ke(e.algorithm,s),t,!e.keysOnly&&e.valueMapper)}function ks(e,t,r,n){var s=B(n?(i,o,c)=>r(n(i),o,c):r);return e.then(i=>{if(i)return i.start(()=>{var o=()=>i.continue();t&&!t(i,c=>o=c,c=>{i.stop(c),o=P},c=>{i.fail(c),o=P})||s(i.value,i,c=>o=c),o()})})}function J(e,t){try{const r=Is(e),n=Is(t);if(r!==n)return r==="Array"?1:n==="Array"?-1:r==="binary"?1:n==="binary"?-1:r==="string"?1:n==="string"?-1:r==="Date"?1:n!=="Date"?NaN:-1;switch(r){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return function(s,i){const o=s.length,c=i.length,a=o<c?o:c;for(let l=0;l<a;++l)if(s[l]!==i[l])return s[l]<i[l]?-1:1;return o===c?0:o<c?-1:1}(xs(e),xs(t));case"Array":return function(s,i){const o=s.length,c=i.length,a=o<c?o:c;for(let l=0;l<a;++l){const u=J(s[l],i[l]);if(u!==0)return u}return o===c?0:o<c?-1:1}(e,t)}}catch{}return NaN}function Is(e){const t=typeof e;if(t!=="object")return t;if(ArrayBuffer.isView(e))return"binary";const r=Jr(e);return r==="ArrayBuffer"?"binary":r}function xs(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}class Dc{_read(t,r){var n=this._ctx;return n.error?n.table._trans(null,q.bind(null,n.error)):n.table._trans("readonly",t).then(r)}_write(t){var r=this._ctx;return r.error?r.table._trans(null,q.bind(null,r.error)):r.table._trans("readwrite",t,"locked")}_addAlgorithm(t){var r=this._ctx;r.algorithm=Ke(r.algorithm,t)}_iterate(t,r){return Kt(this._ctx,t,r,this._ctx.table.core)}clone(t){var r=Object.create(this.constructor.prototype),n=Object.create(this._ctx);return t&&H(n,t),r._ctx=n,r}raw(){return this._ctx.valueMapper=null,this}each(t){var r=this._ctx;return this._read(n=>Kt(r,t,n,r.table.core))}count(t){return this._read(r=>{const n=this._ctx,s=n.table.core;if(We(n,!0))return s.count({trans:r,query:{index:tr(n,s.schema),range:n.range}}).then(o=>Math.min(o,n.limit));var i=0;return Kt(n,()=>(++i,!1),r,s).then(()=>i)}).then(t)}sortBy(t,r){const n=t.split(".").reverse(),s=n[0],i=n.length-1;function o(l,u){return u?o(l[n[u]],u-1):l[s]}var c=this._ctx.dir==="next"?1:-1;function a(l,u){var f=o(l,i),d=o(u,i);return f<d?-c:f>d?c:0}return this.toArray(function(l){return l.sort(a)}).then(r)}toArray(t){return this._read(r=>{var n=this._ctx;if(n.dir==="next"&&We(n,!0)&&n.limit>0){const{valueMapper:s}=n,i=tr(n,n.table.core.schema);return n.table.core.query({trans:r,limit:n.limit,values:!0,query:{index:i,range:n.range}}).then(({result:o})=>s?o.map(s):o)}{const s=[];return Kt(n,i=>s.push(i),r,n.table.core).then(()=>s)}},t)}offset(t){var r=this._ctx;return t<=0||(r.offset+=t,We(r)?Ar(r,()=>{var n=t;return(s,i)=>n===0||(n===1?(--n,!1):(i(()=>{s.advance(n),n=0}),!1))}):Ar(r,()=>{var n=t;return()=>--n<0})),this}limit(t){return this._ctx.limit=Math.min(this._ctx.limit,t),Ar(this._ctx,()=>{var r=t;return function(n,s,i){return--r<=0&&s(i),r>=0}},!0),this}until(t,r){return Lr(this._ctx,function(n,s,i){return!t(n.value)||(s(i),r)}),this}first(t){return this.limit(1).toArray(function(r){return r[0]}).then(t)}last(t){return this.reverse().first(t)}filter(t){var r,n;return Lr(this._ctx,function(s){return t(s.value)}),r=this._ctx,n=t,r.isMatch=Ke(r.isMatch,n),this}and(t){return this.filter(t)}or(t){return new this.db.WhereClause(this._ctx.table,t,this)}reverse(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this}desc(){return this.reverse()}eachKey(t){var r=this._ctx;return r.keysOnly=!r.isMatch,this.each(function(n,s){t(s.key,s)})}eachUniqueKey(t){return this._ctx.unique="unique",this.eachKey(t)}eachPrimaryKey(t){var r=this._ctx;return r.keysOnly=!r.isMatch,this.each(function(n,s){t(s.primaryKey,s)})}keys(t){var r=this._ctx;r.keysOnly=!r.isMatch;var n=[];return this.each(function(s,i){n.push(i.key)}).then(function(){return n}).then(t)}primaryKeys(t){var r=this._ctx;if(r.dir==="next"&&We(r,!0)&&r.limit>0)return this._read(s=>{var i=tr(r,r.table.core.schema);return r.table.core.query({trans:s,values:!1,limit:r.limit,query:{index:i,range:r.range}})}).then(({result:s})=>s).then(t);r.keysOnly=!r.isMatch;var n=[];return this.each(function(s,i){n.push(i.primaryKey)}).then(function(){return n}).then(t)}uniqueKeys(t){return this._ctx.unique="unique",this.keys(t)}firstKey(t){return this.limit(1).keys(function(r){return r[0]}).then(t)}lastKey(t){return this.reverse().firstKey(t)}distinct(){var t=this._ctx,r=t.index&&t.table.schema.idxByName[t.index];if(!r||!r.multi)return this;var n={};return Lr(this._ctx,function(s){var i=s.primaryKey.toString(),o=Z(n,i);return n[i]=!0,!o}),this}modify(t){var r=this._ctx;return this._write(n=>{var s;if(typeof t=="function")s=t;else{var i=M(t),o=i.length;s=function(p){for(var y=!1,m=0;m<o;++m){var v=i[m],w=t[v];fe(p,v)!==w&&(te(p,v,w),y=!0)}return y}}const c=r.table.core,{outbound:a,extractKey:l}=c.schema.primaryKey,u=this.db._options.modifyChunkSize||200,f=[];let d=0;const h=[],g=(p,y)=>{const{failures:m,numFailures:v}=y;d+=p-v;for(let w of M(m))f.push(m[w])};return this.clone().primaryKeys().then(p=>{const y=m=>{const v=Math.min(u,p.length-m);return c.getMany({trans:n,keys:p.slice(m,m+v),cache:"immutable"}).then(w=>{const k=[],_=[],E=a?[]:null,I=[];for(let S=0;S<v;++S){const A=w[S],L={value:Lt(A),primKey:p[m+S]};s.call(L,L.value,L)!==!1&&(L.value==null?I.push(p[m+S]):a||J(l(A),l(L.value))===0?(_.push(L.value),a&&E.push(p[m+S])):(I.push(p[m+S]),k.push(L.value)))}const T=We(r)&&r.limit===1/0&&(typeof t!="function"||t===Pr)&&{index:r.index,range:r.range};return Promise.resolve(k.length>0&&c.mutate({trans:n,type:"add",values:k}).then(S=>{for(let A in S.failures)I.splice(parseInt(A),1);g(k.length,S)})).then(()=>(_.length>0||T&&typeof t=="object")&&c.mutate({trans:n,type:"put",keys:E,values:_,criteria:T,changeSpec:typeof t!="function"&&t}).then(S=>g(_.length,S))).then(()=>(I.length>0||T&&t===Pr)&&c.mutate({trans:n,type:"delete",keys:I,criteria:T}).then(S=>g(I.length,S))).then(()=>p.length>m+v&&y(m+u))})};return y(0).then(()=>{if(f.length>0)throw new ar("Error modifying one or more objects",f,d,h);return p.length})})})}delete(){var t=this._ctx,r=t.range;return We(t)&&(t.isPrimKey&&!Wc||r.type===3)?this._write(n=>{const{primaryKey:s}=t.table.core.schema,i=r;return t.table.core.count({trans:n,query:{index:s,range:i}}).then(o=>t.table.core.mutate({trans:n,type:"deleteRange",range:i}).then(({failures:c,lastResult:a,results:l,numFailures:u})=>{if(u)throw new ar("Could not delete some values",Object.keys(c).map(f=>c[f]),o-u);return o-u}))}):this.modify(Pr)}}const Pr=(e,t)=>t.value=null;function Vc(e,t){return e<t?-1:e===t?0:1}function Jc(e,t){return e>t?-1:e===t?0:1}function Q(e,t,r){var n=e instanceof Ci?new e.Collection(e):e;return n._ctx.error=r?new r(t):new TypeError(t),n}function je(e){return new e.Collection(e,()=>Si("")).limit(0)}function Hc(e,t,r,n,s,i){for(var o=Math.min(e.length,n.length),c=-1,a=0;a<o;++a){var l=t[a];if(l!==n[a])return s(e[a],r[a])<0?e.substr(0,a)+r[a]+r.substr(a+1):s(e[a],n[a])<0?e.substr(0,a)+n[a]+r.substr(a+1):c>=0?e.substr(0,c)+t[c]+r.substr(c+1):null;s(e[a],l)<0&&(c=a)}return o<n.length&&i==="next"?e+r.substr(e.length):o<e.length&&i==="prev"?e.substr(0,r.length):c<0?null:e.substr(0,c)+n[c]+r.substr(c+1)}function Mt(e,t,r,n){var s,i,o,c,a,l,u,f=r.length;if(!r.every(p=>typeof p=="string"))return Q(e,"String expected.");function d(p){s=function(m){return m==="next"?v=>v.toUpperCase():v=>v.toLowerCase()}(p),i=function(m){return m==="next"?v=>v.toLowerCase():v=>v.toUpperCase()}(p),o=p==="next"?Vc:Jc;var y=r.map(function(m){return{lower:i(m),upper:s(m)}}).sort(function(m,v){return o(m.lower,v.lower)});c=y.map(function(m){return m.upper}),a=y.map(function(m){return m.lower}),l=p,u=p==="next"?"":n}d("next");var h=new e.Collection(e,()=>ge(c[0],a[f-1]+n));h._ondirectionchange=function(p){d(p)};var g=0;return h._addAlgorithm(function(p,y,m){var v=p.key;if(typeof v!="string")return!1;var w=i(v);if(t(w,a,g))return!0;for(var k=null,_=g;_<f;++_){var E=Hc(v,w,c[_],a[_],o,l);E===null&&k===null?g=_+1:(k===null||o(k,E)>0)&&(k=E)}return y(k!==null?function(){p.continue(k+u)}:m),!1}),h}function ge(e,t,r,n){return{type:2,lower:e,upper:t,lowerOpen:r,upperOpen:n}}function Si(e){return{type:1,lower:e,upper:e}}class Ci{get Collection(){return this._ctx.table.db.Collection}between(t,r,n,s){n=n!==!1,s=s===!0;try{return this._cmp(t,r)>0||this._cmp(t,r)===0&&(n||s)&&(!n||!s)?je(this):new this.Collection(this,()=>ge(t,r,!n,!s))}catch{return Q(this,ie)}}equals(t){return t==null?Q(this,ie):new this.Collection(this,()=>Si(t))}above(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(t,void 0,!0))}aboveOrEqual(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(t,void 0,!1))}below(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(void 0,t,!1,!0))}belowOrEqual(t){return t==null?Q(this,ie):new this.Collection(this,()=>ge(void 0,t))}startsWith(t){return typeof t!="string"?Q(this,"String expected."):this.between(t,t+Le,!0,!0)}startsWithIgnoreCase(t){return t===""?this.startsWith(t):Mt(this,(r,n)=>r.indexOf(n[0])===0,[t],Le)}equalsIgnoreCase(t){return Mt(this,(r,n)=>r===n[0],[t],"")}anyOfIgnoreCase(){var t=ce.apply(Je,arguments);return t.length===0?je(this):Mt(this,(r,n)=>n.indexOf(r)!==-1,t,"")}startsWithAnyOfIgnoreCase(){var t=ce.apply(Je,arguments);return t.length===0?je(this):Mt(this,(r,n)=>n.some(s=>r.indexOf(s)===0),t,Le)}anyOf(){const t=ce.apply(Je,arguments);let r=this._cmp;try{t.sort(r)}catch{return Q(this,ie)}if(t.length===0)return je(this);const n=new this.Collection(this,()=>ge(t[0],t[t.length-1]));n._ondirectionchange=i=>{r=i==="next"?this._ascending:this._descending,t.sort(r)};let s=0;return n._addAlgorithm((i,o,c)=>{const a=i.key;for(;r(a,t[s])>0;)if(++s,s===t.length)return o(c),!1;return r(a,t[s])===0||(o(()=>{i.continue(t[s])}),!1)}),n}notEqual(t){return this.inAnyRange([[-(1/0),t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})}noneOf(){const t=ce.apply(Je,arguments);if(t.length===0)return new this.Collection(this);try{t.sort(this._ascending)}catch{return Q(this,ie)}const r=t.reduce((n,s)=>n?n.concat([[n[n.length-1][1],s]]):[[-(1/0),s]],null);return r.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(r,{includeLowers:!1,includeUppers:!1})}inAnyRange(t,r){const n=this._cmp,s=this._ascending,i=this._descending,o=this._min,c=this._max;if(t.length===0)return je(this);if(!t.every(v=>v[0]!==void 0&&v[1]!==void 0&&s(v[0],v[1])<=0))return Q(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",O.InvalidArgument);const a=!r||r.includeLowers!==!1,l=r&&r.includeUppers===!0;let u,f=s;function d(v,w){return f(v[0],w[0])}try{u=t.reduce(function(v,w){let k=0,_=v.length;for(;k<_;++k){const E=v[k];if(n(w[0],E[1])<0&&n(w[1],E[0])>0){E[0]=o(E[0],w[0]),E[1]=c(E[1],w[1]);break}}return k===_&&v.push(w),v},[]),u.sort(d)}catch{return Q(this,ie)}let h=0;const g=l?v=>s(v,u[h][1])>0:v=>s(v,u[h][1])>=0,p=a?v=>i(v,u[h][0])>0:v=>i(v,u[h][0])>=0;let y=g;const m=new this.Collection(this,()=>ge(u[0][0],u[u.length-1][1],!a,!l));return m._ondirectionchange=v=>{v==="next"?(y=g,f=s):(y=p,f=i),u.sort(d)},m._addAlgorithm((v,w,k)=>{for(var _=v.key;y(_);)if(++h,h===u.length)return w(k),!1;return!!function(E){return!g(E)&&!p(E)}(_)||(this._cmp(_,u[h][1])===0||this._cmp(_,u[h][0])===0||w(()=>{f===s?v.continue(u[h][0]):v.continue(u[h][1])}),!1)}),m}startsWithAnyOf(){const t=ce.apply(Je,arguments);return t.every(r=>typeof r=="string")?t.length===0?je(this):this.inAnyRange(t.map(r=>[r,r+Le])):Q(this,"startsWithAnyOf() only works with strings")}}function ne(e){return B(function(t){return Nt(t),e(t.target.error),!1})}function Nt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}const we=_t(null,"storagemutated");class Xc{_lock(){return ft(!C.global),++this._reculock,this._reculock!==1||C.global||(C.lockOwnerFor=this),this}_unlock(){if(ft(!C.global),--this._reculock==0)for(C.global||(C.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{ot(t[1],t[0])}catch{}}return this}_locked(){return this._reculock&&C.lockOwnerFor!==this}create(t){if(!this.mode)return this;const r=this.db.idbdb,n=this.db._state.dbOpenError;if(ft(!this.idbtrans),!t&&!r)switch(n&&n.name){case"DatabaseClosedError":throw new O.DatabaseClosed(n);case"MissingAPIError":throw new O.MissingAPI(n.message,n);default:throw new O.OpenFailed(n)}if(!this.active)throw new O.TransactionInactive;return ft(this._completion._state===null),(t=this.idbtrans=t||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}))).onerror=B(s=>{Nt(s),this._reject(t.error)}),t.onabort=B(s=>{Nt(s),this.active&&this._reject(new O.Abort(t.error)),this.active=!1,this.on("abort").fire(s)}),t.oncomplete=B(()=>{this.active=!1,this._resolve(),"mutatedParts"in t&&we.storagemutated.fire(t.mutatedParts)}),this}_promise(t,r,n){if(t==="readwrite"&&this.mode!=="readwrite")return q(new O.ReadOnly("Transaction is readonly"));if(!this.active)return q(new O.TransactionInactive);if(this._locked())return new x((i,o)=>{this._blockedFuncs.push([()=>{this._promise(t,r,n).then(i,o)},C])});if(n)return ve(()=>{var i=new x((o,c)=>{this._lock();const a=r(o,c,this);a&&a.then&&a.then(o,c)});return i.finally(()=>this._unlock()),i._lib=!0,i});var s=new x((i,o)=>{var c=r(i,o,this);c&&c.then&&c.then(i,o)});return s._lib=!0,s}_root(){return this.parent?this.parent._root():this}waitFor(t){var r=this._root();const n=x.resolve(t);if(r._waitingFor)r._waitingFor=r._waitingFor.then(()=>n);else{r._waitingFor=n,r._waitingQueue=[];var s=r.idbtrans.objectStore(r.storeNames[0]);(function o(){for(++r._spinCount;r._waitingQueue.length;)r._waitingQueue.shift()();r._waitingFor&&(s.get(-1/0).onsuccess=o)})()}var i=r._waitingFor;return new x((o,c)=>{n.then(a=>r._waitingQueue.push(B(o.bind(null,a))),a=>r._waitingQueue.push(B(c.bind(null,a)))).finally(()=>{r._waitingFor===i&&(r._waitingFor=null)})})}abort(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new O.Abort))}table(t){const r=this._memoizedTables||(this._memoizedTables={});if(Z(r,t))return r[t];const n=this.schema[t];if(!n)throw new O.NotFound("Table "+t+" not part of transaction");const s=new this.db.Table(t,n,this);return s.core=this.db.core.table(t),r[t]=s,s}}function an(e,t,r,n,s,i,o){return{name:e,keyPath:t,unique:r,multi:n,auto:s,compound:i,src:(r&&!o?"&":"")+(n?"*":"")+(s?"++":"")+Ni(t)}}function Ni(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Oi(e,t,r){return{name:e,primKey:t,indexes:r,mappedClass:null,idxByName:ci(r,n=>[n.name,n])}}let Ot=e=>{try{return e.only([[]]),Ot=()=>[[]],[[]]}catch{return Ot=()=>Le,Le}};function cn(e){return e==null?()=>{}:typeof e=="string"?function(t){return t.split(".").length===1?r=>r[t]:r=>fe(r,t)}(e):t=>fe(t,e)}function Ss(e){return[].slice.call(e)}let Yc=0;function Et(e){return e==null?":id":typeof e=="string"?e:`[${e.join("+")}]`}function Qc(e,t,r){function n(a){if(a.type===3)return null;if(a.type===4)throw new Error("Cannot convert never type to IDBKeyRange");const{lower:l,upper:u,lowerOpen:f,upperOpen:d}=a;return l===void 0?u===void 0?null:t.upperBound(u,!!d):u===void 0?t.lowerBound(l,!!f):t.bound(l,u,!!f,!!d)}const{schema:s,hasGetAll:i}=function(a,l){const u=Ss(a.objectStoreNames);return{schema:{name:a.name,tables:u.map(f=>l.objectStore(f)).map(f=>{const{keyPath:d,autoIncrement:h}=f,g=D(d),p=d==null,y={},m={name:f.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:p,compound:g,keyPath:d,autoIncrement:h,unique:!0,extractKey:cn(d)},indexes:Ss(f.indexNames).map(v=>f.index(v)).map(v=>{const{name:w,unique:k,multiEntry:_,keyPath:E}=v,I={name:w,compound:D(E),keyPath:E,unique:k,multiEntry:_,extractKey:cn(E)};return y[Et(E)]=I,I}),getIndexByKeyPath:v=>y[Et(v)]};return y[":id"]=m.primaryKey,d!=null&&(y[Et(d)]=m.primaryKey),m})},hasGetAll:u.length>0&&"getAll"in l.objectStore(u[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}(e,r),o=s.tables.map(a=>function(l){const u=l.name;return{name:u,schema:l,mutate:function({trans:f,type:d,keys:h,values:g,range:p}){return new Promise((y,m)=>{y=B(y);const v=f.objectStore(u),w=v.keyPath==null,k=d==="put"||d==="add";if(!k&&d!=="delete"&&d!=="deleteRange")throw new Error("Invalid operation type: "+d);const{length:_}=h||g||{length:1};if(h&&g&&h.length!==g.length)throw new Error("Given keys array must have same length as given values array.");if(_===0)return y({numFailures:0,failures:{},results:[],lastResult:void 0});let E;const I=[],T=[];let S=0;const A=U=>{++S,Nt(U)};if(d==="deleteRange"){if(p.type===4)return y({numFailures:S,failures:T,results:[],lastResult:void 0});p.type===3?I.push(E=v.clear()):I.push(E=v.delete(n(p)))}else{const[U,F]=k?w?[g,h]:[g,null]:[h,null];if(k)for(let $=0;$<_;++$)I.push(E=F&&F[$]!==void 0?v[d](U[$],F[$]):v[d](U[$])),E.onerror=A;else for(let $=0;$<_;++$)I.push(E=v[d](U[$])),E.onerror=A}const L=U=>{const F=U.target.result;I.forEach(($,he)=>$.error!=null&&(T[he]=$.error)),y({numFailures:S,failures:T,results:d==="delete"?h:I.map($=>$.result),lastResult:F})};E.onerror=U=>{A(U),L(U)},E.onsuccess=L})},getMany:({trans:f,keys:d})=>new Promise((h,g)=>{h=B(h);const p=f.objectStore(u),y=d.length,m=new Array(y);let v,w=0,k=0;const _=I=>{const T=I.target;m[T._pos]=T.result,++k===w&&h(m)},E=ne(g);for(let I=0;I<y;++I)d[I]!=null&&(v=p.get(d[I]),v._pos=I,v.onsuccess=_,v.onerror=E,++w);w===0&&h(m)}),get:({trans:f,key:d})=>new Promise((h,g)=>{h=B(h);const p=f.objectStore(u).get(d);p.onsuccess=y=>h(y.target.result),p.onerror=ne(g)}),query:function(f){return d=>new Promise((h,g)=>{h=B(h);const{trans:p,values:y,limit:m,query:v}=d,w=m===1/0?void 0:m,{index:k,range:_}=v,E=p.objectStore(u),I=k.isPrimaryKey?E:E.index(k.name),T=n(_);if(m===0)return h({result:[]});if(f){const S=y?I.getAll(T,w):I.getAllKeys(T,w);S.onsuccess=A=>h({result:A.target.result}),S.onerror=ne(g)}else{let S=0;const A=y||!("openKeyCursor"in I)?I.openCursor(T):I.openKeyCursor(T),L=[];A.onsuccess=U=>{const F=A.result;return F?(L.push(y?F.value:F.primaryKey),++S===m?h({result:L}):void F.continue()):h({result:L})},A.onerror=ne(g)}})}(i),openCursor:function({trans:f,values:d,query:h,reverse:g,unique:p}){return new Promise((y,m)=>{y=B(y);const{index:v,range:w}=h,k=f.objectStore(u),_=v.isPrimaryKey?k:k.index(v.name),E=g?p?"prevunique":"prev":p?"nextunique":"next",I=d||!("openKeyCursor"in _)?_.openCursor(n(w),E):_.openKeyCursor(n(w),E);I.onerror=ne(m),I.onsuccess=B(T=>{const S=I.result;if(!S)return void y(null);S.___id=++Yc,S.done=!1;const A=S.continue.bind(S);let L=S.continuePrimaryKey;L&&(L=L.bind(S));const U=S.advance.bind(S),F=()=>{throw new Error("Cursor not stopped")};S.trans=f,S.stop=S.continue=S.continuePrimaryKey=S.advance=()=>{throw new Error("Cursor not started")},S.fail=B(m),S.next=function(){let $=1;return this.start(()=>$--?this.continue():this.stop()).then(()=>this)},S.start=$=>{const he=new Promise((z,Ee)=>{z=B(z),I.onerror=ne(Ee),S.fail=Ee,S.stop=at=>{S.stop=S.continue=S.continuePrimaryKey=S.advance=F,z(at)}}),re=()=>{if(I.result)try{$()}catch(z){S.fail(z)}else S.done=!0,S.start=()=>{throw new Error("Cursor behind last entry")},S.stop()};return I.onsuccess=B(z=>{I.onsuccess=re,re()}),S.continue=A,S.continuePrimaryKey=L,S.advance=U,re(),he},y(S)},m)})},count({query:f,trans:d}){const{index:h,range:g}=f;return new Promise((p,y)=>{const m=d.objectStore(u),v=h.isPrimaryKey?m:m.index(h.name),w=n(g),k=w?v.count(w):v.count();k.onsuccess=B(_=>p(_.target.result)),k.onerror=ne(y)})}}}(a)),c={};return o.forEach(a=>c[a.name]=a),{stack:"dbcore",transaction:e.transaction.bind(e),table(a){if(!c[a])throw new Error(`Table '${a}' not found`);return c[a]},MIN_KEY:-1/0,MAX_KEY:Ot(t),schema:s}}function ln({_novip:e},t){const r=t.db,n=function(s,i,{IDBKeyRange:o,indexedDB:c},a){return{dbcore:function(u,f){return f.reduce((d,{create:h})=>({...d,...h(d)}),u)}(Qc(i,o,a),s.dbcore)}}(e._middlewares,r,e._deps,t);e.core=n.dbcore,e.tables.forEach(s=>{const i=s.name;e.core.schema.tables.some(o=>o.name===i)&&(s.core=e.core.table(i),e[i]instanceof e.Table&&(e[i].core=s.core))})}function dr({_novip:e},t,r,n){r.forEach(s=>{const i=n[s];t.forEach(o=>{const c=On(o,s);(!c||"value"in c&&c.value===void 0)&&(o===e.Transaction.prototype||o instanceof e.Transaction?ue(o,s,{get(){return this.table(s)},set(a){ii(this,s,{value:a,writable:!0,configurable:!0,enumerable:!0})}}):o[s]=new e.Table(s,i))})})}function un({_novip:e},t){t.forEach(r=>{for(let n in r)r[n]instanceof e.Table&&delete r[n]})}function Zc(e,t){return e._cfg.version-t._cfg.version}function el(e,t,r,n){const s=e._dbSchema,i=e._createTransaction("readwrite",e._storeNames,s);i.create(r),i._completion.catch(n);const o=i._reject.bind(i),c=C.transless||C;ve(()=>{C.trans=i,C.transless=c,t===0?(M(s).forEach(a=>{$r(r,a,s[a].primKey,s[a].indexes)}),ln(e,r),x.follow(()=>e.on.populate.fire(i)).catch(o)):function({_novip:a},l,u,f){const d=[],h=a._versions;let g=a._dbSchema=dn(a,a.idbdb,f),p=!1;function y(){return d.length?x.resolve(d.shift()(u.idbtrans)).then(y):x.resolve()}return h.filter(m=>m._cfg.version>=l).forEach(m=>{d.push(()=>{const v=g,w=m._cfg.dbschema;hn(a,v,f),hn(a,w,f),g=a._dbSchema=w;const k=Ti(v,w);k.add.forEach(E=>{$r(f,E[0],E[1].primKey,E[1].indexes)}),k.change.forEach(E=>{if(E.recreate)throw new O.Upgrade("Not yet support for changing primary key");{const I=f.objectStore(E.name);E.add.forEach(T=>fn(I,T)),E.change.forEach(T=>{I.deleteIndex(T.name),fn(I,T)}),E.del.forEach(T=>I.deleteIndex(T))}});const _=m._cfg.contentUpgrade;if(_&&m._cfg.version>l){ln(a,f),u._memoizedTables={},p=!0;let E=li(w);k.del.forEach(A=>{E[A]=v[A]}),un(a,[a.Transaction.prototype]),dr(a,[a.Transaction.prototype],M(E),E),u.schema=E;const I=Tn(_);let T;I&&it();const S=x.follow(()=>{if(T=_(u),T&&I){var A=de.bind(null,null);T.then(A,A)}});return T&&typeof T.then=="function"?x.resolve(T):S.then(()=>T)}}),d.push(v=>{(!p||!qc)&&function(w,k){[].slice.call(k.db.objectStoreNames).forEach(_=>w[_]==null&&k.db.deleteObjectStore(_))}(m._cfg.dbschema,v),un(a,[a.Transaction.prototype]),dr(a,[a.Transaction.prototype],a._storeNames,a._dbSchema),u.schema=a._dbSchema})}),y().then(()=>{var m,v;v=f,M(m=g).forEach(w=>{v.db.objectStoreNames.contains(w)||$r(v,w,m[w].primKey,m[w].indexes)})})}(e,t,i,r).catch(o)})}function Ti(e,t){const r={del:[],add:[],change:[]};let n;for(n in e)t[n]||r.del.push(n);for(n in t){const s=e[n],i=t[n];if(s){const o={name:n,def:i,recreate:!1,del:[],add:[],change:[]};if(""+(s.primKey.keyPath||"")!=""+(i.primKey.keyPath||"")||s.primKey.auto!==i.primKey.auto&&!mr)o.recreate=!0,r.change.push(o);else{const c=s.idxByName,a=i.idxByName;let l;for(l in c)a[l]||o.del.push(l);for(l in a){const u=c[l],f=a[l];u?u.src!==f.src&&o.change.push(f):o.add.push(f)}(o.del.length>0||o.add.length>0||o.change.length>0)&&r.change.push(o)}}else r.add.push([n,i])}return r}function $r(e,t,r,n){const s=e.db.createObjectStore(t,r.keyPath?{keyPath:r.keyPath,autoIncrement:r.auto}:{autoIncrement:r.auto});return n.forEach(i=>fn(s,i)),s}function fn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function dn(e,t,r){const n={};return or(t.objectStoreNames,0).forEach(s=>{const i=r.objectStore(s);let o=i.keyPath;const c=an(Ni(o),o||"",!1,!1,!!i.autoIncrement,o&&typeof o!="string",!0),a=[];for(let u=0;u<i.indexNames.length;++u){const f=i.index(i.indexNames[u]);o=f.keyPath;var l=an(f.name,o,!!f.unique,!!f.multiEntry,!1,o&&typeof o!="string",!1);a.push(l)}n[s]=Oi(s,c,a)}),n}function hn({_novip:e},t,r){const n=r.db.objectStoreNames;for(let s=0;s<n.length;++s){const i=n[s],o=r.objectStore(i);e._hasGetAll="getAll"in o;for(let c=0;c<o.indexNames.length;++c){const a=o.indexNames[c],l=o.index(a).keyPath,u=typeof l=="string"?l:"["+or(l).join("+")+"]";if(t[i]){const f=t[i].idxByName[u];f&&(f.name=a,delete t[i].idxByName[u],t[i].idxByName[a]=f)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&G.WorkerGlobalScope&&G instanceof G.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}class tl{_parseStoresSpec(t,r){M(t).forEach(n=>{if(t[n]!==null){var s=t[n].split(",").map((o,c)=>{const a=(o=o.trim()).replace(/([&*]|\+\+)/g,""),l=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return an(a,l||null,/\&/.test(o),/\*/.test(o),/\+\+/.test(o),D(l),c===0)}),i=s.shift();if(i.multi)throw new O.Schema("Primary key cannot be multi-valued");s.forEach(o=>{if(o.auto)throw new O.Schema("Only primary key can be marked as autoIncrement (++)");if(!o.keyPath)throw new O.Schema("Index must have a name and cannot be an empty string")}),r[n]=Oi(n,i,s)}})}stores(t){const r=this.db;this._cfg.storesSource=this._cfg.storesSource?H(this._cfg.storesSource,t):t;const n=r._versions,s={};let i={};return n.forEach(o=>{H(s,o._cfg.storesSource),i=o._cfg.dbschema={},o._parseStoresSpec(s,i)}),r._dbSchema=i,un(r,[r._allTables,r,r.Transaction.prototype]),dr(r,[r._allTables,r,r.Transaction.prototype,this._cfg.tables],M(i),i),r._storeNames=M(i),this}upgrade(t){return this._cfg.contentUpgrade=Pn(this._cfg.contentUpgrade||P,t),this}}function Bn(e,t){let r=e._dbNamesDB;return r||(r=e._dbNamesDB=new Re("__dbnames",{addons:[],indexedDB:e,IDBKeyRange:t}),r.version(1).stores({dbnames:"name"})),r.table("dbnames")}function Fn(e){return e&&typeof e.databases=="function"}function pn(e){return ve(function(){return C.letThrough=!0,e()})}function rl(){var e;return!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(t){var r=function(){return indexedDB.databases().finally(t)};e=setInterval(r,100),r()}).finally(function(){return clearInterval(e)}):Promise.resolve()}function nl(e){const t=e._state,{indexedDB:r}=e._deps;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(()=>t.dbOpenError?q(t.dbOpenError):e);se&&(t.openCanceller._stackHolder=Me()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;const n=t.openCanceller;function s(){if(t.openCanceller!==n)throw new O.DatabaseClosed("db.open() was cancelled")}let i=t.dbReadyResolve,o=null,c=!1;return x.race([n,(typeof navigator>"u"?x.resolve():rl()).then(()=>new x((a,l)=>{if(s(),!r)throw new O.MissingAPI;const u=e.name,f=t.autoSchema?r.open(u):r.open(u,Math.round(10*e.verno));if(!f)throw new O.MissingAPI;f.onerror=ne(l),f.onblocked=B(e._fireOnBlocked),f.onupgradeneeded=B(d=>{if(o=f.transaction,t.autoSchema&&!e._options.allowEmptyDB){f.onerror=Nt,o.abort(),f.result.close();const g=r.deleteDatabase(u);g.onsuccess=g.onerror=B(()=>{l(new O.NoSuchDatabase(`Database ${u} doesnt exist`))})}else{o.onerror=ne(l);var h=d.oldVersion>Math.pow(2,62)?0:d.oldVersion;c=h<1,e._novip.idbdb=f.result,el(e,h/10,o,l)}},l),f.onsuccess=B(()=>{o=null;const d=e._novip.idbdb=f.result,h=or(d.objectStoreNames);if(h.length>0)try{const p=d.transaction((g=h).length===1?g[0]:g,"readonly");t.autoSchema?function({_novip:y},m,v){y.verno=m.version/10;const w=y._dbSchema=dn(0,m,v);y._storeNames=or(m.objectStoreNames,0),dr(y,[y._allTables],M(w),w)}(e,d,p):(hn(e,e._dbSchema,p),function(y,m){const v=Ti(dn(0,y.idbdb,m),y._dbSchema);return!(v.add.length||v.change.some(w=>w.add.length||w.change.length))}(e,p)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),ln(e,p)}catch{}var g;wt.push(e),d.onversionchange=B(p=>{t.vcFired=!0,e.on("versionchange").fire(p)}),d.onclose=B(p=>{e.on("close").fire(p)}),c&&function({indexedDB:p,IDBKeyRange:y},m){!Fn(p)&&m!=="__dbnames"&&Bn(p,y).put({name:m}).catch(P)}(e._deps,u),a()},l)}))]).then(()=>(s(),t.onReadyBeingFired=[],x.resolve(pn(()=>e.on.ready.fire(e.vip))).then(function a(){if(t.onReadyBeingFired.length>0){let l=t.onReadyBeingFired.reduce(Pn,P);return t.onReadyBeingFired=[],x.resolve(pn(()=>l(e.vip))).then(a)}}))).finally(()=>{t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(()=>e).catch(a=>{t.dbOpenError=a;try{o&&o.abort()}catch{}return n===t.openCanceller&&e._close(),q(a)}).finally(()=>{t.openComplete=!0,i()})}function gn(e){var t=i=>e.next(i),r=s(t),n=s(i=>e.throw(i));function s(i){return o=>{var c=i(o),a=c.value;return c.done?a:a&&typeof a.then=="function"?a.then(r,n):D(a)?Promise.all(a).then(r,n):r(a)}}return s(t)()}function sl(e,t,r){var n=arguments.length;if(n<2)throw new O.InvalidArgument("Too few arguments");for(var s=new Array(n-1);--n;)s[n-1]=arguments[n];r=s.pop();var i=ui(s);return[e,i,r]}function Li(e,t,r,n,s){return x.resolve().then(()=>{const i=C.transless||C,o=e._createTransaction(t,r,e._dbSchema,n),c={trans:o,transless:i};if(n)o.idbtrans=n.idbtrans;else try{o.create(),e._state.PR1398_maxLoop=3}catch(f){return f.name===An.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(()=>Li(e,t,r,null,s))):q(f)}const a=Tn(s);let l;a&&it();const u=x.follow(()=>{if(l=s.call(o,o),l)if(a){var f=de.bind(null,null);l.then(f,f)}else typeof l.next=="function"&&typeof l.throw=="function"&&(l=gn(l))},c);return(l&&typeof l.then=="function"?x.resolve(l).then(f=>o.active?f:q(new O.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))):u.then(()=>l)).then(f=>(n&&o._resolve(),o._completion.then(()=>f))).catch(f=>(o._reject(f),q(f)))})}function Ut(e,t,r){const n=D(e)?e.slice():[e];for(let s=0;s<r;++s)n.push(t);return n}const il={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return{...e,table(t){const r=e.table(t),{schema:n}=r,s={},i=[];function o(u,f,d){const h=Et(u),g=s[h]=s[h]||[],p=u==null?0:typeof u=="string"?1:u.length,y=f>0,m={...d,isVirtual:y,keyTail:f,keyLength:p,extractKey:cn(u),unique:!y&&d.unique};return g.push(m),m.isPrimaryKey||i.push(m),p>1&&o(p===2?u[0]:u.slice(0,p-1),f+1,d),g.sort((v,w)=>v.keyTail-w.keyTail),m}const c=o(n.primaryKey.keyPath,0,n.primaryKey);s[":id"]=[c];for(const u of n.indexes)o(u.keyPath,0,u);function a(u){const f=u.query.index;return f.isVirtual?{...u,query:{index:f,range:(d=u.query.range,h=f.keyTail,{type:d.type===1?2:d.type,lower:Ut(d.lower,d.lowerOpen?e.MAX_KEY:e.MIN_KEY,h),lowerOpen:!0,upper:Ut(d.upper,d.upperOpen?e.MIN_KEY:e.MAX_KEY,h),upperOpen:!0})}}:u;var d,h}return{...r,schema:{...n,primaryKey:c,indexes:i,getIndexByKeyPath:function(u){const f=s[Et(u)];return f&&f[0]}},count:u=>r.count(a(u)),query:u=>r.query(a(u)),openCursor(u){const{keyTail:f,isVirtual:d,keyLength:h}=u.query.index;return d?r.openCursor(a(u)).then(g=>g&&function(p){return Object.create(p,{continue:{value:function(m){m!=null?p.continue(Ut(m,u.reverse?e.MAX_KEY:e.MIN_KEY,f)):u.unique?p.continue(p.key.slice(0,h).concat(u.reverse?e.MIN_KEY:e.MAX_KEY,f)):p.continue()}},continuePrimaryKey:{value(m,v){p.continuePrimaryKey(Ut(m,e.MAX_KEY,f),v)}},primaryKey:{get:()=>p.primaryKey},key:{get(){const m=p.key;return h===1?m[0]:m.slice(0,h)}},value:{get:()=>p.value}})}(g)):r.openCursor(u)}}}}}};function Kn(e,t,r,n){return r=r||{},n=n||"",M(e).forEach(s=>{if(Z(t,s)){var i=e[s],o=t[s];if(typeof i=="object"&&typeof o=="object"&&i&&o){const c=Jr(i);c!==Jr(o)?r[n+s]=t[s]:c==="Object"?Kn(i,o,r,n+s+"."):i!==o&&(r[n+s]=t[s])}else i!==o&&(r[n+s]=t[s])}else r[n+s]=void 0}),M(t).forEach(s=>{Z(e,s)||(r[n+s]=t[s])}),r}const ol={stack:"dbcore",name:"HooksMiddleware",level:2,create:e=>({...e,table(t){const r=e.table(t),{primaryKey:n}=r.schema;return{...r,mutate(i){const o=C.trans,{deleting:c,creating:a,updating:l}=o.table(t).hook;switch(i.type){case"add":if(a.fire===P)break;return o._promise("readwrite",()=>u(i),!0);case"put":if(a.fire===P&&l.fire===P)break;return o._promise("readwrite",()=>u(i),!0);case"delete":if(c.fire===P)break;return o._promise("readwrite",()=>u(i),!0);case"deleteRange":if(c.fire===P)break;return o._promise("readwrite",()=>function(d){return f(d.trans,d.range,1e4)}(i),!0)}return r.mutate(i);function u(d){const h=C.trans,g=d.keys||function(p,y){return y.type==="delete"?y.keys:y.keys||y.values.map(p.extractKey)}(n,d);if(!g)throw new Error("Keys missing");return(d=d.type==="add"||d.type==="put"?{...d,keys:g}:{...d}).type!=="delete"&&(d.values=[...d.values]),d.keys&&(d.keys=[...d.keys]),function(p,y,m){return y.type==="add"?Promise.resolve([]):p.getMany({trans:y.trans,keys:m,cache:"immutable"})}(r,d,g).then(p=>{const y=g.map((m,v)=>{const w=p[v],k={onerror:null,onsuccess:null};if(d.type==="delete")c.fire.call(k,m,w,h);else if(d.type==="add"||w===void 0){const _=a.fire.call(k,m,d.values[v],h);m==null&&_!=null&&(m=_,d.keys[v]=m,n.outbound||te(d.values[v],n.keyPath,m))}else{const _=Kn(w,d.values[v]),E=l.fire.call(k,_,m,w,h);if(E){const I=d.values[v];Object.keys(E).forEach(T=>{Z(I,T)?I[T]=E[T]:te(I,T,E[T])})}}return k});return r.mutate(d).then(({failures:m,results:v,numFailures:w,lastResult:k})=>{for(let _=0;_<g.length;++_){const E=v?v[_]:g[_],I=y[_];E==null?I.onerror&&I.onerror(m[_]):I.onsuccess&&I.onsuccess(d.type==="put"&&p[_]?d.values[_]:E)}return{failures:m,results:v,numFailures:w,lastResult:k}}).catch(m=>(y.forEach(v=>v.onerror&&v.onerror(m)),Promise.reject(m)))})}function f(d,h,g){return r.query({trans:d,values:!1,query:{index:n,range:h},limit:g}).then(({result:p})=>u({type:"delete",keys:p,trans:d}).then(y=>y.numFailures>0?Promise.reject(y.failures[0]):p.length<g?{failures:[],numFailures:0,lastResult:void 0}:f(d,{...h,lower:p[p.length-1],lowerOpen:!0},g)))}}}}})};function Ai(e,t,r){try{if(!t||t.keys.length<e.length)return null;const n=[];for(let s=0,i=0;s<t.keys.length&&i<e.length;++s)J(t.keys[s],e[i])===0&&(n.push(r?Lt(t.values[s]):t.values[s]),++i);return n.length===e.length?n:null}catch{return null}}const al={stack:"dbcore",level:-1,create:e=>({table:t=>{const r=e.table(t);return{...r,getMany:n=>{if(!n.cache)return r.getMany(n);const s=Ai(n.keys,n.trans._cache,n.cache==="clone");return s?x.resolve(s):r.getMany(n).then(i=>(n.trans._cache={keys:n.keys,values:n.cache==="clone"?Lt(i):i},i))},mutate:n=>(n.type!=="add"&&(n.trans._cache=null),r.mutate(n))}}})};function Mn(e){return!("from"in e)}const oe=function(e,t){if(!this){const r=new oe;return e&&"d"in e&&H(r,e),r}H(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0})};function Tt(e,t,r){const n=J(t,r);if(isNaN(n))return;if(n>0)throw RangeError();if(Mn(e))return H(e,{from:t,to:r,d:1});const s=e.l,i=e.r;if(J(r,e.from)<0)return s?Tt(s,t,r):e.l={from:t,to:r,d:1,l:null,r:null},Cs(e);if(J(t,e.to)>0)return i?Tt(i,t,r):e.r={from:t,to:r,d:1,l:null,r:null},Cs(e);J(t,e.from)<0&&(e.from=t,e.l=null,e.d=i?i.d+1:1),J(r,e.to)>0&&(e.to=r,e.r=null,e.d=e.l?e.l.d+1:1);const o=!e.r;s&&!e.l&&hr(e,s),i&&o&&hr(e,i)}function hr(e,t){Mn(t)||function r(n,{from:s,to:i,l:o,r:c}){Tt(n,s,i),o&&r(n,o),c&&r(n,c)}(e,t)}function cl(e,t){const r=yn(t);let n=r.next();if(n.done)return!1;let s=n.value;const i=yn(e);let o=i.next(s.from),c=o.value;for(;!n.done&&!o.done;){if(J(c.from,s.to)<=0&&J(c.to,s.from)>=0)return!0;J(s.from,c.from)<0?s=(n=r.next(c.from)).value:c=(o=i.next(s.from)).value}return!1}function yn(e){let t=Mn(e)?null:{s:0,n:e};return{next(r){const n=arguments.length>0;for(;t;)switch(t.s){case 0:if(t.s=1,n)for(;t.n.l&&J(r,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!n||J(r,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function Cs(e){var t,r;const n=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((r=e.l)===null||r===void 0?void 0:r.d)||0),s=n>1?"r":n<-1?"l":"";if(s){const i=s==="r"?"l":"r",o={...e},c=e[s];e.from=c.from,e.to=c.to,e[s]=c[s],o[s]=c[i],e[i]=o,o.d=Ns(o)}e.d=Ns(e)}function Ns({r:e,l:t}){return(e?t?Math.max(e.d,t.d):e.d:t?t.d:0)+1}nt(oe.prototype,{add(e){return hr(this,e),this},addKey(e){return Tt(this,e,e),this},addKeys(e){return e.forEach(t=>Tt(this,t,t)),this},[Hr](){return yn(this)}});const ll={stack:"dbcore",level:0,create:e=>{const t=e.schema.name,r=new oe(e.MIN_KEY,e.MAX_KEY);return{...e,table:n=>{const s=e.table(n),{schema:i}=s,{primaryKey:o}=i,{extractKey:c,outbound:a}=o,l={...s,mutate:d=>{const h=d.trans,g=h.mutatedParts||(h.mutatedParts={}),p=E=>{const I=`idb://${t}/${n}/${E}`;return g[I]||(g[I]=new oe)},y=p(""),m=p(":dels"),{type:v}=d;let[w,k]=d.type==="deleteRange"?[d.range]:d.type==="delete"?[d.keys]:d.values.length<50?[[],d.values]:[];const _=d.trans._cache;return s.mutate(d).then(E=>{if(D(w)){v!=="delete"&&(w=E.results),y.addKeys(w);const I=Ai(w,_);I||v==="add"||m.addKeys(w),(I||k)&&function(T,S,A,L){function U(F){const $=T(F.name||"");function he(z){return z!=null?F.extractKey(z):null}const re=z=>F.multiEntry&&D(z)?z.forEach(Ee=>$.addKey(Ee)):$.addKey(z);(A||L).forEach((z,Ee)=>{const at=A&&he(A[Ee]),vr=L&&he(L[Ee]);J(at,vr)!==0&&(at!=null&&re(at),vr!=null&&re(vr))})}S.indexes.forEach(U)}(p,i,I,k)}else if(w){const I={from:w.lower,to:w.upper};m.add(I),y.add(I)}else y.add(r),m.add(r),i.indexes.forEach(I=>p(I.name).add(r));return E})}},u=({query:{index:d,range:h}})=>{var g,p;return[d,new oe((g=h.lower)!==null&&g!==void 0?g:e.MIN_KEY,(p=h.upper)!==null&&p!==void 0?p:e.MAX_KEY)]},f={get:d=>[o,new oe(d.key)],getMany:d=>[o,new oe().addKeys(d.keys)],count:u,query:u,openCursor:u};return M(f).forEach(d=>{l[d]=function(h){const{subscr:g}=C;if(g){const p=k=>{const _=`idb://${t}/${n}/${k}`;return g[_]||(g[_]=new oe)},y=p(""),m=p(":dels"),[v,w]=f[d](h);if(p(v.name||"").add(w),!v.isPrimaryKey){if(d!=="count"){const k=d==="query"&&a&&h.values&&s.query({...h,values:!1});return s[d].apply(this,arguments).then(_=>{if(d==="query"){if(a&&h.values)return k.then(({result:I})=>(y.addKeys(I),_));const E=h.values?_.result.map(c):_.result;h.values?y.addKeys(E):m.addKeys(E)}else if(d==="openCursor"){const E=_,I=h.values;return E&&Object.create(E,{key:{get:()=>(m.addKey(E.primaryKey),E.key)},primaryKey:{get(){const T=E.primaryKey;return m.addKey(T),T}},value:{get:()=>(I&&y.addKey(E.primaryKey),E.value)}})}return _})}m.add(r)}}return s[d].apply(this,arguments)}}),l}}}};class Re{constructor(t,r){this._middlewares={},this.verno=0;const n=Re.dependencies;this._options=r={addons:Re.addons,autoOpen:!0,indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange,...r},this._deps={indexedDB:r.indexedDB,IDBKeyRange:r.IDBKeyRange};const{addons:s}=r;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;const i={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:P,dbReadyPromise:null,cancelOpen:P,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};var o;i.dbReadyPromise=new x(c=>{i.dbReadyResolve=c}),i.openCanceller=new x((c,a)=>{i.cancelOpen=a}),this._state=i,this.name=t,this.on=_t(this,"populate","blocked","versionchange","close",{ready:[Pn,P]}),this.on.ready.subscribe=oi(this.on.ready.subscribe,c=>(a,l)=>{Re.vip(()=>{const u=this._state;if(u.openComplete)u.dbOpenError||x.resolve().then(a),l&&c(a);else if(u.onReadyBeingFired)u.onReadyBeingFired.push(a),l&&c(a);else{c(a);const f=this;l||c(function d(){f.on.ready.unsubscribe(a),f.on.ready.unsubscribe(d)})}})}),this.Collection=(o=this,ut(Dc.prototype,function(c,a){this.db=o;let l=xi,u=null;if(a)try{l=a()}catch(g){u=g}const f=c._ctx,d=f.table,h=d.hook.reading.fire;this._ctx={table:d,index:f.index,isPrimKey:!f.index||d.schema.primKey.keyPath&&f.index===d.schema.primKey.name,range:l,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:u,or:f.or,valueMapper:h!==St?h:null}})),this.Table=function(c){return ut(jc.prototype,function(a,l,u){this.db=c,this._tx=u,this.name=a,this.schema=l,this.hook=c._allTables[a]?c._allTables[a].hook:_t(null,{creating:[Pc,P],reading:[Ac,St],updating:[Gc,P],deleting:[$c,P]})})}(this),this.Transaction=function(c){return ut(Xc.prototype,function(a,l,u,f,d){this.db=c,this.mode=a,this.storeNames=l,this.schema=u,this.chromeTransactionDurability=f,this.idbtrans=null,this.on=_t(this,"complete","error","abort"),this.parent=d||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new x((h,g)=>{this._resolve=h,this._reject=g}),this._completion.then(()=>{this.active=!1,this.on.complete.fire()},h=>{var g=this.active;return this.active=!1,this.on.error.fire(h),this.parent?this.parent._reject(h):g&&this.idbtrans&&this.idbtrans.abort(),q(h)})})}(this),this.Version=function(c){return ut(tl.prototype,function(a){this.db=c,this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}(this),this.WhereClause=function(c){return ut(Ci.prototype,function(a,l,u){this.db=c,this._ctx={table:a,index:l===":id"?null:l,or:u};const f=c._deps.indexedDB;if(!f)throw new O.MissingAPI;this._cmp=this._ascending=f.cmp.bind(f),this._descending=(d,h)=>f.cmp(h,d),this._max=(d,h)=>f.cmp(d,h)>0?d:h,this._min=(d,h)=>f.cmp(d,h)<0?d:h,this._IDBKeyRange=c._deps.IDBKeyRange})}(this),this.on("versionchange",c=>{c.newVersion>0?console.warn(`Another connection wants to upgrade database '${this.name}'. Closing db now to resume the upgrade.`):console.warn(`Another connection wants to delete database '${this.name}'. Closing db now to resume the delete request.`),this.close()}),this.on("blocked",c=>{!c.newVersion||c.newVersion<c.oldVersion?console.warn(`Dexie.delete('${this.name}') was blocked`):console.warn(`Upgrade '${this.name}' blocked by other connection holding version ${c.oldVersion/10}`)}),this._maxKey=Ot(r.IDBKeyRange),this._createTransaction=(c,a,l,u)=>new this.Transaction(c,a,l,this._options.chromeTransactionDurability,u),this._fireOnBlocked=c=>{this.on("blocked").fire(c),wt.filter(a=>a.name===this.name&&a!==this&&!a._state.vcFired).map(a=>a.on("versionchange").fire(c))},this.use(il),this.use(ol),this.use(ll),this.use(al),this.vip=Object.create(this,{_vip:{value:!0}}),s.forEach(c=>c(this))}version(t){if(isNaN(t)||t<.1)throw new O.Type("Given version is not a positive number");if(t=Math.round(10*t)/10,this.idbdb||this._state.isBeingOpened)throw new O.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);const r=this._versions;var n=r.filter(s=>s._cfg.version===t)[0];return n||(n=new this.Version(t),r.push(n),r.sort(Zc),n.stores({}),this._state.autoSchema=!1,n)}_whenReady(t){return this.idbdb&&(this._state.openComplete||C.letThrough||this._vip)?t():new x((r,n)=>{if(this._state.openComplete)return n(new O.DatabaseClosed(this._state.dbOpenError));if(!this._state.isBeingOpened){if(!this._options.autoOpen)return void n(new O.DatabaseClosed);this.open().catch(P)}this._state.dbReadyPromise.then(r,n)}).then(t)}use({stack:t,create:r,level:n,name:s}){s&&this.unuse({stack:t,name:s});const i=this._middlewares[t]||(this._middlewares[t]=[]);return i.push({stack:t,create:r,level:n??10,name:s}),i.sort((o,c)=>o.level-c.level),this}unuse({stack:t,name:r,create:n}){return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(s=>n?s.create!==n:!!r&&s.name!==r)),this}open(){return nl(this)}_close(){const t=this._state,r=wt.indexOf(this);if(r>=0&&wt.splice(r,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}t.dbReadyPromise=new x(n=>{t.dbReadyResolve=n}),t.openCanceller=new x((n,s)=>{t.cancelOpen=s})}close(){this._close();const t=this._state;this._options.autoOpen=!1,t.dbOpenError=new O.DatabaseClosed,t.isBeingOpened&&t.cancelOpen(t.dbOpenError)}delete(){const t=arguments.length>0,r=this._state;return new x((n,s)=>{const i=()=>{this.close();var o=this._deps.indexedDB.deleteDatabase(this.name);o.onsuccess=B(()=>{(function({indexedDB:c,IDBKeyRange:a},l){!Fn(c)&&l!=="__dbnames"&&Bn(c,a).delete(l).catch(P)})(this._deps,this.name),n()}),o.onerror=ne(s),o.onblocked=this._fireOnBlocked};if(t)throw new O.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(i):i()})}backendDB(){return this.idbdb}isOpen(){return this.idbdb!==null}hasBeenClosed(){const t=this._state.dbOpenError;return t&&t.name==="DatabaseClosed"}hasFailed(){return this._state.dbOpenError!==null}dynamicallyOpened(){return this._state.autoSchema}get tables(){return M(this._allTables).map(t=>this._allTables[t])}transaction(){const t=sl.apply(this,arguments);return this._transaction.apply(this,t)}_transaction(t,r,n){let s=C.trans;s&&s.db===this&&t.indexOf("!")===-1||(s=null);const i=t.indexOf("?")!==-1;let o,c;t=t.replace("!","").replace("?","");try{if(c=r.map(l=>{var u=l instanceof this.Table?l.name:l;if(typeof u!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return u}),t=="r"||t==="readonly")o="readonly";else{if(t!="rw"&&t!="readwrite")throw new O.InvalidArgument("Invalid transaction mode: "+t);o="readwrite"}if(s){if(s.mode==="readonly"&&o==="readwrite"){if(!i)throw new O.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");s=null}s&&c.forEach(l=>{if(s&&s.storeNames.indexOf(l)===-1){if(!i)throw new O.SubTransaction("Table "+l+" not included in parent transaction.");s=null}}),i&&s&&!s.active&&(s=null)}}catch(l){return s?s._promise(null,(u,f)=>{f(l)}):q(l)}const a=Li.bind(null,this,o,c,s,n);return s?s._promise(o,a,"lock"):C.trans?ot(C.transless,()=>this._whenReady(a)):this._whenReady(a)}table(t){if(!Z(this._allTables,t))throw new O.InvalidTable(`Table ${t} does not exist`);return this._allTables[t]}}const ul=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable";class fl{constructor(t){this._subscribe=t}subscribe(t,r,n){return this._subscribe(t&&typeof t!="function"?t:{next:t,error:r,complete:n})}[ul](){return this}}function Pi(e,t){return M(t).forEach(r=>{hr(e[r]||(e[r]=new oe),t[r])}),e}function dl(e){return new fl(t=>{const r=Tn(e);let n=!1,s={},i={};const o={get closed(){return n},unsubscribe:()=>{n=!0,we.storagemutated.unsubscribe(u)}};t.start&&t.start(o);let c=!1,a=!1;function l(){return M(i).some(d=>s[d]&&cl(s[d],i[d]))}const u=d=>{Pi(s,d),l()&&f()},f=()=>{if(c||n)return;s={};const d={},h=function(g){r&&it();const p=()=>ve(e,{subscr:g,trans:null}),y=C.trans?ot(C.transless,p):p();return r&&y.then(de,de),y}(d);a||(we("storagemutated",u),a=!0),c=!0,Promise.resolve(h).then(g=>{c=!1,n||(l()?f():(s={},i=d,t.next&&t.next(g)))},g=>{c=!1,t.error&&t.error(g),o.unsubscribe()})};return f(),o})}let mn;try{mn={indexedDB:G.indexedDB||G.mozIndexedDB||G.webkitIndexedDB||G.msIndexedDB,IDBKeyRange:G.IDBKeyRange||G.webkitIDBKeyRange}}catch{mn={indexedDB:null,IDBKeyRange:null}}const Ie=Re;function rr(e){let t=le;try{le=!0,we.storagemutated.fire(e)}finally{le=t}}nt(Ie,{...Xt,delete:e=>new Ie(e,{addons:[]}).delete(),exists:e=>new Ie(e,{addons:[]}).open().then(t=>(t.close(),!0)).catch("NoSuchDatabaseError",()=>!1),getDatabaseNames(e){try{return function({indexedDB:t,IDBKeyRange:r}){return Fn(t)?Promise.resolve(t.databases()).then(n=>n.map(s=>s.name).filter(s=>s!=="__dbnames")):Bn(t,r).toCollection().primaryKeys()}(Ie.dependencies).then(e)}catch{return q(new O.MissingAPI)}},defineClass:()=>function(e){H(this,e)},ignoreTransaction:e=>C.trans?ot(C.transless,e):e(),vip:pn,async:function(e){return function(){try{var t=gn(e.apply(this,arguments));return t&&typeof t.then=="function"?t:x.resolve(t)}catch(r){return q(r)}}},spawn:function(e,t,r){try{var n=gn(e.apply(r,t||[]));return n&&typeof n.then=="function"?n:x.resolve(n)}catch(s){return q(s)}},currentTransaction:{get:()=>C.trans||null},waitFor:function(e,t){const r=x.resolve(typeof e=="function"?Ie.ignoreTransaction(e):e).timeout(t||6e4);return C.trans?C.trans.waitFor(r):r},Promise:x,debug:{get:()=>se,set:e=>{di(e,e==="dexie"?()=>!0:Ii)}},derive:Ye,extend:H,props:nt,override:oi,Events:_t,on:we,liveQuery:dl,extendObservabilitySet:Pi,getByKeyPath:fe,setByKeyPath:te,delByKeyPath:function(e,t){typeof t=="string"?te(e,t,void 0):"length"in t&&[].map.call(t,function(r){te(e,r,void 0)})},shallowClone:li,deepClone:Lt,getObjectDiff:Kn,cmp:J,asap:ai,minKey:-(1/0),addons:[],connections:wt,errnames:An,dependencies:mn,semVer:"3.2.3",version:"3.2.3".split(".").map(e=>parseInt(e)).reduce((e,t,r)=>e+t/Math.pow(10,2*r))}),Ie.maxKey=Ot(Ie.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(we("storagemutated",e=>{if(!le){let t;mr?(t=document.createEvent("CustomEvent"),t.initCustomEvent("x-storagemutated-1",!0,!0,e)):t=new CustomEvent("x-storagemutated-1",{detail:e}),le=!0,dispatchEvent(t),le=!1}}),addEventListener("x-storagemutated-1",({detail:e})=>{le||rr(e)}));let le=!1;if(typeof BroadcastChannel<"u"){const e=new BroadcastChannel("x-storagemutated-1");typeof e.unref=="function"&&e.unref(),we("storagemutated",t=>{le||e.postMessage(t)}),e.onmessage=t=>{t.data&&rr(t.data)}}else if(typeof self<"u"&&typeof navigator<"u"){we("storagemutated",t=>{try{le||(typeof localStorage<"u"&&localStorage.setItem("x-storagemutated-1",JSON.stringify({trig:Math.random(),changedParts:t})),typeof self.clients=="object"&&[...self.clients.matchAll({includeUncontrolled:!0})].forEach(r=>r.postMessage({type:"x-storagemutated-1",changedParts:t})))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",t=>{if(t.key==="x-storagemutated-1"){const r=JSON.parse(t.newValue);r&&rr(r.changedParts)}});const e=self.document&&navigator.serviceWorker;e&&e.addEventListener("message",function({data:t}){t&&t.type==="x-storagemutated-1"&&rr(t.changedParts)})}x.rejectionMapper=function(e,t){if(!e||e instanceof Qe||e instanceof TypeError||e instanceof SyntaxError||!e.name||!bs[e.name])return e;var r=new bs[e.name](t||e.message,e);return"stack"in e&&ue(r,"stack",{get:function(){return this.inner.stack}}),r},di(se,Ii);class hl extends Re{constructor(){super("nr-editor");b(this,"catalogues");b(this,"systems");this.version(5).stores({catalogues:"id, content.catalogue.id, content.catalogue.gameSystemId",systems:"id"})}}const Ne=new hl;function Ml(e){const t=/^(?:(http(s?)?:\/\/)?github.com\/)?([^\/]+)\/([^\/]+)$/,r=e.match(t);if(!r)return null;const[,n="https://",s,i,o]=r;return!i||!o?null:`https://github.com/${i}/${o}`}function pl(e){const t=/^(?:https?:\/\/)?(?:www\.)?github\.com\/([^/]+)\/([^/]+)(?:\/)?$/,r=e.match(t);if(!r)throw new Error("Invalid GitHub URL format: "+e);const[,n,s]=r;return{githubUrl:e,githubRepo:`${n}/${s}`,githubOwner:n,githubName:s}}async function Os(e,t){try{const r=e.split("/"),n=r[r.length-2],s=r[r.length-1].replace(".git",""),i=`https://api.github.com/repos/${n}/${s}/contents/${encodeURIComponent(t)}`;console.log(`Querying github api at ${i}`);const o=await $fetch(i,{headers:{"User-Agent":"New Recruit Data Editor (Electron)",Accept:"application/vnd.github.v3+json"}});if(!o||!(o!=null&&o.download_url))throw new Error("No download_url found");console.log(`Downloading file at ${o==null?void 0:o.download_url}`);const c=await $fetch(o.download_url,{headers:{"User-Agent":"New Recruit Data Editor (Electron)",Accept:"application/vnd.github.v3+json"}});return console.log(`Downloaded file, length: ${c.length}`),c}catch(r){throw r}}async function gl(e,t,r){try{return await Os(e,t)}catch(n){if(!r)throw n;return await Os(e,r)}}async function yl(e,t){if(t.fullFilePath)try{const r=ni(t.fullFilePath),n=r.endsWith("z")?$s(r,"z"):void 0,s=await gl(e.githubUrl,r,n),i=/revision="(\d+)"/,o=s.match(i);if(o){const c=(Number(o[1])||0)+1;return console.log(`Revision of ${t.name}: ${t.revision} -> ${c}`),c}}catch(r){console.error(r)}return t.revision||1}function Ts(e,t){if(e)return e[t]||e["*"]}async function pr(e,t,r,n){if(!t.catalogue&&!t.gameSystem)throw Error("invalid loadBsData argument: no .catalogue or .gameSystem in data");const s=t.catalogue?"catalogue":"gameSystem",i=s==="gameSystem",o=s==="catalogue",c=t[s],a=c;if(a.loaded||a.loaded_editor)return a;Ve(c);const l=Dr(c,s);if(l.manager=e,o){const f={targetId:l.gameSystemId},d=e.getLoadedCatalogue(f,r);if(d)l.gameSystem=d;else{const h=await e.getData(f,r),g=e.getLoadedCatalogue(f,r);g?l.gameSystem=g:l.gameSystem=await pr(e,h,r)}}const u=[];for(const f of(l==null?void 0:l.catalogueLinks)||[]){if(!f.targetId){console.warn(`invalid link: no targetId in link: ${f}, found in ${c.name}`);continue}if(f.targetId===l.id){f.target=l;continue}const d=e.getLoadedCatalogue(f,r);if(d){f.target=d;continue}const h=e.getData(f,r).then(g=>{const p=e.getLoadedCatalogue(f,r);if(p){f.target=p;return}return pr(e,g,r).then(y=>f.target=y)});u.push(h)}return await Promise.all(u),i&&e.addLoadedSystem(l),o&&e.addLoadedCatalogue(l),l}class ml{constructor(){b(this,"catalogues",{});b(this,"unresolvedLinks");b(this,"settings")}async getData(t,r){throw new Error("Method not implemented.")}getCatalogueInfo(t){}findOptionById(t){}getLoadedCatalogue(t,r){const n=typeof t=="string"?t:t.targetId||t.name,s=Ts(r,n)||"default",i=this.catalogues[n];return i?i[s]:void 0}addLoadedCatalogue(t,r){const n=Ts(r,t.id)||"default";this.catalogues[t.name]||(this.catalogues[t.name]={}),this.catalogues[t.id]||(this.catalogues[t.id]={}),this.catalogues[t.name][n]=t,this.catalogues[t.id][n]=t}addLoadedSystem(t,r){return this.addLoadedCatalogue(t,r)}unloadAll(){this.catalogues={}}async loadData(t,r){const n=await pr(this,t,r);return n.process(),n}async loadCatalogue(t,r,n){const s=this.getLoadedCatalogue(t,r);if(s&&!n)return s;const i=await this.getData(t,r);if(i)return await this.loadData(i,r);throw Error(`Couldn't load catalogue: couldn't getData ${t}`)}}class Ls extends ml{constructor(){super(...arguments);b(this,"gameSystem",null);b(this,"catalogueFiles",hc());b(this,"allLoaded");b(this,"loadedCatalogues",{});b(this,"github");b(this,"unresolvedLinks",{});b(this,"index",{})}async loadData(r,n){return await pr(this,r,n)}findOptionById(r){for(const n of Object.values(this.loadedCatalogues))if(n.index&&n.index[r])return n.index[r]}unloadAll(){super.unloadAll();for(const r of Object.values(this.loadedCatalogues))r.reset();this.loadedCatalogues={},delete this.allLoaded}async loadAll(r){var i,o;let n=Object.values(this.catalogueFiles).length+1,s=0;if(this.allLoaded||console.log("Loading all catalogues in",(o=(i=this.gameSystem)==null?void 0:i.gameSystem)==null?void 0:o.name),this.gameSystem){r&&await r(s,n,`Loading ${this.gameSystem.gameSystem.name}`),(await this.loadCatalogue({targetId:this.gameSystem.gameSystem.id})).processForEditor(),s++;for(const a of Object.values(this.catalogueFiles))r&&await r(s,n,`Loading ${a.catalogue.name}`),(await this.loadCatalogue({targetId:a.catalogue.id})).processForEditor(),s++,r&&await r(s,n,`Loading ${a.catalogue.name}`)}this.allLoaded=!0}getLoadedCatalogue(r,n){const s=r.targetId||r.name;return this.loadedCatalogues[s]}addLoadedCatalogue(r,n){this.loadedCatalogues[r.id]=r}getAllLoadedCatalogues(){var n;return((n=this.gameSystem)==null?void 0:n.gameSystem.id)?Object.values(this.loadedCatalogues):[]}getId(){var r;return(r=this.gameSystem)==null?void 0:r.gameSystem.id}getCatalogueInfo(r){var n,s;if(((n=this.gameSystem)==null?void 0:n.gameSystem.id)===r.targetId)return(s=this.gameSystem)==null?void 0:s.gameSystem;for(const i of Object.values(this.catalogueFiles))if(i.catalogue.id===r.targetId)return i.catalogue}getAllCatalogueFiles(){return[...this.gameSystem?[this.gameSystem]:[],...Object.values(this.catalogueFiles)]}setSystem(r){this.gameSystem=r}setCatalogue(r){const n=r.catalogue.id;this.catalogueFiles[n]=r}removeCatalogue(r){for(const[n,s]of Object.entries(this.catalogueFiles))s.catalogue.id===r.catalogue.id&&delete this.catalogueFiles[n]}async getData(r,n){var c;if(r.targetId==((c=this.gameSystem)==null?void 0:c.gameSystem.id))return this.gameSystem;if(r.targetId in this.catalogueFiles)return this.catalogueFiles[r.targetId];const s=await Ne.catalogues.get({"content.catalogue.id":r.targetId});if(s)return s.content;const i=await Ne.systems.get(r.targetId);if(i)return i.content;const o=r.name?`name ${r.name}`:`id ${r.targetId}`;throw Error(`Couldn't import catalogue with ${o}, perhaps it wasnt uploaded?`)}}const vl=!1;function ae(e){return e.vnode}function He(e){if(e instanceof R)return e;const t=e.$parent;if(t.item)return t.item;const r=t.$parent;return r.item?r.item:r.$parent.item}function bl(e){e.isSaving=!0}function wl(e){if(e.isSaving){e.isSaving=!1;return}e.isChangedOnDisk=!0}function _l(e){e.isChangedOnDisk&&(e.isChangedOnDisk=!1),e.isSaving===void 0&&(e.isSaving=!1)}const Gr=new Set(["select","showInEditor","showChildsInEditor"]),El=vn("editor",{state:()=>({selections:[],selectedEntries:[],selectedElementGroup:null,selectedElement:null,selectedItem:null,filter:"",filterRegex:RegExp(""),filtered:[],undoStack:[],undoStackPos:-1,historyStack:[],historyStackPos:0,clipboard:[],mode:"edit",clipboardmode:"json",gameSystems:{},gameSystemsLoaded:!1,unsavedChanges:{},unsavedCount:0}),actions:{async create_system(e,t,r){console.log("Creating system with name:",e);const n=`sys-${X()}`,s=this.get_system(n),i=t?`${$s(t.replaceAll("\\","/"),"/")}/${e}`:"";if(electron){if(!i)throw new Error("No folder specified");bc(i)}const o={gameSystem:{id:n,name:e,battleScribeVersion:"2.03",revision:1,categoryEntries:[{name:"Default Category",id:"default-category"}],forceEntries:[{name:"Default Force",hidden:!1,id:"default-force",categoryLinks:[{name:"Default Category",hidden:!1,id:"default-force-category-link",targetId:"default-category"}]}],selectionEntries:[{type:"upgrade",import:!0,name:"Default Root Entry",hidden:!1,id:"default-entry",categoryLinks:[{targetId:"default-category",id:"default-category-link",primary:!0,name:"Default Category",hidden:!1}]}]}};return i&&(o.gameSystem.fullFilePath=`${i}/${e}.${r||"gst"}`),s.setSystem(o),this.get_catalogue_state(o).incremented=!0,this.saveCatalogue(o),s},saveCatalogueInDb(e){const t=Kr(e);!!!e.gameSystemId?Ne.systems.put({content:JSON.parse(t),path:e.fullFilePath,id:e.id}):Ne.catalogues.put({content:JSON.parse(t),path:e.fullFilePath,id:`${e.gameSystemId}-${e.id}`})},async saveCatalogueInFiles(e){const t=e.fullFilePath;if(!t){console.error(`No path included in the catalogue ${e.name} to save at`);return}const r=yr(t);if(t.endsWith(".json")){const n=Kr(e);await ys(t,n)}else{const n=cc(e),s=ei(r),o=ni(t).replace(".gstz",".gst").replace(".catz",".cat"),c=s?await Wi(o,n,"uint8array"):n;await ys(t,c)}},saveCatalogue(e){const t=this.get_catalogue_state(e),r=ye(e);bl(t),electron?this.saveCatalogueInFiles(r):this.saveCatalogueInDb(r),_l(t)},async load_systems_from_folder(e,t){var c,a;if(!globalThis.electron)throw new Error("Not running in electron");const r=await vc(e);if(!(r!=null&&r.length))return;console.log("Loading",r.length,"files",r);const n=[],s=[],i=[],o=r.filter(l=>rc(l.name));for(const l of o){t&&await t(s.length,o.length,l.path);const u=await nc(l.data,l.name.endsWith("json")?"json":"xml"),f=(c=u==null?void 0:u.gameSystem)==null?void 0:c.id,d=(a=u==null?void 0:u.catalogue)==null?void 0:a.id,h=ye(u);if(h.fullFilePath=l.path.replaceAll("\\","/"),f){const g=this.get_system(f);g.setSystem(qn(u)),i.push(g),n.push(f)}if(d){const g=this.get_system(u.catalogue.gameSystemId);g.catalogueFiles[d]=qn(u)}s.push(u)}t&&await t(s.length,o.length);for(const l of i)t&&await t(0,0,"Checking for github integration"),await this.load_system(l);return n},async load_systems_from_db(e=!1){if(!this.gameSystemsLoaded&&!e){this.gameSystemsLoaded=!0;let t=await Ne.systems.offset(0).keys();for(let r of t)r in this.gameSystems||this.load_system_from_db(r)}},async load_system_from_db(e){const t=await Ne.systems.get(e),r=t==null?void 0:t.content;if(!r)throw new Error("System not found "+e);r.gameSystem.fullFilePath||(r.gameSystem.fullFilePath=t.path);const n=await Ne.catalogues.where({"content.catalogue.gameSystemId":e}),s=this.get_system(r.gameSystem.id);s.setSystem(r);for(let{content:i,path:o}of await n.toArray()){const c=i.catalogue.id;i.catalogue.fullFilePath||(i.catalogue.fullFilePath=o),s.catalogueFiles[c]=ji(i)}this.load_system(s,!0)},async load_system(e,t=!1){var r,n;if(e.gameSystem){const s=gs();if(await e.unloadAll(),!t)for(const a of e.getAllCatalogueFiles()){const l=this.get_catalogue_state(a);l&&(l.changed=!1,l.unsaved=!1,l.isChangedOnDisk=!1),s.updateCatalogue(ye(a)),s.setEdited(ye(a).id,!1)}const i=e.gameSystem.gameSystem.publications,o=i==null?void 0:i.find(a=>{var l;return((l=a.name)==null?void 0:l.trim().toLowerCase())==="github"}),c=e.gameSystem.gameSystem.fullFilePath;if(c&&vl)try{const a=await _c(ri(c));a&&a!=="origin"&&(console.log("remote:",a),e.github={...pl(a),discovered:!0})}catch(a){console.error(a)}o&&o.publisherUrl&&(e.github={githubUrl:o.publisherUrl},o.shortName&&o.shortName.includes("/")&&(e.github.githubRepo=o.shortName,e.github.githubOwner=(r=o.shortName)==null?void 0:r.split("/")[0],e.github.githubName=(n=o.shortName)==null?void 0:n.split("/")[1]))}for(const s of e.getAllCatalogueFiles()){const i=ye(s);i.fullFilePath&&wc(i.fullFilePath,()=>{this.on_file_changed(s)})}},on_file_changed(e){console.log(ye(e).name,"changed"),wl(this.get_catalogue_state(e))},async get_or_load_system(e){return e in this.gameSystems||(this.gameSystems[e]=new Ls,await this.load_system_from_db(e)),this.gameSystems[e]},get_system(e){if(!(e in this.gameSystems)){const t=new Ls;t.settings=zt(),this.gameSystems[e]=t}return this.gameSystems[e]},delete_system(e){delete this.gameSystems[e]},get_catalogue_state(e){const t=Wn(e);return this.unsavedChanges[t]||(this.unsavedChanges[t]={changed:!1,unsaved:!1}),this.unsavedChanges[t]},set_catalogue_changed(e,t=!0){const r=this.get_catalogue_state(e);t?(r.changed=!0,r.unsaved||(this.unsavedCount+=1,r.unsaved=t)):r.unsaved=t},async save_catalogue(e,t,r){const n=this.get_catalogue_state(t),s=t.revision;r==="github"&&e.github&&(t.revision=await yl(e.github,t)),r==="yes"&&!(n!=null&&n.incremented)&&(t.revision=t.revision?t.revision+1:1,n.incremented=!0),r==="no"&&(n.incremented=!0),this.saveCatalogue(t);const i=gs(),o=Wn(t);return i.updateCatalogue(t),i.setEdited(o,!0),n!=null&&n.unsaved&&(this.unsavedCount--,n.unsaved=!1),t.revision!==s},async prompt_revision(e){const t=zt(),r=e instanceof sr?e.manager:e;for(const n of e instanceof sr?[e]:r.getAllLoadedCatalogues()){const s=this.get_catalogue_state(n);if(s!=null&&s.unsaved&&!s.incremented)return r.github&&t.githubAutoIncrement&&!navigator.onLine?await(globalThis.customPrompt&&globalThis.customPrompt({html:`<span>Would you like to increase the revision of this catalogue?<span><br/>
    <span class="gray">Note: This is shown because Github cannot be accessed as your are offline</span>`,cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no":r.github&&t.githubAutoIncrement?"github":r.github?await(globalThis.customPrompt&&globalThis.customPrompt({html:"<span>Would you like to increase the revision of this catalogue?<span><br/>",cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no":await(globalThis.customPrompt&&globalThis.customPrompt({html:`<span>Would you like to increase the revision of this catalogue?<span><br/>
    <span class="gray">Note: You can enable automatic revision increments by integrating with GitHub.<br/>This can be achieved by adding a publication in the GameSystem named "GitHub" with the repository's GitHub URL as the Publication URL.`,cancel:"No",accept:"Yes",id:"revision"}))?"yes":"no"}},async save_all(e){var n,s,i;let t=!1,r=0;zt();try{for(const o of Object.values(this.gameSystems)){if(e&&((s=(n=o.gameSystem)==null?void 0:n.gameSystem)==null?void 0:s.id)!==e)continue;const c=await this.prompt_revision(o);for(const a of o.getAllLoadedCatalogues())(i=this.get_catalogue_state(a))!=null&&i.unsaved&&await this.save_catalogue(o,a,c)&&(r+=1)}}catch(o){notify({text:`Failed to save: ${o.name}: ${o.message}`,type:"error"}),t=!0}return r&&notify(`Incremented ${r} catalogue's revision`),t},set_filter(e){this.$state.filter=e,this.filterRegex=Br(e)},init(e){this.catalogueComponent=e,globalThis.$store=this,globalThis.$search=t=>{var r;return this.system_search((r=this.catalogueComponent)==null?void 0:r.systemFiles,{filter:t})}},rerender_catalogue(){this.catalogueComponent&&(this.catalogueComponent.key+=1)},unselect(e){const t=[],r=[];for(const n of this.selections)e===void 0||pe(n.obj)===pe(e)?r.push(n):t.push(n);for(const n of this.selectedEntries)e===void 0||pe(n.obj)===pe(e)?r.push(n):t.push(n);this.selections=t;for(const n of r)n.onunselected&&n.onunselected(),n.obj===this.selectedItem&&(this.selectedItem=null)},is_selected(e){return e instanceof R?this.selectedEntries.find(t=>t.obj===e)!==void 0:this.selections.find(t=>t.obj===e)!==void 0},select(e,t,r){this.is_selected(e)||(e instanceof R?this.selectedEntries.push({obj:e,onunselected:t,payload:r}):this.selections.push({obj:e,onunselected:t,payload:r}))},do_select(e,t,r){const n=Array.isArray(r)?r:[r],s=this.selectedElementGroup,i=this.selectedElement;if(this.selectedElement=t,this.selectedElementGroup=r,e!=null&&e.shiftKey&&pe(r)===pe(s)){const o=n.findIndex(u=>u===pe(i)),c=n.findIndex(u=>u===pe(this.selectedElement)),a=Math.min(o,c),l=Math.max(o,c);for(let u=a;u<=l;u++)n[u].select();return}!(e!=null&&e.ctrlKey)&&!(e!=null&&e.metaKey)&&this.unselect(),e!=null&&e.ctrlKey&&this.is_selected(t)?this.unselect(t):(t.select(),this.selectedItem=t,this.mode="edit")},do_rightclick_select(e,t,r){this.is_selected(t)||this.do_select(e,t,r)},clear_selections(){this.unselect()},get_selections(){const e=this.selections.map(t=>He(t.obj));return this.selectedEntries.forEach(t=>e.push(t.obj)),e},get_selections_with_payload(){const e=this.selections.map(t=>({obj:He(t.obj),payload:t.payload}));return this.selectedEntries.forEach(t=>e.push({obj:t.obj,payload:t.payload})),e},get_selected(){return this.selectedItem&&He(this.selectedItem)},set_selections(e){this.clear_selections();const t=Array.isArray(e)?e:[e];this.selectedEntries=t.map(r=>({obj:r,onunselected:()=>null}))},async do_action(e,t,r){let n;try{n=await r()}catch(s){console.error(s);return}if(this.undoStackPos<this.undoStack.length){const s=this.undoStack.length-this.undoStackPos-1;this.undoStack.splice(this.undoStackPos+1,s,{type:e,undo:t,redo:r})}else this.undoStack.push({type:e,undo:t,redo:r});return this.undoStackPos+=1,n},async set_clipboard(e,t){if(this.clipboardmode==="json"){const r=e.map(s=>({parentKey:s.parentKey,...s})),n=to(r,new Set(["parentKey"]),{forceArray:!1,formatted:!0});t!=null&&t.clipboardData?t.clipboardData.setData("text/plain",n):await navigator.clipboard.writeText(n)}else this.clipboard=e},async get_clipboard(e){if(this.clipboardmode==="json")if(e!=null&&e.clipboardData){const t=e.clipboardData.getData("text/plain");return t?JSON.parse(t):[]}else{const t=await navigator.clipboard.readText();return JSON.parse(t)}return this.clipboard},can_undo(){return!!this.undoStack[this.undoStackPos]},async undo(){if(!this.can_undo())return;const e=this.undoStack[this.undoStackPos];e&&(await e.undo(),this.undoStackPos--)},can_redo(){return!!this.undoStack[this.undoStackPos+1]},async redo(){if(!this.can_redo())return;const e=this.undoStack[this.undoStackPos+1];e&&(await e.redo(),this.undoStackPos++)},async cut(e){await this.set_clipboard(this.get_selections(),e),this.remove()},async copy(e){await this.set_clipboard(this.get_selections(),e)},async paste(e){this.add(await this.get_clipboard(e))},async pasteLink(){const e=await this.get_clipboard();if(!e||!e.parentKey||Array.isArray(e))return;const r=this.get_selections()[0];if(!r)return;const n=r.getCatalogue().findOptionById(e.id);if(n){const s={parentKey:n.isGroup()||n.isEntry()?"entryLinks":"infoLinks",targetId:n.id,id:X(),type:n.editorTypeName,name:n.getName(),hidden:n.hidden,select:!0};this.add(s)}},async duplicate(){const e=this.get_selections();if(!e.length)return;const t=e[0].getCatalogue(),r=t.getSystemId();let n=[];const s=()=>{n=[];for(const o of e){const c=JSON.parse(jt(o,Gr));if(!o.parent)continue;const a=o.parent[o.parentKey];if(!Array.isArray(a))throw new Error(`Couldn't duplicate: parent[${o.parentKey}] is not an array`);Ve({[o.parentKey]:c}),hs(t,c),a.push(c),qe(c,t,o.parent,this.get_system(r)),n.push(c)}},i=()=>{for(const o of n)Or(t,ke(o)),$t(o)};await this.do_action("dupe",i,s),this.set_catalogue_changed(t,!0)},remove(e){let t=[];if(e)for(const a of Array.isArray(e)?e:[e])t.push(a);else{const a=this.get_selections();if(!a.length)return;for(const l of a)t.push(l)}const r=t[0].getCatalogue(),n=r.getSystemId();let s=[],i=[];const o=async()=>{const a=t,l=this.get_system(n);i=[],s=[];for(const u of a){const f=ke(u),d=Or(r,f);i.push(d),s.push(f),$t(d,l)}i.reverse(),s.reverse()},c=async()=>{for(const[a,l]of Di(s,i)){const u=ds(r,a,l);qe(l,r,u,this.get_system(n))}};this.do_action("remove",c,o),this.set_catalogue_changed(r,!0),this.unselect()},async add(e,t,r){let n=[];if(r?(r=Array.isArray(r)?r:[r],n=r.map(f=>({obj:f}))):n=this.get_selections_with_payload(),!n.length){console.error("Couldn't add: no selection or parent(s) provided");return}const s=Array.isArray(e)?e:[e];if(!s.length){console.error("Couldn't add: no data provided");return}const i=n[0].obj.getCatalogue(),o=i.getSystemId();let c=[];const a=async()=>{var f;c=[];for(const d of n){const h=d.obj,g=d.payload;await this.open(h,!0);for(const p of s){const y=ps(h,t||p.parentKey,g);if(!y){console.warn("Couldn't create",t||p.parentKey,"in",g);continue}h[y]||(h[y]=[]);const m=h[y];if(!Array.isArray(m))continue;if(!((f=us(h,h.parentKey))!=null&&f.has(y))){console.warn("Couldn't add",y,"to a",h.parentKey,"because it is not allowed");continue}const v=p instanceof R?jt(p,Gr):JSON.stringify(p),w=JSON.parse(v);Wr(w,y),delete w.parentKey,Ve({[y]:w}),hs(i,w),this.filtered.push(w),w.showChildsInEditor=!0;let k=w;for(;k;)k.showInEditor=!0,k=k.parent;m.push(w),qe(w,i,h,this.get_system(o)),c.push(w)}}return c[0]},l=()=>{for(const f of c)Or(i,ke(f)),$t(f)},u=await this.do_action("add",l,a);return this.set_catalogue_changed(i,!0),u},open_selected(){for(const e of this.selections)e.obj.open()},get_initial_object(e,t){switch(e){case"costTypes":return{name:`New ${ze(Se(e))}`,id:X(),defaultCostLimit:-1};case"repeats":return{value:1,repeats:1,field:"selections",scope:"parent",childId:"any",shared:!0,roundUp:!1,id:X()};case"constraints":{const s=(t==null?void 0:t.parentKey)==="associations",i={type:"min",value:1,field:t!=null&&t.isForce()?"forces":"selections",scope:"parent",shared:!0,id:X()};return s&&(i.childId="any"),i}case"conditions":return{type:"atLeast",value:1,field:"selections",scope:"parent",childId:"any",shared:!0};case"modifiers":return{type:"set",value:!0,field:"hidden"};case"modifierGroups":case"conditionGroups":return{type:"and"};case"sharedSelectionEntries":case"selectionEntries":return{type:"upgrade",import:!0,name:`New ${ze(Se(e))}`,hidden:!1,id:X()};case"entryLinks":return{import:!0,name:`New ${ze(Se(e))}`,hidden:!1,id:X()};case"associations":return{min:1,max:1,scope:"roster",includeChildSelections:!1,of:"any",ids:[],label:"Association",labelMembers:"Unit",hidden:!1,id:X()};case"sharedProfiles":case"profiles":const r=t==null?void 0:t.getCatalogue().iterateProfileTypes().next().value;return{name:(!t||t!=null&&t.isCatalogue()||t==null?void 0:t.getName())||"New Profile",typeId:r==null?void 0:r.id,typeName:r==null?void 0:r.name,hidden:!1,id:X()};case"catalogueLinks":return{type:"catalogue",name:`New ${ze(Se(e))}`,id:X()};case"categoryLinks":return{type:"category",name:`New ${ze(Se(e))}`,hidden:!1,id:X()};default:return{name:`New ${ze(Se(e))}`,hidden:!1,id:X()}}},async create(e,t){const r={...this.get_initial_object(e),select:!0,...t};await this.add(r,e),this.open_selected()},async create_child(e,t,r){const n={...this.get_initial_object(e,t),select:!0,...r};await this.add(n,e,t),this.open_selected()},add_child(e,t,r){var l;const n=ps(t,e);if(!n)throw new Error(`Invalid key: ${e} in ${t.editorTypeName}`);const s=t.catalogue,i=s.getSystemId(),o={...this.get_initial_object(n,t),id:X(),...r};t[n]||(t[n]=[]);const c=t[n];if(!Array.isArray(c))return;if(!((l=us(t,t.parentKey))!=null&&l.has(n))){console.warn("Couldn't add",n,"to a",t.parentKey,"because it is not allowed");return}const a=JSON.parse(o);Wr(a,n),delete a.parentKey,Ve({[n]:a}),c.push(a),qe(a,s,t,this.get_system(i))},can_move(e){return!e.isLink()},get_move_targets(e){const t=e.catalogue;if(!t||e.isLink())return;const r=[];if(!e.parentKey.startsWith("shared")&&this.move_to_key(e,"shared")?r.push({target:t,type:"shared"}):e.parentKey.startsWith("shared")&&this.move_to_key(e,"root")&&r.push({target:t,type:"root"}),this.move_to_key(e,"shared"))for(const n of t.imports)r.push({target:n,type:"shared"});if(this.move_to_key(e,"root"))for(const n of t.imports)r.push({target:n,type:"root"});return r},move_to_key(e,t){if(t==="shared")switch(e.editorTypeName){case"infoGroup":return"sharedInfoGroups";case"rule":return"sharedRules";case"profile":return"sharedProfiles";case"selectionEntry":return"sharedSelectionEntries";case"selectionEntryGroup":return"sharedSelectionEntryGroups";default:return""}switch(e.editorTypeName){case"infoGroup":return"infoGroups";case"rule":return"rules";case"profile":return"profiles";case"selectionEntry":return"selectionEntries";case"selectionEntryGroup":return"";default:return e.parentKey}},move(e,t,r,n){(()=>{const i=this.move_to_key(e,n);if(!i){console.error("Could not find key for move",e.editorTypeName,n);return}const o=e.parent,c=ke(e);uc(e),$t(e);const a=JSON.parse(jt(e,Gr));Ve({[i]:a}),r[i]||(r[i]=[]),r[i].push(a),qe(a,r,r,this.get_system(r.getSystemId()));const u=["rule","infoGroup","profile","selectionEntry","selectionEntryGroup"].includes(e.editorTypeName),f=!e.parentKey.startsWith("shared");if(u&&f){const d={targetId:a.id,id:t.generateNonConflictingId(),type:e.editorTypeName,name:e.getName(),hidden:e.hidden,select:!0};e.isEntry()&&(d.collective=e.collective);const h=e.isGroup()||e.isEntry()?"entryLinks":"infoLinks";Ve({[h]:d}),c[c.length-1].key=h,ds(t,c,d),qe(d,t,o,this.get_system(t.getSystemId()))}})(),this.set_catalogue_changed(t,!0),this.set_catalogue_changed(r,!0)},async open(e,t,r){var l;let n=document.getElementById("editor-entries");if(!n)return;async function s(u){const f=ae(u);f.open(),await f.$nextTick()}async function i(u){const f=ae(u);f.close(),await f.$nextTick()}const o=ke(e);if(!(o!=null&&o.length))return;if(n=n.getElementsByClassName(`depth-0 ${o[0].key}`)[0],!n){r!==!0&&console.error("Couldn't find root element for",o[0].key,"in",e.catalogue.getName());return}await s(n);const c=[];qt(e,u=>{c.push(u)}),c.pop(),c.reverse(),c.push(e),c[0].parentKey==="sharedProfiles"&&c.unshift({parentKey:`label-${c[0].typeName??"Untyped"}`});const a=c[c.length-1];for(let u=0;u<c.length;u++){const f=c[u],d=n.getElementsByClassName(`depth-${u+1} ${f.parentKey}`),h=f.parentKey.startsWith("label-")?d[0]:[...d].find(g=>He(ae(g))===f);h||r!==!0&&console.error("Couldn't find path to",e.getName(),e,"parent:",(l=e.parent)==null?void 0:l.getName()),h&&(n=h),f!==a&&await s(n),f===a&&(t===!1?await i(n):t===!0&&await s(n))}return n},async goto_catalogue(e,t){var o,c,a;const r=this.$router;if(!r)throw new Error("Cannot follow link to another catalogue without $router set");const s=((o=r.currentRoute)==null?void 0:o.query)??((a=(c=r.currentRoute)==null?void 0:c.value)==null?void 0:a.query),i=(s==null?void 0:s.id)||(s==null?void 0:s.systemId);return e!==i?(r.push({name:"catalogue",query:{systemId:t||e,id:e}}),this.$nextTick=new Promise((l,u)=>{this.$nextTickResolve=l}),await this.$nextTick,!0):!1},async show(e,t=!0){this.filtered.includes(e)||this.filtered.push(e),e.showInEditor=!0,e.showChildsInEditor=!0,t&&(e.highlight=!0),qt(e,r=>{r.showInEditor=!0})},async goto(e){const t=e.getCatalogue();this.put_current_state_in_history();const r=Ht();r.get_data(t.id).selection=ke(e),await this.goto_catalogue(t.id,t.gameSystemId),this.show(e,!1),await this.scrollto(e)},async scrollto(e){const t=await this.open(e);if(t){const r=ae(t);this.do_select(null,r,r),t.scrollIntoView({behavior:"instant",block:"center",inline:"center"})}else setTimeout(async()=>{const r=await this.open(e);if(r){const n=ae(r);this.do_select(null,n,n),r.scrollIntoView({behavior:"instant",block:"center",inline:"center"})}},50)},can_goto(e){return e?typeof e=="object"&&e instanceof R:!1},can_follow(e){return!!(e!=null&&e.target)},async follow(e){e!=null&&e.target&&await this.goto(e.target)},async move_up(e){if(e.parent){const t=e.parent[e.parentKey],r=t.indexOf(e);if(r>0){const n=t.splice(r,1)[0];t.splice(r-1,0,n)}}},async move_down(e){if(e.parent){const t=e.parent[e.parentKey],r=t.indexOf(e);if(r>=0&&r<t.length-1){const n=t.splice(r,1)[0];t.splice(r+1,0,n)}}},get_leftpanel_open_collapsible_boxes(){function e(r,n,s=0){const i=`depth-${s} collapsible-box opened`,o=r.getElementsByClassName(i);if(o!=null&&o.length)for(const c of o){const a=He(ae(c)),l=a.parentKey,u=a.parent;if(u){const f=u[l];if(!f||!Array.isArray(f))continue;const d=f.indexOf(a);l in n||(n[l]={}),d in n[l]||(n[l][d]={}),e(c,n[l][d],s+1)}else{const f=[...c.classList].filter(d=>st.has(d)||d.startsWith("label-"));for(const d of f)n[d]={},n[d][0]={};e(c,n[f[0]][0],s+1)}}}const t={};return e(document.documentElement,t),t},get_leftpanel_state(){if(!this.catalogueComponent)return{};const e={},t=this.catalogueComponent.$refs.leftpanel;for(const r of Object.keys(si))e[r]=t[r];return e},get_current_state(){var r;const e=this.get_selected(),t=(r=this.catalogueComponent)==null?void 0:r.cat;return{...this.get_leftpanel_state(),mode:this.mode,open:this.get_leftpanel_open_collapsible_boxes(),selection:e?ke(e):void 0,catalogueId:t==null?void 0:t.id,systemId:t==null?void 0:t.gameSystemId}},save_state(){if(this.catalogueComponent&&this.catalogueComponent.cat){const e=this.catalogueComponent.cat.id,t=Ht(),r=this.get_current_state();t.set_state(e,r)}},async load_state(e){this.catalogueComponent&&(Ht().set_state(e.catalogueId,e),this.mode=e.mode||"edit",await this.goto_catalogue(e.catalogueId,e.systemId)||(this.catalogueComponent.load_state(e),this.rerender_catalogue()))},put_state_in_history(e){if(this.historyStackPos<this.historyStack.length){const t=this.historyStack.length-this.historyStackPos;this.historyStack.splice(this.historyStackPos,t,e)}else this.historyStack.push(e);this.historyStackPos=this.historyStack.length},put_current_state_in_history(){this.catalogueComponent&&this.catalogueComponent.cat&&this.put_state_in_history(this.get_current_state())},can_back(){return this.historyStackPos>0},async back(){this.can_back()&&(this.historyStack[this.historyStackPos]=this.get_current_state(),this.historyStackPos-=1,this.load_state(this.historyStack[this.historyStackPos]))},can_forward(){if(this.historyStack[this.historyStack.length-1])return this.historyStackPos<this.historyStack.length-1},async forward(){this.can_forward()&&(this.historyStackPos+=1,this.load_state(this.historyStack[this.historyStackPos]))},async update_catalogue_search(e,t){const{filter:r,ignoreProfilesRules:n}=t,s=this.filtered;for(const i of s)delete i.showInEditor,delete i.showChildsInEditor,delete i.highlight,qt(i,o=>{delete o.showInEditor,delete i.showChildsInEditor});if(this.filter.length<=1){this.set_filter(""),this.filtered=[];return}this.set_filter(r),this.filtered=e.findOptionsByText(r),n&&(this.filtered=this.filtered.filter(i=>!i.isProfile()&&!i.isRule()&&!i.isInfoGroup()));for(const i of this.filtered)this.show(i);if(await Ps(),this.filtered.length<300){for(const i of this.filtered)if(i.parent)try{await this.open(i,!1,!0)}catch{continue}}},async system_search(e,t,r=1e3){const n=[],{filter:s}=t;if(!s)return null;const i=Br(s);let o=!1;await e.loadAll();for(const a of e.getAllLoadedCatalogues())if(a.forEachObjectWhitelist((l,u)=>{var f;try{if(n.length>=r||l.targetId&&l.target&&l.target.isCategory()&&!(u!=null&&u.isForce()))return;const d=(f=l.getName)==null?void 0:f.call(l),h=l.$text,g=l.description,p=l.id;(p===s||d&&String(d).match(i)||p===s||h&&String(h).match(i)||g&&String(g).match(i))&&n.push(l)}catch(d){console.error("Error while searching:",d)}}),n.length>=r){o=!0;break}console.log("Search for",`"${s}"`,"found",n.length,"results");const c={};for(const a of n)De(c,a.catalogue.name,a);return{grouped:c,all:n,more:o}}}});export{Nl as A,Wn as B,cc as C,Ol as D,ni as E,$l as F,ri as G,Ne as H,Gl as I,Pl as J,Fl as K,vc as L,eo as P,Kl as _,jr as a,He as b,ae as c,Ht as d,Se as e,ze as f,Ll as g,ke as h,so as i,us as j,Tl as k,Dr as l,Xe as m,ye as n,Al as o,gs as p,yl as q,Rl as r,lc as s,Bl as t,El as u,rc as v,ei as w,nc as x,yr as y,Ml as z};
//# sourceMappingURL=editorStore.383ba575.js.map
